Date: Fri, 22 Jan 1999 10:38:40 +0100 (CET)
From: Andrea Arcangeli <>
Subject: Re: [patch] arca-vm-28 - new nr_freeable_pages
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/1999/1/22/125

On Thu, 21 Jan 1999, Andrea Arcangeli wrote:
> 
ftp://e-mind.com/pub/linux/kernel-patches/2.2.0-pre8testing-arca-VM-28.gz
Woops I forgot to diff pagemap.h in arca-vm-28, excuse me. At least
arca-tree-109 was fine ;). 
Index: linux/include/linux/pagemap.h
diff -u linux/include/linux/pagemap.h:1.1.1.1 linux/include/linux/pagemap.h:1.1.2.4
--- linux/include/linux/pagemap.h:1.1.1.1	Mon Jan 18 02:27:10 1999
+++ linux/include/linux/pagemap.h	Fri Jan 22 10:12:47 1999
@@ -11,17 +11,16 @@
 
 #include <linux/mm.h>
 #include <linux/fs.h>
+#include <linux/swap.h>
 
 static inline unsigned long page_address(struct page * page)
 {
-	return PAGE_OFFSET + PAGE_SIZE * page->map_nr;
+	return PAGE_OFFSET + (page->map_nr << PAGE_SHIFT);
 }
 
-#define PAGE_HASH_BITS 11
+#define PAGE_HASH_BITS 13
 #define PAGE_HASH_SIZE (1 << PAGE_HASH_BITS)
 
-#define PAGE_AGE_VALUE 16
-
 extern unsigned long page_cache_size; /* # of pages currently in the hash table */
 extern struct page * page_hash_table[PAGE_HASH_SIZE];
 
@@ -58,7 +57,7 @@
 			break;
 	}
 	/* Found the page. */
-	atomic_inc(&page->count);
+	page_get(page);
 	set_bit(PG_referenced, &page->flags);
 not_found:
 	return page;
@@ -78,6 +77,7 @@
 		page->pprev_hash = NULL;
 	}
 	page_cache_size--;
+	page_put(page);
 }
 
 static inline void __add_page_to_hash_queue(struct page * page, struct page **p)
Andrea Arcangeli
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.rutgers.edu
Please read the FAQ at 
http://www.tux.org/lkml/
Date: Wed, 05 Dec 2007 17:27:41 -0500
From: Gregory Haskins <>
Subject: [PATCH] sched: update root-domain spans upon departure
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2007/12/5/328

Hi Ingo,
  This patch should have been rolled into the series I dropped on you
  yesterday, but was an oversight.  Please apply to sched-devel at your
  earliest convenience.
-Greg
-----------------------
sched: update root-domain spans upon departure
We shouldnt leave cpus enabled in the spans if that RQ has left the domain.
Signed-off-by: Gregory Haskins <ghaskins@novell.com>
---
 kernel/sched.c |    4 ++++
 1 files changed, 4 insertions(+), 0 deletions(-)
diff --git a/kernel/sched.c b/kernel/sched.c
index 05a9a81..33f8b0c 100644
--- a/kernel/sched.c
+++ b/kernel/sched.c
@@ -5845,6 +5845,10 @@ static void rq_attach_root(struct rq *rq, struct root_domain *rd)
 
 		if (atomic_dec_and_test(&old_rd->refcount))
 			kfree(old_rd);
+		else {
+			cpu_clear(rq->cpu, old_rd->span);
+			cpu_clear(rq->cpu, old_rd->online);
+		}
 	}
 
 	atomic_inc(&rd->refcount);
Date: Fri, 16 Feb 2001 12:47:04 +0100
From: Manfred Spraul <>
Subject: Re: Tulip in 2.4.1-ac14 still poorly
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2001/2/16/47

Stephen Thomas wrote:
> 
> On trying 2.4.1-ac13 I hit the tulip driver problems reported elsewhere,
> and ac14 does not seem to fix the problem on my machine.  Attached is an
> extract from my /var/log/messages.
>
Could you try the attached oneliner patches? 
patch-tulip-fix1 is integrated in -ac15, and I send patch-tulip-typo to
Alan a few seconds ago.
--
	Manfreddiff -u 2.4/drivers/net/tulip/pnic.c build-2.4/drivers/net/tulip/pnic.c
--- 2.4/drivers/net/tulip/pnic.c	Fri Feb 16 11:17:03 2001
+++ build-2.4/drivers/net/tulip/pnic.c	Fri Feb 16 11:18:08 2001
@@ -84,7 +84,7 @@
 		tp->full_duplex_lock;
 
 	new_csr6 = tp->csr6;
-	if (negotiated & 0x038)	/* 100mbps. */
+	if (negotiated & 0x0380)	/* 100mbps. */
 		new_csr6 &= ~0x00400000;
 	 else
 		new_csr6 |= 0x00400000;
diff -u 2.4/drivers/net/tulip/pnic.c build-2.4/drivers/net/tulip/pnic.c
--- 2.4/drivers/net/tulip/pnic.c	Thu Feb 15 00:51:38 2001
+++ build-2.4/drivers/net/tulip/pnic.c	Thu Feb 15 01:05:59 2001
@@ -93,8 +93,6 @@
 	 else	
 		new_csr6 &= ~0x0200;
 	if (new_csr6 != tp->csr6) {
-		/* stop the transceiver*/
-		tulip_stop_rxtx(tp, tp->csr6);
 		tp->full_duplex = duplex;
 		tp->csr6 = new_csr6;
 		if (tulip_debug > 0)
@@ -102,10 +100,7 @@
 				   "#%d link partner capability of %4.4x.\n",
 				   dev->name, tp->full_duplex ? "full" : "half",
 				   tp->phys[0], mii_reg5);
-		/* When the transceiver is stopped it triggeres
-		 * a "Transmit stopped interrupt" (misnamed as TxDied).
-		 * The interrupt handler will restart the transceiver
-		 */
+		tulip_restart_rxtx(tp, tp->csr6);
 		return 1;
 	}
 	return 0;
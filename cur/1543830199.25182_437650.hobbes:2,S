Date: Tue, 27 Jun 2006 14:40:20 +1000
From: Nigel Cunningham <>
Subject: [Suspend2][ 3/4] [Suspend2] Power down general routine.
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2006/6/27/55

Powerdown in whatever way the user specified - rebooting being the
overriding option, entering an ACPI state the second choice, doing a simple
power off the third and sitting around in cpu_relax the fallback.
Signed-off-by: Nigel Cunningham <nigel@suspend2.net>
 kernel/power/power_off.c |   28 ++++++++++++++++++++++++++++
 1 files changed, 28 insertions(+), 0 deletions(-)
diff --git a/kernel/power/power_off.c b/kernel/power/power_off.c
index 7f7c565..624ab7b 100644
--- a/kernel/power/power_off.c
+++ b/kernel/power/power_off.c
@@ -50,3 +50,31 @@ int try_pm_state_powerdown(void)
 	return 1;
 }
 
+/*
+ * suspend_power_down
+ * Functionality   : Powers down or reboots the computer once the image
+ *                   has been written to disk.
+ * Key Assumptions : Able to reboot/power down via code called or that
+ *                   the warning emitted if the calls fail will be visible
+ *                   to the user (ie printk resumes devices).
+ * Called From     : do_suspend2_suspend_2
+ */
+
+void suspend_power_down(void)
+{
+	if (test_action_state(SUSPEND_REBOOT)) {
+		suspend_prepare_status(DONT_CLEAR_BAR, "Ready to reboot.");
+		kernel_restart(NULL);
+	}
+
+	suspend_prepare_status(DONT_CLEAR_BAR, "Powering down.");
+
+	if (pm_ops && pm_ops->enter && suspend_powerdown_method && try_pm_state_powerdown())
+		return;
+
+	kernel_power_off();
+	suspend_prepare_status(DONT_CLEAR_BAR, "Powerdown failed");
+	while (1)
+		cpu_relax();
+}
+
--
Nigel Cunningham		nigel at suspend2 dot net
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
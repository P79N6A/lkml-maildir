Date: Sun, 27 Jan 2008 19:01:01 +0530
From: Abhishek Sagar <>
Subject: Re: [PATCH 2/3] x86: Macrofy resuable code
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2008/1/27/125

Sam Ravnborg wrote:
> Small static functions are preferred over macros.
> Any particular reason to use a macro here?
> 
> 	Sam
These macros have very limited(two) instantiations. But here's an alternative patch inlined.
Signed-off-by: Abhishek Sagar <sagar.abhishek@gmail.com>
---
diff --git a/arch/x86/kernel/kprobes.c b/arch/x86/kernel/kprobes.c
index a99e764..b7c2d20 100644
--- a/arch/x86/kernel/kprobes.c
+++ b/arch/x86/kernel/kprobes.c
@@ -159,6 +159,16 @@ struct kretprobe_blackpoint kretprobe_blacklist[] = {
 };
 const int kretprobe_blacklist_size = ARRAY_SIZE(kretprobe_blacklist);
 
+static inline unsigned long kprobe_bkpt_addr(struct pt_regs *regs)
+{
+	return (instruction_pointer(regs) - sizeof(kprobe_opcode_t));
+}
+
+static inline int is_jprobe_bkpt(u8 *ptr)
+{
+	return (ptr > (u8 *)jprobe_return) && (ptr < (u8 *)jprobe_return_end);
+}
+
 /* Insert a jump instruction at address 'from', which jumps to address 'to'.*/
 static void __kprobes set_jmp_op(void *from, void *to)
 {
@@ -519,7 +529,7 @@ static int __kprobes kprobe_handler(struct pt_regs *regs)
 	struct kprobe *p;
 	struct kprobe_ctlblk *kcb;
 
-	addr = (kprobe_opcode_t *)(regs->ip - sizeof(kprobe_opcode_t));
+	addr = (kprobe_opcode_t *)kprobe_bkpt_addr(regs);
 	if (*addr != BREAKPOINT_INSTRUCTION) {
 		/*
 		 * The breakpoint instruction was removed right
@@ -1032,8 +1042,7 @@ int __kprobes longjmp_break_handler(struct kprobe *p, struct pt_regs *regs)
 	u8 *addr = (u8 *) (regs->ip - 1);
 	struct jprobe *jp = container_of(p, struct jprobe, kp);
 
-	if ((addr > (u8 *) jprobe_return) &&
-	    (addr < (u8 *) jprobe_return_end)) {
+	if (is_jprobe_bkpt(addr)) {
 		if (stack_addr(regs) != kcb->jprobe_saved_sp) {
 			struct pt_regs *saved_regs = &kcb->jprobe_saved_regs;
 			printk(KERN_ERR
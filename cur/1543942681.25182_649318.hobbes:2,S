Date: Thu, 7 Feb 2008 01:21:34 +0200
From: "Ahmed S. Darwish" <>
Subject: [Lguest/x86]: Clash with ioremap_nocache() + _PAGE_PWT
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2008/2/6/371

Hi all,
Beginning from commit 4138cc3418f5, ioremap_nocache() sets the _PAGE_PWT
flag. 
Lguest doesn't accept a guest pte with a _PWT flag and reports a
"bad page table entry" in that case. 
I've removed check from lguest code and everything worked fine. 
Is this safe from the Lguest side ?
Mentioned commit [*]:
commit 4138cc3418f5eaa7524ff8e927102863f1ba0ea5
Author: Siddha, Suresh B <suresh.b.siddha@intel.com>
Date:   Wed Jan 30 13:33:43 2008 +0100
    x86: set strong uncacheable where UC is really desired
    Also use _PAGE_PWT for all the mappings which need uncache mapping.
    Instead of existing PAT2 which is UC- (and can be overwritten by MTRRs),
    we now use PAT3 which is strong uncacheable.
    This makes it consistent with pgprot_noncached()
diff --git a/arch/x86/mm/ioremap_32.c b/arch/x86/mm/ioremap_32.c
index 0b27831..ef0f6a4 100644
--- a/arch/x86/mm/ioremap_32.c
+++ b/arch/x86/mm/ioremap_32.c
@@ -119,7 +119,7 @@ EXPORT_SYMBOL(__ioremap);
 void __iomem *ioremap_nocache (unsigned long phys_addr, unsigned long size)
 {
 	unsigned long last_addr;
-	void __iomem *p = __ioremap(phys_addr, size, _PAGE_PCD);
+	void __iomem *p = __ioremap(phys_addr, size, _PAGE_PCD | _PAGE_PWT);
 	if (!p) 
 		return p; 
Thanks,
[*]: latest pull calls set_memory_uc() which also sets the _PWT flag.
--
Ahmed S. Darwish
Homepage: 
http://darwish.07.googlepages.com
Blog: 
http://darwish-07.blogspot.com
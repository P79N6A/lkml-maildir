Date: Sun, 20 Jan 2002 14:18:54 +0100 (CET)
From: Ingo Molnar <>
Subject: Re: [sched] [patch] activate-task-speedup-2.5.3-pre2-A0
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2002/1/20/23

> the attached patch against 2.5.3-pre2 is an optimization of
> activate_task(), to not call effective_prio() if no jiffy passed since
> ->sleep_timestamp was updated. This optimizes high-frequency wakeups.
[attached for real this time.]
	Ingo
--- linux/kernel/sched.c.orig	Sun Jan 20 11:37:04 2002
+++ linux/kernel/sched.c	Sun Jan 20 11:37:21 2002
@@ -126,9 +126,10 @@
 
 static inline void activate_task(task_t *p, runqueue_t *rq)
 {
+	unsigned long sleep_time = jiffies - p->sleep_timestamp;
 	prio_array_t *array = rq->active;
 
-	if (!rt_task(p)) {
+	if (!rt_task(p) && sleep_time) {
 		/*
 		 * This code gives a bonus to interactive tasks. We update
 		 * an 'average sleep time' value here, based on
@@ -136,7 +137,7 @@
 		 * the higher the average gets - and the higher the priority
 		 * boost gets as well.
 		 */
-		p->sleep_avg += jiffies - p->sleep_timestamp;
+		p->sleep_avg += sleep_time;
 		if (p->sleep_avg > MAX_SLEEP_AVG)
 			p->sleep_avg = MAX_SLEEP_AVG;
 		p->prio = effective_prio(p);
Date: Mon, 07 Jun 2004 15:00:56 -0700
From: john stultz <>
Subject: Re: [PATCH 1/3] mull'ify multiplication with HZ in __const_udelay() [Was: Re: Too much error in __const_udelay() ?]
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2004/6/7/238

On Mon, 2004-06-07 at 14:20, Dominik Brodowski wrote:
> Move the multiplication of (loops_per_jiffy * xloops) with HZ into
> the "mull" asm operation. This increases the accuracy of the delay functions
> largely:
> 
[snip]
> diff -ruN linux-original/arch/i386/lib/delay.c linux/arch/i386/lib/delay.c
> --- linux-original/arch/i386/lib/delay.c	2004-06-07 22:01:46.608351088 +0200
> +++ linux/arch/i386/lib/delay.c	2004-06-07 22:05:03.299449496 +0200
> @@ -33,8 +33,8 @@
>  	int d0;
>  	__asm__("mull %0"
>  		:"=d" (xloops), "=&a" (d0)
> -		:"1" (xloops),"0" (current_cpu_data.loops_per_jiffy));
> -        __delay(xloops * HZ);
> +		:"1" (xloops),"0" (current_cpu_data.loops_per_jiffy * HZ));
> +        __delay(xloops);
>  }
Kurt Garloff brought up a good point that loops_per_jiffy*HZ is only
good up to 4Ghz time sources. The workaround he suggested was to
multiply xloops by 4 first and divide HZ by 4. This will allow for
frequencies up to 16Ghz. 
So something like:
	xloops *= 4;
	__asm__("mull %0"
		:"=d" (xloops), "=&a" (d0)
		:"1" (xloops),"0" (LPJ*(HZ/4)));
-john
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
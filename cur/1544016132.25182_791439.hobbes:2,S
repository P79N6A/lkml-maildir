Date: Tue, 13 Jan 2009 17:43:04 +0100
From: Cornelia Huck <>
Subject: [PATCH 1/2] async: Handle kthread_run() return codes.
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2009/1/13/306

If we fail to create the manager thread, fall back to non-fastboot.
If we fail to create an async thread, try again when the manager
thread runs again.
Signed-off-by: Cornelia Huck <cornelia.huck@de.ibm.com>
---
 kernel/async.c |   11 ++++++++---
 1 file changed, 8 insertions(+), 3 deletions(-)
--- linux-2.6.orig/kernel/async.c
+++ linux-2.6/kernel/async.c
@@ -315,11 +315,14 @@ static int async_manager_thread(void *un
 		ec = atomic_read(&entry_count);
 
 		while (tc < ec && tc < MAX_THREADS) {
-			kthread_run(async_thread, NULL, "async/%i", tc);
+			if (IS_ERR(kthread_run(async_thread, NULL, "async/%i",
+					       tc)))
+				/* Try again later. */
+				goto schedule;
 			atomic_inc(&thread_count);
 			tc++;
 		}
-
+schedule:
 		schedule();
 	}
 	remove_wait_queue(&async_new, &wq);
@@ -330,7 +333,9 @@ static int async_manager_thread(void *un
 static int __init async_init(void)
 {
 	if (async_enabled)
-		kthread_run(async_manager_thread, NULL, "async/mgr");
+		if (IS_ERR(kthread_run(async_manager_thread, NULL,
+				       "async/mgr")))
+			async_enabled = 0;
 	return 0;
 }
 
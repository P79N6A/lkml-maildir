Date: Tue, 13 Sep 2005 22:09:00 -0700
From: Roland Dreier <>
Subject: [PATCH] Create __kzalloc_gfp_kernel()
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2005/9/14/14

Andrew, it turns out that your idea of kzalloc_gfp_kernel() does save
a bit.  Here's a patch that shouldn't even make Linus look for a
cattle prod.
[BTW, it's rather amusing watching ld use a gig of memory and several
minutes of CPU time as it strains to link an allyesconfig kernel]
 - R.
Here's a patch to get the effect of having kzalloc_gfp_kernel()
without affecting any callers.  It makes kzalloc() an inline that just
calls __kzalloc_gfp_kernel() if the flags parameter is a compile-time
constant and is GFP_KERNEL, and calls __kzalloc() otherwise.
On an x86_64 allyesconfig kernel, I see the following size:
       text    data     bss     dec     hex filename
    24202272 7609162 1998512 33809946 203e61a ../kbuild-before/vmlinux
    24201601 7609266 1998512 33809379 203e3e3 ../kbuild-after/vmlinux
for a net savings of 671 bytes of text (at a cost of 104 bytes of data
for some reason).  As use of kzalloc() becomes more widespread, this
should get even better.
Signed-off-by: Roland Dreier <rolandd@cisco.com>
diff --git a/include/linux/slab.h b/include/linux/slab.h
--- a/include/linux/slab.h
+++ b/include/linux/slab.h
@@ -99,7 +99,16 @@ found:
 	return __kmalloc(size, flags);
 }
 
-extern void *kzalloc(size_t, unsigned int __nocast);
+extern void *__kzalloc(size_t, unsigned int __nocast);
+extern void *__kzalloc_gfp_kernel(size_t);
+
+static inline void *kzalloc(size_t size, unsigned int __nocast flags)
+{
+	if (__builtin_constant_p(flags) && flags == GFP_KERNEL)
+		return __kzalloc_gfp_kernel(size);
+	else
+		return __kzalloc(size, flags);
+}
 
 /**
  * kcalloc - allocate memory for an array. The memory is set to zero.
diff --git a/mm/slab.c b/mm/slab.c
--- a/mm/slab.c
+++ b/mm/slab.c
@@ -2985,14 +2985,20 @@ EXPORT_SYMBOL(kmem_cache_free);
  * @size: how many bytes of memory are required.
  * @flags: the type of memory to allocate.
  */
-void *kzalloc(size_t size, unsigned int __nocast flags)
+void *__kzalloc(size_t size, unsigned int __nocast flags)
 {
 	void *ret = kmalloc(size, flags);
 	if (ret)
 		memset(ret, 0, size);
 	return ret;
 }
-EXPORT_SYMBOL(kzalloc);
+EXPORT_SYMBOL(__kzalloc);
+
+void *__kzalloc_gfp_kernel(size_t size)
+{
+	return __kzalloc(size, GFP_KERNEL);
+}
+EXPORT_SYMBOL(__kzalloc_gfp_kernel);
 
 /**
  * kfree - free previously allocated memory
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
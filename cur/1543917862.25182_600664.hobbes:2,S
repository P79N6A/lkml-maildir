Date: Mon, 01 Oct 2007 11:31:51 +0200
From: Pieter Palmers <>
Subject: Re: [PATCH] firewire: adopt read cycle timer ABI from raw1394
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2007/10/1/86

Stefan Richter wrote:
>> This duplicates the read cycle timer feature of raw1394 (added in Linux
>> 2.6.21) in firewire-core's userspace ABI.
> 
> Kristian and Pieter, does this simple duplication of the ioctl make
> sense on its own?  AFAIU rawiso's iso packet buffers look different from
> fw-cdevs's. It seems to me as if rawiso always put the cycle into a user
> buffer for each iso packet received...
> 
> raw1394.h::struct raw1394_iso_packet_info {
> 	__u32 offset;
> 	__u16 len;
> 	__u16 cycle;   /* recv only */
> 	__u8  channel; /* recv only */
> 	__u8  tag;
> 	__u8  sy;
> };
> 
> raw1394.c::raw1394_iso_recv_packets()
> 
> 	/* copy the packet_infos out */
> 	for (i = 0; i < upackets.n_packets; i++) {
> 		if (__copy_to_user(&upackets.infos[i],
> 				   &fi->iso_handle->infos[packet],
> 				   sizeof(struct raw1394_iso_packet_info)))
> 			return -EFAULT;
> 
> 		packet = (packet + 1) % fi->iso_handle->buf_packets;
> 	}
> 
> ...while the Juju ABI returns the cycle only for those packets whose
> fw_cdev_iso_packet.control had the FW_CDEV_ISO_INTERRUPT flag set.
> The cycle is then written out in the fw_cdev_event_iso_interrupt event
> which happens when this particular packet was received.  Right?
> 
> Pieter, do applications like yours need the cycle counter only for a few
> predetermined packets or for each and every packet?
We need it for every packet for two reasons:
1) it's the only way to determine how many packets were dropped when 
packet drops are flagged in the callback
2) we convert the 16-bit SYT timestamp of a packet to a full 32-bit 
cycle counter value. This because the range of the 16-bit SYT is too 
small (only 16 packets) for systems that have large buffering.
In short: yes we use it for every packet.
Pieter
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
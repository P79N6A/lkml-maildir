Date: 24 Nov 1999 00:06:53 GMT
From: (H. Peter Anvin)
Subject: Re: NWFS Salvagable File System Name Collisions/No FS IOCTL Problem
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/1999/11/23/68

Followup to:  <383B265A.31FF4A4E@timpanogas.com>
By author:    "Jeff V. Merkey" <jmerkey@timpanogas.com>
In newsgroup: linux.dev.kernel
> 
> Obviously, this is a feature that Linux could certainly use, so we have
> put together the stuff in 2.0 to provide this capability, however, two
> problems:
> 
> 1.  NO IOCTLS to the File System -- this means that in order for the
> file salvage utility to work, we again need an IOCTL into the fs driver,
> or users will have to dismount the volumes before they will be able to
> salvage files.  Netware lets you do it real time from any client so if a
> user trashes files, they can be quickly recovered.  I have written the
> tools to do the salvage, but there's no way at present to talk to the FS
> driver properly so we have an alternate proposal.
> 
On the mounted filesystem, ioctl()s are available just fine.  If you
need ioctl access to the filesystem driver without a mounted
filesystem, use a /dev node.  We have gone over this already.
> 
> 2.  multiple names in Linux - we have seen this problem in NT, and NT
> blows up big time (blue screens of death!!!) if it ever encounters
> multiple identical names.  It responds as though the FS is corrupted.
> Linux seems OK with this, and seems to work fine, but it's hard for
> users to pick a particulat file, so we are adding ".del#" to the end of
> file so folks can pick the ones they want to recover.
> 
This would be exposed through two ways: readdir and lookup.  Linux
itself will always use whatever lookup returns.  readdir, on the other
hand, shouldn't really care about multiple occurrences of the same
filename, although some utilities might malfunction.
> 
> 3.  We have implemented the salvageable file system a little differently
> that in NetWare -- there is a directory on all NetWare volumes calld
> DELETED.SAV that acts as a parent root for all deleted file blocks.  In
> Netware, this directory is internal and invisible to users.  We have
> expposed it, and it acts a lot like the "recycle bin" in NT/Win 98. 
> When you delete a file from a NetWare volume under Linux, it reappears
> under the DELETED.SAV directory.  If you remove the file from the
> DELETED.SAV directory, then it's really purged from the volume (like rm
> does today).  This method will allow folks to have the salvagable file
> system without needing a special utility, but will eat up "A LOT" of
> inodes and inode space.
This is actually very cool, and IMO a much cleaner solution than
anything based on ioctl().  I would, however, suggest calling it
.DELETED.SAV or something else with a leading dot so it doesn't show
up in "ls -l".  I don't think it's a big issue, though.
The Network Appliance file servers use a similar method for their
"snapshot" backups.
> 
> We would prefer to implement so the file system has IOCTL utilities
> based Salvage utilities, but are doing #3 above since there is no IOCTL
> interface to the FS drivers thenselves.  Does anyone out there know if
> there will be any issues with multiple file names showing up within the
> same directory if we do #3 above with what's described.
> 
	-hpa
-- 
<hpa@transmeta.com> at work, <hpa@zytor.com> in private!
"Unix gives you enough rope to shoot yourself in the foot."
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.rutgers.edu
Please read the FAQ at 
http://www.tux.org/lkml/
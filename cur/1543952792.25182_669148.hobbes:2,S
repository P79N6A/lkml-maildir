Date: Wed, 19 Mar 2008 12:27:54 +0900
From: Tejun Heo <>
Subject: Re: 2.6.24.X: SATA/AHCI related boot delay. - not with 2.6.24.3
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2008/3/19/378

Tejun Heo wrote:
> Volker Armin Hemmann wrote:
>> On Dienstag, 18. MÃ¤rz 2008, Tejun Heo wrote:
>>>  failed message on reboots).
>>>
>>>> Of course, I booted and rebooted several times. And it stays.
>>>>
>>>> Maybe it is the hardware. But I replaced the cables already and smart
>>>> says the disk is ok.
>>> Does the attached patch make any difference?
>> patching file drivers/ata/ahci.c
>> Hunk #1 succeeded at 397 (offset -5 lines).
>> Hunk #2 succeeded at 1819 (offset -45 lines).
> 
> It's okay.  It's because I was lazy and generated the patch against
> devel tree.
> 
>> built&booted, same results as allways. With non-raid setting, IDENTIFY error 
>> on cold boot and sofreset error on reboot:
>> (with patch, without nosmi):
> 
> Oh... I see.  I made a mistake.  In ahci.c, what I intended was making
> ahci_softreset NULL not ahci_hardreset.  Can you please change that and
> test again?
> 
Just in case, here's the updated patch.
-- 
tejun
diff --git a/drivers/ata/ahci.c b/drivers/ata/ahci.c
index 6978469..46b7e48 100644
--- a/drivers/ata/ahci.c
+++ b/drivers/ata/ahci.c
@@ -402,6 +402,7 @@ static const struct ata_port_operations ahci_p5wdh_ops = {
 static const struct ata_port_info ahci_port_info[] = {
 	/* board_ahci */
 	{
+		AHCI_HFLAGS	(AHCI_HFLAG_NO_PMP),
 		.flags		= AHCI_FLAG_COMMON,
 		.link_flags	= AHCI_LFLAG_COMMON,
 		.pio_mask	= 0x1f, /* pio0-4 */
@@ -1862,7 +1863,7 @@ static void ahci_error_handler(struct ata_port *ap)
 	}
 
 	/* perform recovery */
-	sata_pmp_do_eh(ap, ata_std_prereset, ahci_softreset,
+	sata_pmp_do_eh(ap, ata_std_prereset, NULL/*ahci_softreset*/,
 		       ahci_hardreset, ahci_postreset,
 		       sata_pmp_std_prereset, ahci_pmp_softreset,
 		       sata_pmp_std_hardreset, sata_pmp_std_postreset);
Date: Wed, 8 Mar 2006 15:09:07 -0500 (EST)
From: Alan Stern <>
Subject: Re: [linux-usb-devel] Re: Fw: Re: oops in choose_configuration()
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2006/3/8/227

On Wed, 8 Mar 2006, David Brownell wrote:
> > In this case it wouldn't make any difference, since all the altsettings
> > for a particular interface are supposed to have the same bInterfaceClass,
> > bInterfaceSubClass, and bInterfaceProtocol.  Although I don't think the
> > USB spec actually says this anywhere..
> 
> I'd have stopped at "wouldn't make any difference"; the kernel must make
> some initial choice, but userspace is free to revise it.  Agreed it would
> be odd if altsettings had different class/subclass/protocol, but I don't
> see any good reason to make that illegal.
Agreed.  And like I said before, this is only a heuristic.
> > The bMaxPower value could be different for different altsettings. 
> 
> Erm, no; that's a per-configuration thing, not a per-altsetting thing.
> It's checking the config descriptor, not the interface descriptor,
> for that particular concern.
Whoops, yes.  I misread the code.  All the more reason not to worry about 
any but the first altsetting.
> > > > b) How do we know that there's actually anything _there_?  The length of
> > > >    that variable-sized array doesn't seem to have been stored anywhere
> > > >    obvious by usb_parse_configuration() and choose_configuration() doesn't
> > > >    check.  What happens if the length was zero?
> > > 
> > > I don't think it is allowed to be, as all USB devices have to have at
> > > least 1 interface.
> 
> I think that's not true, and it would be worth verifying that it's not
> a no-interfaces device even if the USB spec required it.  It's trivial
> to create device firmware that advertises no-interfaces, and those should
> never be able to make Linux hiccup (much less oops).
Ha!  "should never be able" indeed.  It turns out the code doesn't like it 
if a configuration has no interfaces.  How embarassing...
Andrew, if you tell us what's in your /proc/bus/usb/devices we'll see
whether that was the real problem.  In any case, a patch follows.
Alan Stern
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
Date: Fri, 14 Nov 2003 10:27:14 +0530
From: Prasanna S Panchamukhi <>
Subject: Re: LKCD Network dump over netpoll patch (2.6.0-test9)
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2003/11/13/181

Hi,
Below is the patch to netpoll. This patch modifies the netpoll_poll() routine 
to include the zap_completion_queue() routine as suggested by Matt Mackall.
diff -urNp linux.orig/net/core/netpoll.c linux-2.6.0-test9/net/core/netpoll.c
--- linux.orig/net/core/netpoll.c	2003-11-13 05:22:20.000000000 +0530
+++ linux-2.6.0-test9/net/core/netpoll.c	2003-11-13 05:46:46.000000000 +0530
@@ -66,6 +66,7 @@ void netpoll_poll(struct netpoll *np)
 	if(trapped && np->dev->poll &&
 	   test_bit(__LINK_STATE_RX_SCHED, &np->dev->state))
 		np->dev->poll(np->dev, &budget);
+	zap_completion_queue();
 }
 
 static void refill_skbs(void)
@@ -115,8 +116,8 @@ static struct sk_buff * find_skb(struct 
 	unsigned long flags;
 	struct sk_buff *skb = NULL;
 
-repeat:
 	zap_completion_queue();
+repeat:
 	if (nr_skbs < MAX_SKBS)
 		refill_skbs();
 
@@ -165,7 +166,6 @@ repeat:
 		spin_unlock(&np->dev->xmit_lock);
 
 		netpoll_poll(np);
-		zap_completion_queue();
 		goto repeat;
 	}
 
-- 
Thanks & Regards
Prasanna S Panchamukhi
Linux Technology Center
India Software Labs, IBM Bangalore
Ph: 91-80-5044632
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
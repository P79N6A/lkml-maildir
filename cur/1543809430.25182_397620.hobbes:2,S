Date: Wed, 15 Feb 2006 15:59:25 +0100
From: Jens Axboe <>
Subject: Re: 2.6.16-rc3 kernel BUG at drivers/scsi/sata_mv.c:1018
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2006/2/15/140

On Wed, Feb 15 2006, Sander wrote:
> Hi Jeff and others,
> 
> I get a kernel BUG message when I try to create a raid1 or raid5 over
> nine 64MB partitions located on nine sata disks (Maxtor Pro 500) on a
> fresh setup. The system locks hard: no sysrq.
> 
> The onboard controller is an nVidia nForce with three disks.
> The six other disks are connected to a Marvell 88SX6081 controller.
> 
> Last night and the first half of today all disks were tested with
> badblocks in write mode, which the system survived just fine (one disk
> out of ten detected as broken, so nine disks left).
> 
> A google search leads me to
> 
> 
http://www.uwsg.iu.edu/hypermail/linux/kernel/0601.2/0479.html
> 
> and
> 
> 
http://www.uwsg.iu.edu/hypermail/linux/kernel/0601.2/0626.html
> 
> I had MSI disabled in the .config already, and will try again with debug
> options set.
> 
> In the mean time, is this of any help?
> 
> I can try any patch you throw at me, or any config option, as this
> system is not in production yet.
It's barfing on a barrier write, I bet. The attached patch should fix
it.
---
[PATCH] Add missing FUA write to sata_mv dma command list
Signed-off-by: Jens Axboe <axboe@suse.de>
diff --git a/drivers/scsi/sata_mv.c b/drivers/scsi/sata_mv.c
index 6fddf17..2770005 100644
--- a/drivers/scsi/sata_mv.c
+++ b/drivers/scsi/sata_mv.c
@@ -997,6 +997,7 @@ static void mv_qc_prep(struct ata_queued
 	case ATA_CMD_READ_EXT:
 	case ATA_CMD_WRITE:
 	case ATA_CMD_WRITE_EXT:
+	case ATA_CMD_WRITE_FUA_EXT:
 		mv_crqb_pack_cmd(cw++, tf->hob_nsect, ATA_REG_NSECT, 0);
 		break;
 #ifdef LIBATA_NCQ		/* FIXME: remove this line when NCQ added */
-- 
Jens Axboe
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
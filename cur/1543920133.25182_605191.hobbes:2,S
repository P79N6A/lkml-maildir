Date: Mon, 15 Oct 2007 13:37:49 +0200
From: Laurent Vivier <>
Subject: Re: [RESEND 2][PATCH 4/4] Modify KVM to update guest time	accounting.
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2007/10/15/124

Avi Kivity wrote:
> Laurent Vivier wrote:
>> Avi Kivity wrote:
>> 
>>> Ingo Molnar wrote:
>>> 
>>>> * Avi Kivity <avi@qumranet.com> wrote:
>>>>
>>>> 
>>>> 
>>>>> This bit can go; for the external module I can add it back in
>>>>> external-module-compat.h.  No need to pollute mainline with backward
>>>>> compatibility stuff.
>>>>> 
>>>> hm:
>>>>
>>>> static inline void kvm_guest_enter(void)
>>>> {
>>>>         current->flags |= PF_VCPU;
>>>> }
>>>>
>>>> static inline void kvm_guest_exit(void)
>>>> {
>>>> }
>>>>
>>>> shouldnt PF_VCPU be cleared in kvm_guest_exit()?
>>>> 
>>> IIRC the accounting code clears it, but yes, it may not have been called
>>> at all, so clearing it here is needed.
>>>
>>> 
>>
>> No, It must not be cleared here because we can't enter in the
>> accounting code
>> between kvm_guest_enter(void) and kvm_guest_exit(void).
>>
>> 
> 
> Right.
> 
>> This is why the accounting code clears it.
>> 
> 
> But if we didn't get an interrupt in that time?
> 
> We can clear it a bit later, after local_irq_enable() in __vcpu_run(). 
> However we need a nop instruction first because "sti" keeps interrupts
> disabled for one more instruction.
IMHO, I think it is better to let kvm_guest_exit() empty (you can remove it, if
you want):
1st case:
- unset PF_VCPU in kvm_guest_exit(), all the tick is always for system time.
Guest time is always 0.
1st case and half:
- like 1st case but we move kvm_guest_exit() as you propose and the reason of
the interrupt is the tick interrupt. The tick is for guest time only. I think
the probability is very low.
2nd case:
- don't unset PF_VCPU in kvm_guest_exit(), all the tick is for guest time.
I proposed a patch allowing to be more accurate, but it introduces more
complexity and system and user time accounting are not very accurate too (the
tick if for system if it appears whereas we are in system, for user if it
appears whereas we are in user).
Laurent
-- 
---------------- Laurent.Vivier@bull.net  -----------------
"Given enough eyeballs, all bugs are shallow" E. S. Raymond
[unhandled content-type:application/pgp-signature]
Date: Mon, 30 Oct 2006 23:57:01 +0900
From: Akinobu Mita <>
Subject: [PATCH -mm] sunrpc/auth_gss: auth_domain refcount fix
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2006/10/30/147

On Mon, Oct 30, 2006 at 04:43:35PM +1100, Neil Brown wrote:
> 1/ We were adding to the refcount when inserting in the hash table,
>    but only removing from the hashtable when the refcount reached zero.
>    Obviously it never would.  So don't count the implied reference of
>    being in the hash table.
...
> diff .prev/net/sunrpc/svcauth.c ./net/sunrpc/svcauth.c
> --- .prev/net/sunrpc/svcauth.c	2006-10-30 15:41:10.000000000 +1100
> +++ ./net/sunrpc/svcauth.c	2006-10-30 16:12:00.000000000 +1100
> @@ -148,10 +148,8 @@ auth_domain_lookup(char *name, struct au
>  			return hp;
>  		}
>  	}
> -	if (new) {
> +	if (new)
>  		hlist_add_head(&new->hash, head);
> -		kref_get(&new->ref);
> -	}
>  	spin_unlock(&auth_domain_lock);
>  	return new;
>  }
This refcount change affects [PATCH 2/2].
(
http://kernel.org/pub/linux/kernel/people/akpm/patches/2.6/2.6.19-rc3/2.6.19-rc3-mm1/broken-out/auth_gss-unregister-gss_domain-when-unloading-module.patch
)
Subject: sunrpc/auth_gss: auth_domain refcount fix
auth_domain_lookup() has been changed not to increase refcount when
inserting in the hash table.
Cc: Neil Brown <neilb@suse.de>
Cc: Andy Adamson <andros@citi.umich.edu>
Cc: J. Bruce Fields <bfields@citi.umich.edu>
Cc: Trond Myklebust <Trond.Myklebust@netapp.com>
Signed-off-by: Akinobu Mita <akinobu.mita@gmail.com>
Index: 2.6-mm/net/sunrpc/auth_gss/svcauth_gss.c
===================================================================
--- 2.6-mm.orig/net/sunrpc/auth_gss/svcauth_gss.c
+++ 2.6-mm/net/sunrpc/auth_gss/svcauth_gss.c
@@ -770,7 +770,6 @@ svcauth_gss_register_pseudoflavor(u32 ps
 		kfree(new->h.name);
 		goto out_free_dom;
 	}
-	auth_domain_put(&new->h);
 	return 0;
 
 out_free_dom:
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
Date: Fri, 18 Jan 2008 10:12:08 +0100
From: Ingo Molnar <>
Subject: Re: [PATCHv2] x86: Use v8086_mode helper, trivial unification
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2008/1/18/92

* Harvey Harrison <harvey.harrison@gmail.com> wrote:
> Use v8086_mode inline in fault_32.c, no functional change also ifdef 
> the section for 32-bit only and add to fault_64.c
> -	if (regs->flags & VM_MASK) {
> +	if (v8086_mode(regs)) {
> --- a/arch/x86/mm/fault_64.c
> +++ b/arch/x86/mm/fault_64.c
> @@ -551,6 +551,16 @@ good_area:
>  		tsk->maj_flt++;
>  	else
>  		tsk->min_flt++;
> +
> +	/*
> +	 * Did it hit the DOS screen memory VA from vm86 mode?
> +	 */
> +	if (v8086_mode(regs)) {
> +		unsigned long bit = (address - 0xA0000) >> PAGE_SHIFT;
> +		if (bit < 32)
> +			tsk->thread.screen_bitmap |= 1 << bit;
> +	}
hm, is there even vm86 mode in 64-bit? Anyway, gcc will eliminate it i 
guess. I've applied your patch.
	Ingo
Date: Tue, 21 Jun 2005 01:34:10 +0200
From: Jesper Juhl <>
Subject: Re: [patch 2/4] cdrom/aztcd: remove sleep_on() usage
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2005/6/20/336

On 6/21/05, Nishanth Aravamudan <nacc@us.ibm.com> wrote:
> On 21.06.2005 [01:14:11 +0200], Jesper Juhl wrote:
> > On 6/20/05, domen@coderock.org <domen@coderock.org> wrote:
> > > From: Nishanth Aravamudan <nacc@us.ibm.com>
> > >
> > >
> > >
> > > Directly use wait-queues instead of the deprecated sleep_on().
> > > This required adding a local waitqueue. Patch is compile-tested.
> > >
> > > Signed-off-by: Nishanth Aravamudan <nacc@us.ibm.com>
> > > Signed-off-by: Domen Puncer <domen@coderock.org>
> > > ---
> > >  aztcd.c |    6 +++++-
> > >  1 files changed, 5 insertions(+), 1 deletion(-)
> > >
> > > Index: quilt/drivers/cdrom/aztcd.c
> > > ===================================================================
> > > --- quilt.orig/drivers/cdrom/aztcd.c
> > > +++ quilt/drivers/cdrom/aztcd.c
> > > @@ -179,6 +179,7 @@
> > >  #include <linux/ioport.h>
> > >  #include <linux/string.h>
> > >  #include <linux/major.h>
> > > +#include <linux/wait.h>
> > >
> > >  #include <linux/init.h>
> > >
> > > @@ -429,9 +430,12 @@ static void dten_low(void)
> > >  #define STEN_LOW_WAIT   statusAzt()
> > >  static void statusAzt(void)
> > >  {
> > > +       DEFINE_WAIT(wait);
> > >         AztTimeout = AZT_STATUS_DELAY;
> > >         SET_TIMER(aztStatTimer, HZ / 100);
> > > -       sleep_on(&azt_waitq);
> > > +       prepare_to_wait(&azt_waitq, &wait, TASK_UNINTERRUPTIBLE);
> > > +       schedule();
> > > +       finish_wait(&azt_waitq, &wait);
> > >         if (AztTimeout <= 0)
> > >                 printk("aztcd: Error Wait STEN_LOW_WAIT command:%x\n",
> > >                        aztCmd);
> > >
> >
> > Hmm, now that noone's sleeping on azt_waitq the two
> > wake_up(&azt_waitq); calls in aztStatTimer() don't seem to make much
> > sense any more... Can they just go away or?  If they can go away then
> > axt_waitq itself would seem to be a goner as well...   It might just
> > be me missing something, but this patch looks incomplete and not
> > completely thought through to me.
> 
> Huh? prepare_to_wait() means the 'wait' here is sleeping on azt_waitq...
> 
Ahh damn, sorry. Somehow I misread the first argument of
prepare_to_wait() and completely missed the fact that it was sleeping
on azt_waitq. It must be past my bedtime...
My bad - it looks good.
-- 
Jesper Juhl <jesper.juhl@gmail.com>
Don't top-post  
http://www.catb.org/~esr/jargon/html/T/top-post.html
Plain text mails only, please      
http://www.expita.com/nomime.html
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
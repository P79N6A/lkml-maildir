Date: Wed, 19 Mar 2008 01:15:52 +0300
From: Oleg Nesterov <>
Subject: Re: rfc, leader_pid_type()
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2008/3/19/419

On 03/18, Eric W. Biederman wrote:
>
> Oleg Nesterov <oleg@tv-sign.ru> writes:
> 
> > Eric, Pavel.
> >
> > Without tasklist lock held, task_tgid/task_pgrp/task_session can return the
> > bogus NULL. Note that the last 2 can return NULL even if task == current.
> >
> > What do you think if we add yet another helper?
> 
> My current inclination is this places the cost for de_thread in the
> wrong place.  exec on a threaded binary should be rare.
> Any chance we can make de_thread rcu safe?
> 
> We are very close.
> 
> It would take a double check but I believe all we need to do is to
> modify detach_pid to remove link->pid.  This of course messes up
> pid_alive but otherwise we should be ok if we have a big fat comment.
Not sure I understand... detach_pid(type) already sets
	task->pids[type].pid = NULL;
> We might need to replace the detach_pid, attach_pid sequence in
> __set_special_pids with an optimized sequence like transfer_pid
> call it replace_pid where we guarantee there is always a valid pid
> pointer in the group_leader.
OK... I think you are right... good point.
> It just feels wrong to me to put cost (and worse complexity) for
> handling the very rare cases in much more common code paths. 
Absolutely agreed.
> > Yes, we already have a lot helpers... The one potential user is
> > check_kill_permission(), but it can live without it.
> 
> I think it is worth removing the pain of using de_thread if we can.
Agreed, but how? de_thread() must remove the old leader from
->pids[type].node before it does release_task(leader).
(i do remember your idea to _not_ switch ->group_leader on exec,
 it solves sooo many problems...)
Oleg.
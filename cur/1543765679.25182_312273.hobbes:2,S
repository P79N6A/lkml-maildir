Date: Sun, 17 Apr 2005 10:06:53 -0700
From: David Brownell <>
Subject: [patch 2.6.12-rc2] revert fs/char_dev.c CONFIG_BASE_FULL change
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2005/4/17/27

I tracked down a regression in PCMCIA (and other software) to a
new bogus register_chrdev() behavior that got merged last month;
a patch from Matt Mackall that misbehaves.
This patch just reverts Matt's, restoring the previous behavior
but at the cost of about a Kbyte of static memory on 32bit CPUs.
Someday a Real Fix(tm) would be good.
- Dave
This reverts a fs/char_dev.c patch that was merged into BK on March 3.
The problem is that it breaks things ... __register_chrdev_region() has
a block of code, commented "temporary" for over two years now, which
fails rudely during PCMCIA initialization or other register_chrdev()
calls, because it doesn't "degrade to linked list".  This keeps whole
subsystems from working.
A real fix to that "temporary" code should be possible, using some better
scheme to allocate major numbers, but it's not something I want to spend
time on just now.
Signed-off-by: David Brownell <dbrownell@users.sourceforge.net>
--- 1.38/fs/char_dev.c	2005-03-09 09:03:28 -08:00
+++ edited/fs/char_dev.c	2005-04-17 08:45:19 -07:00
@@ -26,8 +26,7 @@
 
 static struct kobj_map *cdev_map;
 
-/* degrade to linked list for small systems */
-#define MAX_PROBE_HASH (CONFIG_BASE_SMALL ? 1 : 255)
+#define MAX_PROBE_HASH 255	/* random */
 
 static DECLARE_MUTEX(chrdevs_lock);
 
Date: Thu, 15 Nov 2007 10:43:35 +0900
From: Tejun Heo <>
Subject: Re: [PATCH 1/2] sata_nv: don't use legacy DMA in ADMA mode
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2007/11/14/486

Hello,
Robert Hancock wrote:
> We need to run any DMA command with result taskfile requested in ADMA mode
> when the port is in ADMA mode, otherwise it may try to use the legacy DMA engine
> in ADMA mode which is not allowed. Enforce this with BUG_ON() since data
> corruption could potentially result if this happened.
> 
> Signed-off-by: Robert Hancock <hancockr@shaw.ca>
> 
> --- linux-2.6.24-rc1-git10/drivers/ata/sata_nv.c	2007-11-01 20:01:32.000000000 -0600
> +++ linux-2.6.24-rc1-git10edit/drivers/ata/sata_nv.c	2007-11-13 19:01:09.000000000 -0600
> @@ -791,11 +797,13 @@
> 
>  static void nv_adma_tf_read(struct ata_port *ap, struct ata_taskfile *tf)
>  {
> -	/* Since commands where a result TF is requested are not
> -	   executed in ADMA mode, the only time this function will be called
> -	   in ADMA mode will be if a command fails. In this case we
> -	   don't care about going into register mode with ADMA commands
> -	   pending, as the commands will all shortly be aborted anyway. */
> +	/* Other than when internal or pass-through commands are executed,
> +	   the only time this function will be called in ADMA mode will be
> +	   if a command fails. In the failure case we don't care about going
> +	   into register mode with ADMA commands pending, as the commands will
> +	   all shortly be aborted anyway. We assume that NCQ commands are not
> +	   issued via passthrough and so this will not abort any commands in
> +	   that case. */
>  	nv_adma_register_mode(ap);
So, now if an ATA DMA command is issued w/ RESULT_TF set, it's issued
using ADMA.  Then when nv_adma_tf_read() is called on success path, it
switches into register mode and read TF which is okay as long as there's
no other ADMA commands in flight and that's why you wrote about not
issuing NCQ commands via NCQ.  Am I understanding it correctly?
If so, can you please add that switching into register mode is okay as
long as there's no other ADMA commands in flight and add
WARN_ON((qc->flags & ATA_QCFLAG_RESULT_TF) && link->sactive)?
Thanks.
-- 
tejun
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
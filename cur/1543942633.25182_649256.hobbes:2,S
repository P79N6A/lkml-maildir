Date: Wed, 6 Feb 2008 23:00:01 +0100
From: Ingo Molnar <>
Subject: Re: [PATCH], issue EOI to APIC prior to calling crash_kexec in die_nmi path
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2008/2/6/309

* Neil Horman <nhorman@tuxdriver.com> wrote:
>  	if (!user_mode_vm(regs)) {
> +		nmi_exit();
> +		local_irq_enable();
>  		current->thread.trap_no = 2;
>  		crash_kexec(regs);
looks good to me, but please move the local_irq_enable() to within 
crash_kexec() instead - probably inside the "got the kexec lock" 
section. That makes crash_kexec() use generally safer too i guess: right 
it seems that die() too can call crash_kexec() with irqs disabled - and 
can thus hang in smp_send_stop() [or wherever it hung before].
	Ingo
Date: Tue, 30 Oct 2007 06:53:04 -0700
From: "H.J. Lu" <>
Subject: PATCH: PR Input Devives/2082: PS/2 mouse out of sync after switching with KVM switch
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2007/10/30/191

The bug report is at
http://bugzilla.kernel.org/show_bug.cgi?id=2082
Problem Description: When switching to another machine with a KVM
switch and back, the mouse is out of control, with X.Org.  To recover,
 I have to unplug the mouse cable and plug it back.
Steps to reproduce: Have a wheel mouse connected and X.Org.  Keyboard,
Mouse and Video are connected to a KVM switch. Switch to another
machine and back.  You have lost the usage of wheel on mouse.
This patch for 2.6.23 tries to reconnect the mouse after KVM switch.
It doesn't completely solve the problem. Mouse still got a few random
bytes after KVM switch. But it recovers with kernel message:
psmouse.c: Wheel Mouse at isa0060/serio1/input0 lost synchronization, issuing reconnect request.
instead of
psmouse.c: Wheel Mouse at isa0060/serio1/input0 lost synchronization, throwing 3 bytes away.
and never recovering from it.
BTW, please CC me when reply.  Thanks.
H.J.
----
--- linux-2.6.23.x86_64/drivers/input/mouse/psmouse-base.c.reset	2007-10-09 13:31:38.000000000 -0700
+++ linux-2.6.23.x86_64/drivers/input/mouse/psmouse-base.c	2007-10-26 23:27:55.000000000 -0700
@@ -302,11 +302,11 @@ static irqreturn_t psmouse_interrupt(str
 
 	if (psmouse->state == PSMOUSE_ACTIVATED &&
 	    psmouse->pktcnt && time_after(jiffies, psmouse->last + HZ/2)) {
-		printk(KERN_INFO "psmouse.c: %s at %s lost synchronization, throwing %d bytes away.\n",
-		       psmouse->name, psmouse->phys, psmouse->pktcnt);
+		printk(KERN_INFO "psmouse.c: %s at %s lost synchronization, issuing reconnect request.\n",
+		       psmouse->name, psmouse->phys);
 		psmouse->badbyte = psmouse->packet[0];
-		__psmouse_set_state(psmouse, PSMOUSE_RESYNCING);
-		queue_work(kpsmoused_wq, &psmouse->resync_work);
+		__psmouse_set_state(psmouse, PSMOUSE_IGNORE);
+		serio_reconnect(psmouse->ps2dev.serio);
 		goto out;
 	}
 
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
Date: Fri, 14 Jan 2000 17:15:52 +0100
From: Markus Hennig <>
Subject: [PATCH] netfilter.c ip_output.c OR The favorite kernel-debug method?
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2000/1/15/198

hi,
there are 2 little patches for the kernel-netfilter-code:
netfilter.c : setting a little more debug output
ip_output.c : setting some skb->netfilter values
with this patches the testscript
netfilter-0.1.16/testsuite/00netfilter/09fragthru.sh doesn't fail.
i debugged this only with printk's and restarting the kernel more than
20 times - thats not funny....
is there a much simpler way to do this? like remote-debugging via
serial, or backtrace the stack for the list of calling functions,
setting breakpoints?
whats your favorite method?
regards 
markus hennig--- linux-2.3.35-unused/net//ipv4/ip_output.c	Fri Jan  7 19:14:23 2000
+++ linux-2.3.35/net/ipv4/ip_output.c	Sun Jan  9 19:07:42 2000
@@ -37,6 +37,7 @@
  *					and more readibility. 
  *		Marc Boucher	:	When call_out_firewall returns FW_QUEUE,
  *					silently drop skb instead of failing with -EPERM.
+ *		Markus Hennig   :       Set netfilter-tags for fragments
  */
 
 #include <asm/uaccess.h>
@@ -897,6 +898,20 @@
 		iph->tot_len = htons(len + hlen);
 
 		ip_send_check(iph);
+
+#ifdef CONFIG_NETFILTER
+		/* netfilter-tags for every fragment */
+		/* Can be used for communication between hooks. */
+		skb2->nfmark=skb->nfmark;
+		/* Reason for doing this to the packet (see netfilter.h) */
+		skb2->nfreason=skb->nfreason;
+		/* Cache info */
+		skb2->nfcache=skb->nfcache;
+#ifdef CONFIG_NETFILTER_DEBUG
+		/* every fragment get nf_debug tag and anybody know with hook was used;-) */
+		skb2->nf_debug = skb->nf_debug;
+#endif
+#endif
 
 		err = output(skb2);
 		if (err)--- linux-2.3.35-unused/net/core/netfilter.c	Mon Jan  3 20:45:05 2000
+++ linux-2.3.35/net/core/netfilter.c	Sun Jan  9 19:14:48 2000
@@ -5,7 +5,22 @@
  * way.
  *
  * Rusty Russell (C)1998 -- This code is GPL.
- */
+ * 
+ *
+ * Authors: Rusty Russell 
+ *
+ *
+ *
+ * 
+ * Fixes
+ * 
+ * 
+ * Markus Hennig     :     little more debug-output in nf_dump_skb
+ *
+ *
+ *
+*/
+
 #include <linux/config.h>
 #include <linux/netfilter.h>
 #include <net/protocol.h>
@@ -169,11 +184,14 @@
 
 void nf_dump_skb(int pf, struct sk_buff *skb)
 {
-	printk("skb: pf=%i %s dev=%s len=%u\n", 
+	printk("skb: pf=%i %s dev=%s len=%u debug=%i nfmark=%lu nfreason=%d\n", 
 	       pf,
 	       skb->sk ? "(owned)" : "(unowned)",
 	       skb->dev ? skb->dev->name : "(no dev)",
-	       skb->len);
+	       skb->len, 
+	       skb->nf_debug, 
+	       skb->nfmark,
+	       skb->nfreason);
 	switch (pf) {
 	case PF_INET: {
 		const struct iphdr *ip = skb->nh.iph;[unhandled content-type:application/x-pkcs7-signature]
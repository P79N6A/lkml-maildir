Date: Thu, 01 Nov 2007 18:09:09 +0100
From: Peter Zijlstra <>
Subject: Re: per-bdi-throttling: synchronous writepage doesn't work correctly
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2007/11/1/210

On Thu, 2007-11-01 at 18:00 +0100, Miklos Szeredi wrote:
> > > Hi,
> > > 
> > > It looks like bdi_thresh will always be zero if filesystem does
> > > synchronous writepage, resulting in very poor write performance.
> > > 
> > > Hostfs (UML) is one such example, but there might be others.
> > > 
> > > The only solution I can think of is to add a set_page_writeback();
> > > end_page_writeback() pair (or some reduced variant, that only does
> > > the proportions magic).  But that means auditing quite a few
> > > filesystems...
> > 
> > Ouch...
> > 
> > I take it there is no other function that is shared between all these
> > writeout paths which we could stick a bdi_writeout_inc(bdi) in?
> 
> No, and you can't detect it from the callers either I think.
The page not having PG_writeback set on return is a hint, but not fool
proof, it could be the device is just blazing fast.
I guess there is nothing to it but for me to grep writepage and manually
look at all hits...
[unhandled content-type:application/pgp-signature]
Date: Fri, 8 Feb 2008 21:15:39 -0800
From: Greg KH <>
Subject: Re: kobject must be initialized before calling kobject_init()?!
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2008/2/9/2

On Fri, Feb 08, 2008 at 08:24:25PM -0800, Roland Dreier wrote:
> So I was perusing the code in lib/kobject.c, and I saw this:
> 
> 	void kobject_init(struct kobject *kobj, struct kobj_type *ktype)
> 	{
> 		// [a couple of of parameter checks...]
> 		if (kobj->state_initialized) {
> 			/* do not error out as sometimes we can recover */
> 			printk(KERN_ERR "kobject (%p): tried to init an initialized "
> 			       "object, something is seriously wrong.\n", kobj);
> 			dump_stack();
> 		}
> 
> in other words the first thing you do is check a member of the
> structure you're supposed to be initializing -- if someone just
> kmalloc()s a struct kobject and passes it into this function, there's
> a good chance that state_initialized won't be zero.  In fact, with
> slab debugging on, it's guaranteed to be poisoned with a non-zero
> value.
> 
> So are users supposed to be zeroing out struct kobjects before
> initializing them?
Yes.  See also the check about the non-zero reference count when
initializing the kref, that too will trip.
> If so, this should probably be documented.
You're right.  Patches gladly accepted :)
thanks,
greg k-h
Date: Tue, 4 Dec 2007 10:28:24 -0500 (EST)
From: Alan Stern <>
Subject: Re: [RFC] kobject: add kobject_init_ng, kobject_add_ng, and kobject_init_and_add functions
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2007/12/4/168

On Tue, 4 Dec 2007, Cornelia Huck wrote:
> > > > > + * If the function is successful, the only way to properly clean up the
> > > > > + * memory is with a call to kobject_del().
> > > > 
> > > > In which case kobject_put() isn't needed?
> > > 
> > > kobject_del() should only undo what kobject_add() did. So kobject_put()
> > > will still be needed to clean up the memory. Perhaps the wording should
> > > be:
> > > 
> > > If the function is successful, the only way to properly clean up the
> > > kobject is to call kobject_del() for removing the kobject from the
> > > hierarchy and to subsequently call kobject_put() to clean up the memory.
> > 
> > But that's not what the code does today in the kobject_del() function.
> 
> Hm, if I'm not completely confused, kobject_del() just gives up the
> extra reference obtained by kobject_add(). That leaves the initial
> reference we got via kobject_init(_ng)(). If we want to clean up the
> memory, we need to give up that reference as well.
That's right.  Furthermore there are other parts of the kernel that 
expect to do the kobject_del() and the final kobject_put() separately.  
For example, the driver core does kobject_del() as part of device_del() 
and then it does the final kobject_put() as part of put_device().
Alan Stern
Date: Mon, 01 Sep 2003 15:15:50 +0200
From: Claus-Justus Heine <>
Subject: Re: 2.6.0-test4: bug WRT lazy FPU switching and CONFIG_PREEMPT
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2003/9/1/83

Claus-Justus Heine wrote:
[snip]
> diff -u --recursive --new-file linux-2.6.0-test4/include/asm-i386/i387.h linux-2.6.0-test4-mine/include/asm-i386/i387.h
[snip]
> --- linux-2.6.0-test4/include/asm-i386/i387.h    2003-07-27 19:06:54.000000000 +0200
> +++ linux-2.6.0-test4-mine/include/asm-i386/i387.h    2003-08-31 15:39:04.000000000 +0200
> @@ -30,7 +30,7 @@
>  static inline void __save_init_fpu( struct task_struct *tsk )
>  {
>      if ( cpu_has_fxsr ) {
> -        asm volatile( "fxsave %0 ; fnclex"
> +        asm volatile( "fxsave %0 ; fclex"
I'm sorry, changing "fnclex" to "fclex" was a stupid idea, can lead to deadlocks. So that
patch should have looked like this:
#########################################################################################################################
diff -u --recursive --new-file linux-2.6.0-test4/arch/i386/kernel/traps.c linux-2.6.0-test4-mine/arch/i386/kernel/traps.c
--- linux-2.6.0-test4/arch/i386/kernel/traps.c    2003-08-31 15:22:42.000000000 +0200
+++ linux-2.6.0-test4-mine/arch/i386/kernel/traps.c    2003-08-31 15:35:49.000000000 +0200
@@ -605,7 +605,10 @@
       * Save the info for the exception handler and clear the error.
       */
      task = current;
-    save_init_fpu(task);
+    /* don't trigger an unnecessary math_state_restore() */
+    if (task->thread_info->status & TS_USEDFPU) {
+        save_init_fpu(task);
+    }
      task->thread.trap_no = 16;
      task->thread.error_code = 0;
      info.si_signo = SIGFPE;
@@ -667,7 +670,10 @@
       * Save the info for the exception handler and clear the error.
       */
      task = current;
-    save_init_fpu(task);
+    /* don't trigger an unnecessary math_state_restore() */
+    if (task->thread_info->status & TS_USEDFPU) {
+        save_init_fpu(task);
+    }
      task->thread.trap_no = 19;
      task->thread.error_code = 0;
      info.si_signo = SIGFPE;
diff -u --recursive --new-file linux-2.6.0-test4/include/asm-i386/i387.h linux-2.6.0-test4-mine/include/asm-i386/i387.h
--- linux-2.6.0-test4/include/asm-i386/i387.h    2003-07-27 19:06:54.000000000 +0200
+++ linux-2.6.0-test4-mine/include/asm-i386/i387.h    2003-08-31 15:39:04.000000000 +0200
@@ -41,8 +41,10 @@
  static inline void save_init_fpu( struct task_struct *tsk )
  {
+    preempt_disable();
      __save_init_fpu(tsk);
      stts();
+    preempt_enable_no_resched();
  }
@@ -53,11 +55,13 @@
  #define clear_fpu( tsk )                    \
  do {                                \
+    preempt_disable();                    \
      if ((tsk)->thread_info->status & TS_USEDFPU) {        \
          asm volatile("fwait");                \
          (tsk)->thread_info->status &= ~TS_USEDFPU;    \
          stts();                        \
      }                            \
+    preempt_enable_no_resched();                \
  } while (0)
  /*
##########################################################################################################################################
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
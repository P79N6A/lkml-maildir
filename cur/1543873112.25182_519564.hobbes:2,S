Date: Tue, 13 Mar 2007 08:31:53 -0700
From: Jeremy Fitzhardinge <>
Subject: Re: _proxy_pda still makes linking modules fail
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2007/3/13/214

Paul Mackerras wrote:
> There is a fundamental problem with using __thread, which is that gcc
> assumes that the addresses of __thread variables are constant within
> one thread, and that therefore it can cache the result of address
> calculations.  However, with preempt, threads in the kernel can't rely
> on staying on one cpu, and therefore the addresses of per-cpu
> variables can change.  There appears to be no way to tell gcc to drop
> all cached __thread variable address calculations at a given point
> (e.g. when enabling or disabling preemption).  That is basically why I
> gave up on using __thread for per-cpu variables on powerpc.
> 
Doesn't that fall under the general class of "you have to be pinned to a
particular cpu in order to meaningfully use per-cpu variables"?
Or do you mean that if you have:
	preempt_disable();
	use_my_percpu++;
	preempt_enable();
	// switch cpus
	preempt_disable();
	use_my_percpu++;
	preempt_enable();
then it will still use the old pointer to use_my_percpu?
In principle gcc could CSE the value of smp_processor_id() across a cpu
change in the same way.
    J
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
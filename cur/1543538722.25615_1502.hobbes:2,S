Date: Wed, 12 Jul 2000 19:14:46 +0400
From: "Vladimir B. Savkin" <>
Subject: IDE problem (VIA82C586, kernel 2.2 and 2.4)
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2000/7/12/67

Hello!
I have troubles using IDE disk with recent versions of Linux kernel.
System configuration:
 - MB: Chaintech PA-2013 with VIA Apollo VP3 chipset
 - CPU: AMD K6-III 350 Mhz
 - RAM: 128Mb PC-100 SDRAM
 - HDD: IBM DPTA-371360 
Kernel versions tried:
   1. 2.2.15 with ide.2.2.15.20000509 patch from Andre Hedrick
       and reiserfs (versions 3.5.21 and 3.5.22 tried)
   2. 2.2.16 with reiserfs-3.5.22
   3. 2.2.16 with reiserfs-3.5.22 and ide.2.2.16.20000619 patch
   4. 2.4.0-test1-ac22-riel++ with reiserfs-3.6.9
   5. 2.4.0-test2-ac2 with reiserfs-3.6.9
I use ALSA sound driver 0.5.8a for my SB AWE 32.
I use "hdparm -d1 -X66 -m16 /dev/hda" to tune IDE subsystem at startup.
Kernels (2) and (3) generate error messages pretty soon after startup
( before I log in and see bash prompt )
Last time I tried it was (from kernel(2)):
> Jul  9 04:26:11 tentacle kernel: hda: timeout waiting for DMA 
> Jul  9 04:26:11 tentacle kernel: hda: irq timeout: status=0x58 { DriveReady Seek
> Complete DataRequest } 
> Jul  9 04:26:21 tentacle kernel: hda: timeout waiting for DMA 
> Jul  9 04:26:21 tentacle kernel: hda: irq timeout: status=0x58 { DriveReady Seek
> Complete DataRequest } 
> Jul  9 04:26:31 tentacle kernel: hda: timeout waiting for DMA 
> Jul  9 04:26:31 tentacle kernel: hda: irq timeout: status=0x58 { DriveReady Seek
> Complete DataRequest } 
> Jul  9 04:26:31 tentacle kernel: hda: status timeout: status=0xd0 { Busy } 
> Jul  9 04:26:31 tentacle kernel: hda: DMA disabled 
> Jul  9 04:26:31 tentacle kernel: hda: drive not ready for command 
> Jul  9 04:26:31 tentacle kernel: ide0: reset: success 
Similar message were produced by kernel (3).
Kernel (5) hanged with HDD LED turned on and last message in log
about cron starting updatedb. IIRC there was no message on console.
Machine is currently running kernel (1). It could reach more than 20 days
uptime without error message in the log. But some days ago I noticed
that sometimes data corruption occured when reading large files.
I prepared test directories with large files both on ext2 and reiserfs 
partitions and ran md5sum on them several times. I got aprox. one error
per 100Mb of data. After reboot I could not reproduce that for 2 days,
but now it started to happen again. Switching DMA off did help, but perfomance
was much worse even with umaskirq enabled. I managed to read several gigabytes
without an error 3 or 4 times. After re-enabling DMA read errors started
to appear again. No kernel messages were generated on read errors.
The system is otherwise stable. It could compile a kernel more than 100
times in a row after I discovered read errors.
Various system information attached:
    kernel configuration
    output of hdparm -i
    output of lspci -v
    kernel boot-up messages
I used similar config for all 2.2 kernels. I tried turning VIA82C586
support on and off when using 2.2.16 w/o ide patches.
:wq
                                        With best regards, 
                                           Vladimir Savkin. 
Output of "grep -v '^#' .config" :
CONFIG_EXPERIMENTAL=y
CONFIG_M586TSC=y
CONFIG_X86_WP_WORKS_OK=y
CONFIG_X86_INVLPG=y
CONFIG_X86_BSWAP=y
CONFIG_X86_POPAD_OK=y
CONFIG_X86_TSC=y
CONFIG_1GB=y
CONFIG_MTRR=y
CONFIG_MODULES=y
CONFIG_KMOD=y
CONFIG_NET=y
CONFIG_PCI=y
CONFIG_PCI_GOANY=y
CONFIG_PCI_BIOS=y
CONFIG_PCI_DIRECT=y
CONFIG_PCI_QUIRKS=y
CONFIG_PCI_OLD_PROC=y
CONFIG_SYSVIPC=y
CONFIG_SYSCTL=y
CONFIG_BINFMT_ELF=y
CONFIG_BINFMT_MISC=m
CONFIG_BLK_DEV_FD=m
CONFIG_BLK_DEV_IDE=y
CONFIG_BLK_DEV_IDEDISK=y
CONFIG_IDEDISK_MULTI_MODE=y
CONFIG_BLK_DEV_IDEPCI=y
CONFIG_IDEPCI_SHARE_IRQ=y
CONFIG_BLK_DEV_IDEDMA=y
CONFIG_IDEDMA_AUTO=y
CONFIG_IDEDMA_NEW_DRIVE_LISTINGS=y
CONFIG_IDEDMA_PCI_EXPERIMENTAL=y
CONFIG_IDEDMA_PCI_WIP=y
CONFIG_BLK_DEV_VIA82CXXX=y
CONFIG_VIA82CXXX_TUNING=y
CONFIG_BLK_DEV_LOOP=m
CONFIG_BLK_DEV_RAM=m
CONFIG_PARIDE_PARPORT=y
CONFIG_BLK_DEV_IDE_MODES=y
CONFIG_PACKET=y
CONFIG_NETLINK=y
CONFIG_RTNETLINK=y
CONFIG_NETLINK_DEV=y
CONFIG_FIREWALL=y
CONFIG_UNIX=y
CONFIG_INET=y
CONFIG_IP_MULTICAST=y
CONFIG_IP_ADVANCED_ROUTER=y
CONFIG_RTNETLINK=y
CONFIG_NETLINK=y
CONFIG_IP_MULTIPLE_TABLES=y
CONFIG_IP_ROUTE_MULTIPATH=y
CONFIG_IP_ROUTE_TOS=y
CONFIG_IP_ROUTE_VERBOSE=y
CONFIG_IP_FIREWALL=y
CONFIG_IP_FIREWALL_NETLINK=y
CONFIG_NETLINK_DEV=y
CONFIG_IP_ROUTE_FWMARK=y
CONFIG_IP_TRANSPARENT_PROXY=y
CONFIG_IP_MASQUERADE=y
CONFIG_NET_IPIP=m
CONFIG_NET_IPGRE=m
CONFIG_NET_IPGRE_BROADCAST=y
CONFIG_IP_MROUTE=y
CONFIG_IP_PIMSM_V1=y
CONFIG_IP_ALIAS=y
CONFIG_SKB_LARGE=y
CONFIG_NETDEVICES=y
CONFIG_DUMMY=m
CONFIG_BONDING=m
CONFIG_ETHERTAP=m
CONFIG_NET_ETHERNET=y
CONFIG_RTL8139=m
CONFIG_NET_ISA=y
CONFIG_NE2000=m
CONFIG_NET_EISA=y
CONFIG_EEXPRESS_PRO100=m
CONFIG_NE2K_PCI=m
CONFIG_VT=y
CONFIG_VT_CONSOLE=y
CONFIG_SERIAL=y
CONFIG_SERIAL_EXTENDED=y
CONFIG_UNIX98_PTYS=y
CONFIG_UNIX98_PTY_COUNT=256
CONFIG_MOUSE=y
CONFIG_PSMOUSE=y
CONFIG_NVRAM=m
CONFIG_RTC=y
CONFIG_FAT_FS=m
CONFIG_MSDOS_FS=m
CONFIG_VFAT_FS=m
CONFIG_ISO9660_FS=m
CONFIG_JOLIET=y
CONFIG_PROC_FS=y
CONFIG_DEVPTS_FS=y
CONFIG_EXT2_FS=y
CONFIG_REISERFS_FS=y
CONFIG_REISERFS_CHECK=y
CONFIG_NFS_FS=m
CONFIG_NFSD=m
CONFIG_NFSD_SUN=y
CONFIG_SUNRPC=m
CONFIG_LOCKD=m
CONFIG_SMB_FS=m
CONFIG_NLS=y
CONFIG_NLS_CODEPAGE_437=m
CONFIG_NLS_CODEPAGE_850=m
CONFIG_NLS_CODEPAGE_866=m
CONFIG_NLS_ISO8859_1=m
CONFIG_NLS_ISO8859_5=m
CONFIG_NLS_KOI8_R=m
CONFIG_VGA_CONSOLE=y
CONFIG_VIDEO_SELECT=y
CONFIG_SOUND=m
CONFIG_MAGIC_SYSRQ=y
Output from "hdparm -i /dev/hda"
/dev/hda:
 Model=IBM-DPTA-371360, FwRev=P74OA30A, SerialNo=JHYJHHN7107
 Config={ HardSect NotMFM HdSw>15uSec Fixed DTR>10Mbs }
 RawCHS=16383/16/63, TrkSize=0, SectSize=0, ECCbytes=34
 BuffType=DualPortCache, BuffSize=1961kB, MaxMultSect=16, MultSect=16
 CurCHS=16383/16/63, CurSects=16514064, LBA=yes, LBAsects=26712000
 IORDY=on/off, tPIO={min:240,w/IORDY:120}, tDMA={min:120,rec:120}
 PIO modes: pio0 pio1 pio2 pio3 pio4 
 DMA modes: mdma0 mdma1 mdma2 udma0 udma1 *udma2 udma3 udma4 
 Kernel Drive Geometry LogicalCHS=26500/16/63
Output from "lspci -v" :
00:00.0 Host bridge: VIA Technologies, Inc. VT82C597 [Apollo VP3] (rev 04)
	Flags: bus master, medium devsel, latency 16
	Memory at e0000000 (32-bit, prefetchable)
	Capabilities: [a0] AGP version 1.0
00:01.0 PCI bridge: VIA Technologies, Inc. VT82C598 [Apollo MVP3 AGP] (prog-if 00 [Normal decode])
	Flags: bus master, 66Mhz, medium devsel, latency 0
	Bus: primary=00, secondary=01, subordinate=01, sec-latency=0
	I/O behind bridge: 0000d000-0000dfff
	Memory behind bridge: e8000000-ebffffff
00:07.0 ISA bridge: VIA Technologies, Inc. VT82C586/A/B PCI-to-ISA [Apollo VP] (rev 47)
	Flags: bus master, stepping, medium devsel, latency 0
00:07.1 IDE interface: VIA Technologies, Inc. VT82C586 IDE [Apollo] (rev 06) (prog-if 8a [Master SecP PriP])
	Flags: bus master, medium devsel, latency 64
	I/O ports at e000
00:07.3 Bridge: VIA Technologies, Inc. VT82C586B ACPI (rev 10)
	Flags: medium devsel
00:08.0 Ethernet controller: Realtek Semiconductor Co., Ltd. RTL-8139 (rev 10)
	Subsystem: Realtek Semiconductor Co., Ltd. RT8139
	Flags: bus master, medium devsel, latency 64, IRQ 12
	I/O ports at e800
	Memory at ec000000 (32-bit, non-prefetchable)
01:00.0 VGA compatible controller: ATI Technologies Inc 3D Rage LT Pro AGP-133 (rev dc) (prog-if 00 [VGA])
	Subsystem: ATI Technologies Inc: Unknown device 0044
	Flags: bus master, stepping, medium devsel, latency 64
	Memory at e8000000 (32-bit, non-prefetchable)
	I/O ports at d000
	Memory at ea000000 (32-bit, non-prefetchable)
	Capabilities: [50] AGP version 1.0
	Capabilities: [5c] Power Management version 1
Kernel boot-up messages about IDE:
Jul  9 05:25:41 tentacle kernel: Uniform Multi-Platform E-IDE driver Revision: 6.30 
Jul  9 05:25:41 tentacle kernel: ide: Assuming 33MHz system bus speed for PIO modes; override with idebus=xx 
Jul  9 05:25:41 tentacle kernel: VP_IDE: IDE controller on PCI bus 00 dev 39 
Jul  9 05:25:41 tentacle kernel: VP_IDE: not 100% native mode: will probe irqs later 
Jul  9 05:25:41 tentacle kernel: VT 82C597 Apollo VP3 
Jul  9 05:25:41 tentacle kernel:  Chipset Core ATA-33 
Jul  9 05:25:41 tentacle kernel: Split FIFO Configuration:  8 Primary buffers, threshold = 1/2 
Jul  9 05:25:41 tentacle kernel:                            8 Second. buffers, threshold = 1/2 
Jul  9 05:25:41 tentacle kernel:     ide0: BM-DMA at 0xe000-0xe007, BIOS settings: hda:DMA, hdb:DMA 
Jul  9 05:25:41 tentacle kernel: ide0: VIA Bus-Master (U)DMA Timing Config Success 
Jul  9 05:25:41 tentacle kernel:     ide1: BM-DMA at 0xe008-0xe00f, BIOS settings: hdc:DMA, hdd:DMA 
Jul  9 05:25:41 tentacle kernel: ide1: VIA Bus-Master (U)DMA Timing Config Success 
Jul  9 05:25:41 tentacle kernel: hda: IBM-DPTA-371360, ATA DISK drive 
Jul  9 05:25:41 tentacle kernel: ide: Assuming 33MHz system bus speed for PIO modes; override with idebus=xx 
Jul  9 05:25:41 tentacle kernel: ide0 at 0x1f0-0x1f7,0x3f6 on irq 14 
Jul  9 05:25:41 tentacle kernel: hda: IBM-DPTA-371360, 13042MB w/1961kB Cache, CHS=26500/16/63, UDMA(33) 
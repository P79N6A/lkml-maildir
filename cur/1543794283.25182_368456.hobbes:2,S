Date: Fri, 18 Nov 2005 14:58:01 -0800
From: Badari Pulavarty <>
Subject: re: 2.6.15-rc1-mm2 - strace unhappy
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2005/11/18/268

On Fri, 2005-11-18 at 12:57 -0800, Kenny Simpson wrote:
> strace causes the kernel to croak:
> 
> cd /tmp
> strace ls
> *BOOM*
> 
> Nov 18 15:44:31 tux6127 kernel: [  221.522945] c0126b5b
> Nov 18 15:44:31 tux6127 kernel: [  221.523069] PREEMPT SMP DEBUG_PAGEALLOC
> Nov 18 15:44:31 tux6127 kernel: [  221.523268] Modules linked in: autofs4 parport_pc parport
> floppy rtc i2c_i801 i2c_core generic usbhid uhci_hcd tg3 snd_intel8x0 snd_ac97_codec snd_ac97_bus
> snd_pcm_oss snd_mixer_oss snd_pcm snd_timer snd soundcore snd_page_alloc ehci_hcd usbcore mousedev
> e1000 bcm5700 unix
> Nov 18 15:44:31 tux6127 kernel: [  221.524392] CPU:    0
> Nov 18 15:44:31 tux6127 kernel: [  221.524393] EIP:    0060:[<c0126b5b>]    Not tainted VLI
> Nov 18 15:44:31 tux6127 kernel: [  221.524394] EFLAGS: 00010202   (2.6.15-rc1-mm2) 
> Nov 18 15:44:31 tux6127 kernel: [  221.524525] EIP is at ptrace_check_attach+0x24/0xc4
Christoph sent this patch earlier, which fixed same problem for me.
Thanks,
Badari
Looks like 2.6.15-rc1-mm1 has total crap in ptrace_get_task_struct
(and it looks like my fault because I sent out a wrong patch).
The patch below should fix it:
Index: linux-2.6/kernel/ptrace.c
===================================================================
--- linux-2.6.orig/kernel/ptrace.c	2005-11-18 10:25:35.000000000 +0100
+++ linux-2.6/kernel/ptrace.c	2005-11-18 10:25:54.000000000 +0100
@@ -459,7 +459,7 @@
 	read_unlock(&tasklist_lock);
 	if (!child)
 		return ERR_PTR(-ESRCH);
-	return 0;
+	return child;
 }
 
 #ifndef __ARCH_SYS_PTRACE
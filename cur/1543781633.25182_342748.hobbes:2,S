Date: Thu, 18 Aug 2005 07:32:18 +1000
From: Benjamin Herrenschmidt <>
Subject: [PATCH] ppc64: iommu vmerge fix]
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2005/8/17/161

From: Brian King <brking@us.ibm.com>
(Looks quite bad, should probably get in right away)
The patch below fixes a bug in the PPC64 iommu vmerge code
which results in the potential for iommu_unmap_sg to go off
unmapping more than it should. This was found on a test system
which resulted in PCI bus errors due to PCI memory being
unmapped while DMAs were still in progress.
Signed-off-by: Brian King <brking@us.ibm.com>
Signed-off-by: Benjamin Herrenschmidt <benh@kernel.crashing.org>
---
 linux-2.6-bjking1/arch/ppc64/kernel/iommu.c |    7 ++++---
 1 files changed, 4 insertions(+), 3 deletions(-)
diff -puN arch/ppc64/kernel/iommu.c~ppc64_iommu_vmerge_fix arch/ppc64/kernel/iommu.c
--- linux-2.6/arch/ppc64/kernel/iommu.c~ppc64_iommu_vmerge_fix	2005-08-17 15:34:50.000000000 -0500
+++ linux-2.6-bjking1/arch/ppc64/kernel/iommu.c	2005-08-17 15:35:19.000000000 -0500
@@ -242,7 +242,7 @@ int iommu_map_sg(struct device *dev, str
 	dma_addr_t dma_next = 0, dma_addr;
 	unsigned long flags;
 	struct scatterlist *s, *outs, *segstart;
-	int outcount;
+	int outcount, incount;
 	unsigned long handle;
 
 	BUG_ON(direction == DMA_NONE);
@@ -252,6 +252,7 @@ int iommu_map_sg(struct device *dev, str
 
 	outs = s = segstart = &sglist[0];
 	outcount = 1;
+	incount = nelems;
 	handle = 0;
 
 	/* Init first segment length for backout at failure */
@@ -338,10 +339,10 @@ int iommu_map_sg(struct device *dev, str
 
 	DBG("mapped %d elements:\n", outcount);
 
-	/* For the sake of iommu_free_sg, we clear out the length in the
+	/* For the sake of iommu_unmap_sg, we clear out the length in the
 	 * next entry of the sglist if we didn't fill the list completely
 	 */
-	if (outcount < nelems) {
+	if (outcount < incount) {
 		outs++;
 		outs->dma_address = DMA_ERROR_CODE;
 		outs->dma_length = 0;
_
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
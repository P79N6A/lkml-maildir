Date: Wed, 26 Jul 2000 03:19:42 +0200
From: Kurt Garloff <>
Subject: [PATCH]: autofs fix for 2.2
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2000/7/25/185

Hi Alan, Al,
autofs in 2.2.1x shows a serious bug:
Imagine a setup with autofs and NFS. The users' home dirs are on a
automounted directory, and all are individually mounted via NFS, when needed.
(Quite standard setup, yes.)
If you ls a home which can not be mounted due to NFS failure, you get a
failure (-ENOENT) on first attempt, a success with empty dir later. mount
and autofs syslog show that the mount was not successful and the dir was
rmdir()ed like it should. You can even cd to that dir.
You can provoke much worse behaviour: Just log in as such user.
Boom! You'll end up with a number (twelve in my tests) of such ghost
directories. Of course, none is real. 
On shutdown of automount, you can watch oopses in kmem_cache_free, called by
shrink_dcache_sb. 
You guess it, it's an dcache artefact. And, consequently, there is a
clean up procedure: Doing ls -R /usr clears the ghost directories, as the
dentry cache gets filled with other stuff. 
Looking into it I found the following in fs/namei.c:
cached_lookup() calls d_revalidate() to check whether the cached dirs are
still valid. If not, it does do a dput(), which actually results in
d_free()ing the dentries, as they are unhashed, and returns 0.
However, when cached_lookup() does return 0, real_lookup() is called. Here,
if the dir is found in dcache after waiting for the dir semaphore going
down, no ->d_lookup() is done, but the contents is trusted. Even worse,
d_revalidate() is called, but the result is discarded. Uhh!
(And this explains, why you only get the fatal error when logging in. The
 dir is then accessed many times and sometimes you hit the race, that the
 dentry was just entered while down() was waiting.)
This breaks autofs, as revalidate() does expect the caller does act on
returning 0. The attached patch does exactly this: 
dput() and return ERR_PTR(-ENOENT);
This fixes the trouble with autofs here. AFAICT, other FSes are unaffected.
(Are there braindead FSes out there always returning 0 on revalidate, but
 having mkdir()ed dirs residing in cache? Then you might find your new dir
 only on the second lookup(), if you started it before the mkdir(). That's
 the only issue I can currently think of. But, I'm not a dcache hacker...)
I'm awaiting your expert comments.
If it's OK, please apply!
Regards,
-- 
Kurt Garloff  <garloff@suse.de>                          Eindhoven, NL
GPG key: See mail header, key servers         Linux kernel development
SuSE GmbH, Nuernberg, FRG                               SCSI, Security
--- linux.susefont/fs/namei.c	Tue Jan  4 19:12:23 2000
+++ linux.autofs.fix/fs/namei.c	Tue Jul 25 23:27:32 2000
@@ -269,7 +269,14 @@
 	 */
 	up(&dir->i_sem);
 	if (result->d_op && result->d_op->d_revalidate)
-		result->d_op->d_revalidate(result, flags);
+		/* FIXME: (garloff@suse.de, 2000-07-25): This must be handled
+		 * the same way as in cached_lookup(), otherwise we risk to end
+		 * up trusting an invalid dentry from cache. 
+		 * This was breaking autofs. Fixed. */
+		if (!result->d_op->d_revalidate(result, flags) && !d_invalidate(result)) {
+			dput(result);
+			result = ERR_PTR(-ENOENT);
+		}
 	return result;
 }
 [unhandled content-type:application/pgp-signature]
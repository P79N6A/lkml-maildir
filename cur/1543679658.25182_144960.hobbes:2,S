Date: Wed, 2 Jul 2003 16:57:34 -0700
From: "Pallipadi, Venkatesh" <>
Subject: [PATCH 2.4-ac] Proper APIC version identification
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2003/7/2/236

Hi,
  The boot issue with DL760 G2 issue with Hyper-Threading (16-way
logical) was root-caused to be coming from hardcoding of apic-version
during the acpi boot-up code. The attached patch fixes the issue, by
reading in the actual apic version. This apic-version is used later in
the boot process, to identify whether the processor supports xAPIC or
not. And that in turn was resulting in boot failure.
Please include in the ac-patchset.
Refer following lkml threads for detailed the problem description:
Subject: SUMMARY: DL760 G2 issue with Hyper-Threading:
Subject: PROBLEM: DL760 G2 issue on 2.4.21 with Hyper-Threading
Thanks,
-Venkatesh
--- linux-2.4.21-ac2/arch/i386/kernel/mpparse.c.org	2003-06-30
12:52:21.000000000 -0700
+++ linux-2.4.21-ac2/arch/i386/kernel/mpparse.c	2003-07-01
16:07:40.000000000 -0700
@@ -999,7 +999,14 @@
 
 	processor.mpc_type = MP_PROCESSOR;
 	processor.mpc_apicid = id;
-	processor.mpc_apicver = 0x10; /* TBD: lapic version */
+
+	/*
+	 * mp_register_lapic_address() which is called before the
+	 * current function does the fixmap of FIX_APIC_BASE.
+	 * Read in the correct APIC version from there
+	 */
+	processor.mpc_apicver = apic_read(APIC_LVR);
+	
 	processor.mpc_cpuflag = (enabled ? CPU_ENABLED : 0);
 	processor.mpc_cpuflag |= (boot_cpu ? CPU_BOOTPROCESSOR : 0);
 	processor.mpc_cpufeature = (boot_cpu_data.x86 << 8) | [unhandled content-type:application/octet-stream]
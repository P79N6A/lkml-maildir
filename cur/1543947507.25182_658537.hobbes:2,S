Date: Sat, 23 Feb 2008 00:07:17 -0800
From: Andrew Morton <>
Subject: Re: linux/kernel/irq/chip.c IRQ disable, shutdown bug
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2008/2/23/63

On Fri, 15 Feb 2008 14:10:18 -0000 "Hennerich, Michael" <Michael.Hennerich@analog.com> wrote:
> free_irq() does not disable/mask the irq, in case disable or shutdown in struct irq_chip is left uninitilazied.
> 
> /**
>  * struct irq_chip - hardware interrupt chip descriptor
>  *
>  * @name:		name for /proc/interrupts
>  * @startup:		start up the interrupt (defaults to ->enable if NULL)
>  * @shutdown:		shut down the interrupt (defaults to ->disable if NULL)
>  * @enable:		enable the interrupt (defaults to chip->unmask if NULL)
>  * @disable:		disable the interrupt (defaults to chip->mask if NULL)
> 
> 
> According to linux/irq.h struct irq_chip information,
> chip->disable should default to chip->mask if NULL.
> However irq_chip_set_defaults(struct irq_chip *chip) will set it to default_disable a empty function.
> 
> 
> Looking through various architectures, it's pretty common that disable and shutdown is NULL.
> So this bug affects many architectures.
> 
> This patch fixes the issue.
> 
Please send a Signed-off-by: for this work, as per
Documentation/SubmittingPatches, thanks.
> Index: irq/chip.c
> ===================================================================
> --- irq/chip.c  (revision 4276)
> +++ irq/chip.c  (working copy)
Please prepare future patches in `patch -p1' form.  This should have been
> --- a/kernel/irq/chip.c
> +++ a/kernel/irq/chip.c
> @@ -233,6 +233,10 @@
>   */
>  static void default_disable(unsigned int irq)
>  {
> +       struct irq_desc *desc = irq_desc + irq;
> +
> +       desc->chip->mask(irq);
> +       desc->status |= IRQ_MASKED;
>  }
> 
>  /*
Ingo, Thomas: ack?
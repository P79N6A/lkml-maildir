Date: Tue, 04 Mar 2008 15:02:22 -0500
From: "Jun'ichi Nomura" <>
Subject: Re: [RFC PATCH 1/3] block: add rq->complete_io hook for request stacking
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2008/3/4/406

Hi Hannes,
Hannes Reinecke wrote:
> Kiyoshi Ueda wrote:
>> I'm thinking about an idea come from Mike and Jens after the session
>> at LSF'08:
>>   o stacking driver clones both bio and request and uses
>>     bio->bi_end_io and rq->end_io
>>   o stacking driver uses blk_complete_request() in rq->end_io
>>     so that stacking driver can work without queue lock
>> With this idea, we don't need to add the new hook to request,
>> and we can use request stacking on drivers using __blk_end_request().
>>
> Huh? I can't really imagine how this should work. If you start using
> bio->bi_end_io() for stacking usage you'll end up with doing weird thing
> with the bios ... Can you elaborate a bit more here?
Cloned bio's bi_end_io() can check the error.
For successful I/O, it calls something equivalent to
end_that_request_first() for the original request,
that may eventually complete the original bio and
notify the submitter.
For error, it can decide not to complete the original bio
and record the error information.
When the clone request is finally completed and rq->end_io() is
called, stacking driver can check the recorded error information
and decide whether it should take any action or just complete
the original request by blk_complete_request().
Thanks,
-- 
Jun'ichi Nomura, NEC Corporation of America
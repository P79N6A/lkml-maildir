Date: Wed, 18 May 2005 14:08:41 +0200
From: Miklos Szeredi <>
Subject: Re: [PATCH] fix race in mark_mounts_for_expiry()
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2005/5/18/100

> What you're doing is tricky. It's asking for a race.
I know.  The comment above the function is there to make sure the user
is aware of this.
> Admittedly, it may not
> occur in the particular situation you're looking at, but can you always
> guarantee that?
Yes, if it's always called under lock.
> Remember, it may be a race against some piece of code that's not yet
> written, by an author who doesn't realise what _you_ are doing here
> because their changeset doesn't intersect with yours.
> 
> Remember: you have, in effect, made the usage count on that structure
> non-atomic.
But _only after_ it's has gone to zero.  When in fact there are no
more references to it, so it shouldn't matter.
The fact that it does matter and that mark_mounts_for_expiry()
derefences mnt->mnt_namespace without actually having a proper
reference to the namespace is the real culprit here.
This is the third bug found by Jamie Lokier, Ram and me in the
mnt_namespace change.  So if we are looking at proper solutions I
think that is what we should be examining.
Thanks,
Miklos
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
Date: Mon, 17 Mar 2008 14:59:10 -0400
From: Len Brown <>
Subject: Re: [PATCH] thermal: fix Kconfig dependencies
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2008/3/17/240

On Monday 17 March 2008, Heiko Carstens wrote:
> On Mon, Mar 17, 2008 at 09:55:13AM -0700, Linus Torvalds wrote:
> > On Mon, 17 Mar 2008, Heiko Carstens wrote:
> > > 
> > > Change the select to a depends on to fix this. Should work as well.
> > 
> > Nope, that doesn't work. ACPI_THERMAL will select THERMAL, so now you have 
> > THERMAL selected without HWMON.
> 
> Oh, missed that. Sorry.
> 
> > As a minimal fix, you'd at least need to make ACPI_THERMAL depend on 
> > THERMAL too.
Although the "select" that started this thread was certainly erroneous,
this doesn't look right either.
THERMAL should not depend on or select HWMON.
Instead, part of its code that is there for
the benefit of HWMON should depend on HWMON.
Based on Jean's last message, that code should
probably get its own sub-config option, CONFIG_THERMAL_HWMON
that is default N for the benefit of old libraries.
Similarly, ACPI_THERMAL should not depend on THERMAL,
instead the code that registers with THERMAL should
simply depend on if THERMAL is selected or not.
Also, the "default y" should go.
I'll tinker with this a bit after lunch.
thanks,
-Len
> Updated patch:
> 
> Subject: [PATCH] thermal: fix Kconfig dependencies
> 
> From: Heiko Carstens <heiko.carstens@de.ibm.com>
> 
> git commit 3152fb9f11cdd2fd8688c2c5cb805e5c09b53dd9
> "thermal: fix generic thermal I/F for hwmon" adds a select HWMON
> to THERMAL. This causes HWMON to be selected regardless of its
> other dependencies. In this case depends on HAS_IOMEM gets ignored
> which causes this build error on s390:
> 
> drivers/hwmon/w83627hf.c: In function 'superio_outb':
> drivers/hwmon/w83627hf.c:117: error: implicit declaration of function 'outb'
> 
> Change the select to a depends on. In addition change the select THERMAL
> from ACPI_THERMAL to a depends on THERMAL. Otherwise THERMAL
> could be selected by ACPI_THERMAL without HWMON being selected.
> 
> Cc: Zhang Rui <rui.zhang@intel.com>
> Cc: Len Brown <len.brown@intel.com>
> Cc: Sam Ravnborg <sam@ravnborg.org>
> Cc: Martin Schwidefsky <schwidefsky@de.ibm.com>
> Signed-off-by: Heiko Carstens <heiko.carstens@de.ibm.com>
> ---
> 
>  drivers/acpi/Kconfig    |    3 +--
>  drivers/thermal/Kconfig |    2 +-
>  2 files changed, 2 insertions(+), 3 deletions(-)
> 
> Index: linux-2.6/drivers/thermal/Kconfig
> ===================================================================
> --- linux-2.6.orig/drivers/thermal/Kconfig
> +++ linux-2.6/drivers/thermal/Kconfig
> @@ -4,7 +4,7 @@
> 
>  menuconfig THERMAL
>  	bool "Generic Thermal sysfs driver"
> -	select HWMON
> +	depends on HWMON
>  	default y
>  	help
>  	  Generic Thermal Sysfs driver offers a generic mechanism for
> Index: linux-2.6/drivers/acpi/Kconfig
> ===================================================================
> --- linux-2.6.orig/drivers/acpi/Kconfig
> +++ linux-2.6/drivers/acpi/Kconfig
> @@ -187,8 +187,7 @@ config ACPI_HOTPLUG_CPU
> 
>  config ACPI_THERMAL
>  	tristate "Thermal Zone"
> -	depends on ACPI_PROCESSOR
> -	select THERMAL
> +	depends on ACPI_PROCESSOR && THERMAL
>  	default y
>  	help
>  	  This driver adds support for ACPI thermal zones.  Most mobile and
> --
> To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
> the body of a message to majordomo@vger.kernel.org
> More majordomo info at  
http://vger.kernel.org/majordomo-info.html
> Please read the FAQ at  
http://www.tux.org/lkml/
> 
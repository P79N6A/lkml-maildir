Date: Wed, 12 Nov 2008 06:22:21 -0600
From: Rusty Russell <>
Subject: [PATCH 1/7] virtio: Don't use PAGE_SIZE in virtio_pci.c
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2008/11/12/111

The virtio PCI devices don't depend on the guest page size.  This matters
now PowerPC virtio is gaining ground (they like 64k pages).
Signed-off-by: Rusty Russell <rusty@rustcorp.com.au>
---
 drivers/virtio/virtio_pci.c |    2 +-
 include/linux/virtio_pci.h  |    4 ++++
 2 files changed, 5 insertions(+), 1 deletion(-)
diff -r 8014f9c51f4e drivers/virtio/virtio_pci.c
--- a/drivers/virtio/virtio_pci.c	Wed Nov 12 21:12:39 2008 +1030
+++ b/drivers/virtio/virtio_pci.c	Wed Nov 12 21:47:21 2008 +1030
@@ -244,7 +244,7 @@
 	}
 
 	/* activate the queue */
-	iowrite32(virt_to_phys(info->queue) >> PAGE_SHIFT,
+	iowrite32(virt_to_phys(info->queue) >> VIRTIO_PCI_QUEUE_ADDR_SHIFT,
 		  vp_dev->ioaddr + VIRTIO_PCI_QUEUE_PFN);
 
 	/* create the vring */
diff -r 8014f9c51f4e include/linux/virtio_pci.h
--- a/include/linux/virtio_pci.h	Wed Nov 12 21:12:39 2008 +1030
+++ b/include/linux/virtio_pci.h	Wed Nov 12 21:47:21 2008 +1030
@@ -53,4 +53,8 @@
 
 /* Virtio ABI version, this must match exactly */
 #define VIRTIO_PCI_ABI_VERSION		0
+
+/* How many bits to shift physical queue address written to QUEUE_PFN.
+ * 12 is historical, and due to x86 page size. */
+#define VIRTIO_PCI_QUEUE_ADDR_SHIFT	12
 #endif
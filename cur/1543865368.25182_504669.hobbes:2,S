Date: Sat, 3 Feb 2007 08:14:26 +0000
From: Russell King <>
Subject: Re: [PATCH/RFC] alternative aproach to: Ban module license tag string termination trick
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2007/2/3/15

On Sat, Feb 03, 2007 at 03:08:14AM +0100, Bodo Eggert wrote:
> This patch changes the module license handling code to:
> - prevent the "GPL\0 for nothing"-trick
You can achieve this effect without changing the existing module
format, and it's far more difficult to bypass with build-with-
modified module.h tricks.
--- a/kernel/module.c	Mon Nov  7 19:58:31 2005
+++ b/kernel/module.c	Mon Dec  5 19:39:36 2005
@@ -286,6 +286,24 @@ static unsigned long find_local_symbol(E
  	return 0;
 }
 
+static int check_modinfo_objects(Elf_Shdr *sechdrs,
+				 unsigned int symindex,
+				 unsigned int infoindex)
+{
+	unsigned int i;
+	Elf_Sym *sym = (void *)sechdrs[symindex].sh_addr;
+	char *info = (char *)sechdrs[infoindex].sh_addr;
+
+	for (i = 1; i < sechdrs[symindex].sh_size/sizeof(*sym); i++) {
+		if (sym[i].st_shndx == infoindex &&
+		    ELF_ST_TYPE(sym[i].st_info) == STT_OBJECT) {
+			if (strlen(info + sym[i].st_value) + 1 != sym[i].st_size)
+				return -ENOEXEC;
+		}
+	}
+	return 0;
+}
+
 /* Search for module by name: must hold module_mutex. */
 static struct module *find_module(const char *name)
 {
@@ -1674,6 +1692,10 @@ static struct module *load_module(void _
 		goto free_hdr;
 	}
 
+	err = check_modinfo_objects(sechdrs, symindex, infoindex);
+	if (err)
+		goto free_hdr;
+
 	modmagic = get_modinfo(sechdrs, infoindex, "vermagic");
 	/* This is allowed: modprobe --force will invalidate it. */
 	if (!modmagic) {
-- 
Russell King
 Linux kernel    2.6 ARM Linux   - 
http://www.arm.linux.org.uk/
 maintainer of:
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
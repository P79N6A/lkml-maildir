Date: Sun, 6 Jun 2004 19:58:48 +0200
From: BlaisorBlade <>
Subject: [PATCH] Missing BKL in sys_chroot() for 2.6
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2004/6/7/172

(PLEASE cc me on replies as I'm not subscribed).
Set_fs_root *claims* it wants the BKL held:
/*
 * Replace the fs->{rootmnt,root} with {mnt,dentry}. Put the old values.
 * It can block. Requires the big lock held.
 */
void set_fs_root(struct fs_struct *fs, struct vfsmount *mnt,
                 struct dentry *dentry)
But sys_chroot ignores this. So I attach this patch (apply with patch -p1 -l). 
Maybe the solution is to kill that comment, maybe not (sys_pivot_root() calls 
chroot_fs_refs() -> set_fs_root() with the BKL held, but that has a lot of 
reasons other than this). If that comment is correct, however, it probably 
holds even for set_fs_altroot(), since it's similar. So this patch adds it.
TESTING: none, I'm sure about the inconsistency, a lot less about the solution 
(no kernel manual explains the BKL, since it is a relict; except the ones who 
still says it blocks all the rest of the kernel, while I think it is just a 
recursive and "sleepable" spinlock - am I correct?).
--- vanilla-linux-2.6.6/fs/open.c.saved 2004-05-10 21:37:11.000000000 +0200
+++ vanilla-linux-2.6.6/fs/open.c       2004-06-06 19:40:20.000000000 +0200
@@ -581,8 +581,13 @@
        if (!capable(CAP_SYS_CHROOT))
                goto dput_and_out;
+       lock_kernel();
+
        set_fs_root(current->fs, nd.mnt, nd.dentry);
        set_fs_altroot();
+
+       unlock_kernel();
+
        error = 0;
 dput_and_out:
        path_release(&nd);
--- vanilla-linux-2.6.6/fs/namei.c.saved        2004-05-10 21:37:09.000000000 
+0200
+++ vanilla-linux-2.6.6/fs/namei.c      2004-06-06 19:49:25.000000000 +0200
@@ -814,6 +814,9 @@
        return 1;
 }
+/*
+ * Requires the big lock held.
+ */
 void set_fs_altroot(void)
 {
        char *emul = __emul_prefix();
-- 
Paolo Giarrusso, aka Blaisorblade
Linux registered user n. 292729
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
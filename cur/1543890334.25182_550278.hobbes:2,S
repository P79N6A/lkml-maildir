Date: Tue, 29 May 2007 09:33:37 +0200
From: Tejun Heo <>
Subject: Re: [PATCH] libata: implement ata_wait_after_reset()
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2007/5/29/37

Jeff Garzik wrote:
> Tejun Heo wrote:
>> -    msleep(150);
>> +    /* wait a while before checking status */
>> +    ata_wait_after_reset(ap, deadline);
> [...]
>> -    msleep(150);
>> +    /* wait a while before checking status */
>> +    ata_wait_after_reset(ap, deadline);
>> 
>>      /* Before we perform post reset processing we want to see if
>>       * the bus shows 0xFF because the odd clown forgets the D7
>> @@ -3543,8 +3583,8 @@ int sata_std_hardreset(struct ata_port *
>>          return 0;
>>      }
>> 
>> -    /* wait a while before checking status, see SRST for more info */
>> -    msleep(150);
>> +    /* wait a while before checking status */
>> +    ata_wait_after_reset(ap, deadline);
>> 
>>      rc = ata_wait_ready(ap, deadline);
> [...]
>> -    msleep(150);
>> +    /* wait a while before checking status */
>> +    ata_wait_after_reset(ap, deadline);
>> 
>>      /* Before we perform post reset processing we want to see if
>>       * the bus shows 0xFF because the odd clown forgets the D7
>> Index: work/drivers/ata/sata_inic162x.c
>> ===================================================================
>> --- work.orig/drivers/ata/sata_inic162x.c
>> +++ work/drivers/ata/sata_inic162x.c
>> @@ -446,7 +446,7 @@ static int inic_hardreset(struct ata_por
>>          struct ata_taskfile tf;
>> 
>>          /* wait a while before checking status */
>> -        msleep(150);
>> +        ata_wait_after_reset(ap, deadline);
>> 
>>          rc = ata_wait_ready(ap, deadline);
> [...]
> 
> The main thing that bothers me is not the increase in delay, but the
> fact that this create converts a delay/Status-poll sequence into a
> delay/Status-poll/Status-poll sequence.
> 
> ata_wait_after_reset() immediately before ata_wait_ready() seems highly
> redundant.  Why not just poll Status once?
I was trying to minimize code disturbance around reset such that
ata_wait_after_reset() can be drop-in replacement for msleep(150).  This
was for two reasons 1. as this patch was to fix regression I didn't want
to introduce a lot of change into -rcX and 2. I was lazy.  :-)
As dont-consider-0xff-as-port-empty-if-sstatus-available patch fixes the
regression nicely, I think we can delay this to 2.6.23.  I'll merge
ata_wait_after_reset() into ata_wait_ready() (or the other way around).
Thanks.
-- 
tejun
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
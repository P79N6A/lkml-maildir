Date: Sun, 28 Jul 2002 20:21:09 +0400
From: Stas Sergeev <>
Subject: [patch] vm86: Clear AC on INT
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2002/7/28/130

Hello.
According to this:
http://support.intel.com/design/intarch/techinfo/Pentium/instrefi.htm#89126
AC flag is cleared by an INT
instruction executed in real mode.
The attached patch implements that
functionality and solves some
problems recently discussed in
dosemu mailing list.
--- linux/arch/i386/kernel/vm86.c	Sat Jul 27 13:12:38 2002
+++ linux/arch/i386/kernel/vm86.c	Sat Jul 27 23:56:27 2002
@@ -317,6 +317,11 @@
 	regs->eflags &= ~TF_MASK;
 }
 
+static inline void clear_AC(struct kernel_vm86_regs * regs)
+{
+	regs->eflags &= ~AC_MASK;
+}
+
 /* It is correct to call set_IF(regs) from the set_vflags_*
  * functions. However someone forgot to call clear_IF(regs)
  * in the opposite case.
@@ -471,6 +476,7 @@
 	IP(regs) = segoffs & 0xffff;
 	clear_TF(regs);
 	clear_IF(regs);
+	clear_AC(regs);
 	return;
 
 cannot_handle:
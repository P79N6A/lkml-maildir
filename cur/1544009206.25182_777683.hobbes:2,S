Date: Sat, 6 Dec 2008 14:53:23 +0100
From: "Rafael J. Wysocki" <>
Subject: Re: Regression from 2.6.26: Hibernation (possibly suspend) broken on Toshiba R500 (bisected)
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2008/12/6/67

On Saturday, 6 of December 2008, Rafael J. Wysocki wrote:
> On Saturday, 6 of December 2008, Linus Torvalds wrote:
> > 
> > On Sat, 6 Dec 2008, Rafael J. Wysocki wrote:
> > >
> > > It only affects the legacy handling, but the non-legacy handling was left
> > > untouched.  IOW, the old "default" functions are still there and are being
> > > called by the "non-legacy" code (it's only used by USB at the moment, AFAICS).
> > 
> > Ok.
> > 
> > > Anyway, I did the test doing it only to the devices which don't have any
> > > non-default suspend-resume handling at all and _that_ apparently fixed the
> > > problem on my box. :-)
> > 
> > Which makes sense, btw. Because if you do the pci_save_state() on a device 
> > that _does_ have a suspend function, you'll be saving the post-suspend 
> > state - ie the device turned off.
> > 
> > So yeah, we really can only do the default suspend if the device has no 
> > pre-existing suspend function - or we'd need to make sure that all PCI 
> > drivers that do have suspend functions would only do the higher-level 
> > functionality.
> > 
> > Anyway, what I'm most interested in hearing is whether this actually 
> > improves your situation.
> 
> Yes, it does, from what I can tell at the moment. :-)
OK, this patch alone doesn't fix the problem, ie. I was able to reproduce it
with this patch applied, but it decreases the probability of a failure.
_However_, when I added two more patches to the mix:
- a patch that moved the PCI Express port suspend and resume to functions
  executed with interrupts disabled
- a patch that moves the restoration of the PCI config space in snd_hda_intel
  to a ->resume_early() callback
I'm not able to reproduce the problem any more (I did over 20
hibernation-resume cycles with this combination of patches applied with
occasional suspend-to-RAM-resume cycles in between and there were no problems
resuming).
I'm going to post the three patches in a separate thread for discussion.
Thanks,
Rafael
Date: Thu, 14 Jul 2005 22:38:55 +0200
From: Johannes Stezenbach <>
Subject: Re: [PATCH] i386: Selectable Frequency of the Timer Interrupt
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2005/7/14/203

On Thu, Jul 14, 2005 Linus Torvalds wrote:
> In other words, the _right_ way to do this is literally
> 
> 	unsigned long timeout = jiffies + HZ/2;
> 	for (;;) {
> 		if (ready())
> 			return 0;
> 		if (time_after(timeout, jiffies))
> 			break;
> 		msleep(10);
> 	}
> 
> which is unquestionably more complex, yes, but it's more complex because 
> it is CORRECT!
Since you emphasised on correctness, your code is actually buggy
for the preemptible kernel. It could get preempted after the ready() test,
but before the time_after(), for quite a whie if a high priority process
keeps the system busy. This code is better:
 	unsigned long timeout = jiffies + HZ/2;
	int err;
 	for (;;) {
 		err = time_after(timeout, jiffies);
 		if (ready())
 			return 0;
 		if (err)
 			break;
 		msleep(10);
 	}
This way the condition is always re-tested before reporting timeout.
Johannes
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
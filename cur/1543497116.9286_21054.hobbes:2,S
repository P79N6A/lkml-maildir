Date: Sun, 30 May 1999 07:50:57 -0400 (EDT)
From: Jeff Garzik <>
Subject: [2.3.4.pre2] alpha compile fixes
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/1999/5/30/173

This patch fixes Alpha compile problems on 2.3.4.pre2.  They seem to be
working on my UP Alpha, but I do get two kmem_grow warnings on bootup.
Maybe kmem_grow warning is not Alpha-specific, though.
	Jeff
Patch changelog:
	include/asm-alpha/softirq.h: New macros local_bh_{dis,en}able,
	copied from include/asm-i386/softirq.h
	include/asm-alpha/spinlock.h: New macros {spin,read,write}_{un}lock_bh,
	copied from include/asm-i386/spinlock.h
	include/linux/interrupt.h: Needs ptrace.h for struct pt_regs.
Kernel bootup messages:
...
ncr53c810-0-<3,*>: FAST-10 SCSI 10.0 MB/s (100 ns, offset 8)
SCSI device sda: hdwr sector= 512 bytes. Sectors= 2069860 [1010 MB] [1.0 GB]
ncr53c810-0-<6,*>: FAST-10 SCSI 10.0 MB/s (100 ns, offset 8)
SCSI device sdb: hdwr sector= 512 bytes. Sectors= 4124736 [2014 MB] [2.0 GB]
kmem_grow: Called nonatomically from int - size-256
eth0: DE434/5 at 0x8800 (PCI bus 0, device 11), h/w address 00:00:f8:21:6a:09,
kmem_grow: Called nonatomically from int - size-16384
      and requires IRQ15 (provided by PCI BIOS).
de4x5.c:V0.544 1999/5/8 davies@maniac.ultranet.com
Partition check:
 sda: sda1 sda2 sda3 sda4 sda5
 sdb: sdb1 sdb3
...
diff -u -r -N linux.pre2/include/asm-alpha/softirq.h linux/include/asm-alpha/softirq.h
--- linux.pre2/include/asm-alpha/softirq.h	Sun Dec 27 18:20:32 1998
+++ linux/include/asm-alpha/softirq.h	Sun May 30 06:53:29 1999
@@ -2,12 +2,16 @@
 #define _ALPHA_SOFTIRQ_H
 
 #include <linux/stddef.h>
+#include <linux/interrupt.h>
+#include <linux/smp.h>
 #include <asm/atomic.h>
 #include <asm/hardirq.h>
 
 extern unsigned int local_bh_count[NR_CPUS];
 
 #define get_active_bhs()	(bh_mask & bh_active)
+#define local_bh_disable()      (local_bh_count[smp_processor_id()]++)
+#define local_bh_enable()       (local_bh_count[smp_processor_id()]--)
 
 static inline void clear_active_bhs(unsigned long x)
 {
diff -u -r -N linux.pre2/include/asm-alpha/spinlock.h linux/include/asm-alpha/spinlock.h
--- linux.pre2/include/asm-alpha/spinlock.h	Sun Jan 10 12:59:59 1999
+++ linux/include/asm-alpha/spinlock.h	Sun May 30 06:53:25 1999
@@ -2,6 +2,15 @@
 #define _ALPHA_SPINLOCK_H
 
 #include <asm/system.h>
+#include <asm/softirq.h>
+
+#define spin_lock_bh(lock)                      do { local_bh_disable(); spin_lock(lock); } while (0)
+#define read_lock_bh(lock)                      do { local_bh_disable(); read_lock(lock); } while (0)
+#define write_lock_bh(lock)                     do { local_bh_disable(); write_lock(lock); } while (0)
+#define spin_unlock_bh(lock)                    do { spin_unlock(lock); local_bh_enable();        } while (0)
+#define read_unlock_bh(lock)                    do { read_unlock(lock); local_bh_enable();        } while (0)
+#define write_unlock_bh(lock)                   do { write_unlock(lock); local_bh_enable();        } while (0)
+
 
 #ifndef __SMP__
 
diff -u -r -N linux.pre2/include/linux/interrupt.h linux/include/linux/interrupt.h
--- linux.pre2/include/linux/interrupt.h	Sun May 16 16:18:21 1999
+++ linux/include/linux/interrupt.h	Sun May 30 06:53:29 1999
@@ -3,6 +3,7 @@
 #define _LINUX_INTERRUPT_H
 
 #include <linux/kernel.h>
+#include <linux/ptrace.h>
 #include <asm/bitops.h>
 #include <asm/atomic.h>
 
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.rutgers.edu
Please read the FAQ at 
http://www.tux.org/lkml/
Date: Sun, 04 May 2008 13:39:03 +0300
From: Pekka Enberg <>
Subject: Re: [Patch] fs/binfmt_elf.c: fix a wrong free
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2008/5/4/69

WANG Cong wrote:
> Hi, Pekka!
> 
> Thanks for your comments. Yes, it seems that fill_note_info() is ugly.
> :-) How about the below one?
> 
> Signed-off-by: WANG Cong <wangcong@zeuux.org>
> 
> ---
> diff --git a/fs/binfmt_elf.c b/fs/binfmt_elf.c
> index f6d5a9d..357b503 100644
> --- a/fs/binfmt_elf.c
> +++ b/fs/binfmt_elf.c
> @@ -1900,7 +1900,7 @@ static int elf_core_dump(long signr, struct pt_regs *regs, struct file *file, un
>  	/* alloc memory for large data structures: too large to be on stack */
>  	elf = kmalloc(sizeof(*elf), GFP_KERNEL);
>  	if (!elf)
> -		goto cleanup;
> +		goto ret;
> 
>  	segs = current->mm->map_count;
>  #ifdef ELF_CORE_EXTRA_PHDRS
> @@ -2034,8 +2034,9 @@ end_coredump:
>  	set_fs(fs);
> 
>  cleanup:
> -	kfree(elf);
>  	free_note_info(&info);
> +	kfree(elf);
> +ret:
>  	return has_dumped;
Looks good although 'ret' is usually reserved for the variable that 
contains the return value so you might want to consider using the more 
idiomatic 'out' as the label name.
		Pekka
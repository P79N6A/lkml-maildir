Date: Thu, 15 Aug 2002 09:38:10 +0200 (CEST)
From: Steffen Persvold <>
Subject: [PATCH] Fixup pci_alloc_consistent with 64bit DMA masks on i386
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2002/8/15/104

Hi,
Here's just the patch related to the problem I reported yesterday. It's 
against 2.4.19, but I think it will apply to any of the latest 
2.4.20-pre2 trees.
Let's hope it gets included into the next -pre release.
Regards,
-- 
  Steffen Persvold   | Scalable Linux Systems |   Try out the world's best
 mailto:sp@scali.com |  
http://www.scali.com
  | performing MPI implementation:
Tel: (+47) 2262 8950 |   Olaf Helsets vei 6   |      - ScaMPI 1.13.8 -
Fax: (+47) 2262 8951 |   N0621 Oslo, NORWAY   | >320MBytes/s and <4uS latency
--- linux-2.4.19-old/arch/i386/kernel/pci-dma.c.~1~	Wed Aug 14 15:06:49 2002
+++ linux-2.4.19/arch/i386/kernel/pci-dma.c	Wed Aug 14 15:08:29 2002
@@ -19,7 +19,7 @@
 	void *ret;
 	int gfp = GFP_ATOMIC;
 
-	if (hwdev == NULL || hwdev->dma_mask != 0xffffffff)
+	if (hwdev == NULL || hwdev->dma_mask < 0xffffffff)
 		gfp |= GFP_DMA;
 	ret = (void *)__get_free_pages(gfp, get_order(size));
 
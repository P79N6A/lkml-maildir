Date: Tue, 1 Aug 2006 13:20:28 -0500
From: "Nish Aravamudan" <>
Subject: Re: deprecate and convert some sleep_on variants.
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2006/8/1/284

On 8/1/06, Dave Jones <davej@redhat.com> wrote:
> We've been carrying this for a dogs age in Fedora. It'd be good to get
> this in -mm, so that it stands some chance of getting upstreamed at some point.
>
> Signed-off-by: Arjan van de Ven <arjan@infradead.org>
> Signed-off-by: Dave Jones <davej@redhat.com>
>
> diff -urNp --exclude-from=/home/davej/.exclude linux-1060/drivers/block/DAC960.c linux-1070/drivers/block/DAC960.c
> --- linux-1060/drivers/block/DAC960.c
> +++ linux-1070/drivers/block/DAC960.c
> @@ -6132,6 +6132,9 @@ static boolean DAC960_V2_ExecuteUserComm
>    unsigned long flags;
>    unsigned char Channel, TargetID, LogicalDriveNumber;
>    unsigned short LogicalDeviceNumber;
> +  wait_queue_t __wait;
> +
> +  init_waitqueue_entry(&__wait, current);
>
>    spin_lock_irqsave(&Controller->queue_lock, flags);
>    while ((Command = DAC960_AllocateCommand(Controller)) == NULL)
> @@ -6314,11 +6317,18 @@ static boolean DAC960_V2_ExecuteUserComm
>                                         .SegmentByteCount =
>             CommandMailbox->ControllerInfo.DataTransferSize;
>           DAC960_ExecuteCommand(Command);
> +         add_wait_queue(&Controller->CommandWaitQueue, &__wait);
> +         set_current_state(TASK_UNINTERRUPTIBLE);
Could this use prepare_to_wait()
> +
>           while (Controller->V2.NewControllerInformation->PhysicalScanActive)
>             {
>               DAC960_ExecuteCommand(Command);
> -             sleep_on_timeout(&Controller->CommandWaitQueue, HZ);
> +             schedule_timeout(HZ);
> +             set_current_state(TASK_UNINTERRUPTIBLE);
and schedule_timeout_uninterruptible() (which is redundant for the
first invocation, I suppose)
>             }
> +         current->state = TASK_RUNNING;
> +         remove_wait_queue(&Controller->CommandWaitQueue, &__wait);
and finish_wait()?
Same for ibmtr.c ?
Also, would these changes:
> diff -urNp --exclude-from=/home/davej/.exclude linux-1060/include/linux/wait.h linux-1070/include/linux/wait.h
> --- linux-1060/include/linux/wait.h
> +++ linux-1070/include/linux/wait.h
Be better in a separate patch?
Thanks,
Nish
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
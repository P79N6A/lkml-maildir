Date: Sat, 17 Jan 2009 17:10:44 +0000
From: Russell King - ARM Linux <>
Subject: Re: [PATCH 07/10] omap mailbox: add save_/restore_ctx() for PM
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2009/1/17/104

On Fri, Jan 16, 2009 at 10:27:37AM +0200, Hiroshi DOYU wrote:
> diff --git a/arch/arm/mach-omap2/mailbox.c b/arch/arm/mach-omap2/mailbox.c
> index a877305..544dde9 100644
> --- a/arch/arm/mach-omap2/mailbox.c
> +++ b/arch/arm/mach-omap2/mailbox.c
> @@ -32,6 +32,8 @@
>  #define MAILBOX_IRQ_NEWMSG(u)		(1 << (2 * (u)))
>  #define MAILBOX_IRQ_NOTFULL(u)		(1 << (2 * (u) + 1))
> 
> +#define MBOX_REG_SIZE			0x120
> +
>  static void __iomem *mbox_base;
> 
>  struct omap_mbox2_fifo {
> @@ -47,6 +49,7 @@ struct omap_mbox2_priv {
>  	unsigned long irqstatus;
>  	u32 newmsg_bit;
>  	u32 notfull_bit;
> +	char ctx[MBOX_REG_SIZE];
	u32 ctx[MOX_REG_SIZE / sizeof(u32)];
?
>  };
> 
>  static struct clk *mbox_ick_handle;
> @@ -167,6 +170,36 @@ static int omap2_mbox_is_irq(struct omap_mbox *mbox,
>  	return (enable & status & bit);
>  }
> 
> +static void omap2_mbox_save_ctx(struct omap_mbox *mbox)
> +{
> +	int i;
> +	struct omap_mbox2_priv *p = mbox->priv;
> +
> +	for (i = 0; i < MBOX_REG_SIZE; i += sizeof(u32)) {
> +		u32 val;
> +
> +		val = mbox_read_reg(i);
> +		*(u32 *)(p->ctx + i) = val;
		p->ctx[i] = mbox_read_reg(i);
?
> +
> +		dev_dbg(mbox->dev, "%s\t[%02d] %08x\n", __func__, i, val);
tabs aren't nice in kernel messages.
		dev_dbg(mbox->dev, "%s: [%02d] %08x\n", __func__,
			i, p->ctx[i]);
also, mixing decimal and octal as bare numbers can be rather confusing.
> +	}
> +}
> +
> +static void omap2_mbox_restore_ctx(struct omap_mbox *mbox)
> +{
> +	int i;
> +	struct omap_mbox2_priv *p = mbox->priv;
> +
> +	for (i = 0; i < MBOX_REG_SIZE; i += sizeof(u32)) {
> +		u32 val;
> +
> +		val = *(u32 *)(p->ctx + i);
> +		mbox_write_reg(val, i);
		mbox_write_reg(p->ctx[i], i);
> +
> +		dev_dbg(mbox->dev, "%s\t[%02d] %08x\n", __func__, i, val);
		dev_dbg(mbox->dev, "%s: [%02d] %08x\n@, __func__,
			i, p->ctx[i]);
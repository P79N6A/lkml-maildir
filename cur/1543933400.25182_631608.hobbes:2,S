Date: Mon, 24 Dec 2007 00:23:01 -0700
From: Grant Grundler <>
Subject: Re: [RFC/PATCH 4/4] [POWERPC] pci: Disable IO/Mem on a device when resources can't be allocated
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2007/12/24/10

On Tue, Dec 18, 2007 at 10:01:15AM +1100, Benjamin Herrenschmidt wrote:
> This patch changes the PowerPC PCI code to disable IO and/or Memory
> decoding on a PCI device when a resource of that type failed to be
> allocated. This is done to avoid having unallocated dangling BARs enabled
> that might try to decode on top of other devices.
> 
> If a proper resource is assigned later on, then pci_enable_device{,_io,_mem}
> will take care of re-enabling decoding.
> 
> Signed-off-by: Benjamin Herrenschmidt <benh@kernel.crashing.org>
....
> @@ -1062,8 +1065,12 @@ static void __init pcibios_allocate_reso
>  				disabled = !(command & PCI_COMMAND_IO);
>  			else
>  				disabled = !(command & PCI_COMMAND_MEMORY);
> -			if (pass == disabled)
> -				alloc_resource(dev, idx);
> +			if (pass == disabled && alloc_resource(dev, idx)) {
> +				command &= ~(r->flags & (IORESOURCE_IO |
> +							 IORESOURCE_MEM));
While this may be ok for PPC, in general, wouldn't we want to only disable
which ever type of resource that couldn't be allocated?
ie make two calls: alloc_resource_io() and alloc_resource_mem() and disable
the respective flag if the alloc call fails?
Thus a device which was enable and programmed by BIOS could remain functional
despite one resource not being allocated.
(e.g. MMIO was allocated successfully while IO Port space was not)
Again, this is just a hypothetical question since I have no example (yet)
off hand where this is true. ISTR, the original discussion around
pci_enable_device_bars() suggested some machines already have this issue.
cheers,
grant
> +				pci_write_config_word(dev,
> +						      PCI_COMMAND, command);
> +			}
>  		}
>  		if (pass)
>  			continue;
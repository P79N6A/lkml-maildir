Date: Sat, 02 Oct 2004 17:42:23 +0400
From: Kirill Korotaev <>
Subject: Ugly netdev sysfs errors handling
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2004/10/2/48

Hello,
During debug I faced oops in 
netdev_unregister_sysfs()->sysfs_remove_group(),
since kobj->dentry == NULL.
The problem is that netdev code doesn't handle errors from sysfs 
correctly - it calls netdev_unregister_sysfs() in any case, even if 
netdev_register_sysfs() failed on registering:
void netdev_run_todo(void)
...
                 case NETREG_REGISTERING:
                         err = netdev_register_sysfs(dev);
                         if (err)
                                 printk(KERN_ERR "%s: failed sysfs 
registration (%d)\n",
                                        dev->name, err);
                         dev->reg_state = NETREG_REGISTERED;
                         break;
                 case NETREG_UNREGISTERING:
                         netdev_unregister_sysfs(dev); <<<< OOPS here,
					<<<< if netdev_register_sysfs()
					<<<<< failed
...
I tried to fix it in netdev code, but it's impossible to do it in a 
fashioned manner. Since there are some kobject manipulations in 
destructors (e.g. free_netdev() oopses as well if workaround the above 
code).
Another approach can be to check kobj->dentry and other fields in sysfs.
Maybe someone has any ideas on this? Except for "no errors should 
normally happen" :)
Kirill
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
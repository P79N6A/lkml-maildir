Date: Sun, 17 Oct 2004 12:31:30 +1000
From: Nick Piggin <>
Subject: Re: Hang on x86-64, 2.6.9-rc3-bk4
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2004/10/16/177

Nick Piggin wrote:
> Jeff Garzik wrote:
> 
>>
>> Nope, this patch does not fix the hang.
>>
> 
> Arrgh, sorry that should be
>     if (zone->pages_scanned *>=* blah)
> 
> If you've got zero LRU pages, both sides of this should be zero, and
> we *want* all_unreclaimable to be set.
We'd better do this too, so kswapd can't take the machine down
even if it wants to.
---
 linux-2.6-npiggin/mm/vmscan.c |    4 +++-
 1 files changed, 3 insertions(+), 1 deletion(-)
diff -puN mm/vmscan.c~vm-break-kswapd mm/vmscan.c
--- linux-2.6/mm/vmscan.c~vm-break-kswapd	2004-10-17 12:30:02.000000000 +1000
+++ linux-2.6-npiggin/mm/vmscan.c	2004-10-17 12:30:16.000000000 +1000
@@ -1103,8 +1103,10 @@ out:
 
 		zone->prev_priority = zone->temp_priority;
 	}
-	if (!all_zones_ok)
+	if (!all_zones_ok) {
+		cond_resched();
 		goto loop_again;
+	}
 
 	return total_reclaimed;
 }
_
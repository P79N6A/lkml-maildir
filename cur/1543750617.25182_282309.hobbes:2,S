Date: Sat, 1 Jan 2005 19:46:23 -0800 (PST)
From: Davide Libenzi <>
Subject: Re: ptrace single-stepping change breaks Wine
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2005/1/1/67

On Sat, 1 Jan 2005, Linus Torvalds wrote:
> On Sat, 1 Jan 2005, Davide Libenzi wrote:
> > 
> > I used the test program below on 2.4.27, 2.6.8.1 and latest BK + TF-careful. 
> > In all cases single stepping over POPF succeeded.
> 
> I don't think you realize what the failure case for popf was.
>
> It wasn't that we couldn't single-step it: it was that we corrupted the 
> resulting elfags value after single-stepping it.
I thought you were saying that we cleared TF, and this resulted in ptrace 
losing control over the tracee becasue of the missing flag. But yeah, TF 
reporting has always been broken.
> Try to extend your program to print out not only the EIP after the 
> single-step, but also the value of EFLAGS, and you'll see what I mean. 
> Earlier kernels are _really_ bad at it: they'll always report that TF is 
> set. The "TF-careful" patch gets TF right for normal instructions, and the 
> "TF-popf" patch gets TF right after popf too.
> 
> The one remaining case I know of where we still get TF wrong is "pushf",
> where single-stepping a pushf will not corrupt TF, but it will save the
> wrong value on the stack (which obviously may corrupt TF _later_, when the
> paired "popf" happens).
That would be even trickier than the POPF case. Do you really want to go 
there? Anyway, the TF-careful fixes Wine and single-step-after-syscall, 
and on top of that brings some needed cleanup. It still remain to be 
verfied the strace case, for which I do not have a testcase. Looking at 
how we handle things in TF-careful, it should be fine too.
- Davide
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
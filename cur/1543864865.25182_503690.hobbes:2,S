Date: Wed, 31 Jan 2007 10:54:39 -0500 (EST)
From: Alan Stern <>
Subject: Re: [linux-pm] question on resume()
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2007/1/31/168

On Wed, 31 Jan 2007, Pavel Machek wrote:
> Hi!
> 
> > > Yes, it will.  The process freezer can only return success if there are no more
> > > TASK_UNINTERRUPTIBLE tasks.  Otherwise it fails (after a timeout).
> > 
> > So, this means, on suspend():
> > 
> > 1. Don't worry about TASK_UNINTERRUPTIBLE
> > 2. Do worry about TASK_INTERRUPTIBLE
> > We have to cease IO and must not call wake_up_interruptible()
> 
> "cease IO"? No, I believe it is enough not to start new I/O. Userspace
> is frozen at that point, it can't ask you to do I/O.
There may be I/O requests sitting in a queue, already submitted by
userspace.  The suspend method should wait for existing I/O to complete
and stop processing new entries from the queue.
> > Isn't that a race until suspend() is called?
> 
> I do not think so.
The part about not calling wake_up_interruptible() is indeed a race.  We 
have:
	1. Task is frozen.
	2. Driver must not call wake_up_interruptible().
	3. Driver's suspend() method is called.
How is the driver supposed to satisfy (2) before (3) has occurred?
In fact this shouldn't matter.  There shouldn't be anything wrong with 
calling wake_up_interruptible() on a frozen task.
> > On resume():
> > 
> > 1. Don't worry about TASK_UNINTERRUPTIBLE
> > 2. Do not restart IO that may call wake_up_interruptible()
> > 
> > When do we restart such IO?
> 
> We reuse signal handling code to do that for us. It is same situation
> as when someone signals task doing I/O.
Again you misunderstood the question.  The driver must start queued I/O
when its resume() method is called.  It should then be okay for the driver
to call wake_up_interruptible(), even before tasks are unfrozen.
Alan Stern
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
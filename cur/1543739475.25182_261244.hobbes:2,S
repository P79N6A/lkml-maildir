Date: Sat, 16 Oct 2004 23:47:44 -0400
From: Andrew <>
Subject: [PATCH] kernel-2.6.9.rc4 lib/kobject.c
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2004/10/16/195

There are two conditions where kset_hotplug can exit without the call to 
call_usermodehelper() after incrementing the sequence_number.  This 
patch eliminates the first by getting the kobj_path before the 
sequence_number++. It also reduces the likelihood of the second by 
decrementing the sequence_number (if it can) if the call to 
kset->hotplug_ops->hotplug() fails.
Some user space programs (rightly or wrongly) are expecting there would 
be no "gaps" in hotplug event sequence numbers, and hang waiting for the 
"missing" events.
   Signed-off-by: Andrew Duggan <cmkrnl@speakeasy.net>
--- lib/kobject.c.orig    2004-10-16 20:51:01.450973973 -0400
+++ lib/kobject.c    2004-10-16 21:08:19.961602269 -0400
@@ -177,6 +177,10 @@ static void kset_hotplug(const char *act
    envp [i++] = scratch;
    scratch += sprintf(scratch, "ACTION=%s", action) + 1;
+    kobj_path = kobject_get_path(kset, kobj, GFP_KERNEL);
+    if (!kobj_path)
+        goto exit;
+
    spin_lock(&sequence_lock);
    seq = sequence_num++;
    spin_unlock(&sequence_lock);
@@ -184,10 +188,6 @@ static void kset_hotplug(const char *act
    envp [i++] = scratch;
    scratch += sprintf(scratch, "SEQNUM=%ld", seq) + 1;
-    kobj_path = kobject_get_path(kset, kobj, GFP_KERNEL);
-    if (!kobj_path)
-        goto exit;
-
    envp [i++] = scratch;
    scratch += sprintf (scratch, "DEVPATH=%s", kobj_path) + 1;
@@ -199,6 +199,13 @@ static void kset_hotplug(const char *act
        if (retval) {
            pr_debug ("%s - hotplug() returned %d\n",
                  __FUNCTION__, retval);
+            /* decr sequence_num since no event will happen
+               but only if it is consistent */
+            spin_lock(&sequence_lock);
+            if (sequence_num == seq+1)
+               sequence_num--;
+            spin_unlock(&sequence_lock);
+
            goto exit;
        }
    }
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
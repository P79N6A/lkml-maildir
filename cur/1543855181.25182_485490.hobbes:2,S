Date: Fri, 24 Nov 2006 21:46:37 +0100
From: Ingo Molnar <>
Subject: Re: [patch] x86: unify/rewrite SMP TSC sync code
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2006/11/24/148

* Andi Kleen <ak@suse.de> wrote:
> 
> > yeah - the main new bit for x86-64 is the unconditional check for time 
> > warps. We shouldnt (and cannot) really trust the CPU and the board/BIOS 
> > getting it right. There were always some motherboards using Intel CPUs 
> > that had the TSCs wrong.
> 
> In the 64bit capable generation I don't know of any run in spec 
> (except for multinode systems and there was one overclocked system 
> where the cores got unsync, but overclocking is an operator error)
i have one (Intel based), 64-bit, fully in spec, which is off by 
~3000-4000 cycles. So it happens. But it's a no-brainer thing, this area 
is historically so bad that it would be crazy /not/ to spend this 20 
msecs bootup time per CPU to check whether its TSC is in sync.
I was in fact surprised when i noticed that you removed the 
unconditional TSC check that i put there years ago - with this we 
started a ride into the dark with lights off. If the situation gets 
better in say 2 years and no system ever produces the warning message we 
can remove it. (but i doubt it will ever get 100% correct.) [The patch 
will need some cooking in -mm, because it touches code that is fragile 
to begin with, but it's a necessity i'm quite sure.]
> > > The trouble is that people are using the RDTSC anyways even if the 
> > > kernel doesn't. So some synchronization is probably a good idea.
> > 
> > which apps are using it? It might be safer in terms of app 
> > compatibility if we removed the TSC bit in the case where we know it 
> > doesnt work, and if we turned the feature off in the CPU in this 
> > case. We could also try to 'approximately' sync up the TSC,
> 
> There was a patch from google for trap -- trapping RDTSC for syncing 
> on demand. I'm not sure that was the right strategy though.
but which apps are using RDTSC natively? Trapping isnt too good i agree 
- if then we should remove it from the CPU features and hence apps wont 
(or shouldnt) use it.
> > nor can the TSC really be synced up properly in the hotplug CPU 
> > case, after the fact - what if the app already read out an older TSC 
> > value and a new CPU is added. If the TSC isnt sync on SMP then it 
> > quickly gets pretty messy, and we should rather take a look at /why/ 
> > these apps are using RDTSC.
> 
> Because gettimeofday is too slow.
as i indicated it in another discussion, i can fix that. Next patch will 
be that.
	Ingo
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
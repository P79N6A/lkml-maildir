Date: Sun, 30 Oct 2005 12:12:13 -0800 (PST)
From: Zwane Mwaikambo <>
Subject: Re: [patch 1/5] i386 generic cmpxchg
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2005/10/30/136

Hi Nick,
On Sun, 30 Oct 2005, Nick Piggin wrote:
+#define cmpxchg(ptr,o,n)						\
+({									\
+	__typeof__(*(ptr)) __ret;					\
+	if (likely(boot_cpu_data.x86 > 3))				\
+		__ret = __cmpxchg((ptr), (unsigned long)(o),		\
+					(unsigned long)(n), sizeof(*(ptr))); \
+	else								\
+		__ret = cmpxchg_386((ptr), (unsigned long)(o),		\
+					(unsigned long)(n), sizeof(*(ptr))); \
+	__ret;								\
+})
+#endif
How about something similar to the following to remove the branch on 
optimised kernels?
static inline int __is_i386(void)
{
#ifdef CONFIG_M386
	return boot_cpu_data.x86 == 3;
#else
	return 0
#endif
}
#define cmpxchg(ptr,o,n)                                               \
({                                                                     \
       __typeof__(*(ptr)) __ret;                                       \
       if (likely(!__is_i386()))                              \
               __ret = __cmpxchg((ptr), (unsigned long)(o),            \
                                       (unsigned long)(n), sizeof(*(ptr))); \
       else                                                            \
               __ret = cmpxchg_386((ptr), (unsigned long)(o),          \
                                       (unsigned long)(n), 
sizeof(*(ptr))); \
       __ret;                                                          \
})
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
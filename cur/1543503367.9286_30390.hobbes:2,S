Date: Tue, 20 Jul 1999 16:51:54 +0200
From: Wichert Akkerman <>
Subject: SO_REUSEADDR problem with 2.2.10-ac11?
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/1999/7/20/65

I upgraded my system from 2.2.6 to 2.2.10-ac11 yesterday and noticed
an interesting problem: multiple sockets can now bind to the same
port on the same interface. I noticed this when I suddenly had 10
ircd running and client connections were getting accepted by the wrong
server (ie not the first one). I've been told this also happens with
2.2.10-ac10.
Below is a simple test-program to demonstrate the problem.
Wichert.
#include <sys/socket.h>
#include <stdio.h>
#include <sys/types.h>
#include <netinet/in.h>
#include <arpa/inet.h>
int createsock(int argc, char **argv)
{
        struct sockaddr_in addr,maddr;
        int sock;
        int len = sizeof(maddr);
        int err;
        char *saddr;
        sock = socket(AF_INET, SOCK_STREAM, 0);
        if(sock < 0) perror("socket");
	if(argc < 3) {
		err = 1;
		err = setsockopt(sock, SOL_SOCKET, SO_REUSEADDR, &err, sizeof(err));
		if (err) perror("setsockopt");
	}	
        inet_aton((argc > 1) ? argv[1] : "127.0.0.1" , &addr.sin_addr);
        addr.sin_port = htons(9001);
        addr.sin_family = AF_INET;
        err = bind(sock, &addr, sizeof(addr));
        if(err) perror("bind"), exit(1);
	err = listen(sock, 10);
	if(err) perror("listen"), exit(1);
	return 0;
}
main(int argc, char **argv)
{
  createsock(argc, argv);
  createsock(argc,argv);
}
[unhandled content-type:application/pgp-signature]
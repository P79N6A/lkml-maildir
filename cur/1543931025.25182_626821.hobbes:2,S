Date: Tue, 11 Dec 2007 21:40:30 -0500
From: Trond Myklebust <>
Subject: Re: [PATCH 1/1] fix 2.6.24-rc1 nfs_file_mmap change for NOMMU
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2007/12/11/383

On Sun, 2007-12-09 at 19:52 +0100, Berkhan, Enrik (GE Infra, Oil & Gas)
wrote:
> - generic_file_mmap returns -ENOSYS for NOMMU systems; replicate this
>   behaviour
> 
> Signed-off-by: Enrik Berkhan <Enrik.Berkhan@ge.com>
> ---
>  fs/nfs/file.c |    4 ++++
>  1 files changed, 4 insertions(+)
> 
> Index: fs/nfs/file.c
> ===================================================================
> --- fs/nfs/file.c.orig	2007-12-05 09:48:59.000000000 +0100
> +++ fs/nfs/file.c	2007-12-05 09:49:56.000000000 +0100
> @@ -283,7 +283,11 @@ nfs_file_mmap(struct file * file, struct
>  	if (!status) {
>  		vma->vm_ops = &nfs_file_vm_ops;
>  		vma->vm_flags |= VM_CAN_NONLINEAR;
> +#ifdef CONFIG_MMU
>  		file_accessed(file);
> +#else
> +		return -ENOSYS;
> +#endif
>  	}
>  	return status;
>  }
Why do that after going through the process of revalidating the inode
etc.? Just replace nfs_file_mmap() with a function returning ENOSYS in
the case of CONFIG_MMU.
Better still, in the case of CONFIG_MMU, instead of having an
nfs_file_mmap(), just replace the .mmap field in nfs_file_operations
with a call to generic_file_mmap().
Trond
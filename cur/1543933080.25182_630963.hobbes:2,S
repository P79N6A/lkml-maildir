Date: Fri, 21 Dec 2007 13:14:42 +0100
From: Jens Axboe <>
Subject: Re: [PATCH - SH/Dreamcast] Add support for GD-Rom device
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2007/12/21/85

On Fri, Dec 21 2007, Adrian McMenamin wrote:
> On 20/12/2007, Adrian McMenamin <lkmladrian@gmail.com> wrote:
> > This patch adds support for the CD Rom device (called a "GD Rom") on
> > the SEGA Dreamcast.This device has a command block similar to a
> > standard ATA-3 device, though implements Sega's proprietary packet
> > interface - the so-called "Sega Packet Interface".
> >
> 
> Fairly typically, I noticed I had chopped the final line from the
> patch as soon as I had sent it.
> 
> I've also fixed a small difference in the Kconfig
You should properly protect gdrom_deferred, the locking is not clear
there. In gdrom_readdisk_dma() I would do:
static void gdrom_readdisk_dma(struct work_struct *work)
{
        ...
        read_command = kzalloc(sizeof(struct packet_command), GFP_KERNEL);
        if (!read_command)
                probably just defer the work to some time later
        spin_lock(&gdrom_lock);
        while (!list_empty(&gdrom_deferred)) {
                req = list_entry(gdrom_deferred.next, struct request, queuelist);
                list_del_init(&req->queuelist);
                spin_unlock(&gdrom_lock);
                ...
                spin_lock(&gdrom_lock);
        };
        kfree(read_command);
}
That's a lot more obvious imho and doesn't suffer from potential races
or list reordering. Your read_command allocation and free for every
command also seems pretty pointless, so move that outside the loop.
What is pages doing in gdrom_request()?
Your design is also heavily geared towards there just being a single
CDROM, I'm assuming this wont be a problem given your hw (it sets a bad
example for others to follow though, lots of violations against normal
programming practice for multiple devices and smp).
-- 
Jens Axboe
Date: Fri, 20 Feb 2004 17:13:37 +0100
From: Andi Kleen <>
Subject: Re: Intel x86-64 support patch breaks amd64
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2004/2/19/201

On Thu, 19 Feb 2004 10:34:49 -0800
Tony Lindgren <tony@atomide.com> wrote:
> I guess you probably already know about this, but the recent changeset
> 1.1561.1.1 breaks compiling and booting for amd64.
You need the appended patch to build on Uni Processor again. I already
submitted it to Linus, but he doesn't seem to have merged it yet
(or alternatively compile for SMP) 
> After #if 0 out some parts to make it compile, it fails to boot with no
> output at all. Sorry, don't have low level debugging or serial console on 
> this machine configured, let me know if you need further information.
It works for me with this patch both UP and SMP. Maybe you commented out 
too much? 
-Andi
diff -u linux-2.6.3/arch/x86_64/kernel/setup.c-o linux-2.6.3/arch/x86_64/kernel/setup.c
--- linux-2.6.3/arch/x86_64/kernel/setup.c-o	2004-02-19 09:01:09.000000000 +0100
+++ linux-2.6.3/arch/x86_64/kernel/setup.c	2004-02-19 09:09:27.000000000 +0100
@@ -588,6 +588,7 @@
 
 static void __init detect_ht(void)
 {
+#ifdef CONFIG_SMP
 	extern	int phys_proc_id[NR_CPUS];
 	
 	u32 	eax, ebx, ecx, edx;
@@ -631,6 +632,7 @@
 		printk(KERN_INFO  "CPU: Physical Processor ID: %d\n",
 		       phys_proc_id[cpu]);
 	}
+#endif
 }
 	
 #define LVL_1_INST	1
diff -u linux-2.6.3/arch/x86_64/kernel/Makefile-o linux-2.6.3/arch/x86_64/kernel/Makefile
--- linux-2.6.3/arch/x86_64/kernel/Makefile-o	2004-02-19 09:01:09.000000000 +0100
+++ linux-2.6.3/arch/x86_64/kernel/Makefile	2004-02-19 09:15:41.000000000 +0100
@@ -33,4 +33,4 @@
 cpuid-$(subst m,y,$(CONFIG_X86_CPUID))  += ../../i386/kernel/cpuid.o
 topology-y                     += ../../i386/mach-default/topology.o
 swiotlb-$(CONFIG_SWIOTLB)      += ../../ia64/lib/swiotlb.o
-microcode-$(CONFIG_MICROCODE)  += ../../i386/kernel/microcode.o
+microcode-$(subst m,y,$(CONFIG_X86_CPUID))  += ../../i386/kernel/microcode.o
diff -u linux-2.6.3/arch/x86_64/kernel/x8664_ksyms.c-o linux-2.6.3/arch/x86_64/kernel/x8664_ksyms.c
--- linux-2.6.3/arch/x86_64/kernel/x8664_ksyms.c-o	2004-02-19 09:01:09.000000000 +0100
+++ linux-2.6.3/arch/x86_64/kernel/x8664_ksyms.c	2004-02-19 09:08:04.000000000 +0100
@@ -194,7 +194,9 @@
 
 EXPORT_SYMBOL(die_chain);
 
+#ifdef CONFIG_SMP_
 EXPORT_SYMBOL(cpu_sibling_map);
+#endif
 
 extern void do_softirq_thunk(void);
 EXPORT_SYMBOL_NOVERS(do_softirq_thunk);
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
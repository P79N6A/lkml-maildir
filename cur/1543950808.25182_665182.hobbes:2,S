Date: Sat, 8 Mar 2008 02:16:07 +0100 (CET)
From: Jesper Juhl <>
Subject: [PATCH] Fix small mem leak in IBM Hot Plug Controller Driver
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2008/3/7/381

In drivers/pci/hotplug/ibmphp_ebda.c::ebda_rsrc_controller(), storage is 
allocated with kzalloc() and assigned to 'tmp_slot'.
Then lots of stuff, like ->flag, ->supported_speed etc is set in tmp_slot. 
A bit further down there's then this test : 
  if (!bus_info_ptr1) {
    rc = -ENODEV;
    goto error;
  }
At this point, tmp_slot has not been assigned to anything, so when 
erroring-out we want to free it, but nothing at the 'error:' label free's 
'tmp_slot' - and we can't really free 'tmp_slot' at 'error:' since we may 
jump to that label later when 'tmp_slot' *has* been used and we do not 
want it freed. So, the only sane option left seems to be to 
kfree(tmp_slot) just before jumping to the 'error:' label in the one place 
where this is what actually makes sense. The following patch does just 
that and thus kills off a tiny potential memory leak.
Signed-off-by: Jesper Juhl <jesper.juhl@gmail.com>
---
 ibmphp_ebda.c |    1 +
 1 file changed, 1 insertion(+)
diff --git a/drivers/pci/hotplug/ibmphp_ebda.c b/drivers/pci/hotplug/ibmphp_ebda.c
index 600ed7b..bbccde9 100644
--- a/drivers/pci/hotplug/ibmphp_ebda.c
+++ b/drivers/pci/hotplug/ibmphp_ebda.c
@@ -963,6 +963,7 @@ static int __init ebda_rsrc_controller (void)
 
 			bus_info_ptr1 = ibmphp_find_same_bus_num (hpc_ptr->slots[index].slot_bus_num);
 			if (!bus_info_ptr1) {
+				kfree(tmp_slot);
 				rc = -ENODEV;
 				goto error;
 			}
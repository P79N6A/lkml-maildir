Date: Sat, 23 Oct 2004 22:58:16 -0400
From: Brian Gerst <>
Subject: [PATCH] mem leak in tty_io.c
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2004/10/23/301

The recent patch to clean up user accesses introduced a memory leak.  If 
write_buf is reallocated, the old buffer isn't freed.  Also, since kfree 
can take nulls, I removed the if from the other kfree.
--
				Brian Gerst
diff -urN linux-2.6.9-bk/drivers/char/tty_io.c linux/drivers/char/tty_io.c
--- linux-2.6.9-bk/drivers/char/tty_io.c	2004-10-22 09:53:21.373263820 -0400
+++ linux/drivers/char/tty_io.c	2004-10-22 10:36:10.753679871 -0400
@@ -168,8 +168,7 @@
 
 static inline void free_tty_struct(struct tty_struct *tty)
 {
-	if (tty->write_buf)
-		kfree(tty->write_buf);
+	kfree(tty->write_buf);
 	kfree(tty);
 }
 
@@ -1060,6 +1059,7 @@
 			up(&tty->atomic_write);
 			return -ENOMEM;
 		}
+		kfree(tty->write_buf);
 		tty->write_cnt = chunk;
 		tty->write_buf = buf;
 	}
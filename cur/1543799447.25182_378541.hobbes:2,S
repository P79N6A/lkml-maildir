Date: Thu, 22 Dec 2005 18:04:49 +0300
From: Vitaly Wool <>
Subject: [PATCH 2.6-git] SPI: add set_clock() to bitbang
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2005/12/22/130

Hi David,
inlined is the small patch that adds set_clock function to the spi_bitbang structure.
Currently SPI bus clock can be configured either in chipselect() (which is _wrong_) or in txrx_buf (also doesn't encourage me much). Making it a separate function adds readability for the code.
Also, it seems to be redundant to set clock on each transfer, so it's proposed to do per-message clock setting. If SPI bus clock setting involves some PLL reconfiguration it's definitely gonna save some time.
Vitaly
Signed-off-by: Vitaly Wool <vwool@ru.mvista.com>
 drivers/spi/spi_bitbang.c       |    3 +++
 include/linux/spi/spi_bitbang.h |    1 +
 2 files changed, 4 insertions(+)
Index: linux-2.6.orig/drivers/spi/spi_bitbang.c
===================================================================
--- linux-2.6.orig.orig/drivers/spi/spi_bitbang.c
+++ linux-2.6.orig/drivers/spi/spi_bitbang.c
@@ -263,6 +263,9 @@ nsecs = 100;
 		chipselect = 0;
 		status = 0;
 
+		if (bitbang->set_clock)
+			bitbang->set_clock(spi);
+
 		for (;;t++) {
 			if (bitbang->shutdown) {
 				status = -ESHUTDOWN;
Index: linux-2.6.orig/include/linux/spi/spi_bitbang.h
===================================================================
--- linux-2.6.orig.orig/include/linux/spi/spi_bitbang.h
+++ linux-2.6.orig/include/linux/spi/spi_bitbang.h
@@ -31,6 +31,7 @@ struct spi_bitbang {
 	struct spi_master	*master;
 
 	void	(*chipselect)(struct spi_device *spi, int is_on);
+	void	(*set_clock)(struct spi_device *spi);
 
 	int	(*txrx_bufs)(struct spi_device *spi, struct spi_transfer *t);
 	u32	(*txrx_word[4])(struct spi_device *spi,
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
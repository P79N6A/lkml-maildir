Date: Fri, 6 Jul 2007 21:16:40 +0200 (CEST)
From: "Indan Zupancic" <>
Subject: Re: understanding firmware loader for speedtouch (kernel 2.6.21.5)
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2007/7/6/293

On Fri, July 6, 2007 16:20, Duncan Sands wrote:
> On Friday 6 July 2007 14:54:18 mikie wrote:
>> Hi,
>>
>> I experience some problems with the speedtch.c module, especially in
>> regards to its firmware loader.
>> I am not quite sure if this module is going to load the firmware
>> itself or does it use some external software to do that ?
>
> It loads it itself, using some external software!
For information, it generates a hotplug event and the kernel calls the
program written at /proc/sys/kernel/hotplug with certain information.
That used to be /sbin/hotplug, became later udev, but today in general
udev reads the uevents generated by the kernel.
>> I have read and checked the firmware.agent script from some hotplug
>> package, and noticed that it makes something like simple file copy of
>> the firmware to the "data" and echoing 1 or 0 to the "loading" file.
>> But what is the location of these data/loading ? Also the firmware is
>> split into 2 parts -- should I upload them one after another? Is that
>> all that should be done to get the firmware loaded?
>
> You need to write the file that was asked for: the modem starts by asking
> for the first file, uploads it, then asks for the second file and uploads it.
> The file is written to the "data" file, but note that the data file is created
> on the fly when the modem requests a firmware load so you can't write to it
> at some random time.
If you really don't want to use udevd, you could use the below script I wrote
(not really tested, it's an bash version of the Udev rules I've have, more or less.)
Echo the script pathname to /proc/sys/kernel/hotplug early at bootup and all
should work, assuming your pppd is setup correctly and the script isn't buggy.
#!/bin/sh
set -e
p()
{
	# For debugging/logging, edit for your needs.
	echo "$*"
	echo "$*" > /dev/vc/1;
	echo "$*" >> /tmp/bla;
}
if [ "$SUBSYSTEM" = "firmware" ]; then
	p "Loading firmware..."
	cd /sys/$DEVPATH
	if [ -f "/lib/firmware/$FIRMWARE" ]; then
		echo 1 > loading
		cat "/lib/firmware/$FIRMWARE" > data
		echo 0 > loading
		p "Done."
	else
		echo -1 > loading
		p "$FIRMWARE not found."
	fi
elif [ "$SUBSYSTEM" = "atm" ]; then
	if [[ "$KERNEL" != speedtch* ]]; then
		exit
	fi
	if [ "$ACTION" = "add" ]; then
		p "Starting pppd."
		pppd call adsl
	elif [ "$ACTION" = "remove" ]; then
		p "Stopping pppd."
		pkill pppd
	fi
fi
Greetings,
Indan
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
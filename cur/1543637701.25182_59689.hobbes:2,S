Date: Sun, 28 Jul 2002 17:17:50 +0300
From: Muli Ben-Yehuda <>
Subject: [PATCH] add num_possible_cpus() to fix 2.5.29 apm.c compilation
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2002/7/28/96

This patch fixes the apm.c breakage in 2.5.29 by providing definitions
for num_possible_cpus() for UP and SMP. There were several patches
posted to fix it, but I think this is what the author intended. Rusty?
Patch against latest bitkeeper, compiles fine on UP and SMP. Don't
have an SMP machine to test it own. 
# This is a BitKeeper generated patch for the following project:
# Project Name: Linux kernel tree
# This patch format is intended for GNU patch command version 2.5 or higher.
# This patch includes the following deltas:
#	           ChangeSet	1.477   -> 1.478  
#	include/asm-i386/smp.h	1.11    -> 1.12   
#	arch/i386/kernel/apm.c	1.34    -> 1.35   
#	 include/linux/smp.h	1.12    -> 1.13   
#
# The following is the BitKeeper ChangeSet Log
# --------------------------------------------
# 02/07/28	mulix@alhambra.merseine.nu	1.478
# fix compilation failure in apm.c due to missing num_possible_cpus()
# --------------------------------------------
#
diff -Nru a/arch/i386/kernel/apm.c b/arch/i386/kernel/apm.c
--- a/arch/i386/kernel/apm.c	Sun Jul 28 17:07:57 2002
+++ b/arch/i386/kernel/apm.c	Sun Jul 28 17:07:57 2002
@@ -214,6 +214,7 @@
 #include <linux/sched.h>
 #include <linux/pm.h>
 #include <linux/kernel.h>
+#include <linux/smp.h>
 #include <linux/smp_lock.h>
 
 #include <asm/system.h>
diff -Nru a/include/asm-i386/smp.h b/include/asm-i386/smp.h
--- a/include/asm-i386/smp.h	Sun Jul 28 17:07:57 2002
+++ b/include/asm-i386/smp.h	Sun Jul 28 17:07:57 2002
@@ -93,6 +93,11 @@
 	return hweight32(cpu_online_map);
 }
 
+extern inline unsigned int num_possible_cpus(void)
+{
+	return hweight32(phys_cpu_present_map);
+}
+
 extern inline int any_online_cpu(unsigned int mask)
 {
 	if (mask & cpu_online_map)
diff -Nru a/include/linux/smp.h b/include/linux/smp.h
--- a/include/linux/smp.h	Sun Jul 28 17:07:57 2002
+++ b/include/linux/smp.h	Sun Jul 28 17:07:57 2002
@@ -96,6 +96,7 @@
 #define cpu_online_map				1
 #define cpu_online(cpu)				({ cpu; 1; })
 #define num_online_cpus()			1
+#define num_possible_cpus()                     1
 #define __per_cpu_data
 #define per_cpu(var, cpu)			var
 #define this_cpu(var)				var
-- 
http://vipe.technion.ac.il/~mulix/
http://syscalltrack.sf.net/
[unhandled content-type:application/pgp-signature]
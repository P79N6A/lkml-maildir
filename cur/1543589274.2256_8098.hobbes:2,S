Date: Sat, 28 Apr 2001 22:09:40 -0400 (EDT)
From: Alexander Viro <>
Subject: [PATCH] prune_icache() fix
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2001/4/28/100

	Look and enjoy. If prune_icache() doesn't shoot its goal, it
tries to sync some dirty inodes and look for freeable ones one more
time. The sad thing being, counter is not reset on the second pass.
I.e. you end up with nr_unused decremented by 2 * freed_at_the_first_pass +
freed_at_the_second_pass.
	Result: underestimated nr_unused. Since that's what we use for
determining the pressure on icache...
	Seeing negative number in /proc/sys/fs/inode-nr is... well, an
interesting experience.
	Please, apply the patch below.
								Al
PS: _Ouch_. 6 hours of hunting for this one.
diff -urN S4/fs/inode.c S4-prune_icache/fs/inode.c
--- S4/fs/inode.c	Sat Apr 28 02:12:56 2001
+++ S4-prune_icache/fs/inode.c	Sat Apr 28 21:37:25 2001
@@ -612,12 +612,13 @@
 {
 	LIST_HEAD(list);
 	struct list_head *entry, *freeable = &list;
-	int count = 0, synced = 0;
+	int count, synced = 0;
 	struct inode * inode;
 
 	spin_lock(&inode_lock);
 
 free_unused:
+	count = 0;
 	entry = inode_unused.prev;
 	while (entry != &inode_unused)
 	{
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
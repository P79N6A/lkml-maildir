Date: Tue, 10 May 2005 10:43:47 +0800
From: KC <>
Subject: Re: proc_mknod() replacement
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2005/5/9/198

Hi
> >
> > For regular file, I do agree with you.  But for device node, I don't see
> > anything wrong by create it directly from kernel space.
> > In fact, I do not understand why proc_mknod() is removed from
> > 2.6.x ... I will be happy if someone can tell me why.
> 
> Because naming of devices is a policy that shouldn't be defined in the
> kernel.
Mmm ... generally speaking, I agree with that ... but IMHO, the better way
should be ... kernel or driver writer should provide default policy and
allow user space to overwrite the default ... so once the module is loaded,
it's ready to use ... without extra deamon's help. 
For example, in ovi-dev, I scan the PCI bus and if the device is found,
create device entries as
/proc/ovi/vendor_name/device_name-x.y where
vendor_name and device_name is defined by driver writer.
x is board ID which is determine by PCI scan.
y is sub device ID (similar to minor number) which is defined by
   driver writer too.
This approach may not good for general hardware such as tty, hard disk ... but
is useful for DAQ system.
By using this trick, I can provide a general deivce interface (APIs) such as
ovi_dev_open(vendor_name, device_name, boardID, subID, flags)
ovi_dev_write[b,w,l](dev, base, offset, value)
ovi_dev_read[b,w,l](dev, base,offset, *value)
ovi_dev_close(dev)
And if your ISA/PCI/cPCI/PXI device only use I/O and memory access, you can
have your driver done in ~ 5 min (maybe less) without any deamon's help ...
Just load the driver and use the API to access the devices.
> >
> > Why I want to use proc_mknod() in driver ?  I write a small package, ovi-dev,
> > which can be downloaded from
> > 
http://www.sourceforge.net/projects/ovi
> > The ovi-dev will scan the PCI bus and if it found, eg, 3 PCI devices, it
> > will create 3 device entries (nodes) automatically at module load time.
> > So number of device entries (nodes) will match number of devices
> > of the system ... well, UNIX/Linux doesn't work that way ... there are a lot
> > of device entries ... but no corresponding hardware existed.
> 
> You must have not have converted to udev, it's sort of like devfs in that
> device nodes are created dynamicly but it's a userspace daemon that
> adds/removes device nodes in response to hotplug events generated by the kernel.
> >
> > The proc_mknod() can fix the problems ... but it was removed from 2.6.x ...
> > too bad ... at least for me.   So I'm looking for an alternative way to create
> > device entry under /dev from drivers instead of /proc ... but still don't know
> > how.   Anyone know how to do that ?  It should be done at module_init()
> > and the entry should be removed at module_exit().
> 
> I believe if you use the driver core class stuff (i.e.
> class_simple_device_add) it should add device nodes in sysfs and generate
> hotplug events for udev.
Thanks, I will check that.
Regards
KC
kccheng@LinuxDAQ-Labs.org
> 
> Jim.
>
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
Date: Fri, 4 Apr 2008 11:50:06 +1000
From: David Chinner <>
Subject: Re: xfs_io "BUG: lock held when returning to user space!" on suspend
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2008/4/3/479

On Thu, Apr 03, 2008 at 03:53:14PM +0200, Peter Zijlstra wrote:
> On Thu, 2008-04-03 at 07:57 +1000, David Chinner wrote:
> > On Wed, Apr 02, 2008 at 11:58:54AM -0700, Jeremy Fitzhardinge wrote:
> > > I'm getting this:
> > > 
> > > ================================================
> > > [ BUG: lock held when returning to user space! ]
> > > ------------------------------------------------
> > > xfs_io/18796 is leaving the kernel with locks still held!
> > > 1 lock held by xfs_io/18796:
> > > #0:  (&type->s_umount_key#19){----}, at: [<c048c9ac>] get_super+0x42/0x87
> > > 
> > > when I suspend, possibly during an xfs-freeze.  There don't seem to be any 
> > > ill-effects.
> > 
> > Yup, both the sb->s_umount and bdev->bd_mount_sem seaphores are held
> > across freeze_bdev()/thaw_bdev(), and they are issued via separate
> > ioctls generally from separate processes. Not great design, but not
> > a bug....
> 
> Actually... we do consider that bugs.
Ok, you're welcome to fix it then. It's way below my care factor
right now....
FWIW, I did suggest that this needed fixing before FIFREEZE/FITHAW
are introduced, but that hasn't happened yet.
Cheers,
Dave.
-- 
Dave Chinner
Principal Engineer
SGI Australian Software Group
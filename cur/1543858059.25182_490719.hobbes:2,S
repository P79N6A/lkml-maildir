Date: Tue, 12 Dec 2006 12:10:28 +0100
From: Ingo Molnar <>
Subject: [patch] lockdep: fix seqlock_init()
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2006/12/12/72

Subject: [patch] lockdep: fix seqlock_init()
From: Ingo Molnar <mingo@elte.hu>
seqlock_init() needs to use spin_lock_init() for dynamic locks, so that 
lockdep is notified about the presence of a new lock.
(this is a fallout of the recent networking merge, which started using 
the so-far unused seqlock_init() API.)
This fix solves the following lockdep-internal warning on current -git:
 INFO: trying to register non-static key.
 the code is fine but needs lockdep annotation.
 turning off the locking correctness validator.
  [<c0104fd9>] dump_trace+0x63/0x1e8
  [<c0105177>] show_trace_log_lvl+0x19/0x2e
  [<c010557e>] show_trace+0x12/0x14
  [<c0105594>] dump_stack+0x14/0x16
  [<c0142992>] __lock_acquire+0x10c/0x9f9
  [<c0143564>] lock_acquire+0x56/0x72
  [<c03c514f>] _spin_lock+0x35/0x42
  [<c0369875>] neigh_destroy+0x9d/0x12e
  [<c036a1d5>] neigh_periodic_timer+0x10a/0x15c
  [<c01302a5>] run_timer_softirq+0x126/0x18e
  [<c012c530>] __do_softirq+0x6b/0xe6
  [<c0106404>] do_softirq+0x64/0xd2
  [<c012c249>] ksoftirqd+0x82/0x138
  [<c01398f1>] kthread+0xb2/0xd7
  [<c0104c1b>] kernel_thread_helper+0x7/0x10
Signed-off-by: Ingo Molnar <mingo@elte.hu>
---
 include/linux/seqlock.h |    7 +++++--
 1 file changed, 5 insertions(+), 2 deletions(-)
Index: linux-hres-timers.q/include/linux/seqlock.h
===================================================================
--- linux-hres-timers.q.orig/include/linux/seqlock.h
+++ linux-hres-timers.q/include/linux/seqlock.h
@@ -44,8 +44,11 @@ typedef struct {
 #define SEQLOCK_UNLOCKED \
 		 __SEQLOCK_UNLOCKED(old_style_seqlock_init)
 
-#define seqlock_init(x) \
-		do { *(x) = (seqlock_t) __SEQLOCK_UNLOCKED(x); } while (0)
+#define seqlock_init(x)					\
+	do {						\
+		(x)->sequence = 0;			\
+		spin_lock_init(&(x)->lock);		\
+	} while (0)
 
 #define DEFINE_SEQLOCK(x) \
 		seqlock_t x = __SEQLOCK_UNLOCKED(x)
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
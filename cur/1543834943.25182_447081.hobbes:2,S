Date: Thu, 27 Jul 2006 00:24:32 -0700
From: Andrew Morton <>
Subject: Re: [BUG?] possible recursive locking detected
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2006/7/27/32

On Thu, 27 Jul 2006 16:51:29 +1000
Nick Piggin <nickpiggin@yahoo.com.au> wrote:
> > We hold the ext2 directory mutex, and ntfs_put_inode is trying to take an
> > ntfs i_mutex.  Not a deadlock as such, but it could become one in ntfs if
> > ntfs ever does a __GFP_WAIT allocation inside i_mutex, which it surely
> > does.
> 
> Though it should be using GFP_NOFS, right? So the dcache shrinker would
> not reenter the fs in that case.
Sort-of, arguably.  Many years ago, holding i_mutex (i_sem) was considered
to be "in the fs" and one should use GFP_NOFS.
(This code dates from the ext2 directory-in-pagecache conversion - it's
2.4 stuff.)
It's better, of course, to use GFP_HIGHUSER for pagecache so we should aim
to get this working.  And that means don't-take-i_mutex-on-the-reclaim-path.
We quite possibly are doing that in other places, too.
> I'm surprised ext2 is allocating with __GFP_FS set, though. Would that
> cause any problem?
It might, if ext2 takes i_mutex on the reclaim path.  But it doesn't.
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
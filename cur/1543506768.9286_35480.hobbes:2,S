Date: Mon, 23 Aug 1999 22:55:11 -0700
From: Richard Henderson <>
Subject: removing pipe bkl
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/1999/8/24/10

This started off as just a small tweek to let pipes use the entire page
of memory allocated to them (on 8k machines).  I was horrified to discover
that pipe_read and pipe_write still held the Big Kernel Lock.
So, instead of the rather broken ancient PIPE_LOCK thing, we now use
the inode semaphore to protect all of the pipe data.  The ring buffer
has been adjusted to use a full page of memory.  Note that this does
not change the value of PIPE_BUF -- all that value does is make 
atomicity guarantees.
One thing that warrents study by other eyes is the removal of the
PIPE_{RD,WR}_OPENERS code from fifo.c.  For the life of me I could 
not figure out what assurance that provided over the PIPE_READERS
and PIPE_WRITERS flags alone.  Based on the PIPE_LOCK code, I'm
quite willing to believe that PIPE_RD_OPENERS merely papered over
other locking issues, and by properly mutexing the pipe data we
will not see whatever losage prompted that code.
This has been tested via a kernel make -j6 on UP only -- I'd have
to go up to the office to try SMP, which I don't feel like doing
this evening.  Nor have I yet bothered to collect performance data.
r~
[unhandled content-type:application/x-gunzip]
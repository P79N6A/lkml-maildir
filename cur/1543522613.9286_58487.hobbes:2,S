Date: Wed, 19 Jan 2000 06:04:37 +0000 (UTC)
From: Adam Fritzler <>
Subject: [patch] Proper MCA detection for AHA-1640
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2000/1/19/76

Patch attached lets the aha1542 driver detect the compatible MCA version
(the AHA-1640) using the proper MCA bus routines.  
This is mainly a cosmetic change, as the AHA-1640 works just fine without
it.  However, the benefits come in when the adapter is located at odd
addresses (normal driver only probes two of the possible six).  On MCA
these will get detected properly, where without the patch you would need
to specify the parametes.  In that regard, it may be slightly safer, but I
doubt it.  The ISA autoprobe still happens (a behavior that must remain in
order to support machines with both MCA and ISA).  
You also need this patch to get your 1640 to be listed in /proc/mca :)
Works on my PS/2 Model 80.  It only adds stuff thats wrapped in CONFIG_MCA
checks, so shouldn't affect you ISA users at all.
af
---
  Adam Fritzler
  { mid@auk.cx, afritz@iname.com}
    
http://www.auk.cx/~mid/
--- 2.3.39.clean/drivers/scsi/aha1542.c	Thu Dec 30 01:00:54 1999
+++ 2.3.39/drivers/scsi/aha1542.c	Wed Jan 19 05:47:07 2000
@@ -21,6 +21,8 @@
  *  Modified by Chris Faulhaber <jedgar@fxp.org>
  *        Added module command-line options
  *        19-Jul-99
+ *  Modified by Adam Fritzler <mid@auk.cx>
+ *        Added proper detection of the AHA-1640 (MCA version of AHA-1540)
  */
 
 #include <linux/module.h>
@@ -40,6 +42,9 @@
 #include <asm/system.h>
 #include <asm/io.h>
 #include <linux/blk.h>
+#ifdef CONFIG_MCA
+#include <linux/mca.h>
+#endif
 #include "scsi.h"
 #include "hosts.h"
 
@@ -96,7 +101,7 @@
 #define MAXBOARDS 4		/* Increase this and the sizes of the
 				   arrays below, if you need more.. */
 
-/* Boards 3,4 slots are reserved for ISAPnP scans */
+/* Boards 3,4 slots are reserved for ISAPnP/MCA scans */
 
 static unsigned int bases[MAXBOARDS] = {0x330, 0x334, 0, 0};
 
@@ -1043,6 +1048,69 @@
 		setup_dmaspeed[0] = atbt;
 	}
 #endif
+
+	/*
+	 *	Find MicroChannel cards (AHA1640)
+	 */
+#ifdef CONFIG_MCA
+	if(MCA_bus) {
+		int slot = 0;
+		int pos = 0;
+
+		for (indx = 0; (slot !=  MCA_NOTFOUND) && 
+			     (indx < sizeof(bases)/sizeof(bases[0])); indx++) {
+
+			if (bases[indx])
+				continue;
+
+			/* Detect only AHA-1640 cards -- MCA ID 0F1F */
+			slot = mca_find_unused_adapter(0x0f1f, slot);
+			if (slot == MCA_NOTFOUND)
+				break;
+
+			
+			/* Found one */
+			pos = mca_read_stored_pos(slot, 3);
+			
+			/* Decode address */
+			if (pos & 0x80) {
+				if (pos & 0x02) {
+					if (pos & 0x01)
+						bases[indx] = 0x334;
+					else
+						bases[indx] = 0x234;
+				} else {
+					if (pos & 0x01)
+						bases[indx] = 0x134;
+				}
+			} else {
+				if (pos & 0x02) {
+					if (pos & 0x01)
+						bases[indx] = 0x330;
+					else
+						bases[indx] = 0x230;
+				} else {
+					if (pos & 0x01)
+						bases[indx] = 0x130;
+				}
+			}
+
+			/* No need to decode IRQ and Arb level -- those are
+			 * read off the card later.
+			 */
+			printk(KERN_INFO "Found an AHA-1640 in MCA slot %d, I/O 0x%04x\n", slot, bases[indx]);
+
+			mca_set_adapter_name(slot, "Adapter AHA-1640");
+			mca_set_adapter_procfn(slot, NULL, NULL);
+			mca_mark_as_used(slot);
+			
+			/* Go on */
+			slot++;
+		}
+		
+	}
+#endif
+
 	/*
 	 *	Hunt for ISA Plug'n'Pray Adaptecs (AHA1535)
 	 */
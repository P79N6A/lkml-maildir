Date: Fri, 4 Aug 2006 09:22:15 +0900
From: KAMEZAWA Hiroyuki <>
Subject: Re: [Lhms-devel] [PATCH] memory hotadd fixes [4/5] avoid check in acpi
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2006/8/3/339

Hi, Keith
Thank you for test.
On Thu, 03 Aug 2006 16:09:36 -0700
keith mannthey <kmannth@us.ibm.com> wrote:
> > >  drivers/acpi/acpi_memhotplug.c |    9 +--------
> > >  1 files changed, 1 insertion(+), 8 deletions(-)
> > > 
> > > Index: linux-2.6.18-rc3/drivers/acpi/acpi_memhotplug.c
> > > ===================================================================
> > > --- linux-2.6.18-rc3.orig/drivers/acpi/acpi_memhotplug.c	2006-08-01 16:11:47.000000000 +0900
> > > +++ linux-2.6.18-rc3/drivers/acpi/acpi_memhotplug.c	2006-08-02 14:12:45.000000000 +0900
> > > @@ -230,17 +230,10 @@
> > >  	 * (i.e. memory-hot-remove function)
> > >  	 */
> > >  	list_for_each_entry(info, &mem_device->res_list, list) {
> > > -		u64 start_pfn, end_pfn;
> > > -
> > > -		start_pfn = info->start_addr >> PAGE_SHIFT;
> > > -		end_pfn = (info->start_addr + info->length - 1) >> PAGE_SHIFT;
> > > -
> > > -		if (pfn_valid(start_pfn) || pfn_valid(end_pfn)) {
> > > -			/* already enabled. try next area */
> > > +		if (info->enabled) { /* just sanity check...*/
> > >  			num_enabled++;
> > >  			continue;
> > >  		}
> > 
> > This check needs to go.  pfn_valid is a sparsemem specific check. Sanity
> > checking should be done it the the add_memory code. 
> > 
> > I will test and let you know. This is going to expose some baddness I
> > see already with my RESERVE path work. (Extra add_memory calls from this
> > driver during boot....)
> 
> Ok.  This pfn_valid check needs to be inserted somewhere in the code
> path for sparsemem hotadd.
> 
> with a debug statement in add_memory
> 
> Hotplug Mem Device
> add_memory 0 400000000 70000000
> System RAM resource 400000000 - 46fffffff cannot be added
This messages is at ioresouce collision check. This says system has 
memory resource between 400000000 - 46fffffff...before hotadd.
and sparse_add_one_seciton() returns -EEXIST if section exists.
==
int sparse_add_one_section(struct zone *zone, unsigned long start_pfn,
                           int nr_pages)
{
<snip>
	if (ms->section_mem_map & SECTION_MARKED_PRESENT) {
                ret = -EEXIST;
                goto out;
        }
}
==
Ah... but x86_64 special (not depends on sparsemem..) __add_pages() call doesn't
do sanity check at  online_page(). 
Here.
==
        for (pfn = start_pfn; pfn < start_pfn + nr_pages; pfn++) {
                if (pfn_valid(pfn)) {
                        online_page(pfn_to_page(pfn));
                        err = 0;
                        mem++;
                }
==
So, panics ...maybe. 
(System has memory between 40000000 - 46fffffff but it's onlined again)
Could you add sanity check in online_page() ?
==
if (PageReserved(page) {
	online_page(pfn_to_page(pfn));
}
==
will be enough.
I don't have avaliable x86_64 box now.
-Kame
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
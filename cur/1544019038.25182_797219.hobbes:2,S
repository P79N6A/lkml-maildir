Date: Tue, 27 Jan 2009 00:38:03 -0500 (EST)
From: Steven Rostedt <>
Subject: Re: [PATCH -tip] x86: ftrace - simplify wait_for_nmi
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2009/1/27/15

Ingo,
The following patch is in:
  git://git.kernel.org/pub/scm/linux/kernel/git/rostedt/linux-2.6-trace.git
    branch: tip/devel
Cyrill Gorcunov (1):
      x86: ftrace - simplify wait_for_nmi
----
 arch/x86/kernel/ftrace.c |   11 +++++------
 1 files changed, 5 insertions(+), 6 deletions(-)
---------------------------
commit e4733771167c00aa8bf8791307ca47f1c0420f55
Author: Cyrill Gorcunov <gorcunov@gmail.com>
Date:   Mon Jan 26 18:28:02 2009 +0300
    x86: ftrace - simplify wait_for_nmi
    
    Get rid of 'waited' stack variable.
    
    Signed-off-by: Cyrill Gorcunov <gorcunov@gmail.com>
    Signed-off-by: Steven Rostedt <srostedt@redhat.com>
diff --git a/arch/x86/kernel/ftrace.c b/arch/x86/kernel/ftrace.c
index 1b43086..4d33224 100644
--- a/arch/x86/kernel/ftrace.c
+++ b/arch/x86/kernel/ftrace.c
@@ -133,15 +133,14 @@ void ftrace_nmi_exit(void)
 
 static void wait_for_nmi(void)
 {
-	int waited = 0;
+	if (!atomic_read(&in_nmi))
+		return;
 
-	while (atomic_read(&in_nmi)) {
-		waited = 1;
+	do {
 		cpu_relax();
-	}
+	} while(atomic_read(&in_nmi));
 
-	if (waited)
-		nmi_wait_count++;
+	nmi_wait_count++;
 }
 
 static int
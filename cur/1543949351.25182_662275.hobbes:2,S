Date: Sun, 2 Mar 2008 23:28:35 +0100
From: "Dmitry Adamushko" <>
Subject: Re: [PATCH 1/2] kthread: add a missing memory barrier to kthread_stop()
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2008/3/2/148

On 02/03/2008, Rusty Russell <rusty@rustcorp.com.au> wrote:
> On Thursday 21 February 2008 08:36:30 Dmitry Adamushko wrote:
>  > From: Dmitry Adamushko <dmitry.adamushko@gmail.com>
>  > Subject: kthread: add a missing memory barrier to kthread_stop()
>  >
>  > We must ensure that kthread_stop_info.k has been updated before
>  > kthread's wakeup. This is required to properly support
>  > the use of kthread_should_stop() in the main loop of kthread.
>  >
>  > wake_up_process() doesn't imply a full memory barrier,
>  > so we add an explicit one.
>
>
> I always believed that wake_up_process() implies a write barrier.  It's pretty
>  common to set something up then wake the intended recipient.
No, it didn't imply a write mb. Moreover, the situation I tried to
address required a full mb (write vs. read ops. synchronization).
Please take a look at the discussion here 
http://lkml.org/lkml/2008/2/23/238
and here is a more detailed description of the problem :
http://groups.google.com/group/fa.linux.kernel/browse_thread/thread/44c45685680585fc/e58785df0eeee6f8?lnk=raot
>
>  So I think this patch is overkill, but I'm happy to be corrected.
We ended up adding an explicit smp_wmb() (a patch by Linus) to the
very beginning of try_to_wake_up(). Combined with the following
spin_lock() it acts as a 'full' mb for write vs. read ('read' takes
place inside try_to_wake_up()) and that's exactly what we need here.
The 1st link mentioned above may provide more details for interested readers.
So yes, now that we have got smp_wmb() in try_to_wake_up() this patch
is redundant.
>
>  Thanks!
>
> Rusty.
>
-- 
Best regards,
Dmitry Adamushko
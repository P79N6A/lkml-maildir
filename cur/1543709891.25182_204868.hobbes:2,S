Date: Tue, 09 Mar 2004 16:39:00 +1100
From: Nick Piggin <>
Subject: Re: [RFC][PATCH 4/4] vm-mapped-x-active-lists
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2004/3/9/6

Nick Piggin wrote:
>
>@@ -714,14 +737,27 @@ shrink_zone(struct zone *zone, int max_s
> 	 * just to make sure that the kernel will slowly sift through the
> 	 * active list.
> 	 */
>-	ratio = (unsigned long)SWAP_CLUSTER_MAX * zone->nr_active /
>-				((zone->nr_inactive | 1) * 2);
>+	nr_active = zone->nr_active_mapped + zone->nr_active_unmapped;
>+	ratio = (unsigned long)SWAP_CLUSTER_MAX * nr_active /
>+				(zone->nr_inactive * 2 + 1);
>+	mapped_ratio = (unsigned long long)ratio * nr_active;
>+	do_div(mapped_ratio, zone->nr_active_mapped+1);
>
Just for information, this is where you would balance mapped vs unmapped
pages:    do_div(mapped_ratio, 16); /* mapped pages are worth 16 times 
more */
>+
>+	ratio = ratio - mapped_ratio;
>+	atomic_add(ratio+1, &zone->nr_scan_active_unmapped);
>+	count = atomic_read(&zone->nr_scan_active_unmapped);
>+	if (count >= SWAP_CLUSTER_MAX) {
>+		atomic_set(&zone->nr_scan_active_unmapped, 0);
>+		shrink_active_list(zone, &zone->active_unmapped_list,
>+					&zone->nr_active_unmapped, count, ps);
>+	}
> 
>-	atomic_add(ratio+1, &zone->nr_scan_active);
>-	count = atomic_read(&zone->nr_scan_active);
>+	atomic_add(mapped_ratio+1, &zone->nr_scan_active_mapped);
>+	count = atomic_read(&zone->nr_scan_active_mapped);
> 	if (count >= SWAP_CLUSTER_MAX) {
>-		atomic_set(&zone->nr_scan_active, 0);
>-		shrink_active_list(zone, &zone->active_list, count, ps);
>+		atomic_set(&zone->nr_scan_active_mapped, 0);
>+		shrink_active_list(zone, &zone->active_mapped_list,
>+					&zone->nr_active_mapped, count, ps);
> 	}
> 
> 	atomic_add(max_scan, &zone->nr_scan_inactive);
>
>  
>
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
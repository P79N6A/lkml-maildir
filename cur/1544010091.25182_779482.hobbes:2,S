Date: Thu, 11 Dec 2008 09:45:06 -0800
From: Dave Hansen <>
Subject: Re: [PATCH 07/15] kmemleak: Add memleak_alloc callback from alloc_large_system_hash
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2008/12/11/188

On Thu, 2008-12-11 at 17:38 +0000, Catalin Marinas wrote:
> On Thu, 2008-12-11 at 09:30 -0800, Dave Hansen wrote:
> > On Thu, 2008-12-11 at 09:50 +0000, Catalin Marinas wrote:
> > > > Since alloc_large_system_hash() is using bootmem (and is called early),
> > > > I'm a little surprised that it is OK to call into memleak_alloc() which
> > > > uses kmem_cache_alloc().  Is the slab even set up at this point?
> > > 
> > > It doesn't need to be. Early callbacks like this are logged by kmemleak
> > > in a buffer and properly registered once the slab allocator is fully
> > > initialised (slab initialisation needs to allocate some memory for
> > > itself as well).
> > 
> > Ahh, thanks for the clarification.  Could you add something to the code
> > to this effect?
> 
> Do you mean a comment? I can do this.
Yeah, something like
/*
 * kmemleak doesn't actually allocate memory when called this early
 * so the GFP_ATOMIC here is actually meaningless, but consistent
 * with the rest of this function.
 */
Maybe that's too verbose. :)
-- Dave
Date: Wed, 12 Dec 2007 22:56:12 -0500 (EST)
From: Steven Rostedt <>
Subject: Re: [PATCH, RFC] hacks to allow -rt to run kernbench on POWER
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2007/12/12/490

On Mon, 29 Oct 2007, Paul E. McKenney wrote:
> diff -urpNa -X dontdiff linux-2.6.23.1-rt4/mm/memory.c linux-2.6.23.1-rt4-fix/mm/memory.c
> --- linux-2.6.23.1-rt4/mm/memory.c	2007-10-27 22:20:57.000000000 -0700
> +++ linux-2.6.23.1-rt4-fix/mm/memory.c	2007-10-28 15:40:36.000000000 -0700
> @@ -664,6 +664,7 @@ static unsigned long zap_pte_range(struc
>  	int anon_rss = 0;
>
>  	pte = pte_offset_map_lock(mm, pmd, addr, &ptl);
> +	preempt_disable();
>  	arch_enter_lazy_mmu_mode();
>  	do {
>  		pte_t ptent = *pte;
> @@ -732,6 +733,7 @@ static unsigned long zap_pte_range(struc
>
>  	add_mm_rss(mm, file_rss, anon_rss);
>  	arch_leave_lazy_mmu_mode();
> +	preempt_enable();
>  	pte_unmap_unlock(pte - 1, ptl);
>
>  	return addr;
I'm pulling your patch for the above added code. Took me a few hours to
find the culprit, but I was getting scheduling in atomic bugs. Turns out
that this code you put "preempt_disable" in calls sleeping spinlocks.
Might want to run with DEBUG_PREEMPT.
Thanks,
-- Steve
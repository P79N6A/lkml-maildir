Date: Sat, 8 Dec 2001 20:44:03 +0100
From: Jens Axboe <>
Subject: Re: 2.5.1-pre7 ide-cd module
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2001/12/8/89

On Sat, Dec 08 2001, Udo A. Steinberg wrote:
> Jens Axboe wrote:
> > 
> > Yes please -- try 2.5.1-pre1 and 2.5.1-pre2, it probably broke there.
> 
> Indeed. pre1 works, pre2 doesn't:
Ah, I think I see the problem. Very first mode page capabilities probe
fails, which is expected and therefore retried. But now we've killed the
correct length of command, which should only be done on success. The
second time you load ide-cd, it succeeds on first probe and thus works.
Attached patch should fix it.
-- 
Jens Axboe
--- /opt/kernel/linux-2.5.1-pre7/drivers/ide/ide-cd.c	Fri Dec  7 20:38:44 2001
+++ drivers/ide/ide-cd.c	Sat Dec  8 14:39:43 2001
@@ -2145,7 +2145,8 @@
 	pc.timeout = cgc->timeout;
 	pc.sense = cgc->sense;
 	cgc->stat = cdrom_queue_packet_command(drive, &pc);
-	cgc->buflen -= pc.buflen;
+	if (!cgc->stat)
+		cgc->buflen -= pc.buflen;
 	return cgc->stat;
 }
 
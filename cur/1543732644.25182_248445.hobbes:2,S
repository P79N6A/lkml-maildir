Date: Thu, 02 Sep 2004 17:54:47 -0700
From: john stultz <>
Subject: [PATCH] fix target_cpus() for summit subarch
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2004/9/2/361

I've been hunting down a bug affecting IBM x440/x445 systems where the
floppy driver would get spurious interrupts and would not initialize
properly. 
After digging James Cleverdon and Bill Irwin pointed out that
target_cpus() is routing the interrupts to the clustered apic broadcast
mask using destFixed deliver mode. This was causing multiple interrupts
to show up, breaking the floppy init code. 
This fix simply changes the delivery mode to dest_LowestPrio and
initially routes interrupts to the first cpu to resolve this issue.
Please consider for inclusion into your tree.
thanks
-john
linux-2.6.9-rc1_summit-target-cpus-fix_A2.patch
===============================================
diff -Nru a/include/asm-i386/mach-summit/mach_apic.h b/include/asm-i386/mach-summit/mach_apic.h
--- a/include/asm-i386/mach-summit/mach_apic.h	2004-09-02 17:46:06 -07:00
+++ b/include/asm-i386/mach-summit/mach_apic.h	2004-09-02 17:46:06 -07:00
@@ -19,11 +19,15 @@
 
 static inline cpumask_t target_cpus(void)
 {
-	return CPU_MASK_ALL;
+	/* CPU_MASK_ALL (0xff) has undefined behaviour with
+	 * dest_LowestPrio mode logical clustered apic interrupt routing
+	 * Just start on cpu 0.  IRQ balancing will spread load
+	 */
+	return cpumask_of_cpu(0);
 } 
 #define TARGET_CPUS	(target_cpus())
 
-#define INT_DELIVERY_MODE (dest_Fixed)
+#define INT_DELIVERY_MODE (dest_LowestPrio)
 #define INT_DEST_MODE 1     /* logical delivery broadcast to all procs */
 
 static inline unsigned long check_apicid_used(physid_mask_t bitmap, int apicid)
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
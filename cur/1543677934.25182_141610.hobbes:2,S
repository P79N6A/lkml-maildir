Date: Wed, 18 Jun 2003 18:02:20 -0700
From: David Mosberger <>
Subject: missing bit for thread_info-next-to-task_struct patch
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2003/6/18/274

The attached patch is needed to really allow the thread_info to live
in the same chunk of memory as task structure.  I missed it in my last
patch because the fix was originally keyed on INIT_THREAD_SIZE, which
was wrong but resulted in a one-liner patch which was easy to miss.
The patch below is cleaner.  I suppose it would be nice if we could
get rid of INIT_THREAD_SIZE entirely, but it looks like user-mode
Linux still relies on it.
	--david
diff -Nru a/include/linux/sched.h b/include/linux/sched.h
--- a/include/linux/sched.h	Wed Jun 18 18:01:04 2003
+++ b/include/linux/sched.h	Wed Jun 18 18:01:04 2003
@@ -504,9 +509,10 @@
  */
 extern struct exec_domain	default_exec_domain;
 
-#ifndef INIT_THREAD_SIZE
-# define INIT_THREAD_SIZE	2048*sizeof(long)
-#endif
+#ifndef __HAVE_ARCH_TASK_STRUCT_ALLOCATOR
+# ifndef INIT_THREAD_SIZE
+#  define INIT_THREAD_SIZE	2048*sizeof(long)
+# endif
 
 union thread_union {
 	struct thread_info thread_info;
@@ -514,6 +520,9 @@
 };
 
 extern union thread_union init_thread_union;
+
+#endif /* !__HAVE_ARCH_TASK_STRUCT_ALLOCATOR */
+
 extern struct task_struct init_task;
 
 extern struct   mm_struct init_mm;
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
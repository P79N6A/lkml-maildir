Date: Wed, 2 Jan 2002 18:40:24 +0100
From: "Petr Vandrovec" <>
Subject: Re: [PATCH] C undefined behavior fix
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2002/1/2/85

On  2 Jan 02 at 11:45, Paul Koning wrote:
> 
> It might be interesting for the compiler to warn about this coding
> error (since it presumably can detect it).  But "fixing" the behavior
> of undefined code seems like a strange thing to do.
It is even worse (gcc 2.95.4 20011223 (Debian prerelease), i386).
Test code:
#include <string.h>
char* dst;
void main(void) {
   strcpy(dst, "test"+CONSTANT);
}
# gcc -O2 -S test.c -DCONSTANT=10
test.c: In function `main':
test.c:4: warning: offset outside bounds of constant string
...
and compiler generated correct code (call to strcpy with "test"+10).
But:
# gcc -O2 -S test.c -DCONSTANT=0x80000000
test.c: In function `main':
test.c:4: warning: offset outside bounds of constant string
gcc: Internal compiler error: program cc1 got fatal signal 11
(and for CONSTANT < 5 it of course generated correct code to fill
dst with string contents; and yes, I know that code will sigsegv on
run because of dst is not initialized - but it should die at runtime,
not at compile time).
So we should definitely change RELOC(), or sooner or later gcc will
die on such code :-(
Debian's gcc 3.0.3-1 generates:
0 <= CONSTANT <= 4: fills dst directly with constant
5 <= CONSTANT <= 0x7FFFFFFF: emit warnings + use strcpy()
0x80000000U <= CONSTANT <= 0xFFFFFFFFU: use strcpy() silently
... and it does not die.
                                            Best regards,
                                                Petr Vandrovec
                                                vandrove@vc.cvut.cz
                                                
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
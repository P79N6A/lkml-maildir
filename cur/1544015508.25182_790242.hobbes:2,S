Date: Sun, 11 Jan 2009 09:48:00 -0800
From: Mike Travis <>
Subject: Re: [PATCH 4/4] kstat: modify kstat_irqs_legacy to be variable sized
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2009/1/11/229

Mike Travis wrote:
> Yinghai Lu wrote:
>> On Sat, Jan 10, 2009 at 2:38 PM, Mike Travis <travis@sgi.com> wrote:
>>> Impact: reduce memory usage.
>>>
>>> Allocate kstat_irqs_legacy based on nr_cpu_ids to deal with this
>>> memory usage bump when NR_CPUS bumped from 128 to 4096:
>>>
>>>     8192   +253952    262144 +3100%  kstat_irqs_legacy(.bss)
>>>
>>> This is only when CONFIG_SPARSE_IRQS=y.
>>>
>>> Signed-off-by: Mike Travis <travis@sgi.com>
>>> ---
>>>  kernel/irq/handle.c |    9 ++++++---
>>>  1 file changed, 6 insertions(+), 3 deletions(-)
>>>
>>> --- linux-2.6-for-ingo.orig/kernel/irq/handle.c
>>> +++ linux-2.6-for-ingo/kernel/irq/handle.c
>>> @@ -124,8 +124,7 @@ static struct irq_desc irq_desc_legacy[N
>>>        }
>>>  };
>>>
>>> -/* FIXME: use bootmem alloc ...*/
>>> -static unsigned int kstat_irqs_legacy[NR_IRQS_LEGACY][NR_CPUS];
>>> +static unsigned int *kstat_irqs_legacy;
>>>
>>>  int __init early_irq_init(void)
>>>  {
>>> @@ -146,9 +145,13 @@ int __init early_irq_init(void)
>>>        /* allocate irq_desc_ptrs array based on nr_irqs */
>>>        irq_desc_ptrs = alloc_bootmem(nr_irqs * sizeof(void *));
>>>
>>> +       /* allocate based on nr_cpu_ids */
>>> +       kstat_irqs_legacy = alloc_bootmem(NR_IRQS_LEGACY * nr_cpu_ids *
>>> +                                         sizeof(int));
>>> +
>>>        for (i = 0; i < legacy_count; i++) {
>>>                desc[i].irq = i;
>>> -               desc[i].kstat_irqs = kstat_irqs_legacy[i];
>>> +               desc[i].kstat_irqs = kstat_irqs_legacy + i * NR_IRQS_LEGACY;
>> here should be
>>
>> +               desc[i].kstat_irqs = kstat_irqs_legacy + i * nr_cpu_ids;
>>
>> YH
> 
> Hmm, thanks!  (I wonder why I wanted it the other way?  Oh well.)
> 
> I'll make an append patch to fix it.
> 
> Thanks,
> Mike
I'll push this to my cpus4096-for-ingo.git tree:
Subject: irq: fix initialization of legacy kstat irqs
Impact: fix bug with legacy kstat irqs
The sectioning of the allocated kstat_irqs_legacy should use nr_cpu_ids
instead of NR_IRQS_LEGACY.
Thanks to Yinghai for pointing this out.
Signed-off-by: Mike Travis <travis@sgi.com>
---
 kernel/irq/handle.c |    2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)
--- linux-2.6-for-ingo.orig/kernel/irq/handle.c
+++ linux-2.6-for-ingo/kernel/irq/handle.c
@@ -155,7 +155,7 @@ int __init early_irq_init(void)
 
 	for (i = 0; i < legacy_count; i++) {
 		desc[i].irq = i;
-		desc[i].kstat_irqs = kstat_irqs_legacy + i * NR_IRQS_LEGACY;
+		desc[i].kstat_irqs = kstat_irqs_legacy + i * nr_cpu_ids;
 		lockdep_set_class(&desc[i].lock, &irq_desc_lock_class);
 		init_alloc_desc_masks(&desc[i], 0, true);
 		irq_desc_ptrs[i] = desc + i;
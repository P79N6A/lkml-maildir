Date: Tue, 29 Oct 2002 22:23:15 -0600 (CST)
From: Josh Myer <>
Subject: [PATCH] sound/pci/via82xx.c "sleeping function called..."
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2002/10/29/290

Attached is a patch which seems to cure these, but no promises that it's
Correct (!):
(To: l-k so the Gurus can tell me i'm wrong more efficiently =)
Debug: sleeping function called from illegal context at mm/slab.c:1374
Call Trace:
 [<c0114d41>] __might_sleep+0x55/0x64
 [<c012f44a>] kmalloc+0x56/0x1e4
 [<c4049098>] build_via_table+0x38/0x184 [snd-via82xx]
 [<c40490bb>] build_via_table+0x5b/0x184 [snd-via82xx]
 [<c01b8567>] __delay+0x13/0x28
 [<c404955a>] snd_via82xx_setup_periods+0x2e/0x128 [snd-via82xx]
 [<c4049864>] snd_via82xx_playback_prepare+0x80/0x8c [snd-via82xx]
 [<c4037e80>] snd_pcm_prepare+0xac/0x18c [snd-pcm]
 [<c40397e6>] snd_pcm_common_ioctl1+0x1d6/0x2a8 [snd-pcm]
 [<c4039c1e>] snd_pcm_playback_ioctl1+0x366/0x374 [snd-pcm]
 [<c4039fbf>] snd_pcm_kernel_playback_ioctl_R7d246e95+0x27/0x30 [snd-pcm]
 [<c403a01b>] snd_pcm_kernel_ioctl_Ra45ade40+0x23/0x40 [snd-pcm]
 [<c4052c81>] snd_pcm_oss_prepare+0x15/0x34 [snd-pcm-oss]
 [<c4052cd2>] snd_pcm_oss_make_ready+0x32/0x40 [snd-pcm-oss]
 [<c4053060>] snd_pcm_oss_write1+0x3c/0x148 [snd-pcm-oss]
 [<c4054f6a>] snd_pcm_oss_write+0x32/0x68 [snd-pcm-oss]
 [<c013d351>] vfs_write+0xc1/0x160
 [<c013d456>] sys_write+0x2a/0x3c
 [<c0108b07>] syscall_call+0x7/0xb
It's creepy to look over at the TV and see what looks like an Oops trace
but the music is still going... =)
--
/jbm, but you can call me Josh. Really, you can!
 "What's a metaphor?" "For sheep to graze in"
7958 1C1C 306A CDF8 4468  3EDE 1F93 F49D 5FA1 49C4
--- linux-2.5.44/sound/pci/via82xx.c	2002-10-19 00:01:19.000000000 -0400
+++ linux-2.5.44-jbm/sound/pci/via82xx.c	2002-10-29 23:12:26.000000000 -0500
@@ -217,7 +217,7 @@
 			return -ENOMEM;
 	}
 	if (! dev->idx_table) {
-		dev->idx_table = kmalloc(sizeof(*dev->idx_table) * VIA_TABLE_SIZE, GFP_KERNEL);
+		dev->idx_table = kmalloc(sizeof(*dev->idx_table) * VIA_TABLE_SIZE, GFP_ATOMIC);
 		if (! dev->idx_table)
 			return -ENOMEM;
 	}
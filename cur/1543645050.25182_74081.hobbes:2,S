Date: Fri, 27 Sep 2002 15:17:41 +0100
From: Matthew Wilcox <>
Subject: [PATCH] fix file_lock_cache leak
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2002/9/27/74

Always free the request, not just on error.
diff -urpNX dontdiff linux-2.5.38/fs/locks.c linux-2.5.38-flock/fs/locks.c
--- linux-2.5.38/fs/locks.c	2002-09-21 18:47:00.000000000 -0700
+++ linux-2.5.38-flock/fs/locks.c	2002-09-26 10:36:16.000000000 -0700
@@ -1459,10 +1470,8 @@ int fcntl_setlk(struct file *filp, unsig
 		break;
 	}
 
-out:
-	if (error) {
-		locks_free_lock(file_lock);
-	}
+ out:
+	locks_free_lock(file_lock);
 	return error;
 }
 
@@ -1601,11 +1614,8 @@ int fcntl_setlk64(struct file *filp, uns
 		break;
 	}
 
-
 out:
-	if (error) {
-		locks_free_lock(file_lock);
-	}
+	locks_free_lock(file_lock);
 	return error;
 }
 #endif /* BITS_PER_LONG == 32 */
-- 
Revolutions do not require corporate support.
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
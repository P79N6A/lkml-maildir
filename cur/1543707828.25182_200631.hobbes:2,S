Date: Fri, 20 Feb 2004 17:28:27 -0800
From: Andrew Morton <>
Subject: Re: PROBLEM: NAT over 3c59x cards freezes interactivity on 2.6.2
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2004/2/20/300

Chad Walstrom <chewie@wookimus.net> wrote:
>
> On Thu, Feb 12, 2004 at 06:42:08PM -0800, Andrew Morton wrote:
> > Chad Walstrom <chewie@wookimus.net> wrote:
> > >
> > > [2.] DETAILS: Upon upgrading from 2.4.x to 2.6.2, I've noticed that my
> > >  workstation/NAT box freezes on interactive processes while transfering
> > >  large files over NAT to other machines on the network. 
> > 
> > Please monitor the system time with top or `vmstat 1'.  Is it excessive?
> 
> I'm not sure what excessive might mean.  There doesn't seem to be any
> spikes in memory consumption.  Following is the output from 'vmstat 1'.
> The number of procs waiting for run time increases when the
> interactivity freezes (while the laptop is downloading files over the
> workstation's NAT).  The '6' and '5' both occur during download attempts
> and interactivy freezes.  When I kill the download, interactivy resumes,
> and the waiting processes drops.
> 
> Script started on Fri Feb 20 16:17:30 2004
> [16:17:30] chewie@skuld (501)$ vmstat 1
> procs -----------memory---------- ---swap-- -----io---- --system-- ----cpu----
>  r  b   swpd   free   buff  cache   si   so    bi    bo   in    cs us sy id wa
>  2  0   9364   2560  46256 300188    0    0    10    12   35    44 96  1  3  0
>  1  0   9364   2560  46256 300188    0    0     0     0 1008    63 100  0  0  0
>  1  0   9364   2560  46264 300188    0    0     0    12 1008    56 100  0  0  0
It claims that the CPU is pegged in userspace.  What does `top' say?
> > A kernel profile might tell us what is going on.  See
> > Documentation/basic_profiling.txt.
> 
> I'll have to recompile the kernel to test this for you.  I'll do so and
> compile 2.6.3.
Well if you're spending 100% of CPU in userspace then a kernel profile
won't tell us much.
> > If you remove all the netfilter rules, what happens?
> 
> Then I wouldn't be able to NAT. ;-)  The workstation works fine as a
> standalone.  I've downloaded large files w/o too much difficulty, and
> interactivity remains stable.  The only time I see problems is when I'm
> downloading files through NAT to the laptop.
So it is the presence of the NAT rules which is causing the problem?
Perhaps the above vmstat trace is wrong?  Make sure that you have a nice and
recent procps package.
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
Date: Thu, 26 Apr 2007 16:29:21 +0200
From: Jarek Poplawski <>
Subject: Re: [PATCH] cancel_delayed_work: use del_timer() instead of del_timer_sync()
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2007/4/26/266

On Wed, Apr 25, 2007 at 04:52:14PM +0400, Oleg Nesterov wrote:
> On 04/25, Jarek Poplawski wrote:
> >
> > On Wed, Apr 25, 2007 at 01:50:34AM +0400, Oleg Nesterov wrote:
> > > del_timer_sync() buys nothing for cancel_delayed_work(), but it is less
> > > efficient since it locks the timer unconditionally, and may wait for the
> > > completion of the delayed_work_timer_fn().
> > 
> > I'm not sure what is the main aim of this patch.
> 
> optimization
> 
> >                                                  It seems this
> > change cannot do any harm, but anyway it could change a few
> > things, e.g. with current version of cancel_rearming_delayed_work
> > some flush_workqueue could be done needlessly, before the work
> > is queued from timer.
> 
> I don't think so... Could you clarify?
With a code like:
if (!cancel_delayed_work(dwork))
	flush_workqueue(wq);
	
if cancel_ returns 0, and there is _queue_work in progress,
flush_ will be done once, after this work is queued.
After the patch, and the same situation flush_ also runs
one time, but maybe without the work in a queue.
So, if there is no more loops, there could be difference,
and even if very unprobable, something could stop working
after such change.
> 
> >                       It's not a big deal here, but if anybody
> > did something like this without loop - it could matter.
> > 
> > So, probably a lot of current code should be checked, before
> > applying and I doubt the gain is worth of this. Maybe, for
> > safety, make this with new name as an alternative and
> > deprecate the current version?
> 
> This change should not make any visible difference for the callers,
> otherwise it is buggy.
IMHO, there is the same visible difference,
as between del_timer and del_timer_sync.
Regards,
Jarek P.
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
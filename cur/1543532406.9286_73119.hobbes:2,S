Date: Thu, 30 Mar 2000 13:21:25 +0200
From: Matthias Andree <>
Subject: [FIX] 2.2.15pre16 build failure due to make menuconfig/xconfig bugs
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2000/3/30/47

NOTE THAT THIS FIX DOES NOT HELP AGAINST THE MAKE XCONFIG BUG,
IT JUST REPAIRS MAKE MENUCONFIG! MAKE CONFIG IS UNAFFECTED.
Hi,
some observations in 2.2.15pre16: 
1) A serious bug/incompatiblitiy in make menuconfig and make xconfig
   allows MSP3400 to be linked against the kernel while CONFIG_SOUND is
   m. make config gets it right. My .config is attached. 
   Fix for Menuconfig is attached. I am not deep enough into make
   xconfig to fix that as well, so this will need to be done before
   2.2.15 by somebody else. 
2) after changing CONFIG_VIDEO_MSP3400 from y to m required rebuilding
   the entire kernel. This sucks. I don't think this is actually
   needed. 
-- 
Matthias Andree
                Where do you think you're going today?
CONFIG_EXPERIMENTAL=y
CONFIG_M586TSC=y
CONFIG_X86_WP_WORKS_OK=y
CONFIG_X86_INVLPG=y
CONFIG_X86_BSWAP=y
CONFIG_X86_POPAD_OK=y
CONFIG_X86_TSC=y
CONFIG_1GB=y
CONFIG_MTRR=y
CONFIG_MODULES=y
CONFIG_KMOD=y
CONFIG_NET=y
CONFIG_PCI=y
CONFIG_PCI_GOANY=y
CONFIG_PCI_BIOS=y
CONFIG_PCI_DIRECT=y
CONFIG_PCI_QUIRKS=y
CONFIG_PCI_OPTIMIZE=y
CONFIG_PCI_OLD_PROC=y
CONFIG_SYSVIPC=y
CONFIG_BSD_PROCESS_ACCT=y
CONFIG_SYSCTL=y
CONFIG_BINFMT_AOUT=y
CONFIG_BINFMT_ELF=y
CONFIG_BINFMT_MISC=m
CONFIG_PARPORT=y
CONFIG_PARPORT_PC=y
CONFIG_BLK_DEV_FD=y
CONFIG_BLK_DEV_IDE=y
CONFIG_BLK_DEV_IDEDISK=y
CONFIG_BLK_DEV_IDEPCI=y
CONFIG_BLK_DEV_IDEDMA=y
CONFIG_IDEDMA_AUTO=y
CONFIG_BLK_DEV_VIA82C586=y
CONFIG_BLK_DEV_LOOP=m
CONFIG_BLK_DEV_RAM=y
CONFIG_BLK_DEV_INITRD=y
CONFIG_PARIDE_PARPORT=y
CONFIG_PACKET=y
CONFIG_NETLINK=y
CONFIG_RTNETLINK=y
CONFIG_NETLINK_DEV=y
CONFIG_FIREWALL=y
CONFIG_UNIX=y
CONFIG_INET=y
CONFIG_IP_ADVANCED_ROUTER=y
CONFIG_RTNETLINK=y
CONFIG_NETLINK=y
CONFIG_IP_MULTIPLE_TABLES=y
CONFIG_IP_ROUTE_VERBOSE=y
CONFIG_IP_ROUTE_LARGE_TABLES=y
CONFIG_IP_FIREWALL=y
CONFIG_IP_FIREWALL_NETLINK=y
CONFIG_NETLINK_DEV=y
CONFIG_IP_MASQUERADE=y
CONFIG_IP_MASQUERADE_ICMP=y
CONFIG_IP_MASQUERADE_MOD=y
CONFIG_IP_ALIAS=y
CONFIG_SYN_COOKIES=y
CONFIG_INET_RARP=y
CONFIG_SKB_LARGE=y
CONFIG_IPX=m
CONFIG_NET_SCHED=y
CONFIG_NETLINK=y
CONFIG_RTNETLINK=y
CONFIG_NET_SCH_CBQ=m
CONFIG_NET_SCH_CSZ=m
CONFIG_NET_SCH_PRIO=m
CONFIG_NET_SCH_RED=m
CONFIG_NET_SCH_SFQ=m
CONFIG_NET_SCH_TEQL=m
CONFIG_NET_SCH_TBF=m
CONFIG_NET_QOS=y
CONFIG_NET_ESTIMATOR=y
CONFIG_NET_CLS=y
CONFIG_NET_CLS_ROUTE4=m
CONFIG_NET_CLS_ROUTE=y
CONFIG_NET_CLS_FW=m
CONFIG_NET_CLS_U32=m
CONFIG_NET_CLS_RSVP=m
CONFIG_NET_CLS_RSVP6=m
CONFIG_SCSI=y
CONFIG_BLK_DEV_SD=y
CONFIG_CHR_DEV_ST=y
CONFIG_BLK_DEV_SR=y
CONFIG_BLK_DEV_SR_VENDOR=y
CONFIG_CHR_DEV_SG=y
CONFIG_SCSI_CONSTANTS=y
CONFIG_SCSI_LOGGING=y
CONFIG_SCSI_AHA1542=m
CONFIG_SCSI_AIC7XXX=m
CONFIG_AIC7XXX_TCQ_ON_BY_DEFAULT=y
CONFIG_AIC7XXX_CMDS_PER_DEVICE=8
CONFIG_AIC7XXX_PROC_STATS=y
CONFIG_AIC7XXX_RESET_DELAY=5
CONFIG_SCSI_SYM53C8XX=y
CONFIG_SCSI_NCR53C8XX_DEFAULT_TAGS=16
CONFIG_SCSI_NCR53C8XX_MAX_TAGS=32
CONFIG_SCSI_NCR53C8XX_SYNC=20
CONFIG_SCSI_DC390T=y
CONFIG_SCSI_DC390T_NOGENSUPP=y
CONFIG_I2O=y
CONFIG_I2O_PCI=m
CONFIG_I2O_BLOCK=m
CONFIG_I2O_SCSI=m
CONFIG_NETDEVICES=y
CONFIG_DUMMY=m
CONFIG_ETHERTAP=y
CONFIG_NET_ETHERNET=y
CONFIG_NET_VENDOR_3COM=y
CONFIG_EL3=y
CONFIG_VORTEX=y
CONFIG_PPP=y
CONFIG_SLIP=y
CONFIG_SLIP_COMPRESSED=y
CONFIG_SLIP_SMART=y
CONFIG_VT=y
CONFIG_VT_CONSOLE=y
CONFIG_SERIAL=y
CONFIG_SERIAL_CONSOLE=y
CONFIG_SERIAL_EXTENDED=y
CONFIG_SERIAL_MANY_PORTS=y
CONFIG_SERIAL_SHARE_IRQ=y
CONFIG_SERIAL_DETECT_IRQ=y
CONFIG_SERIAL_MULTIPORT=y
CONFIG_SERIAL_NONSTANDARD=y
CONFIG_UNIX98_PTYS=y
CONFIG_UNIX98_PTY_COUNT=256
CONFIG_PRINTER=y
CONFIG_PRINTER_READBACK=y
CONFIG_MOUSE=y
CONFIG_PSMOUSE=y
CONFIG_NVRAM=y
CONFIG_RTC=y
CONFIG_VIDEO_DEV=y
CONFIG_VIDEO_BT848=y
CONFIG_VIDEO_SAA5249=y
CONFIG_AUTOFS_FS=y
CONFIG_AFFS_FS=m
CONFIG_FAT_FS=y
CONFIG_MSDOS_FS=m
CONFIG_UMSDOS_FS=m
CONFIG_VFAT_FS=y
CONFIG_ISO9660_FS=y
CONFIG_JOLIET=y
CONFIG_MINIX_FS=m
CONFIG_NTFS_FS=m
CONFIG_PROC_FS=y
CONFIG_DEVPTS_FS=y
CONFIG_EXT2_FS=y
CONFIG_UFS_FS=m
CONFIG_UFS_FS_WRITE=y
CONFIG_REISERFS_FS=y
CONFIG_CRYPTO_SECURE_HASH=y
CONFIG_CODA_FS=m
CONFIG_NFS_FS=m
CONFIG_NFSD=m
CONFIG_SUNRPC=m
CONFIG_LOCKD=m
CONFIG_SMB_FS=m
CONFIG_BSD_DISKLABEL=y
CONFIG_SOLARIS_X86_PARTITION=y
CONFIG_AMIGA_PARTITION=y
CONFIG_NLS=y
CONFIG_NLS_CODEPAGE_437=y
CONFIG_NLS_CODEPAGE_850=y
CONFIG_NLS_ISO8859_1=y
CONFIG_NLS_ISO8859_15=y
CONFIG_VGA_CONSOLE=y
CONFIG_VIDEO_SELECT=y
CONFIG_SOUND=m
CONFIG_SOUND_OSS=m
CONFIG_SOUND_SB=m
CONFIG_SOUND_MPU401=m
CONFIG_SOUND_PSS=m
CONFIG_PSS_MIXER=y
CONFIG_SOUND_MSS=m
CONFIG_SOUND_SOFTOSS=m
CONFIG_SOUND_YM3812=m
CONFIG_LOWLEVEL_SOUND=y
CONFIG_VIDEO_MSP3400=y
CONFIG_MAGIC_SYSRQ=y
--- linux-2.2.15pre16/scripts/Menuconfig.orig	Thu Mar 30 12:28:26 2000
+++ linux-2.2.15pre16/scripts/Menuconfig	Thu Mar 30 12:48:11 2000
@@ -68,6 +68,10 @@
 #
 # 24 January 1999, Michael Elizabeth Chastain, <mec@shout.net>
 # - Improve the exit message (Jeff Ronne).
+#
+# 30 March 2000, Matthias Andree <matthias.andree@gmx.de>
+# - allow dep_tristate to accept more than one dependency as 
+#   Configure (make config) does
 
 
 #
@@ -188,13 +192,31 @@
 #       else in the kernel.
 #
 function dep_tristate () {
-	if [ "$3" = "y" ]; then
-	    tristate "$1" "$2"
-	else if [ "$3" = "m" ]; then
-	    mod_bool "$1" "$2"
-	else 
-	    define_bool "$2" n
-	fi; fi
+        local label=$1 
+	local name=$2
+	shift 2
+	local need_module=0
+
+	while [ $# -gt 0 ]; do 
+	  case "$1" in
+	    n) 
+	      define_bool "$name" "n"
+	      return
+	      ;;
+	    m)
+	      need_module=1
+	      ;;
+          esac
+	  shift
+        done
+
+	if [ need_module -eq 0 ]; then
+	    tristate "$label" "$name"
+	else
+	    mod_bool "$label" "$name"
+	fi
+	# note that the while loop above already defined the variable
+	# to "n" if the dependencies are not met. 
 }
 
 #
@@ -992,9 +1014,16 @@
 	}
 
 	function dep_tristate () {
-		set_x_info "$2" "n"
-		if [ "$3" = "m" -a "$x" = "y" ]; then x="m"; fi
-		define_bool "$2" "$x"
+	        local opt=$2
+		shift 2
+		set_x_info "$opt" "n"
+		if [ "$x" = "y" ] ; then 
+			while [ $# -gt 0 ]; do 
+				if [ "$1" = "m" ]; then x="m" ; fi 
+				shift
+			done
+		fi
+		define_bool "$opt" "$x"
 	}
 
 	function int () {-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.0.1 (GNU/Linux)
Comment: For info see 
http://www.gnupg.org
iQCVAwUAOOM0RidEoB0mv1ypAQHlXQP+O8PQEMrkkJ6fd9tn44YUAqOeUJXCo7Cq
r1WiSqO3nryILls2idm2aMNswwU7/NL1X8YRkHEw9LfsNSDq+qcQOhsgZAX/vVqX
F+xYjrWaLc8edffgMnWGabEZMXEiv1PAgN9638xVn2hwaZlj0xKZa5u56Hybvydg
XvZr7OjkBVA=
=nuTN
-----END PGP SIGNATURE-----
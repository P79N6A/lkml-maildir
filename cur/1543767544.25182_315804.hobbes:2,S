Date: Tue, 3 May 2005 12:00:18 +0200 (MEST)
From: "Michael Kerrisk" <>
Subject: Re: fcntl: F_SETLEASE/F_RDLCK question
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2005/5/3/25

Hi Stephen,
> On Mon, 2 May 2005 11:15:24 +0200 Heiko Carstens
> <heiko.carstens@de.ibm.com> wrote:
> >
> > the semantics of fnctl used together with F_SETLEASE and
> > argument F_RDLCK have been changed with bk changeset
> > 1.1938.185.141 (sometime between 2.6.9 and 2.6.10).
> > Since then it's only possible to get a read lease when the
> > file in question does not have _any_ writers.
> > This is at least inconsistent with the man page of fcntl
> > and looks pretty much like this is a bug in the kernel.
> > 
> > Any comments?
> 
> The previous behaviour was a bug that occurred because at the time the
> original lease code was written, it was not possible to tell if there 
> were
> writers when the read lease was being taken. Further improvements in the
> kernel have since made this possible.
> 
> The intention of a read lease is to let the holder know is anyone tries 
> to modify the file.
> 
> The current behaviour does not conflict with the man pages on Debian
> (although the previous behaviour did not either :-))
Indeed the problem referred to is fixed, but it looks like another 
one may have been introduced.
It now appears (I tested on 2.6.11.6) that if a process opens 
a file O_RDWR and then tries to place a read lease via that
file descriptor, then the F_SETLEASE fails with EAGAIN, 
even though no other process has the file open for writing.  
(On the other hand, if the process opens the file 
O_WRONLY, then it can place either a read or a write lease.  
This is how I think things always worked, but it seems 
inconsistent with the aforementioned behaviour.)  
Some further testing showed the following (both open() 
and fcntl(F_SETLEASE) from same process):
 open()  |  lease requested
  flag   | F_RDLCK  | F_WRLCK
---------+----------+----------
O_RDONLY | okay     |  okay
O_WRONLY | EAGAIN   |  okay
O_RDWR   | EAGAIN   |  okay
This seems strange (I imagine the caller should be excluded 
from the list of processes being checked to see if the file 
is opened for writing), and differs from earlier kernel
versions.  What is the intended behaviour here?
Cheers,
Michael
-- 
+++ Lassen Sie Ihren Gedanken freien Lauf... z.B. per FreeSMS +++
GMX bietet bis zu 100 FreeSMS/Monat: 
http://www.gmx.net/de/go/mail
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
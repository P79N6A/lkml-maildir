Date: Mon, 21 Apr 2003 15:55:30 +0400
From: Oleg Drokin <>
Subject: Re: "[PATCH] devfs: switch over ubd to ->devfs_name" breaks ubd/sysfs
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2003/4/21/49

Hello!
   The "[PATCH] devfs: switch over ubd to ->devfs_name" patch that was included into 2.5.68,
   have broken UML's ubd/sysfs interaction.
   Sysfs is very upset when something tries to register several devices with 
   same name, so I was forced to use following patch.
   If this is wrong, then please explain to me why, and suggest the correct way of handling
   this situation.
   Thank you.
Bye,
    Oleg
===== arch/um/drivers/ubd_kern.c 1.32 vs edited =====
--- 1.32/arch/um/drivers/ubd_kern.c	Sun Apr 20 01:17:05 2003
+++ edited/arch/um/drivers/ubd_kern.c	Mon Apr 21 15:52:54 2003
@@ -494,7 +494,7 @@
 	disk->first_minor = unit << UBD_SHIFT;
 	disk->fops = &ubd_blops;
 	set_capacity(disk, size / 512);
-	sprintf(disk->disk_name, "ubd");
+	sprintf(disk->disk_name, "ubd%d", unit);
 	sprintf(disk->devfs_name, "ubd/disc%d", unit);
 
 	disk->private_data = &ubd_dev[unit];
@@ -527,7 +527,7 @@
 	if(err) 
 		return(err);
  
-	if(fake_major)
+	if(fake_major != MAJOR_NR)
 		ubd_new_disk(fake_major, dev->size, n, 
 			     &fake_gendisk[n]);
 
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
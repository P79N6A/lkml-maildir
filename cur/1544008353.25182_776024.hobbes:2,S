Date: Wed, 3 Dec 2008 10:19:01 +1100
From: Stephen Rothwell <>
Subject: Re: [PATCH linux-next] powerpc/powermac: Add missing of_node_put
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2008/12/2/356

Hi Nicolas,
Thanks for all this work.
I think this particular patch is also required against Linus' kernel (not
just linux-next).
On Tue, 2 Dec 2008 14:45:18 +0100 Nicolas Palix <npalix@diku.dk> wrote:
>
> diff --git a/arch/powerpc/platforms/powermac/pci.c b/arch/powerpc/platforms/powermac/pci.c
> index bcf50d7..800fcce 100644
> --- a/arch/powerpc/platforms/powermac/pci.c
> +++ b/arch/powerpc/platforms/powermac/pci.c
> @@ -661,6 +661,7 @@ static void __init init_second_ohare(void)
>  			pci_find_hose_for_OF_device(np);
>  		if (!hose) {
>  			printk(KERN_ERR "Can't find PCI hose for OHare2 !\n");
> +			of_node_put(np);
>  			return;
>  		}
>  		early_read_config_word(hose, bus, devfn, PCI_COMMAND, &cmd);
> @@ -669,6 +670,7 @@ static void __init init_second_ohare(void)
>  		early_write_config_word(hose, bus, devfn, PCI_COMMAND, cmd);
>  	}
>  	has_second_ohare = 1;
> +	of_node_put(np);
>  }
This part looks good.
> diff --git a/arch/powerpc/platforms/powermac/time.c b/arch/powerpc/platforms/powermac/time.c
> index 59eb840..394593c 100644
> --- a/arch/powerpc/platforms/powermac/time.c
> +++ b/arch/powerpc/platforms/powermac/time.c
> @@ -265,12 +265,14 @@ int __init via_calibrate_decr(void)
>  	struct resource rsrc;
> 
>  	vias = of_find_node_by_name(NULL, "via-cuda");
>  	if (vias == 0)
>  		vias = of_find_node_by_name(NULL, "via-pmu");
>  	if (vias == 0)
>  		vias = of_find_node_by_name(NULL, "via");
>  	if (vias == 0 || of_address_to_resource(vias, 0, &rsrc))
>  		return 0;
> +	of_node_put(vias);
> +
But this needs to also do the of_node_put() if the above "return 0" is
taken i.e. if of_address_to_resource() fails.
-- 
Cheers,
Stephen Rothwell                    sfr@canb.auug.org.au
http://www.canb.auug.org.au/~sfr/
[unhandled content-type:application/pgp-signature]
Date: Mon, 23 Oct 2006 11:23:29 +0200
From: Thomas Zeitlhofer <>
Subject: mkdir on read-only NFS is broken in 2.6.18
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2006/10/23/85

Hello,
there is a problem in 2.6.18/.1 when mkdir is called for an existing
directory on a read-only mounted NFS filesystem.
Lets consider a server that exports the directory /export which contains
the directory-tree a/b/c:
1) If /export is mounted ro and the first access to a, b, or c  is
mkdir, then this directory and all directories underneath become
inaccessible:
  client:# mount server:/export /mnt -o ro
  client:# mkdir /mnt/a/b
  mkdir: cannot create directory `/mnt/a/b': Read-only file system
  client:# find /mnt
  /mnt
  /mnt/a
  find: /mnt/a/b: No such file or directory
2) If /export is mounted ro and the first access to a, b, or c  is _not_
by calling mkdir, then a following mkdir does not destroy the directory
structure (and mkdir now returns EEXIST):
  client:# mount server:/export /mnt -o ro
  client:# find /mnt
  /mnt
  /mnt/a
  /mnt/a/b
  /mnt/a/b/c
  client:# mkdir /mnt/a/b
  mkdir: cannot create directory `/mnt/a/b': File exists
  client:# find /mnt
  /mnt
  /mnt/a
  /mnt/a/b
  /mnt/a/b/c
3) If /export is mounted rw (although exported ro), then mkdir does not
destroy the directory structure:
  client:# mount server:/export /mnt -o rw
  client:# mkdir /mnt/a/b
  mkdir: cannot create directory `/mnt/a/b': Read-only file system
  client:# find /mnt
  /mnt
  /mnt/a
  /mnt/a/b
  /mnt/a/b/c
As a consequence of 1), autofs does not work with mountpoints on NFS
(ro) because the automount daemon calls mkdir for all directories in the
path to the mountpoint. This seems related to the discussion [1], and,
as suggested in [1], the issue is fixed by reverting the patch:
http://kernel.org/git/gitweb.cgi?p=linux/kernel/git/torvalds/linux-2.6.git;a=commitdiff;h=a634904a7de0d3a0bc606f608007a34e8c05bfee;hp=ddeff520f02b92128132c282c350fa72afffb84a
So please consider this patch for the next -stable release:
diff --git a/fs/namei.c b/fs/namei.c
index 432d6bc..5201d77 100644
--- a/fs/namei.c
+++ b/fs/namei.c
@@ -1774,8 +1774,6 @@ struct dentry *lookup_create(struct name
 	if (nd->last_type != LAST_NORM)
 		goto fail;
 	nd->flags &= ~LOOKUP_PARENT;
-	nd->flags |= LOOKUP_CREATE;
-	nd->intent.open.flags = O_EXCL;
 
 	/*
 	 * Do the final lookup.
--
[1] 
http://lkml.org/lkml/2006/9/22/182
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
Date: Fri, 29 Jul 2005 11:31:50 -0700
From: "Martin J. Bligh" <>
Subject: [PATCH] Fix NUMA node sizing in nr_free_zone_pages
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2005/7/29/210

We are iterating over all nodes in nr_free_zone_pages(). Because the 
fallback zonelists contain all nodes in the system, and we walk all
the zonelists, we're counting memory multiple times (once for each
node). This caused us to make a size estimate of 32GB for an 8GB
AMD64 box, which makes all the dirty ratio calculations, etc incorrect.
There's still a further bug to fix from e820 holes causing overestimation
as well, but this fix is separate, and good as is, and fixes one class
of problems. Problem found by Badari, and tested by Ram Pai - thanks!
Signed-off-by:  Martin J. Bligh <mbligh@mbligh.org> 
Signed-off-by:  Matt Dobson <colpatch@us.ibm.com>
diff -purN -X /home/mbligh/.diff.exclude linux-2.6.12/mm/page_alloc.c 2.6.12-nr_free_zone_pages/mm/page_alloc.c
--- linux-2.6.12/mm/page_alloc.c	2005-06-17 17:21:43.000000000 -0700
+++ 2.6.12-nr_free_zone_pages/mm/page_alloc.c	2005-07-28 16:54:03.000000000 -0700
@@ -1006,20 +1006,19 @@ unsigned int nr_free_pages_pgdat(pg_data
 
 static unsigned int nr_free_zone_pages(int offset)
 {
-	pg_data_t *pgdat;
+	/* Just pick one node, since fallback list is circular */
+	pg_data_t *pgdat = NODE_DATA(numa_node_id());
 	unsigned int sum = 0;
 
-	for_each_pgdat(pgdat) {
-		struct zonelist *zonelist = pgdat->node_zonelists + offset;
-		struct zone **zonep = zonelist->zones;
-		struct zone *zone;
+	struct zonelist *zonelist = pgdat->node_zonelists + offset;
+	struct zone **zonep = zonelist->zones;
+	struct zone *zone;
 
-		for (zone = *zonep++; zone; zone = *zonep++) {
-			unsigned long size = zone->present_pages;
-			unsigned long high = zone->pages_high;
-			if (size > high)
-				sum += size - high;
-		}
+	for (zone = *zonep++; zone; zone = *zonep++) {
+		unsigned long size = zone->present_pages;
+		unsigned long high = zone->pages_high;
+		if (size > high)
+			sum += size - high;
 	}
 
 	return sum;
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
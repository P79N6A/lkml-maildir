Date: Thu, 14 Jul 2005 13:31:49 +0200
From: Thomas Hood <>
Subject: Patch to make mount follow a symlink at /etc/mtab
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2005/7/14/59

I attach a patch that modifies the mount program in the util-linux
package so that if /etc/mtab is a symbolic link (to a location outside
of /proc) then mount accesses mtab at the target of the symbolic link.
This feature is useful when the root filesystem is mounted read-only;
/etc/mtab can then be symlinked to a location on a writable filesystem.
In the long run mtab should be eliminated entirely but in the meantime
it is nice to be able to relocate the file.
The patch deals correctly with the fact that mount creates lock files
in the same directory as mtab.
This patch also fixes a bug in umount.c whereby umount will update mtab
in some circumstances even though the -n option has been given.
I wrote the patch in August 2003 and submitted it to the util-linux
maintainer at that time.  He said that he would apply it if it proved
to be reliable after some testing.  The patch has been on my web page
     
http://panopticon.csustan.edu/thood/readonly-root.html
for almost two years since then, updated from time to time as new
versions of util-linux were released.  I have advertised the patch in
various forums and I have used the patch myself for a long time.  No
problems have ever been reported.
The latest version of the patch applies to versions 2.12p and 2.12q.
     util-linux-2.12q-symlinkmtab_jdth20050709.patch
I tested it by patching the latest Debian and Ubuntu packages.  In
order for the latter to build I had to modify 10fstab.dpatch as well.
I attach the patch for that file too.
     util-linux-2.12q-symlinkmtab-10fstab_jdth20050709.patch
-- 
Thomas Hood
--- util-linux-2.12p_ORIG/debian/patches/10fstab.dpatch	2005-07-09 11:47:17.000000000 +0200
+++ util-linux-2.12p/debian/patches/10fstab.dpatch	2005-07-09 16:20:23.000000000 +0200
@@ -12,8 +12,8 @@
  		struct flock flock;
  		int errsv, fd, i, j;
  
--		i = open (linktargetfile, O_WRONLY|O_CREAT, 0);
-+		i = open (linktargetfile, O_WRONLY|O_CREAT, 0600);
+-		i = open (mtab_lock_targ, O_WRONLY|O_CREAT, 0);
++		i = open (mtab_lock_targ, O_WRONLY|O_CREAT, 0600);
  		if (i < 0) {
  			int errsv = errno;
  			/* linktargetfile does not exist (as a file)
Date: Wed, 28 Jan 2009 15:38:56 -0800
From: Jeremy Fitzhardinge <>
Subject: Re: [PATCH RFC WIP] x86/paravirt: add register-saving thunks to	reduce caller register pressure
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2009/1/28/481

Zachary Amsden wrote:
> Enable/Disable have no clobbers at all.
> Save clobbers only return value, %eax
> Restore also clobbers nothing.
>
> The patching code has gotten quite complex with the 32/64 union; let me
> apply it first and see before I comment on the patch.
> 
This gets it to compile.
diff -r 452b0aa6f629 arch/x86/kernel/vmi_32.c
--- a/arch/x86/kernel/vmi_32.c	Wed Jan 28 14:18:52 2009 -0800
+++ b/arch/x86/kernel/vmi_32.c	Wed Jan 28 15:37:54 2009 -0800
@@ -670,10 +670,11 @@
 	para_fill(pv_mmu_ops.write_cr2, SetCR2);
 	para_fill(pv_mmu_ops.write_cr3, SetCR3);
 	para_fill(pv_cpu_ops.write_cr4, SetCR4);
-	para_fill(pv_irq_ops.save_fl, GetInterruptMask);
-	para_fill(pv_irq_ops.restore_fl, SetInterruptMask);
-	para_fill(pv_irq_ops.irq_disable, DisableInterrupts);
-	para_fill(pv_irq_ops.irq_enable, EnableInterrupts);
+
+	para_fill(pv_irq_ops.save_fl.func, GetInterruptMask);
+	para_fill(pv_irq_ops.restore_fl.func, SetInterruptMask);
+	para_fill(pv_irq_ops.irq_disable.func, DisableInterrupts);
+	para_fill(pv_irq_ops.irq_enable.func, EnableInterrupts);
 
 	para_fill(pv_cpu_ops.wbinvd, WBINVD);
 	para_fill(pv_cpu_ops.read_tsc, RDTSC);
    J
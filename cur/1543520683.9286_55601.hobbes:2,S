Date: Wed, 29 Dec 1999 23:01:13 +0100
From: Gerald Haese <>
Subject: Re: Is it just me or did 2.3.32 break md?
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/1999/12/29/72

>Mike Galbraith <mikeg@weiden.de> posted details on one possible
>solution on Dec 17 (Message-ID: <Pine.Linu.4.10.9912170320120.542-100000@mikeg.weiden.de>)
>if it matters...
Yes, it's a quick-hack. But it works (for 2.3.35, too).
Attached to this you can find a patch, but we need a CLEAN solution for the
md-problem ...
Gerald
--- linux/drivers/block/md.c.orig	Fri Dec 24 10:04:44 1999
+++ linux/drivers/block/md.c	Fri Dec 24 10:06:53 1999
@@ -756,14 +756,14 @@
 		}
 		return (md_dev[minor].pers->make_request(md_dev+minor, rw, bh));
 	} else {
-		make_request (MAJOR(bh->b_rdev), rw, bh);
+		make_request_redirect (MAJOR(bh->b_rdev), rw, bh);
 		return 0;
 	}
 }
 
 static void do_md_request (request_queue_t * q)
 {
-  printk ("Got md request, not good...");
+  /* printk ("Got md request, not good..."); */
   return;
 }
 
--- linux/drivers/block/ll_rw_blk.c.orig	Fri Dec 24 10:07:22 1999
+++ linux/drivers/block/ll_rw_blk.c	Fri Dec 24 10:09:45 1999
@@ -785,6 +785,21 @@
 	spin_unlock_irqrestore(&io_request_lock,flags);
 }
 
+void make_request_redirect(int major,int rw,  struct buffer_head * bh)
+{
+	request_queue_t * q;
+	unsigned long flags;
+	
+	q = get_queue(bh->b_rdev);
+
+	__make_request(q, major, rw, bh);
+
+	spin_lock_irqsave(&io_request_lock,flags);
+	if( !q->plugged )
+		(q->request_fn)(q);
+	spin_unlock_irqrestore(&io_request_lock,flags);
+}
+
 
 
 /* This function can be used to request a number of buffers from a block
--- linux/include/linux/blkdev.h.orig	Fri Dec 24 10:10:22 1999
+++ linux/include/linux/blkdev.h	Fri Dec 24 10:10:47 1999
@@ -107,6 +107,7 @@
 extern void resetup_one_dev(struct gendisk *dev, int drive);
 extern void unplug_device(void * data);
 extern void make_request(int major,int rw, struct buffer_head * bh);
+extern void make_request_redirect(int major,int rw, struct buffer_head * bh);
 
 /*
  * Access functions for manipulating queue properties
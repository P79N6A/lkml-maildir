Date: Sat, 22 Sep 2001 23:02:37 -0700
From: "Adam J. Richter" <>
Subject: PATCH: linux-2.4.10-pre14/drivers/sound/maestro.c ignored pci_module_init results
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2001/9/23/125

	The initialization routine in
linux-2.4.10-pre14/drivers/sound/maestro.c ignores the return value
from pci_module_init, and allows module initialization to succeed
even if pci_module_init failed.  pci_module_init fails and unloads
the driver if the caller is a module and there is no matching hardware.
Because maestro.c ignored this failure, loading maestro.o on a system
where the corresponding alsa driver was already loaded or on a system
without matchin hardware would result in a kernel null pointer dereference
in pci_unregister_driver when the module is unloaded or when one
attempts to reboot the system (i.e., when the module attempt to
unregister a PCI driver that is not registered).
	This bug is also present in drivers/net/tlan.c and
drivers/net/irda/toshoboe.c.  I will send patches for them shortly.
	Here is the patch for maestro.c.  Please apply.
-- 
Adam J. Richter     __     ______________   4880 Stevens Creek Blvd, Suite 104
adam@yggdrasil.com     \ /                  San Jose, California 95129-1034
+1 408 261-6630         | g g d r a s i l   United States of America
fax +1 408 261-6631      "Free Software For The Rest Of Us."
--- linux-2.4.10-pre14/drivers/sound/maestro.c	Sun Aug 12 10:51:42 2001
+++ linux/drivers/sound/maestro.c	Sat Sep 22 22:42:48 2001
@@ -3602,7 +3602,12 @@
 
 int __init init_maestro(void)
 {
-	pci_module_init(&maestro_pci_driver);
+	int rc;
+
+	rc = pci_module_init(&maestro_pci_driver);
+	if (rc < 0)
+		return rc;
+
 	if (register_reboot_notifier(&maestro_nb))
 		printk(KERN_WARNING "maestro: reboot notifier registration failed; may not reboot properly.\n");
 #ifdef MODULE
Date: Wed, 11 Apr 2007 12:30:20 +0400
From: Ivan Kokshaysky <>
Subject: [PATCH 6/7] ALPHA: more fixes for specific machine types
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2007/4/11/82

arch/alpha/kernel/sys_sx164.c
	Earlier firmware revisions need MVI fix as well.
arch/alpha/kernel/sys_nautilus.c
	On UP1500 firmware reports wrong AGP IRQ (10 instead of 5).
	This causes interrupt storm if there is a PCI device that
	uses IRQ 5.
Signed-off-by: Ivan Kokshaysky <ink@jurassic.park.msu.ru>
--- linux.orig/arch/alpha/kernel/sys_sx164.c	Thu Jun  1 13:46:21 2006
+++ linux/arch/alpha/kernel/sys_sx164.c	Thu Jun  1 13:46:11 2006
@@ -132,7 +132,7 @@ sx164_init_arch(void)
 
 	if (amask(AMASK_MAX) != 0
 	    && alpha_using_srm
-	    && (cpu->pal_revision & 0xffff) == 0x117) {
+	    && (cpu->pal_revision & 0xffff) <= 0x117) {
 		__asm__ __volatile__(
 		"lda	$16,8($31)\n"
 		"call_pal 9\n"		/* Allow PALRES insns in kernel mode */
--- linux.orig/arch/alpha/kernel/sys_nautilus.c	Tue Apr 10 13:59:43 2007
+++ linux/arch/alpha/kernel/sys_nautilus.c	Tue Apr 10 14:29:55 2007
@@ -70,6 +70,12 @@ nautilus_map_irq(struct pci_dev *dev, u8
 	/* Preserve the IRQ set up by the console.  */
 
 	u8 irq;
+	/* UP1500: AGP INTA is actually routed to IRQ 5, not IRQ 10 as
+	   console reports. Check the device id of AGP bridge to distinguish
+	   UP1500 from UP1000/1100. Note: 'pin' is 2 due to bridge swizzle. */
+	if (slot == 1 && pin == 2 &&
+	    dev->bus->self && dev->bus->self->device == 0x700f)
+		return 5;
 	pci_read_config_byte(dev, PCI_INTERRUPT_LINE, &irq);
 	return irq;
 }
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
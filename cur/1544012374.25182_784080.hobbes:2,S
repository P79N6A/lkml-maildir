Date: Thu, 25 Dec 2008 21:59:56 -0800
From: "Yinghai Lu" <>
Subject: Re: [PATCH for -tip 3/4] proc: remove ifdef CONFIG_SPARSE_IRQ from stat.c
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2008/12/26/4

On Thu, Dec 25, 2008 at 9:24 PM, KOSAKI Motohiro
<kosaki.motohiro@jp.fujitsu.com> wrote:
>> On Thu, Dec 25, 2008 at 8:21 PM, KOSAKI Motohiro
>> <kosaki.motohiro@jp.fujitsu.com> wrote:
>> >> > Subject: [PATCH] proc: remove ifdef CONFIG_SPARSE_IRQ from stat.c
>> >> > Impact: cleanup
>> >> >
>> >> > introduce irq_inuse() macro and remove ifdef in stat.c
>> >>
>> >> should have a good name... irq_inuse is some confusing.
>> >
>> > Why?
>> > May I ask your perfered name?
>>
>> after freeing msi with dynamic_irq_cleanup(), that irq_desc is not used.
>
> hm, instead, How about following patch?
>
>
>
> =======
> Subject: [PATCH] proc: remove ifdef CONFIG_SPARSE_IRQ from stat.c
> Impact: cleanup
>
> irq_desc can be NULL when CONFIG_SPARSE_IRQ=y only.
> therefore, NULL checking can move into kstat_irqs_cpu() of SPARSE_IRQ version.
>
>
> Signed-off-by: KOSAKI Motohiro <kosaki.motohiro@jp.fujitsu.com>
> ---
>  fs/proc/stat.c      |   11 +----------
>  kernel/irq/handle.c |    2 +-
>  2 files changed, 2 insertions(+), 11 deletions(-)
>
> Index: b/fs/proc/stat.c
> ===================================================================
> --- a/fs/proc/stat.c
> +++ b/fs/proc/stat.c
> @@ -9,6 +9,7 @@
>  #include <linux/seq_file.h>
>  #include <linux/slab.h>
>  #include <linux/time.h>
> +#include <linux/irqnr.h>
>  #include <asm/cputime.h>
>
>  #ifndef arch_irq_stat_cpu
> @@ -45,10 +46,6 @@ static int show_stat(struct seq_file *p,
>                steal = cputime64_add(steal, kstat_cpu(i).cpustat.steal);
>                guest = cputime64_add(guest, kstat_cpu(i).cpustat.guest);
>                for_each_irq_nr(j) {
> -#ifdef CONFIG_SPARSE_IRQ
> -                       if (!irq_to_desc(j))
> -                               continue;
> -#endif
>                        sum += kstat_irqs_cpu(j, i);
>                }
>                sum += arch_irq_stat_cpu(i);
> @@ -95,12 +92,6 @@ static int show_stat(struct seq_file *p,
>        /* sum again ? it could be updated? */
>        for_each_irq_nr(j) {
>                per_irq_sum = 0;
> -#ifdef CONFIG_SPARSE_IRQ
> -               if (!irq_to_desc(j)) {
> -                       seq_printf(p, " %u", per_irq_sum);
> -                       continue;
> -               }
> -#endif
>                for_each_possible_cpu(i)
>                        per_irq_sum += kstat_irqs_cpu(j, i);
>
> Index: b/kernel/irq/handle.c
> ===================================================================
> --- a/kernel/irq/handle.c
> +++ b/kernel/irq/handle.c
> @@ -445,7 +445,7 @@ void early_init_irq_lock_class(void)
>  unsigned int kstat_irqs_cpu(unsigned int irq, int cpu)
>  {
>        struct irq_desc *desc = irq_to_desc(irq);
> -       return desc->kstat_irqs[cpu];
> +       return desc ? desc->kstat_irqs[cpu] : 0;
>  }
>  #endif
>  EXPORT_SYMBOL(kstat_irqs_cpu);
>
>
nice. much clean.
YH
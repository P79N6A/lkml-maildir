Date: Tue, 30 Oct 2007 13:01:37 -0700
From: Andrew Morton <>
Subject: Re: [PATCH] Allow auto-destruction of loop devices.
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2007/10/30/409

On Sun, 28 Oct 2007 19:08:31 -0400
David Woodhouse <dwmw2@infradead.org> wrote:
> This allows a flag to be set on loop devices so that when they are
> closed for the last time, they'll self-destruct.
> 
Why do we want to do this?
> 
> diff --git a/drivers/block/loop.c b/drivers/block/loop.c
> index 56e2304..7fae828 100644
> --- a/drivers/block/loop.c
> +++ b/drivers/block/loop.c
> @@ -973,6 +973,10 @@ loop_set_status(struct loop_device *lo, const struct loop_info64 *info)
>  	lo->transfer = xfer->transfer;
>  	lo->ioctl = xfer->ioctl;
> 
> +	if ( (lo->lo_flags & LO_FLAGS_AUTOCLEAR) !=
> +	     (info->lo_flags & LO_FLAGS_AUTOCLEAR))
> +		lo->lo_flags ^= LO_FLAGS_AUTOCLEAR;
> +
>  	lo->lo_encrypt_key_size = info->lo_encrypt_key_size;
>  	lo->lo_init[0] = info->lo_init[0];
>  	lo->lo_init[1] = info->lo_init[1];
> @@ -1331,6 +1335,10 @@ static int lo_release(struct inode *inode, struct file *file)
> 
>  	mutex_lock(&lo->lo_ctl_mutex);
>  	--lo->lo_refcnt;
> +
> +	if ((lo->lo_flags & LO_FLAGS_AUTOCLEAR) && !lo->lo_refcnt)
> +		loop_clr_fd(lo, inode->i_bdev);
> +
>  	mutex_unlock(&lo->lo_ctl_mutex);
> 
>  	return 0;
> diff --git a/include/linux/loop.h b/include/linux/loop.h
> index 26a0a10..46169a7 100644
> --- a/include/linux/loop.h
> +++ b/include/linux/loop.h
> @@ -76,6 +76,7 @@ struct loop_device {
>  enum {
>  	LO_FLAGS_READ_ONLY	= 1,
>  	LO_FLAGS_USE_AOPS	= 2,
> +	LO_FLAGS_AUTOCLEAR	= 4,
>  };
> 
>  #include <asm/posix_types.h>	/* for __kernel_old_dev_t */
> 
> -- 
> dwmw2
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
Date: 28 Mar 2003 04:43:39 +0800
From: Antonino Daplas <>
Subject: Re: [Linux-fbdev-devel] Framebuffer fixes.
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2003/3/27/217

On Thu, 2003-03-27 at 11:01, Antonino Daplas wrote:
> 5. logo fixes 
> 	- forgotten case statement for FB_VISUAL_PSEUDOCOLOR. 
> 
>        - image->depth should be representative of the data depth
> (currently, either 8 or 1).  If image->depth == 1, color expansion can
> now be used to draw the logo, thus there's no need to differentiate
> between mono logo drawing and monochrome expansion.
> 
> 
> The patch is against 2.5.66 + fbdev.diff.gz. 
> 
Grr.  The patch has a few problems...
Tony
diff -Naur linux-2.5.66-orig/drivers/video/console/fbcon.c linux-2.5.66/drivers/video/console/fbcon.c
--- linux-2.5.66-orig/drivers/video/console/fbcon.c	2003-03-27 20:36:06.000000000 +0000
+++ linux-2.5.66/drivers/video/console/fbcon.c	2003-03-27 20:40:53.000000000 +0000
@@ -209,7 +209,7 @@
 		cursor.set = FB_CUR_SETFLASH;
 
 		if (!cursor_drawn)
-			cursor.set = FB_CUR_SETCUR;
+			cursor.set |= FB_CUR_SETCUR;
 		accel_cursor(vc, info, &cursor, real_y(p, vc->vc_y));
 		cursor_drawn ^= 1;
 		vbl_cursor_cnt = cursor_blink_rate;
@@ -597,6 +597,8 @@
 	/* Allocate private data */
 	info->fbcon_priv = kmalloc(sizeof(struct fbcon_private), GFP_KERNEL);
 	if (info->fbcon_priv == NULL) {
+		if (softback_buf)
+			kfree(softback_buf);
 		kfree(vc);
 		return NULL;
 	}
diff -Naur linux-2.5.66-orig/drivers/video/fbmem.c linux-2.5.66/drivers/video/fbmem.c
--- linux-2.5.66-orig/drivers/video/fbmem.c	2003-03-27 20:36:06.000000000 +0000
+++ linux-2.5.66/drivers/video/fbmem.c	2003-03-27 20:37:52.000000000 +0000
@@ -728,17 +728,14 @@
 	 * Monochrome expansion and logo drawing functions are the same if
 	 * fb_logo.needs_logo == 1.
 	 */
-	switch (info->fix.visual) {
-	case FB_VISUAL_MONO10:
+	if (fb_logo.needs_logo == 1) {
 		image.fg_color = (u32) (~(~0UL << fb_logo.depth));
 		image.bg_color = 0;
 		image.depth = 1;
-		break;
-	case FB_VISUAL_MONO01:
-		image.bg_color = (u32) (~(~0UL << fb_logo.depth));
-		image.fg_color = 0;
-		image.depth = 1;
-		break;
+		if (info->fix.visual == FB_VISUAL_MONO01) {
+			image.bg_color = image.fg_color;
+			image.fg_color = 0;
+		}
 	}
 
 	for (x = 0; x < num_online_cpus() * (fb_logo.logo->width + 8) &&
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
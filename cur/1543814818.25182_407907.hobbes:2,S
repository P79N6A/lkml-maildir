Date: Sat, 18 Mar 2006 17:04:44 +0100
From: "Rafael J. Wysocki" <>
Subject: Re: -mm: PM=y, VT=n doesn't compile
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2006/3/18/98

Hi,
On Friday 17 March 2006 18:18, Adrian Bunk wrote:
> swsusp-pm-refuse-to-suspend-devices-if-wrong-console-is-active.patch
> causes the following compile error with CONFIG_PM=y, CONFIG_VT=n:
> 
> <--  snip  -->
> 
> ...
>   LD      .tmp_vmlinux1
> drivers/built-in.o: In function `device_suspend': undefined reference to `fg_console'
> drivers/built-in.o: In function `device_suspend': undefined reference to `vc_cons'
> make: *** [.tmp_vmlinux1] Error 1
> 
> <--  snip  -->
Sorry, I overlooked your message yesterday.  [Actually Andrew turned my
attention to it by dropping the patch from -mm. ;-)]
Fixed version of the patch is appended.
Greetings,
Rafael
---
From: "Rafael J. Wysocki" <rjw@sisk.pl>
1) Remove the console-switching code from the suspend part of the swsusp
   userland interface and let the userland tools switch the console.
2) It is unsafe to suspend devices if the hardware is controlled by X. 
   Add an extra check to prevent this from happening.
Signed-off-by: Rafael J. Wysocki <rjw@sisk.pl>
---
 drivers/base/power/suspend.c |   17 +++++++++++++++++
 kernel/power/user.c          |    3 ---
 2 files changed, 17 insertions(+), 3 deletions(-)
Index: linux-2.6.16-rc6-mm2/drivers/base/power/suspend.c
===================================================================
--- linux-2.6.16-rc6-mm2.orig/drivers/base/power/suspend.c
+++ linux-2.6.16-rc6-mm2/drivers/base/power/suspend.c
@@ -8,6 +8,9 @@
  *
  */
 
+#include <linux/vt_kern.h>
+#include <linux/kbd_kern.h>
+#include <linux/console.h>
 #include <linux/device.h>
 #include <linux/kallsyms.h>
 #include <linux/pm.h>
@@ -65,6 +68,17 @@ int suspend_device(struct device * dev, 
 	return error;
 }
 
+#ifdef CONFIG_VT
+static inline int is_suspend_console_safe(void)
+{
+	/* It is unsafe to suspend devices while X has control of the
+	 * hardware. Make sure we are running on a kernel-controlled console.
+	 */
+	return vc_cons[fg_console].d->vc_mode == KD_TEXT;
+}
+#else
+#define is_suspend_console_safe()	1
+#endif
 
 /**
  *	device_suspend - Save state and stop all devices in system.
@@ -85,6 +99,9 @@ int device_suspend(pm_message_t state)
 {
 	int error = 0;
 
+	if (!is_suspend_console_safe())
+		return -EINVAL;
+
 	down(&dpm_sem);
 	down(&dpm_list_sem);
 	while (!list_empty(&dpm_active) && error == 0) {
Index: linux-2.6.16-rc6-mm2/kernel/power/user.c
===================================================================
--- linux-2.6.16-rc6-mm2.orig/kernel/power/user.c
+++ linux-2.6.16-rc6-mm2/kernel/power/user.c
@@ -138,12 +138,10 @@ static int snapshot_ioctl(struct inode *
 		if (data->frozen)
 			break;
 		down(&pm_sem);
-		pm_prepare_console();
 		disable_nonboot_cpus();
 		if (freeze_processes()) {
 			thaw_processes();
 			enable_nonboot_cpus();
-			pm_restore_console();
 			error = -EBUSY;
 		}
 		up(&pm_sem);
@@ -157,7 +155,6 @@ static int snapshot_ioctl(struct inode *
 		down(&pm_sem);
 		thaw_processes();
 		enable_nonboot_cpus();
-		pm_restore_console();
 		up(&pm_sem);
 		data->frozen = 0;
 		break;
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
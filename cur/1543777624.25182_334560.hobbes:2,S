Date: Fri, 15 Jul 2005 20:04:23 -0700
From: john stultz <>
Subject: [RFC][PATCH - 7/12] NTP cleanup: Cleanup signed shifting logic
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2005/7/15/257

All,
	Signed shifting must be done carefully, and the ntp code has quite a
number of conditionals to do the signed shifting. This patch makes use
of the local shiftR() macro introduced in a previous patch to simplify a
bit of logic.
Any comments or feedback would be greatly appreciated.
thanks
-john
linux-2.6.13-rc3_timeofday-ntp-part7_B4.patch
============================================
diff --git a/kernel/ntp.c b/kernel/ntp.c
--- a/kernel/ntp.c
+++ b/kernel/ntp.c
@@ -165,28 +165,19 @@ void second_overflow(void)
 	}
 
 	ltemp = time_freq;
-	if (ltemp < 0)
-		time_adj -= -ltemp >> (SHIFT_USEC + SHIFT_HZ - SHIFT_SCALE);
-	else
-		time_adj += ltemp >> (SHIFT_USEC + SHIFT_HZ - SHIFT_SCALE);
+	time_adj += shiftR(ltemp, (SHIFT_USEC + SHIFT_HZ - SHIFT_SCALE));
 
 #if HZ == 100
     /* Compensate for (HZ==100) != (1 << SHIFT_HZ).
      * Add 25% and 3.125% to get 128.125; => only 0.125% error (p. 14)
      */
-	if (time_adj < 0)
-		time_adj -= (-time_adj >> 2) + (-time_adj >> 5);
-	else
-		time_adj += (time_adj >> 2) + (time_adj >> 5);
+	time_adj += shiftR(time_adj,2) + shiftR(time_adj,5);
 #endif
 #if HZ == 1000
     /* Compensate for (HZ==1000) != (1 << SHIFT_HZ).
      * Add 1.5625% and 0.78125% to get 1023.4375; => only 0.05% error (p. 14)
      */
-	if (time_adj < 0)
-		time_adj -= (-time_adj >> 6) + (-time_adj >> 7);
-	else
-		time_adj += (time_adj >> 6) + (time_adj >> 7);
+	time_adj += shiftR(time_adj,6) + shiftR(time_adj,7);
 #endif
 }
 
@@ -352,10 +343,7 @@ int ntp_adjtimex(struct timex *txc)
 	if ((txc->modes & ADJ_OFFSET_SINGLESHOT) == ADJ_OFFSET_SINGLESHOT)
 		txc->offset = save_adjust;
 	else {
-		if (time_offset < 0)
-			txc->offset = -(-time_offset >> SHIFT_UPDATE);
-		else
-			txc->offset = time_offset >> SHIFT_UPDATE;
+		txc->offset = shiftR(time_offset, SHIFT_UPDATE);
 	}
 	txc->freq = time_freq;
 	txc->maxerror = time_maxerror;
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
Date: Tue, 26 Apr 2005 23:42:41 +0200
From: Frederik Deweerdt <>
Subject: Re: [PATCH] Don't oops when unregistering unknown kprobes
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2005/4/26/296

Le 26/04/05 21:57 +0530, Prasanna S Panchamukhi Ã©crivit:
> This is wrong. You should call get_kprobe() with spin_lock().
> 
Right, corrected patch attached. It also sets flags to zero.
Signed-off-by: Frederik Deweerdt <frederik.deweerdt@laposte.net>
Regards,
Frederik
-- 
o----------------------------------------------o
| 
http://open-news.net
 : l'info alternative    |
| Tech - Sciences - Politique - International  |
o----------------------------------------------o
--- linux-2.6.12-rc3/kernel/kprobes.c	2005-04-26 16:35:22.000000000 +0200
+++ linux-2.6.12-rc3-devel/kernel/kprobes.c	2005-04-26 23:18:47.000000000 +0200
@@ -106,13 +106,22 @@ rm_kprobe:
 
 void unregister_kprobe(struct kprobe *p)
 {
-	unsigned long flags;
+	unsigned long flags = 0;
+
+	spin_lock_irqsave(&kprobe_lock, flags);
+	if (!get_kprobe(p)) {
+		printk(KERN_WARNING "Warning: Attempt to unregister "
+					"unknown kprobe (addr:0x%lx)\n",
+					(unsigned long) p);
+		goto out;
+	}
 	arch_remove_kprobe(p);
 	spin_lock_irqsave(&kprobe_lock, flags);
 	*p->addr = p->opcode;
 	hlist_del(&p->hlist);
 	flush_icache_range((unsigned long) p->addr,
 			   (unsigned long) p->addr + sizeof(kprobe_opcode_t));
+out:
 	spin_unlock_irqrestore(&kprobe_lock, flags);
 }
 
Date: Mon, 14 May 2007 00:50:57 +0400
From: Oleg Nesterov <>
Subject: Re: 2.6.22-rc1: Broken suspend on SMP with tifm
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2007/5/13/184

On 05/13, Rafael J. Wysocki wrote:
>
> On Sunday, 13 May 2007 22:30, Oleg Nesterov wrote:
> > > 
> > > > --- linux-2.6.22-rc1.orig/kernel/workqueue.c
> > > > +++ linux-2.6.22-rc1/kernel/workqueue.c
> > > > @@ -799,9 +799,7 @@ static int __devinit workqueue_cpu_callb
> > > >  	struct cpu_workqueue_struct *cwq;
> > > >  	struct workqueue_struct *wq;
> > > > 
> > > > -	action &= ~CPU_TASKS_FROZEN;
> > > > -
> > > > -	switch (action) {
> > > > +	switch (action & ~CPU_TASKS_FROZEN) {
> > > 
> > > Confused. How can we see, say CPU_UP_PREPARE_FROZEN, if we cleared
> > > CPU_TASKS_FROZEN bit?
> > 
> > So, unless I missed something stupid, this patch is not 100% right.
> 
> Well, it isn't, but for a different reason (see [*] below).
Yes, I missed something stupid :)
> > I think the better fix (at least for now) is
> > 
> > 	- #define create_freezeable_workqueue(name) __create_workqueue((name), 0, 1)
> > 	+ #define create_freezeable_workqueue(name) __create_workqueue((name), 1, 1)
> > 
> > Alex, do you really need a multithreaded wq?
> > 
> > Rafael, what do you think?
> 
> That would be misleading if the driver needs the threads to be frozen.
Hm? The thread will be frozen, the "patch" above changes "singlethread", not
"freezeable".
> [*] Getting back to the patch, it seems to me that we should do something like
> take_over_work() before thawing the frozen thread, because there may be a queue
> to process and the device is suspended at that point.
Yes, exactly because the driver wants this wq to be frozen.
So, could you take a second look at the "patch" above ?
Oleg.
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
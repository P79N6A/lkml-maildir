Date: Mon, 7 Jun 1999 14:41:47 +0200 (CEST)
From: Ingo Molnar <>
Subject: Re: 2.2.9-ac2 locks solid
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/1999/6/7/75

anyway, the attached patch changes the assignment to be a locked OR. (the
TLB flush code could be optimized further, but we dont want to do that for
2.2) George, does this patch make any difference? (if Alan's previous
patch did not help) 
-- mingo
--- linux/arch/i386/kernel/smp.c.orig3	Mon Jun  7 13:25:54 1999
+++ linux/arch/i386/kernel/smp.c	Mon Jun  7 13:28:05 1999
@@ -1590,7 +1590,10 @@
 		 * locked or.
 		 */
 
-		smp_invalidate_needed = cpu_online_map;
+		asm volatile ( "lock; orl %1, %0"
+			:"=m"(smp_invalidate_needed)
+			:"r"(cpu_online_map)
+		);
 
 		/*
 		 * Processors spinning on some lock with IRQs disabled
@@ -1614,7 +1617,7 @@
 			 * Take care of "crossing" invalidates
 			 */
 			if (test_bit(cpu, &smp_invalidate_needed))
-			clear_bit(cpu, &smp_invalidate_needed);
+				clear_bit(cpu, &smp_invalidate_needed);
 			--stuck;
 			if (!stuck) {
 				printk("stuck on TLB IPI wait (CPU#%d)\n",cpu);
Date: Fri, 16 Jan 2009 06:55:13 +0100
From: Oleg Nesterov <>
Subject: [PATCH 1/3] pids: document task_pgrp/task_session is not safe without tasklist/rcu
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2009/1/16/7

Even if task == current, it is not safe to dereference the result of
task_pgrp/task_session. We can race with another thread which changes
the special pid via setpgid/setsid.
Document this. The next 2 patches give an example of the unsafe usage,
we have more bad users.
Signed-off-by: Oleg Nesterov <oleg@redhat.com>
--- CUR/include/linux/sched.h~SP_1_COMMENT	2009-01-12 23:07:48.000000000 +0100
+++ CUR/include/linux/sched.h	2009-01-16 02:13:50.000000000 +0100
@@ -1449,6 +1449,13 @@ static inline struct pid *task_tgid(stru
 	return task->group_leader->pids[PIDTYPE_PID].pid;
 }
 
+/*
+ * Without tasklist or rcu lock it is not safe to dereference
+ * the result of task_pgrp/task_session even if task == current,
+ * we can race with another thread doing sys_setsid/sys_setpgid.
+ *
+ */
+
 static inline struct pid *task_pgrp(struct task_struct *task)
 {
 	return task->group_leader->pids[PIDTYPE_PGID].pid;
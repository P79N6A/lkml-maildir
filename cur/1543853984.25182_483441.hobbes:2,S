Date: Fri, 17 Nov 2006 16:13:14 +0000
From: Russell King <>
Subject: Re: [patch 5/6] [RFC] Add MMC Password Protection (lock/unlock) support V6
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2006/11/17/160

On Fri, Nov 17, 2006 at 09:12:39AM -0400, Anderson Briglia wrote:
> +	if (mmc_card_locked(card) && !strncmp(data, "erase", 5)) {
> +		/* forced erase only works while card is locked */
> +		spin_lock(&mmc_lock);
> +		mmc_lock_unlock(card, NULL, MMC_LOCK_MODE_ERASE);
> +		spin_unlock(&mmc_lock);
mmc_lock_unlock can sleep; holding a spinlock while sleeping is illegal
and is a serious bug.  Inappropriate locking?  What's this lock trying
to achieve?
I don't see any requirement for locking here - mmc_lock_unlock() claims
the host, and if that succeeds, it has exclusive access via that host to
the card.  No one else will be able to talk on the bus until
mmc_lock_unlock() releases it's claim on the host.  So I suspect that
whatever locking you require is already in place.
Ditto for each other instances.
-- 
Russell King
 Linux kernel    2.6 ARM Linux   - 
http://www.arm.linux.org.uk/
 maintainer of:  2.6 Serial core
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
Date: Thu, 13 Dec 2007 22:31:35 +0100
From: Marcin Slusarz <>
Subject: Re: [PATCH] logo: move declarations of logos to linux_logo.h
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2007/12/13/439

On Thu, Dec 13, 2007 at 02:31:11AM -0800, Andrew Morton wrote:
> On Sun, 9 Dec 2007 22:40:31 +0100 Marcin Åšlusarz <marcin.slusarz@gmail.com> wrote:
>
> > logo: move declarations of logos to linux_logo.h
> >
> > there was a mismatch between externs in logo.c and code generated by pnmtologo
> > (on old tree, you need to rm drivers/video/logo/logo_*.c before compilation)
>
> This patch (after I fixed it) keeps on causing trouble: mismatches between
> the header file declarations and the actual definitions of the lookup
> tables.  This happens as I apply and unapply the patch.
>
> It _shouldn't_ happen, but there would appear to be some missing makefile
> rules.  I guess the C files aren't being regenerated when
> scripts/pnmtologo.c has been altered, so the C files aren't matching the
> header which this patch alters.
Ok, updated patch below:
logo: move declarations of logos to linux_logo.h
there was a mismatch between externs in logo.c and code generated by pnmtologo
Signed-off-by: Marcin Slusarz <marcin.slusarz@gmail.com>
CC: Antonino Daplas <adaplas@gmail.com>
CC: Andrew Morton <akpm@linux-foundation.org>
CC: Sam Ravnborg <sam@ravnborg.org>
---
 drivers/video/logo/Makefile |    8 ++++----
 drivers/video/logo/logo.c   |   13 -------------
 include/linux/linux_logo.h  |   13 +++++++++++++
 scripts/pnmtologo.c         |    6 +++---
 4 files changed, 20 insertions(+), 20 deletions(-)
diff --git a/drivers/video/logo/Makefile b/drivers/video/logo/Makefile
index a5fc4ed..61b8c24 100644
--- a/drivers/video/logo/Makefile
+++ b/drivers/video/logo/Makefile
@@ -41,16 +41,16 @@ quiet_cmd_logo = LOGO    $@
 			-t $(patsubst $*_%,%,$(notdir $(basename $<))) \
 			-n $(notdir $(basename $<)) -o $@ $<
-$(obj)/%_mono.c: $(src)/%_mono.pbm FORCE
+$(obj)/%_mono.c: $(src)/%_mono.pbm scripts/pnmtologo FORCE
 	$(call if_changed,logo)
-$(obj)/%_vga16.c: $(src)/%_vga16.ppm FORCE
+$(obj)/%_vga16.c: $(src)/%_vga16.ppm scripts/pnmtologo FORCE
 	$(call if_changed,logo)
-$(obj)/%_clut224.c: $(src)/%_clut224.ppm FORCE
+$(obj)/%_clut224.c: $(src)/%_clut224.ppm scripts/pnmtologo FORCE
 	$(call if_changed,logo)
-$(obj)/%_gray256.c: $(src)/%_gray256.pgm FORCE
+$(obj)/%_gray256.c: $(src)/%_gray256.pgm scripts/pnmtologo FORCE
 	$(call if_changed,logo)
 # Files generated that shall be removed upon make clean
diff --git a/drivers/video/logo/logo.c b/drivers/video/logo/logo.c
index fc72684..f5a0cd3 100644
--- a/drivers/video/logo/logo.c
+++ b/drivers/video/logo/logo.c
@@ -21,19 +21,6 @@
 #include <asm/bootinfo.h>
 #endif
-extern const struct linux_logo logo_linux_mono;
-extern const struct linux_logo logo_linux_vga16;
-extern const struct linux_logo logo_linux_clut224;
-extern const struct linux_logo logo_dec_clut224;
-extern const struct linux_logo logo_mac_clut224;
-extern const struct linux_logo logo_parisc_clut224;
-extern const struct linux_logo logo_sgi_clut224;
-extern const struct linux_logo logo_sun_clut224;
-extern const struct linux_logo logo_superh_mono;
-extern const struct linux_logo logo_superh_vga16;
-extern const struct linux_logo logo_superh_clut224;
-extern const struct linux_logo logo_m32r_clut224;
-
 static int nologo;
 module_param(nologo, bool, 0);
 MODULE_PARM_DESC(nologo, "Disables startup logo");
diff --git a/include/linux/linux_logo.h b/include/linux/linux_logo.h
index 08a9296..da9fb79 100644
--- a/include/linux/linux_logo.h
+++ b/include/linux/linux_logo.h
@@ -42,4 +42,17 @@ static inline void fb_append_extra_logo(const struct linux_logo *logo,
 {}
 #endif
+extern const struct linux_logo logo_linux_mono;
+extern const struct linux_logo logo_linux_vga16;
+extern const struct linux_logo logo_linux_clut224;
+extern const struct linux_logo logo_dec_clut224;
+extern const struct linux_logo logo_mac_clut224;
+extern const struct linux_logo logo_parisc_clut224;
+extern const struct linux_logo logo_sgi_clut224;
+extern const struct linux_logo logo_sun_clut224;
+extern const struct linux_logo logo_superh_mono;
+extern const struct linux_logo logo_superh_vga16;
+extern const struct linux_logo logo_superh_clut224;
+extern const struct linux_logo logo_m32r_clut224;
+
 #endif /* _LINUX_LINUX_LOGO_H */
diff --git a/scripts/pnmtologo.c b/scripts/pnmtologo.c
index 6aa2a24..3048431 100644
--- a/scripts/pnmtologo.c
+++ b/scripts/pnmtologo.c
@@ -237,14 +237,14 @@ static void write_header(void)
     fprintf(out, " *  Linux logo %s\n", logoname);
     fputs(" */\n\n", out);
     fputs("#include <linux/linux_logo.h>\n\n", out);
-    fprintf(out, "static unsigned char %s_data[] __initdata = {\n",
+    fprintf(out, "static const unsigned char %s_data[] __initdata = {\n",
 	    logoname);
 }
 static void write_footer(void)
 {
     fputs("\n};\n\n", out);
-    fprintf(out, "struct linux_logo %s __initdata = {\n", logoname);
+    fprintf(out, "const struct linux_logo %s __initdata = {\n", logoname);
     fprintf(out, "    .type\t= %s,\n", logo_types[logo_type]);
     fprintf(out, "    .width\t= %d,\n", logo_width);
     fprintf(out, "    .height\t= %d,\n", logo_height);
@@ -374,7 +374,7 @@ static void write_logo_clut224(void)
     fputs("\n};\n\n", out);
     /* write logo clut */
-    fprintf(out, "static unsigned char %s_clut[] __initdata = {\n",
+    fprintf(out, "static const unsigned char %s_clut[] __initdata = {\n",
 	    logoname);
     write_hex_cnt = 0;
     for (i = 0; i < logo_clutsize; i++) {
--
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
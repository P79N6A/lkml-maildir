Date: Thu, 18 Oct 2007 16:18:10 +0200
From: Takashi Iwai <>
Subject: Re: [patch] snd: fix build bug with	CONFIG_SND_HDA_CODEC_SIGMATEL=y && !CONFIG_SND_HDA_GENERIC
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2007/10/18/258

At Thu, 18 Oct 2007 16:54:58 +0200,
Ingo Molnar wrote:
> 
> 
> * Takashi Iwai <tiwai@suse.de> wrote:
> 
> > +++ b/sound/pci/hda/patch_sigmatel.c	Thu Oct 18 16:23:22 2007 +0200
> > @@ -3062,9 +3062,16 @@ static int patch_stac9872(struct hda_cod
> >  	board_config = snd_hda_check_board_config(codec, STAC_9872_MODELS,
> >  						  stac9872_models,
> >  						  stac9872_cfg_tbl);
> > -	if (board_config < 0)
> > +	if (board_config < 0) {
> > +		printk(KERN_WARNING "hda-codec: "
> > +		       "found unknown STAC9872 device\n");
> > +#ifdef CONFIG_SND_HDA_GENERIC
> >  		/* unknown config, let generic-parser do its job... */
> >  		return snd_hda_parse_generic_codec(codec);
> > +#else
> > +		return -ENODEV;
> > +#endif
> 
> pushing an #ifdef into a driver is quite unclean, if then you should 
> define snd_hda_parse_generic_codec() in a header as a -ENODEV inline 
> function if !CONFIG_SND_HDA_GENERIC.
Fair enough.  The revised patch is below.  This cleans up the ifdefs
in another place, too.
Takashi
diff -r fb9512ce24e0 pci/hda/hda_codec.c
--- a/pci/hda/hda_codec.c	Thu Oct 18 10:48:43 2007 +0200
+++ b/pci/hda/hda_codec.c	Thu Oct 18 17:06:44 2007 +0200
@@ -626,24 +626,19 @@ int __devinit snd_hda_codec_new(struct h
 		snd_hda_get_codec_name(codec, bus->card->mixername,
 				       sizeof(bus->card->mixername));
 
-#ifdef CONFIG_SND_HDA_GENERIC
 	if (is_generic_config(codec)) {
 		err = snd_hda_parse_generic_codec(codec);
 		goto patched;
 	}
-#endif
 	if (codec->preset && codec->preset->patch) {
 		err = codec->preset->patch(codec);
 		goto patched;
 	}
 
 	/* call the default parser */
-#ifdef CONFIG_SND_HDA_GENERIC
 	err = snd_hda_parse_generic_codec(codec);
-#else
-	printk(KERN_ERR "hda-codec: No codec parser is available\n");
-	err = -ENODEV;
-#endif
+	if (err < 0)
+		printk(KERN_ERR "hda-codec: No codec parser is available\n");
 
  patched:
 	if (err < 0) {
diff -r fb9512ce24e0 pci/hda/hda_local.h
--- a/pci/hda/hda_local.h	Thu Oct 18 10:48:43 2007 +0200
+++ b/pci/hda/hda_local.h	Thu Oct 18 17:06:44 2007 +0200
@@ -245,7 +245,14 @@ int snd_hda_multi_out_analog_cleanup(str
 /*
  * generic codec parser
  */
+#ifdef CONFIG_SND_HDA_GENERIC
 int snd_hda_parse_generic_codec(struct hda_codec *codec);
+#else
+static int snd_hda_parse_generic_codec(struct hda_codec *codec)
+{
+	return -ENODEV;
+}
+#endif
 
 /*
  * generic proc interface
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
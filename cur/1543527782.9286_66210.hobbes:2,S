Date: Mon, 28 Feb 2000 12:48:29 +0300
From: Andrey Panin <>
Subject: [PATCH] Debugging messages compacting
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2000/2/28/25

Hi all,
this small and self explaining patch, reduce kernel image 
size (uncompressed) by several kiloBytes.
It replaces some debugging messages spread around kernel image
("wq bug, forcing oops", "kernel bug at %s" etc.) with 
4 string placed in messages.c file.
Best wishes,
		Andrey
P.S. Sorry for bad English
diff -u -r -N /mnt/d/linux-2.3.47/include/asm-i386/page.h /linux/include/asm-i386/page.h
--- /mnt/d/linux-2.3.47/include/asm-i386/page.h	Fri Feb 25 23:43:14 2000
+++ /linux/include/asm-i386/page.h	Sun Feb 27 14:18:21 2000
@@ -85,8 +85,9 @@
  * Tell the user there is some problem. Beep too, so we can
  * see^H^H^Hhear bugs in early bootup as well!
  */
+extern char *kernel_bug;
 #define BUG() do { \
-	printk("kernel BUG at %s:%d!\n", __FILE__, __LINE__); \
+	printk(kernel_bug, __FILE__, __LINE__); \
 	__asm__ __volatile__(".byte 0x0f,0x0b"); \
 } while (0)
 
diff -u -r -N /mnt/d/linux-2.3.47/include/asm-ia64/page.h /linux/include/asm-ia64/page.h
--- /mnt/d/linux-2.3.47/include/asm-ia64/page.h	Fri Feb 25 23:43:32 2000
+++ /linux/include/asm-ia64/page.h	Sun Feb 27 16:05:02 2000
@@ -124,7 +124,8 @@
 #define __pa(x)		({ia64_va _v; _v.l = (long) (x); _v.f.reg = 0; _v.l;})
 #define __va(x)		({ia64_va _v; _v.l = (long) (x); _v.f.reg = -1; _v.p;})
 
-#define BUG() do { printk("kernel BUG at %s:%d!\n", __FILE__, __LINE__); *(int *)0=0; } while (0)
+extern char *kernel_bug;
+#define BUG() do { printk(kernel_bug, __FILE__, __LINE__); *(int *)0=0; } while (0)
 #define PAGE_BUG(page) do { BUG(); } while (0)
 
 extern __inline__ int get_order(unsigned long size)
diff -u -r -N /mnt/d/linux-2.3.47/include/asm-m68k/page.h /linux/include/asm-m68k/page.h
--- /mnt/d/linux-2.3.47/include/asm-m68k/page.h	Fri Feb 25 23:43:20 2000
+++ /linux/include/asm-m68k/page.h	Sun Feb 27 16:07:29 2000
@@ -158,14 +158,15 @@
 
 #define MAP_NR(addr)		(((unsigned long)(addr)-PAGE_OFFSET) >> PAGE_SHIFT)
 
+extern char *kernel_bug;
 #ifndef CONFIG_SUN3
 #define BUG() do { \
-	printk("kernel BUG at %s:%d!\n", __FILE__, __LINE__); \
+	printk(kernel_bug, __FILE__, __LINE__); \
 	asm volatile("illegal"); \
 } while (0)
 #else
 #define BUG() do { \
-	printk("kernel BUG at %s:%d!\n", __FILE__, __LINE__); \
+	printk(kernel_bug, __FILE__, __LINE__); \
 	panic("BUG!"); \
 } while (0)
 #endif
diff -u -r -N /mnt/d/linux-2.3.47/include/asm-ppc/page.h /linux/include/asm-ppc/page.h
--- /mnt/d/linux-2.3.47/include/asm-ppc/page.h	Fri Feb 25 23:43:24 2000
+++ /linux/include/asm-ppc/page.h	Sun Feb 27 16:10:07 2000
@@ -14,14 +14,15 @@
 #ifndef __ASSEMBLY__
 #ifdef __KERNEL__
 
+extern char *kernel_bug;
 #ifdef CONFIG_XMON
 #define BUG() do { \
-	printk("kernel BUG at %s:%d!\n", __FILE__, __LINE__); \
+	printk(kernel_bug, __FILE__, __LINE__); \
 	xmon(0); \
 } while (0)
 #else
 #define BUG() do { \
-	printk("kernel BUG at %s:%d!\n", __FILE__, __LINE__); \
+	printk(kernel_bug, __FILE__, __LINE__); \
 	__asm__ __volatile__(".long 0x0"); \
 } while (0)
 #endif
diff -u -r -N /mnt/d/linux-2.3.47/include/asm-sh/page.h /linux/include/asm-sh/page.h
--- /mnt/d/linux-2.3.47/include/asm-sh/page.h	Fri Feb 25 23:43:32 2000
+++ /linux/include/asm-sh/page.h	Sun Feb 27 16:10:42 2000
@@ -68,8 +68,9 @@
 /*
  * Tell the user there is some problem.
  */
+extern char *kernel_bug;
 #define BUG() do { \
-	printk("kernel BUG at %s:%d!\n", __FILE__, __LINE__); \
+	printk(kernel_bug, __FILE__, __LINE__); \
 	asm volatile("nop"); \
 } while (0)
 
diff -u -r -N /mnt/d/linux-2.3.47/include/asm-sparc/page.h /linux/include/asm-sparc/page.h
--- /mnt/d/linux-2.3.47/include/asm-sparc/page.h	Fri Feb 25 23:43:20 2000
+++ /linux/include/asm-sparc/page.h	Sun Feb 27 16:11:18 2000
@@ -27,7 +27,8 @@
 
 #ifndef __ASSEMBLY__
 
-#define BUG() do { printk("kernel BUG at %s:%d!\n", __FILE__, __LINE__); *(int *)0=0; } while (0)
+extern char *kernel_bug;
+#define BUG() do { printk(kernel_bug, __FILE__, __LINE__); *(int *)0=0; } while (0)
 
 #define PAGE_BUG(page) do { \
 	BUG(); \
diff -u -r -N /mnt/d/linux-2.3.47/include/linux/wait.h /linux/include/linux/wait.h
--- /mnt/d/linux-2.3.47/include/linux/wait.h	Fri Feb 25 23:43:04 2000
+++ /linux/include/linux/wait.h	Sun Feb 27 15:02:26 2000
@@ -24,17 +24,20 @@
 
 #if WAITQUEUE_DEBUG
 extern int printk(const char *fmt, ...);
+extern char *wq_bug;
 #define WQ_BUG() do { \
-	printk("wq bug, forcing oops.\n"); \
+	printk(wq_bug); \
 	*(int*)0 = 0; \
 } while (0)
 
+extern char *bad_magic1;
+extern char *bad_magic2;
 #define CHECK_MAGIC(x) if (x != (long)&(x)) \
-	{ printk("bad magic %lx (should be %lx), ", (long)x, (long)&(x)); WQ_BUG(); }
+	{ printk(bad_magic2, (long)x, (long)&(x)); WQ_BUG(); }
 
 #define CHECK_MAGIC_WQHEAD(x) do { \
 	if (x->__magic != (long)&(x->__magic)) { \
-		printk("bad magic %lx (should be %lx, creator %lx), ", \
+		printk(bad_magic1, \
 			x->__magic, (long)&(x->__magic), x->__creator); \
 		WQ_BUG(); \
 	} \
diff -u -r -N /mnt/d/linux-2.3.47/kernel/Makefile /linux/kernel/Makefile
--- /mnt/d/linux-2.3.47/kernel/Makefile	Fri Feb 25 23:43:02 2000
+++ /linux/kernel/Makefile	Sun Feb 27 14:31:43 2000
@@ -13,7 +13,7 @@
 O_TARGET := kernel.o
 O_OBJS    = sched.o dma.o fork.o exec_domain.o panic.o printk.o sys.o \
 	    module.o exit.o itimer.o info.o time.o softirq.o resource.o \
-	    sysctl.o acct.o capability.o ptrace.o timer.o
+	    sysctl.o acct.o capability.o ptrace.o timer.o messages.o
 
 OX_OBJS  += signal.o
 
@@ -26,7 +26,7 @@
 endif
 
 ifeq ($(CONFIG_MODULES),y)
-OX_OBJS  += ksyms.o
+OX_OBJS  += ksyms.o messages.o
 endif
 
 ifdef CONFIG_ACPI
diff -u -r -N /mnt/d/linux-2.3.47/kernel/messages.c /linux/kernel/messages.c
--- /mnt/d/linux-2.3.47/kernel/messages.c	Thu Jan  1 03:00:00 1970
+++ /linux/kernel/messages.c	Sun Feb 27 15:37:56 2000
@@ -0,0 +1,21 @@
+/*
+ * linux/kernel/messages.c
+ *
+ * This file contains various debugging messages.
+ * Gathered here by Andrey Panin <pazke@orbita.don.sitek.net>
+ */
+
+#include <linux/module.h>
+
+char *kernel_bug = "kernel BUG at %s:%d!\n";
+
+char *wq_bug = "wq bug, forcing oops.\n";
+
+char *bad_magic1 = "bad magic %lx (should be %lx, creator %lx), ";
+
+char *bad_magic2 = "bad magic %lx (should be %lx), ";
+
+EXPORT_SYMBOL(kernel_bug);
+EXPORT_SYMBOL(wq_bug);
+EXPORT_SYMBOL(bad_magic1);
+EXPORT_SYMBOL(bad_magic2);
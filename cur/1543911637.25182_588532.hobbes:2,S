Date: Sat, 25 Aug 2007 14:23:24 +0200
From: Frederik Deweerdt <>
Subject: Re: [-mm patch] enforce noreplace-smp in alternative_instructions()
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2007/8/25/67

On Sat, Aug 25, 2007 at 10:07:29PM +1000, Rusty Russell wrote:
> On Fri, 2007-08-24 at 10:22 +0200, Frederik Deweerdt wrote:
> > [Added Gerd Hoffman and Rusty Russel to cc]
> > On Thu, Aug 23, 2007 at 11:46:52PM -0700, Jeremy Fitzhardinge wrote:
> > > Frederik Deweerdt wrote:
> > > > That means that even when you specify noreplace_smp, some replacing
> > > > takes place anyway. One of the consequences, besides noreplace_smp not
> > > > working as expected, is that lguest crashes when you feed it an SMP kernel
> > > > (I suspect that you can not replace alternatives for smp _and_ paravirt).
> > > > 
> > > 
> > > No, that should be fine.  Why does lguest crash?
> > It dies with:
> > [    0.131000] SMP alternatives: switching to UP code
> > lguest: bad stack page 0xc057a000
Hello Rusty,
> 
> How odd!  This means that the guest set the kernel to a stack which it
> hadn't mapped writable (or perhaps not mapped at all).  I always run SMP
I had time to investigate this a little further, it appears that in fact
0xc057a000 is the beginning of the __smp_locks section.
The crash responsible function call is in alternative_instructions():
		free_init_pages("SMP alternatives",
				(unsigned long)__smp_locks,
				(unsigned long)__smp_locks_end);
Ie, if I comment this out, I can boot lguest without passing
noreplace_smp.
BTW, to make things clear: the patch I sent does _not_ fix the
lguest/alternatives problem. It just makes noreplace_smp functional
again and hence allows working around the lguest/alternatives bug.
> kernels, and that seems a very strange side effect of a patching
> problem...
> 
> Nonetheless, I did have a previous problem with a bug in the patching
> code which didn't show up native and did show up under lguest.
> 
> Can you send your config? 
Here it is:
http://fdeweerdt.free.fr/lguest_smp/dot_config
> Do you need noreplace-smp even on 2.6.23-rc3,
> or only 2.6.23-rc3-mm1?
I'll try ASAP.
Thanks,
Frederik
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
Date: Thu, 17 Jan 2008 21:42:41 +0530
From: Balaji Rao <>
Subject: Re: hpet_late_init hang
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2008/1/17/161

On Thursday 17 January 2008 03:09:42 am Yinghai Lu wrote:
> > Looks like IRQ 31 is assigned to timer 3, even without the patch! I wonder who wrote the number 31. But the manual says
> > that it is zero by default.
> >
> > I think we should check whether the timer has been allocated an IRQ before proceeding to assign one to it.
> > Here is a patch that does this.
> >
> > Yinghai, could you please apply this on top of my patch and check ?
> >
> > ---
> > Index: linux-2.6/arch/x86/kernel/hpet.c
> > ===================================================================
> > --- linux-2.6.orig/arch/x86/kernel/hpet.c
> ...
> >
> 
> it works
> 
Cool!
Ingo, here's the patch with the SOB. Please apply.
regards,
balaji rao
Check if there's an IRQ assigned to the timer before assigning one.
Signed-off-by: Balaji Rao <balajirrao@gmail.com>
Index: linux-2.6/arch/x86/kernel/hpet.c
===================================================================
--- linux-2.6.orig/arch/x86/kernel/hpet.c
+++ linux-2.6/arch/x86/kernel/hpet.c
@@ -116,7 +116,8 @@ int is_hpet_enabled(void)
 static void hpet_reserve_platform_timers(unsigned long id)
 {
        struct hpet __iomem *hpet = hpet_virt_address;
-       unsigned int nrtimers;
+       struct hpet_timer __iomem *timer = &hpet->hpet_timers[2];
+       unsigned int nrtimers, i;
        struct hpet_data hd;
 
        nrtimers = ((id & HPET_ID_NUMBER) >> HPET_ID_NUMBER_SHIFT) + 1;
@@ -134,10 +135,9 @@ static void hpet_reserve_platform_timers
        hd.hd_irq[0] = HPET_LEGACY_8254;
        hd.hd_irq[1] = HPET_LEGACY_RTC;
 
-       /*
-        * IRQs for the other timers are assigned dynamically
-        * in hpet_alloc
-        */
+       for (i = 2; i < nrtimers; timer++, i++)
+              hd.hd_irq[i] = (timer->hpet_config & Tn_INT_ROUTE_CNF_MASK) >>
+                      Tn_INT_ROUTE_CNF_SHIFT;
        hpet_alloc(&hd);
 }
 #else
Index: linux-2.6/drivers/char/hpet.c
===================================================================
--- linux-2.6.orig/drivers/char/hpet.c
+++ linux-2.6/drivers/char/hpet.c
@@ -852,6 +852,12 @@ int hpet_alloc(struct hpet_data *hdp)
 
                timer = &hpet->hpet_timers[devp - hpetp->hp_dev];
 
+               /* Check if there's already an IRQ assigned to the timer */
+               if (hdp->hd_irq[i]) {
+                       hpetp->hp_dev[i].hd_hdwirq = hdp->hd_irq[i];
+                       continue;
+               }
+
                hpet_config = readq(&timer->hpet_config);
                irq_bitmap = (hpet_config & Tn_INT_ROUTE_CAP_MASK)
                        >> Tn_INT_ROUTE_CAP_SHIFT;
--
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
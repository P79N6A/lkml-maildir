Date: Tue, 5 Jun 2001 19:50:46 +0200
From: Trond Myklebust <>
Subject: [PATCH 2.4.5] Fix NFS Oops w.r.t. unhashed inodes
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2001/6/5/93

Hi Linus,
  One consequence of the removal of the 'put_inode: force_delete' made for
2.4.5 mmap() is that we now use the 'magic nfs' codepath in
iput(). The result is that when we unhash inodes due to staleness in
nfs_revalidate_inode(), we now end up calling clear_inode() in iput
without first calling truncate_inode_pages(), and thus trigger the
BUG() on line 486 in fs/inode.c.
  After discussion with Al, I think the minimal solution would be to
add a call to truncate_inode_pages() to the magic nfs code. To do the
call in nfs_revalidate_inode() itself (Al's suggestion) would be racy
w.r.t. adding pages in read or write itself.
  A second consequence of the removal of force_delete was the fact
that file or directory deletion no longer results in the inode getting
thrown out of the icache upon last iput(). This gave problems due to
inode number reuse on the userland nfsd. The solution is to update
i_nlink when we delete or rmdir.
Cheers,
  Trond
--- linux-2.4.5-pre6/fs/inode.c.orig	Fri May 25 14:15:38 2001
+++ linux-2.4.5-pre6/fs/inode.c	Wed May 30 12:17:29 2001
@@ -1044,6 +1044,8 @@
 				inode->i_state|=I_FREEING;
 				inodes_stat.nr_inodes--;
 				spin_unlock(&inode_lock);
+				if (inode->i_data.nrpages)
+					truncate_inode_pages(&inode->i_data, 0);
 				clear_inode(inode);
 			}
 		}
--- linux-2.4.5-pre6/fs/nfs/dir.c.orig	Fri May 25 14:15:38 2001
+++ linux-2.4.5-pre6/fs/nfs/dir.c	Thu May 31 14:53:32 2001
@@ -753,6 +753,8 @@
 
 	nfs_zap_caches(dir);
 	error = NFS_PROTO(dir)->rmdir(dir, &dentry->d_name);
+	if (!error)
+		dentry->d_inode->i_nlink = 0;
 
 	return error;
 }
@@ -870,6 +872,8 @@
 	error = NFS_PROTO(dir)->remove(dir, &dentry->d_name);
 	if (error < 0)
 		goto out;
+	if (inode)
+		inode->i_nlink--;
 
  out_delete:
 	/*
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
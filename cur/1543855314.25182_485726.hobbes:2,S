Date: Sun, 26 Nov 2006 18:00:53 +0800
From: Eugene Teo <>
Subject: [2.6 patch] net/sctp/socket.c: add missing sctp_spin_unlock_irqrestore
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2006/11/26/20

This patch adds a missing sctp_spin_unlock_irqrestore when returning
from "if(space_left<addrlen)" condition.
Signed-off-by: Eugene Teo <eteo@redhat.com>
  net/sctp/socket.c |   19 +++++++++++--------
  1 file changed, 11 insertions(+), 8 deletions(-)
diff --git a/net/sctp/socket.c b/net/sctp/socket.c
index 935bc91..a5d4d75 100644
--- a/net/sctp/socket.c
+++ b/net/sctp/socket.c
@@ -3955,7 +3955,7 @@ static int sctp_copy_laddrs_to_user(stru
         struct sctp_sockaddr_entry *addr;
         unsigned long flags;
         union sctp_addr temp;
-       int cnt = 0;
+       int cnt = 0, err = 0;
         int addrlen;
         sctp_spin_lock_irqsave(&sctp_local_addr_lock, flags);
@@ -3968,21 +3968,24 @@ static int sctp_copy_laddrs_to_user(stru
                 sctp_get_pf_specific(sk->sk_family)->addr_v4map(sctp_sk(sk),
                                                                 &temp);
                 addrlen = sctp_get_af_specific(temp.sa.sa_family)->sockaddr_len;
-               if(space_left<addrlen)
-                       return -ENOMEM;
+               if(space_left<addrlen) {
+                       err = -ENOMEM;
+                       goto unlock;
+               }
                 temp.v4.sin_port = htons(port);
                 if (copy_to_user(*to, &temp, addrlen)) {
-                       sctp_spin_unlock_irqrestore(&sctp_local_addr_lock,
-                                                   flags);
-                       return -EFAULT;
+                       err = -EFAULT;
+                       goto unlock;
                 }
                 *to += addrlen;
                 cnt ++;
                 space_left -= addrlen;
         }
-       sctp_spin_unlock_irqrestore(&sctp_local_addr_lock, flags);
+       err = cnt;
-       return cnt;
+unlock:
+       sctp_spin_unlock_irqrestore(&sctp_local_addr_lock, flags);
+       return err;
  }
  /* Old API for getting list of local addresses. Does not work for 32-bit
-- 
eteo redhat.com  ph: +65 6490 4142  
http://www.kernel.org/~eugeneteo
gpg fingerprint:  47B9 90F6 AE4A 9C51 37E0  D6E1 EA84 C6A2 58DF 8823
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
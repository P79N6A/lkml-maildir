Date: 18 Dec 2001 20:54:47 +0300
From: Borsenkow Andrej <>
Subject: PATCH: apm.c - detection of brokern APM Idle call implementation
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2001/12/18/132

On Пнд, 2001-12-17 at 06:34, Dave Jones wrote:
> On 16 Dec 2001, Borsenkow Andrej wrote:
> 
> > I thought once about run-time detection - if BIOS reports that Idle does
> > not slow down CPU try Idle call once and compare jiffies (probably
> > repeat several times to be sure). Is it sensible?
> 
> A far simpler way would be to add DMI blacklist entries for the BIOSes
> that don't do this, although this assumes the problem machine has a DMI
> compliant BIOS.
> 
Well, the following three-liners (+ comments) seems to do it. It checks
if clock was advanced after return from APM Idle - if not we assume BIOS
did not halt CPU and do it ourselves. The addidional condition &&
!current->need_resched is for the case when BIOS did halt CPU and
non-clock interrupt happened that waked up somebody else. But may be I
am just plain paranoid. The code has no impact for "BIOS slows CPU"
case.
It works here for broken BIOS. I appreciate if people with good BIOS
test it. 
-andrej
--- apm.c.bor	Tue Dec 18 20:30:08 2001
+++ apm.c	Tue Dec 18 20:42:24 2001
@@ -1381,13 +1381,18 @@
 		 */
 		if (apm_do_idle() != -1) {
 			unsigned long start = jiffies;
+			unsigned long before;
 			while ((!exit_kapmd) && system_idle()) {
-				if (apm_do_idle()) {
+				before = jiffies;
+				if (apm_do_idle() || (jiffies == before && !current->need_resched)) {
 					set_current_state(TASK_INTERRUPTIBLE);
 					/* APM needs us to snooze .. either
 					   the BIOS call failed (-1) or it
 					   slowed the clock (1). We sleep
-					   until it talks to us again */
+					   until it talks to us again.
+					   If clock did not advance CPU was
+					   not halted by BIOS so we do it
+					   now*/
 					schedule_timeout(1);
 				}
 				if ((jiffies - start) > APM_CHECK_TIMEOUT) {
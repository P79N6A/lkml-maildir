Date: Thu, 22 Mar 2007 09:20:32 +0200
From: Avi Kivity <>
Subject: Re: [PATCH] make KVM conform to sucky rdmsr interface
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2007/3/22/57

Rusty Russell wrote:
> Grrr.... Andi refused to take my "rdmsr64" patch which moved to a
> function-like interface for MSRs, dismissing it as pointless churn.
>
> paravirt_ops cleanups changed a macro to an inline and spotted this
> kvm bug.
>
> Signed-off-by: Rusty Russell <rusty@rustcorp.com.au>
>
> diff -r 47c6ee74a5c5 drivers/kvm/vmx.c
> --- a/drivers/kvm/vmx.c	Thu Mar 22 12:57:44 2007 +1100
> +++ b/drivers/kvm/vmx.c	Thu Mar 22 13:38:24 2007 +1100
> @@ -1127,7 +1127,7 @@ static int vmx_vcpu_setup(struct kvm_vcp
>  		u64 data;
>  		int j = vcpu->nmsrs;
> 
> -		if (rdmsr_safe(index, &data_low, &data_high) < 0)
> +		if (rdmsr_safe(index, data_low, data_high) < 0)
>  			continue;
>  		if (wrmsr_safe(index, data_low, data_high) < 0)
>  			continue;
>
>
> 
My rdmsr_safe (x86_64, i386 is similar/same) is
#define rdmsr_safe(msr,a,b) \
        ({ int ret__;                                           \
          asm volatile ("1:       rdmsr\n"                      \
                      "2:\n"                                    \
                      ".section .fixup,\"ax\"\n"                \
                      "3:       movl %4,%0\n"                   \
                      " jmp 2b\n"                               \
                      ".previous\n"                             \
                      ".section __ex_table,\"a\"\n"             \
                      " .align 8\n"                             \
                      " .quad 1b,3b\n"                          \
                      ".previous":"=&bDS" (ret__), "=a"(*(a)), "=d"(*(b))\
                      :"c"(msr), "i"(-EIO), "0"(0));            \
          ret__; })
Which seems quite happy to accept pointers to the values. The one in 
asm/i386/paravirt.h has a similar calling convention.
-- 
Do not meddle in the internals of kernels, for they are subtle and quick to panic.
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
Date: Thu, 29 Apr 2004 06:50:28 +0100
From:  viro@parcelfa ...
Subject: Re: [PATCH 2.4] add SMBIOS information to /proc/smbios/
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2004/4/29/16

On Thu, Apr 29, 2004 at 12:39:33AM -0500, Michael Brown wrote:
> +smbios_read_table_entry_point(char *page, char **start,
> +				off_t off, int count,
> +				int *eof, void *data)
> +{
> +	unsigned int max_off = sizeof(the_smbios_device.table_eps);
> +	MOD_INC_USE_COUNT;
> +
> +	memcpy(page, &the_smbios_device.table_eps, max_off);
> +
> +	MOD_DEC_USE_COUNT;
> +	return max_off;
> +}
*LART*
Use ->owner instead of (racy) messing with MOD_{INC,DEC}_USE_COUNT.
> +/* Use the more flexible procfs style. We tell the core that we can handle
> + * >4k transactions by setting *start. When doing this we also have to handle
> + * our own *eof and make sure not to overrun the page or count given.
> + */
> +static ssize_t
> +smbios_read_table(char *page, char **start,
> +		off_t offset, int count,
> +		int *eof, void *data)
> +{
> +	u8 *buf;
> +	int i = 0;
> +	int max_off = the_smbios_device.smbios_table_real_length;
> +	MOD_INC_USE_COUNT;
> +
> +	if (offset > max_off)
> +		return 0;
> +
> +	if (count > (max_off - offset))
> +		count = max_off - offset;
> +
> +	buf = ioremap(the_smbios_device.table_eps.table_address, max_off);
> +	if (buf == NULL)
> +		return -ENXIO;
> +
> +	/* memcpy( buffer, buf+pos, count ); */
> +	for (i = 0; i < count; ++i) {
> +		page[i] = readb( buf+offset+i );
> +	}
> +
> +	iounmap(buf);
> +
> +	*start = page; /* tells procfs that we handle >1 page */
> +	MOD_DEC_USE_COUNT;
> +	return count;
> +}
... and the reason why you need to go through procfs default ->read()
instead of providing an obvious one of your own would be...?  Note that
it would be smaller and simpler than your callback above.
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
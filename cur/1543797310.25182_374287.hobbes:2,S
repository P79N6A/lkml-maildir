Date: Thu, 08 Dec 2005 19:44:41 +0300
From: Valentine Barshak <>
Subject: [PATCH] posix_fadvise bug (unexpected success on FIFO/pipe)
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2005/12/8/148

Hello, all.
I have the following problem with posix_fadvise :
the system call succeeds on a pipe or FIFO, although it has to fail with 
ESPIPE (EINVAL on linux) return value.
Looks like a kernel bug.
I've attached a small test for posix_fadvise and a patch for linux 
kernel 2.6.14 that fixes the problem.
The patch makes posix_fadvise return ESPIPE on FIFO/pipe in order to be 
fully POSIX-compliant.
Please, take a look at these.
Thanks.
#define _GNU_SOURCE
#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>
#include <fcntl.h>
#include <sys/stat.h>
#include <sys/types.h>
#include <errno.h>
int main()
{
	int retval, fd;
	if (mkfifo("fifo", 0666) < 0) {
		printf("create fifo error\n");
		return 1;
	}
	
	fd = open("fifo", O_RDWR);
	if (fd < 0) {
		printf("open fifo error\n");
		remove("fifo");
		return 1;
	}
	
	retval = posix_fadvise(fd, 0, 0, POSIX_FADV_NORMAL);
	if (retval) {
		printf("Expected fail - The fd argument is associated with a pipe or FIFO.\n");
		if (retval != ESPIPE)
			printf("Unexpected ERRNO %d (Expected %d)\n", retval, ESPIPE);
	} else
		printf("Unexpected success  - The fd argument is associated with a pipe or FIFO.\n");
	close(fd);
	remove("fifo");
	if (retval)
		return 0;
	return 1;
}
--- a/mm/fadvise.c 2005-10-10 22:54:29.000000000 +0400
+++ b/mm/fadvise.c 2005-12-06 23:04:19.980711464 +0300
@@ -37,6 +37,11 @@
        if (!file)
                return -EBADF;
 
+       if (S_ISFIFO(file->f_dentry->d_inode->i_mode)) {
+               ret = -ESPIPE;
+               goto out;
+       }
+
        mapping = file->f_mapping;
        if (!mapping || len < 0) {
                ret = -EINVAL;
Date: Thu, 26 Aug 1999 10:44:09 -0600
From: "Jeff Merkey" <>
Subject: Locks used  in the FAT file system are non-atomic and in fact, don't work on SMP systems
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/1999/8/26/111

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML><HEAD>
<META content="text/html; charset=iso-8859-1" http-equiv=Content-Type>
<META content="MSHTML 5.00.2116.100" name=GENERATOR>
<STYLE></STYLE>
</HEAD>
<BODY bgColor=#ffffff>
<DIV><FONT face=Arial size=2>&nbsp;&nbsp;&nbsp; </FONT></DIV>
<DIV><FONT face=Arial size=2>We had attempted to use the FAT version of locks 
with wait queues, but have discovered they are non-atomic and in fact, under 
very heavy load allow shared data corrupton on SMP systems.&nbsp; They also have 
some subtle race conditions even on non-SMP systems i reentrant code.&nbsp; We 
are using atomic semaphores now instead.&nbsp; Just thought we would warn folks 
that what's out there appears to be busted.</FONT></DIV>
<DIV>&nbsp;</DIV>
<DIV><FONT face=Arial size=2>The offending code is:</FONT></DIV>
<DIV>&nbsp;</DIV>
<DIV><FONT face=Arial size=2>Lock()</FONT></DIV>
<DIV><FONT face=Arial size=2>{</FONT></DIV>
<DIV><FONT face=Arial size=2>&nbsp;&nbsp; while (lock) 
sleep_on(&amp;wait);</FONT></DIV>
<DIV><FONT face=Arial size=2>&nbsp;&nbsp; lock = 1;</FONT></DIV>
<DIV><FONT face=Arial size=2>}</FONT></DIV>
<DIV>&nbsp;</DIV>
<DIV><FONT face=Arial size=2>Unlock()</FONT></DIV>
<DIV><FONT face=Arial size=2>{</FONT></DIV>
<DIV><FONT face=Arial size=2>&nbsp;&nbsp; lock = 0;</FONT></DIV>
<DIV><FONT face=Arial size=2>&nbsp;&nbsp; wake_up(&amp;wait);</FONT></DIV>
<DIV><FONT face=Arial size=2>}</FONT></DIV>
<DIV>&nbsp;</DIV>
<DIV><FONT face=Arial size=2>Two processes can enter Lock() while lock is equal 
to 0, and both set it.&nbsp; We have seen this occur, and it seems broken.&nbsp; 
</FONT></DIV>
<DIV>&nbsp;</DIV>
<DIV><FONT face=Arial size=2>Jeff</FONT></DIV>
<DIV>&nbsp;</DIV>
<DIV>&nbsp;</DIV></BODY></HTML>
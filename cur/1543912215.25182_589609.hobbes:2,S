Date: Wed, 29 Aug 2007 15:14:32 +0800
From: Fengguang Wu <>
Subject: Re: How to find out how many other processes share VM with $PID?
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2007/8/29/37

On Tue, Aug 28, 2007 at 09:00:41PM +0100, Denys Vlasenko wrote:
> On Tuesday 28 August 2007 01:10, Fengguang Wu wrote:
> > > > There is a nice LWN article on this issue:
> > > >         ELC: How much memory are applications really using?
> > > >         
http://lwn.net/Articles/230975/
> > > >
> > > > Another helpful patch could be:
> > > >         maps: PSS(proportional set size) accounting in smaps
> > > >         
http://lkml.org/lkml/2007/8/19/23
> > >
> > > Thanks a lot, very useful pages indeed.
> > >
> > > However they still don't explain how I can avoid counting memory
> > > twice for /proc/PID1 and /proc/PID2 when PID2 is a child of PID1,
> > > created with CLONE_VM.
> > >
> > > The example: I allocate 1234k, dirty it, then clone with CLONE_VM.
> > > I will seemingly have two processes, each using 1234k, _privately_
> > > (i.e., pages are not shown as shared in smaps) -
> > > which is technically correct, pages are not shared with other VMs,
> > > but they ARE shared by means of these two processes having the same VM!
> > >
> > > How userspace tools can figure out that these processes have shared VM?
> > >
> > > IOW: do we need "VMsharecount: N" in addition to "Threads: N"
> > > in /proc/PID/status?
> >
> > A full solution would require two parameters, i.e. VmUsers/VmMagic.
> >
> > But please make sure the new lines won't break important tools like
> > ps/top/pmaps/...
> 
> Should be safe - tools skip lines they do not recognize.
Except yours ;-)
FYI, I found another tool that depends on status: atop.
> Ok, we have "Threads: N".
> 
> I can cook up a patch which adds count of processes
> which share VM with us - it's just atomic_read(&current->mm->mm_users).
Yeah, the code itself would be simple.
> What name do you like? 
> 
> SharedVmCount: N
> VmUsers: N
> other?
I'd prefer VmUsers: that's the choice of source code.
Fengguang
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
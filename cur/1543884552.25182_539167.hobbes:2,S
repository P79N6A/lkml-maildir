Date: Wed, 02 May 2007 15:36:03 -0700
From: Zachary Amsden <>
Subject: Mysterious RTC hangs on x86_64 - fixed, sort of
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2007/5/2/539

With this patch, /sbin/hwclock no longer hangs my AMD64 machine when run 
after reaching multiuser.  What I don't understand is why.  I have the 
RTC based sound sequencer timer as a module, but not loaded, and the 
error message I added to indicate broken rtc control does not fire.
So why is it that if I stop taking the rtc_task_lock and issuing the 
callbacks which should never be held or exist that my system no longer 
hard freezes?
Zach
--- /tmp/a      2007-05-03 15:36:07.451256181 -0700
+++ drivers/char/rtc.c  2007-05-03 15:27:49.000000000 -0700
@@ -265,10 +265,10 @@
        spin_unlock (&rtc_lock);
 
        /* Now do the rest of the actions */
-       spin_lock(&rtc_task_lock);
-       if (rtc_callback)
-               rtc_callback->func(rtc_callback->private_data);
-       spin_unlock(&rtc_task_lock);
+/*     spin_lock(&rtc_task_lock); */
+//     if (rtc_callback)
+//             rtc_callback->func(rtc_callback->private_data);
+/*     spin_unlock(&rtc_task_lock); */
        wake_up_interruptible(&rtc_wait);       
 
        kill_fasync (&rtc_async_queue, SIGIO, POLL_IN);
@@ -811,6 +811,7 @@
 
 int rtc_register(rtc_task_t *task)
 {
+       printk(KERN_ERR "rtc_register is busted\n");
 #ifndef RTC_IRQ
        return -EIO;
 #elseCONFIG_HPET_EMULATE_RTC=y
CONFIG_RTC=y
# CONFIG_HPET_RTC_IRQ is not set
CONFIG_SND_RTCTIMER=m
CONFIG_SND_SEQ_RTCTIMER_DEFAULT=y
CONFIG_RTC_LIB=y
CONFIG_RTC_CLASS=y
CONFIG_RTC_HCTOSYS=y
CONFIG_RTC_HCTOSYS_DEVICE="rtc0"
CONFIG_RTC_DEBUG=y
# RTC interfaces
CONFIG_RTC_INTF_SYSFS=y
CONFIG_RTC_INTF_PROC=y
CONFIG_RTC_INTF_DEV=y
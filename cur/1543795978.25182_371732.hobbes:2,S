Date: Wed, 30 Nov 2005 14:06:01 -0500
From: Kyle Moffett <>
Subject: [PATCH][2.6.15-rc3] powerpc: Fix kexec on PPC32
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2005/11/30/148

The PPC merge broke CONFIG_KEXEC on PPC32 very slightly.
Signed-off-by: Kyle Moffett <mrmacman_g4@mac.com>
--
NOTE: This is compile and boot tested, but I haven't had time to read  
the kexec docs and start playing with kexec yet, so it may not work  
correctly.
diff -ru linux-2.6.15-rc3/arch/ppc/kernel/machine_kexec.c linux-2.6.15-rc3-aphrodite1/arch/ppc/kernel/machine_kexec.c
--- linux-2.6.15-rc3/arch/ppc/kernel/machine_kexec.c	2005-11-29 12:57:27.000000000 -0500
+++ linux-2.6.15-rc3-aphrodite1/arch/ppc/kernel/machine_kexec.c	2005-11-29 14:45:48.000000000 -0500
@@ -34,11 +34,13 @@
  */
 note_buf_t crash_notes[NR_CPUS];
 
+#ifndef CONFIG_PPC_MERGE
 void machine_shutdown(void)
 {
 	if (ppc_md.machine_shutdown)
 		ppc_md.machine_shutdown();
 }
+#endif
 
 void machine_crash_shutdown(struct pt_regs *regs)
 {
diff -ru linux-2.6.15-rc3/include/asm-powerpc/machdep.h linux-2.6.15-rc3-aphrodite1/include/asm-powerpc/machdep.h
--- linux-2.6.15-rc3/include/asm-powerpc/machdep.h	2005-11-29 14:49:54.000000000 -0500
+++ linux-2.6.15-rc3-aphrodite1/include/asm-powerpc/machdep.h	2005-11-29 14:52:51.000000000 -0500
@@ -13,6 +13,7 @@
 #include <linux/seq_file.h>
 #include <linux/init.h>
 #include <linux/dma-mapping.h>
+#include <linux/kexec.h>
 
 #include <asm/setup.h>
 
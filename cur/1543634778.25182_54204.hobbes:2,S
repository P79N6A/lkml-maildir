Date: Tue, 25 Jun 2002 12:47:20 -0700
From: Andrew Morton <>
Subject: Re: efficient copy_to_user and copy_from_user routines in Linux Kernel
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2002/6/25/12

kuznet@ms2.inr.ac.ru wrote:
> 
> Hello!
> 
> > I changed tcp to use a different copy if either source or dest were
> > not eight-byte aligned, and found that the resulting improvement
> > across a mixed networking load was only 1%.  Your numbers are higher,
> > so perhaps there are different alignments in the mix...
> 
> Did you look at sender or changed both of the functions?
I changed it to use csum_copy_from_user() instead of copy_from_user()
if the source and dest weren't 8-byte aligned.   No other changes
in there.   
> After that accident TCP was changed and it does not use copy_from_user more,
> it does copy_and_csum even when no checksum is required. So, his results
> on sender side (except for strange anomaly at msg size 8K) just confirm
> nil effect of copy_from_user.
Yup.
> What's about copy_to_user, we forgot about this at all,
> worrying mostly about sender side. :-)
We didn't really forget, but we were trying to get a 2.4 kernel out,
so it became a "fix in 2.5" item.  You're right, we should fix it in
2.4.
I wrote a little app to test this - it times a couple of copy algorithms
at all possible alignments.  It may be useful for someone...  
http://www.zip.com.au/~akpm/linux/cptimer.tar.gz
I think it covers everything - uncached/cache source/dest,
all possible transfer alignemnts.
The cost of getting it wrong is, iirc, 40% slowdown.  In the
kernel's single most expensive function.
-
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
Date: Mon, 7 Aug 2006 15:04:34 -0400
From: "Tien ChenLi" <>
Subject: Re: [PATCH]pktgen oops when used with balance-tlb bonding
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2006/8/7/253

Indeed the skb->mac.raw is already set just several lines up. Now only
two lines are needed:
Signed-off-by: Chen-Li Tien <cltien@gmail.com>
--- linux-2.6.17.6/net/core/pktgen.c.orig       2006-07-15
15:00:43.000000000 -0400
+++ linux-2.6.17.6/net/core/pktgen.c    2006-08-07 14:50:09.000000000 -0400
@@ -2149,6 +2149,8 @@ static struct sk_buff *fill_packet_ipv4(
        skb->mac.raw = ((u8 *) iph) - 14 - pkt_dev->nr_labels*sizeof(u32);
        skb->dev = odev;
        skb->pkt_type = PACKET_HOST;
+       skb->nh.iph = iph;
+       skb->h.uh = udph;
        if (pkt_dev->nfrags <= 0)
                pgh = (struct pktgen_hdr *)skb_put(skb, datalen);
Since google mail extand tab into spaces and I cannot change them back
to tab, I attached the patch file itself so please use it instead.
Sincerely,
Chen-Li Tien
On 02/08/06, Willy Tarreau <w@1wt.eu> wrote:
> On Sat, Jul 22, 2006 at 07:11:21PM -0400, Tien ChenLi wrote:
> > I fixed a bug in pktgen so it won't cause oops when used with
> > balance-tlb or balance-alb bonding driver:
> >
> > --- linux-2.6.17.4/net/core/pktgen.c.orig       2006-07-06
> > 16:02:28.000000000 -0
> > 400
> > +++ linux-2.6.17.4/net/core/pktgen.c    2006-07-10 16:40:47.000000000 -0400
> > @@ -2149,6 +2149,9 @@
> >        skb->mac.raw = ((u8 *) iph) - 14 - pkt_dev->nr_labels*sizeof(u32);
> >        skb->dev = odev;
> >        skb->pkt_type = PACKET_HOST;
> > +       skb->mac.raw = eth;
>           ^^^^^^^^^^^^
> Are you sure about this ? I don't understand why you change skb->mac.raw
> here while it's still assigned 3 lines above. Either of those is unneeded
> and/or erroneous.
>
> > +       skb->nh.iph = iph;
> > +       skb->h.uh = udph;
> >
> >        if (pkt_dev->nfrags <= 0)
> >                pgh = (struct pktgen_hdr *)skb_put(skb, datalen);
> >
> > The root cause is that the bond_alb_xmit in bonding will peek the
> > destination address in packet via the skb->nh.iph pointer, generally
> > this will be filled by upper layer network driver, but the packet
> > generated by pktgen will be sent to device driver so it will need to
> > set this pointer correctly. The other two pointers are not necessary
> > for now, they are set to avoid similar problem.
>
> Fine. Please confirm your intention about mac.raw above, and as David
> said, please sign-off the patch and check your mailer for unexpected
> tabs/spaces conversions.
>
> > Chen-Li Tien
>
> Thanks in advance,
> Willy
>
>
--- linux-2.6.17.6/net/core/pktgen.c.orig	2006-07-15 15:00:43.000000000 -0400
+++ linux-2.6.17.6/net/core/pktgen.c	2006-08-07 14:50:09.000000000 -0400
@@ -2149,6 +2149,8 @@ static struct sk_buff *fill_packet_ipv4(
 	skb->mac.raw = ((u8 *) iph) - 14 - pkt_dev->nr_labels*sizeof(u32);
 	skb->dev = odev;
 	skb->pkt_type = PACKET_HOST;
+	skb->nh.iph = iph;
+	skb->h.uh = udph;
 
 	if (pkt_dev->nfrags <= 0)
 		pgh = (struct pktgen_hdr *)skb_put(skb, datalen);
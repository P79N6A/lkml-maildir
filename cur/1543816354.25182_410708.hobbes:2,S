Date: Sat, 25 Mar 2006 02:49:32 +0100
From: Herbert Poetzl <>
Subject: [PATCH] loop: potential kernel hang waiting for kthread
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2006/3/24/370

Hi Andrew! Folks!
just stumbled over the following issue with loop_set_fd()
calling kernel_thread(loop_thread), ignoring the return
value, even if it is an error, then doing wait_for_completion()
on the device, which, in beforementioned error case, would
wait forever (keeping a process stuck in 'D' state)
I can imagine at least three other solutions, but this
one seemed quite organic to me, YMMV ...
best,
Herbert
Signed-off-by: Herbert Poetzl <herbert@13thfloor.at>
---
--- linux/drivers/block/loop.c	2006-03-24 03:37:07 +0100
+++ linux/drivers/block/loop.c	2006-03-25 02:30:37 +0100
@@ -747,6 +747,7 @@ static int loop_set_fd(struct loop_devic
 	int		lo_flags = 0;
 	int		error;
 	loff_t		size;
+	pid_t		pid;
 
 	/* This is safe, since we have a reference from open(). */
 	__module_get(THIS_MODULE);
@@ -839,10 +840,14 @@ static int loop_set_fd(struct loop_devic
 
 	set_blocksize(bdev, lo_blocksize);
 
-	kernel_thread(loop_thread, lo, CLONE_KERNEL);
+	pid = kernel_thread(loop_thread, lo, CLONE_KERNEL);
+	if (pid < 0)
+		goto out_err;
 	wait_for_completion(&lo->lo_done);
 	return 0;
 
+ out_err:
+	error = (int)pid;
  out_putf:
 	fput(file);
  out:
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
Date: Mon, 8 Mar 1999 03:08:25 +0100 (CET)
From: Andrea Arcangeli <>
Subject: Re: TCP window updates [Was: PROBLEM: Sending mail-attachment]
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/1999/3/7/146

On Sun, 7 Mar 1999, Matthias Moeller wrote:
>I still see a problem. What if only the first ACK (advertising
>the small window) gets through to the sender and the other ACKs
>get lost in network? Should'nt there be a timeout?
Yes. This patch should do the trick and it also allow us to not deadlock
in the nonblocking case. It has to be applyed on the top of DaveM's
previous patch.
Index: tcp.c
===================================================================
RCS file: /var/cvs/linux/net/ipv4/tcp.c,v
retrieving revision 1.1.2.3
diff -u -r1.1.2.3 tcp.c
--- tcp.c	1999/02/23 17:08:43	1.1.2.3
+++ linux/net/ipv4/tcp.c	1999/03/08 02:05:30
@@ -202,6 +202,10 @@
  *		Eric Schenk	:	Fix fast close down bug with
  *					shutdown() followed by close().
  *		Andi Kleen :	Make poll agree with SIGIO
+ *		Andrea Arcangeli:	Avoid deadlocking using a 10sec
+ *					timeout between window updates
+ *					in cleanup_rbuf, and send the window
+ *					update also in the nonblocking case.
  *					
  *		This program is free software; you can redistribute it and/or
  *		modify it under the terms of the GNU General Public License
@@ -1211,15 +1215,26 @@
 			break;
 		}
 
+		/*
+		 * If needed advertise the new window also in the nonblocking
+		 * case to allow the sender to make some progress while
+		 * we'll return to userspace. -arca
+		 */
+		cleanup_rbuf(sk, copied);
+
 		if (nonblock) {
 			copied = -EAGAIN;
 			break;
 		}
 
-		cleanup_rbuf(sk, copied);
 		release_sock(sk);
 		sk->socket->flags |= SO_WAITDATA;
-		schedule();
+		/*
+		 * If the ack generated by cleanup_rbuf to advertise the new
+		 * window gets dropped by the network, this timeout of 10sec
+		 * will avoid us to deadlock here. -arca
+		 */
+		schedule_timeout(10*HZ);
 		sk->socket->flags &= ~SO_WAITDATA;
 		lock_sock(sk);
 		continue;
Andrea Arcangeli
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.rutgers.edu
Please read the FAQ at 
http://www.tux.org/lkml/
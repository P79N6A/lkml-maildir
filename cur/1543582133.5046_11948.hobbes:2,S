Date: Fri, 16 Feb 2001 17:43:16 +0100
From: Jamie Lokier <>
Subject: Re: x86 ptep_get_and_clear question
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2001/2/16/69

Manfred Spraul wrote:
> The other cpu writes the dirty bit - we just overwrite it ;-)
> After the ptep_get_and_clear(), before the set_pte().
Ah, I see.  The other CPU does an atomic *pte |= _PAGE_DIRTY, without
checking the present bit.  ('scuse me for temporary brain failure).
How about a pragmatic solution.
Given that Ben's found that "checks pte_present on dirtying" works in
practice, and it is _much_ simpler to do things that way, perhaps we
could write a boot time test for this?
If the boot time test fails, we
 (a) printk("Sorry we've never seen a CPU like this, please report");
 (b) Put this in ptep_get_and_clear:
      if (tlb_dirty_doesnt_sync)
        flush_tlb_page(page)
It should be fast on known CPUs, correct on unknown ones, and much
simpler than "gather" code which may be completely unnecessary and
rather difficult to test.
If anyone reports the message, _then_ we think about the problem some more.
Ben, fancy writing a boot-time test?
-- Jamie
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
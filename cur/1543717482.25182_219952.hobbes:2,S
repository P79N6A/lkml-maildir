Date: Wed, 12 May 2004 13:23:26 +0100
From: Anton Altaparmakov <>
Subject: SOLVED - Re: PROBLEM: compiling NTFS write support
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2004/5/12/56

On Wed, 2004-05-12 at 12:56, andrea.fracasso@infoware-srl.com wrote:
> > On Wed, 2004-05-12 at 11:14, andrea.fracasso@infoware-srl.com wrote:
> >> Hi, I have found a problem compiling te source of kernel 2.6.6, if I
> >> enable NTFS write support when i run "make" i get this error:
> >>
> >> ....
> >>   CC      fs/ntfs/inode.o
> >>   CC      fs/ntfs/logfile.o
> >> {standard input}: Assembler messages:
> >> {standard input}:683: Error: suffix or operands invalid for `bsf'
> >> make[2]: *** [fs/ntfs/logfile.o] Error 1
> >> make[1]: *** [fs/ntfs] Error 2
> >> make: *** [fs] Error 2
> >>
> >> my kernel version is:
> >> Linux version 2.6.5-AS1500 (root@ntb-gozzolox) (gcc version 3.3.2
> >> 20031022
> >> (Red Hat Linux 3.3.2-1)) #3 Thu Apr 15 10:13:11 CEST 2004
> 
> The binutils ver is:
> binutils-2.14.90.0.6-4
This happens because gcc (wrongly!) optimizes a variable into a constant
and then ffs() fails to assemble because the bsfl instruction is only
allowed with memory operands and not constants.
/me hates gcc...
Please try the below fix.  It uses generic_ffs() which is ffs() the slow
way so it should build fine.
Thanks a lot for your help.
Best regards,
	Anton
-- 
Anton Altaparmakov <aia21 at cam.ac.uk> (replace at with @)
Unix Support, Computing Service, University of Cambridge, CB2 3QH, UK
Linux NTFS maintainer / IRC: #ntfs on irc.freenode.net
WWW: 
http://linux-ntfs.sf.net/
 &
http://www-stu.christs.cam.ac.uk/~aia21/
--- bklinux-2.6/fs/ntfs/logfile.c	2004-05-08 23:43:29.000000000 +0100
+++ ntfs-2.6/fs/ntfs/logfile.c	2004-05-12 13:16:47.615924480 +0100
@@ -25,6 +25,7 @@
 #include <linux/fs.h>
 #include <linux/highmem.h>
 #include <linux/buffer_head.h>
+#include <linux/bitops.h>
 
 #include "logfile.h"
 #include "volume.h"
@@ -455,7 +456,13 @@ BOOL ntfs_check_logfile(struct inode *lo
 	else
 		log_page_size = PAGE_CACHE_SIZE;
 	log_page_mask = log_page_size - 1;
-	log_page_bits = ffs(log_page_size) - 1;
+	/*
+	 * Gcc is annoying and sometimes optimizes log_page_size and turns it
+	 * into a constant in the assembler output and ffs() then fails to
+	 * assemble because bsfl instruction cannot be used with a constant so
+	 * we have to use generic_ffs() which does it by hand.
+	 */
+	log_page_bits = generic_ffs(log_page_size) - 1;
 	size &= ~(log_page_size - 1);
 	/*
 	 * Ensure the log file is big enough to store at least the two restart
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
Date: Wed, 21 Sep 2005 13:33:03 +0200
From: Sébastien Dugué <>
Subject: Re: [AIO] aio-2.6.13-rc6-B1
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2005/9/21/49

On Tue, 2005-09-20 at 15:13 -0400, Benjamin LaHaise wrote:
> On Tue, Sep 20, 2005 at 12:23:10PM +0200, Sébastien Dugué wrote:
> >   what's the point of calling wake_up_locked(&sem->wait) in 
> > aio_down_wait? We're already in a wakeup path and end up
> > calling __wake_up_common recursively.
> 
> That's necessary to kick the next semaphore op in the list.  The 
> list_del_init() right above that makes sure that we don't recurse 
> and run the routine again.
  OK, understood.
> 
> >   I think it may be one of the cause of my kernel hanging at the
> > very beginning.
> > 
> >   When I remove this call things go further but at some point a
> > semaphore wait queue gets thrashed and __wake_up_common tries to
> > call an invalid callback function.
> 
> This patch from Zach might make a difference.  Let me know if it changes 
> the symptoms at all.  Sorry if it doesn't apply cleanly, as it is against 
> a base kernel.  Basically, we could sleep while holding ctx_lock, which 
> does Bad Things(tm) on SMP systems.
> 
  Well, it does not change a thing (I was not expecting it to). I think 
the problem rather lies in the async semaphores (aio_down/aio_up)
mechanism and not in the fs aio.
  What leads me to this is that the crash occurs only when there is
contention on an inode semaphore, which seems to happen frequently
with pipes and not so frequently with regular file IO.
  And as the pipes are the only users (aside from xxx_aio_writev) of 
this mecanism it shows right after the kernel is booted. Without the
90_pipe_aio.diff patch, the kernel boots normally but Oopses during
shutdown involving again a semaphore operation.
  Any ideas?
  Sébastien.
-- 
------------------------------------------------------
  Sébastien Dugué                BULL/FREC:B1-247
  phone: (+33) 476 29 77 70      Bullcom: 229-7770
  mailto:sebastien.dugue@bull.net
  Linux POSIX AIO: 
http://www.bullopensource.org/posix
  
------------------------------------------------------
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
Date: Thu, 23 Aug 2001 20:22:39 +0200
From: Daniel Phillips <>
Subject: Re: 2.4.9 VM/VMA subsystem works much better
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2001/8/23/107

On August 23, 2001 12:29 pm, Stephan von Krawczynski wrote:
> Daniel Phillips <phillips@bonn-fries.net> wrote:
> 
> > On August 22, 2001 09:58 pm, Brad Chapman wrote:
> > > Everyone,
> > > 
> > > 	Just a note: the VMA sanity patch which went in to 2.4.9
> > > has improved Mozilla's performance considerably. I did a rough
> > > calculation based on startup time and found that Mozilla started
> > > approximately 10%-12% faster on 2.4.9 then 2.4.8. Plus, I've
> > > found that swapping is actually starting to work again, although
> > > it still tends to stick at certain times.
> > > 
> > > 	Great job everyone.
> > 
> > Make sure you have my SetPageReferenced patch in, swap is borked without 
> > it.
> 
> Can you send me the patches you think should cure a straight 2.4.9 for
> re-testing (probably the one from Marcelo Tosatti, too).
> I am from the old school: don't believe what you can't test. :-)
I took the liberty of cc'ing this to the list.  This patch fixes a severe 
swap thrashing problem that was introduced by the use-once patch in 2.4.8.  I 
explained the details elsewhere.  Other than the swap problem (which was just 
an oversight, not a design error) the use-once strategy seems to be working 
fine.  My own anecdotal evidence: before, dpkg --config -a on this box was 
effectively a DoS, now I barely notice it while I'm running other 
applications.
There should be a similar hole in pagemap_nopage affecting memmapped files, 
but nobody has reported it yet.  I presume this is because it's a lot harder 
to trigger.  I'll supply a patch after I've looked at it a little more.
--- ../2.4.9.clean/mm/memory.c	Mon Aug 13 19:16:41 2001
+++ ./mm/memory.c	Sun Aug 19 21:35:26 2001
@@ -1119,6 +1119,7 @@
 			 */
 			return pte_same(*page_table, orig_pte) ? -1 : 1;
 		}
+		SetPageReferenced(page);
 	}
 
 	/*
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
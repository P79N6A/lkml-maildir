Date: Mon, 30 Aug 2004 14:10:12 +0200
From: Andrei Voropaev <>
Subject: Re: with 2.6.7 setitimer called in sequence returns strange values on i686
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2004/8/30/67

On Tue, Aug 24, 2004 at 04:42:41PM +0200, Andrei Voropaev wrote:
[...]
> 
> I'm using setitimer(ITIMER_REAL...) to measure time intervals.
> Everything was working fine untill I've installed 2.6.7 kernel. 
[...]
> 
> Previous value of 10 timer is 10.479
> 
> Note the last line. I've reset timer to 10 seconds and setitimer tells
> me that there are 10.479 seconds left.
I'm not sure if it is of particular importance. After checking the
sources it appears that the problem lies with mathematic. New math makes
sure than during conversion of timeval to jiffies bigger number of
jiffies is allocated to force the requirement that timer expires not
earlier than requested. But during conversion from jiffies back to
timeval no reverse adjustment is done, so resulting timeval can be
more than original. From my standpoint this violates the requirement
that the timer is only decremented (thus reduces its value) and not 
incremented.
That is why I believe that the following patch would be correct.
--- ../time.h   2004-08-30 13:59:14.000000000 +0200
+++ include/linux/time.h        2004-08-30 14:00:10.000000000 +0200
@@ -239,7 +239,7 @@
         * Convert jiffies to nanoseconds and separate with
         * one divide.
         */
-       u64 nsec = (u64)jiffies * TICK_NSEC; 
+       u64 nsec = (u64)jiffies * TICK_NSEC - (TICK_NSEC / 2); 
        value->tv_sec = div_long_long_rem(nsec, NSEC_PER_SEC, &value->tv_nsec);
 }
Well, this might be minor issue since normally nobody should call getitimer immidiately after setitimer, but still...
> I have one more machine with 2.6.7 kernel. But that machine is Athlon64
> and runs 64-bit kernel. There the program also runs correctly.
The above is not true. The problem appears on 64-bit kernel as well.
Just for different numbers :)
Andrei
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
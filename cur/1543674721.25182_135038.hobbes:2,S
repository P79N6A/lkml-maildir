Date: Sat, 24 May 2003 16:36:59 +0200
From: Thomas Schlichter <>
Subject: Re: Error during compile of 2.5.69-mm8
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2003/5/24/26

On Friday, 23 May 2003 06:32, David S. Miller wrote:
>    From: Thomas Schlichter <schlicht@uni-mannheim.de>
>    Date: Fri, 23 May 2003 05:38:38 +0200
>
>    OK, done...
>
> I already did it myself and sent the changes to Linus, he should pick
> them up by tomorrow.
Well it seems you missed one file that my patch would have cought. So here is 
a seperate diff to fix drivers/usb/media/pwc-if.c, too.
I also attached a patch that fixes the SET_MODULE_OWNER thing for net/ipv4/ by 
using static initializers instead of performing the assignment at runtime. 
This should be no problem here, as SET_MODULE_OWNER was called from static 
init functions once. I also made 'esp4_init' static to be safe. This function 
is not called from anywhere else in the whole kernel tree. (That's whar grep 
says)
Both patches should cleanly apply to current bk.
For me it compiles and runs without any problems...
Best regards
  Thomas Schlichter
--- linux-2.5.69-bk/drivers/usb/media/pwc-if.c.orig	Sat May 24 16:12:40 2003
+++ linux-2.5.69-bk/drivers/usb/media/pwc-if.c	Sat May 24 16:13:43 2003
@@ -1804,7 +1804,7 @@
 	}
 	memcpy(vdev, &pwc_template, sizeof(pwc_template));
 	strcpy(vdev->name, name);
-	SET_MODULE_OWNER(vdev);
+	vdev->owner = THIS_MODULE;
 	pdev->vdev = vdev;
 	vdev->priv = pdev;
 --- linux-2.5.69-bk/net/ipv4/esp.c.orig	Sat May 24 16:14:29 2003
+++ linux-2.5.69-bk/net/ipv4/esp.c	Sat May 24 16:13:43 2003
@@ -567,7 +567,7 @@
 	.no_policy	=	1,
 };
 
-int __init esp4_init(void)
+static int __init esp4_init(void)
 {
 	struct xfrm_decap_state decap;
 
@@ -578,7 +578,6 @@
 		decap_data_too_small();
 	}
 
-	esp_type.owner = THIS_MODULE;
 	if (xfrm_register_type(&esp_type, AF_INET) < 0) {
 		printk(KERN_INFO "ip esp init: can't add xfrm type\n");
 		return -EAGAIN;
--- linux-2.5.69-bk/net/ipv4/ipcomp.c.orig	Sat May 24 16:15:04 2003
+++ linux-2.5.69-bk/net/ipv4/ipcomp.c	Sat May 24 16:13:43 2003
@@ -385,6 +385,7 @@
 static struct xfrm_type ipcomp_type =
 {
 	.description	= "IPCOMP4",
+	.owner		= THIS_MODULE,
 	.proto	     	= IPPROTO_COMP,
 	.init_state	= ipcomp_init_state,
 	.destructor	= ipcomp_destroy,
@@ -400,7 +401,6 @@
 
 static int __init ipcomp4_init(void)
 {
-	ipcomp_type.owner = THIS_MODULE;
 	if (xfrm_register_type(&ipcomp_type, AF_INET) < 0) {
 		printk(KERN_INFO "ipcomp init: can't add xfrm type\n");
 		return -EAGAIN;
--- linux-2.5.69-bk/net/ipv4/xfrm4_tunnel.c.orig	Sat May 24 16:15:34 2003
+++ linux-2.5.69-bk/net/ipv4/xfrm4_tunnel.c	Sat May 24 16:13:43 2003
@@ -215,6 +215,7 @@
 
 static struct xfrm_type ipip_type = {
 	.description	= "IPIP",
+	.owner		= THIS_MODULE,
 	.proto	     	= IPPROTO_IPIP,
 	.init_state	= ipip_init_state,
 	.destructor	= ipip_destroy,
@@ -229,7 +230,6 @@
 
 static int __init ipip_init(void)
 {
-	ipip_type.owner = THIS_MODULE;
 	if (xfrm_register_type(&ipip_type, AF_INET) < 0) {
 		printk(KERN_INFO "ipip init: can't add xfrm type\n");
 		return -EAGAIN;[unhandled content-type:application/pgp-signature]
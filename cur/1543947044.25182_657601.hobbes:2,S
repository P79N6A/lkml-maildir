Date: Thu, 21 Feb 2008 19:46:20 +0100
From: Haavard Skinnemoen <>
Subject: MMC card detection
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2008/2/21/262

Hi Pierre,
I've been trying to debug some card detection problems in the atmel-mci
driver. Sometimes, when I remove a card, the event doesn't seem to get
detected properly, and the MMC core thinks the card is still there.
When I re-insert the card, the MMC core thinks the card is gone.
I've tried to add a debouncing timer to avoid glitches on the card
detect pin. This helps a bit, but it does not eliminate the problem
altogether.
It seems like the problem only occurs if the card is removed very
slowly. If I increase the debouncing or detection delay, I have to
remove the card more slowly to trigger the problem.
I think the real problem is that the card detection interrupt triggers
while there is still electrical contact with the card. So when the MMC
core tries to send a SEND_STATUS command to check if it's still there,
the card will respond even though it's about to be removed. Since there
will be no more interrupts as the card is completely removed, the MMC
core will never notice that the card is gone.
When the card is reinserted, the MMC core will try to send a
SEND_STATUS command again. This time, the card won't respond because it
is in the "idle" state, and the MMC core will think the card is gone.
In order to fix this problem, I think I need a way to tell the MMC core
that the card really is gone and that there's no point trying to
communicate with it. Is there any way I can do that?
Haavard
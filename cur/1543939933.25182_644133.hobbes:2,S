Date: Sun, 27 Jan 2008 23:00:29 +0200
From: "Pekka Enberg" <>
Subject: Re: lib/idr.c: initialize struct idr_layer
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2008/1/27/211

Hi Vegard,
On Jan 27, 2008 10:07 PM, Vegard Nossum <vegard.nossum@gmail.com> wrote:
> I am testing my kmemcheck patches, and it has come up with a couple of
> uses of uninitialized memory in lib/idr.c. These are (the line numbers
> may differ slightly):
[snip]
> @@ -39,12 +39,16 @@ static struct idr_layer *alloc_layer(struct idr *idp)
>  {
>         struct idr_layer *p;
>         unsigned long flags;
> +       int i;
>
>         spin_lock_irqsave(&idp->lock, flags);
>         if ((p = idp->id_free)) {
>                 idp->id_free = p->ary[0];
>                 idp->id_free_cnt--;
> -               p->ary[0] = NULL;
> +               p->bitmap = 0;
> +               for(i = 0; i < ARRAY_SIZE(p->ary); ++i)
> +                       p->ary[i] = NULL;
> +               p->count = 0;
But aren't these zeroed by idr_cache_ctor() already?
>         }
>         spin_unlock_irqrestore(&idp->lock, flags);
>         return(p);
                        Pekka
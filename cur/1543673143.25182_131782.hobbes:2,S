Date: 11 May 2003 12:37:48 -0600
From: (Eric W. Biederman)
Subject: Re: bug on shutdown from 68-mm4 (machine_power_off returning causes problems)
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2003/5/11/140

"Martin J. Bligh" <mbligh@aracnet.com> writes:
> >> >> Sorry if this is old news, haven't been paying attention for a week.
> >> >>  Bug on shutdown (just after it says "Power Down") from 68-mm4.
> >> >>  (the NUMA-Q).
> >> > 
> >> > Random guess: is it related to CONFIG_KEXEC?
> >> 
> >> Don't think so - I don't have that enabled. Config file is attatched.
> > 
> > It doesn't matter - the kexec patch tends to futz with stuff like that
> > regardless of CONFIG_KEXEC.
> > 
> > It doesn't happen here.  Could you please retest without the kexec
> > patch applied?
> 
> Yup, backing out kexec fixes it.
Ok.  Thinking it through the differences is that I have machine_power_off
call stop_apics (which is roughly equivalent to the old smp_send_stop).
In the kexec patch that does 2 things.
1) It shuts down the secondary cpus, and returns the bootstrap cpu to
   virtual wire mode. 
2) It calls set_cpus_allowed to force the reboot to be on the primary
   cpu.
After returning from machine_power_off. We run into a problem
in flush_tlb_mm.  Because we have a cpu disabled, that is still part
of the mm's vm mask.
Does anyone know why machine_halt, and machine_power_off return?
If not I am just going to disable the return path.
Eric
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
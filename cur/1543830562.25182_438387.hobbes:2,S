Date: Wed, 28 Jun 2006 13:24:35 +0200
From: Heiko Carstens <>
Subject: [patch] lockdep: special s390 print_symbol() version
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2006/6/28/126

From: Heiko Carstens <heiko.carstens@de.ibm.com>
Have a special version of print_symbol() for s390 which clears the most
significant bit of addr before calling __print_symbol(). This seems to
be better than checking/changing each place in the kernel that saves an
instruction pointer.
Without this the output would look like:
hardirqs last  enabled at (30907): [<80018c6a>] 0x80018c6a
hardirqs last disabled at (30908): [<8001e48c>] 0x8001e48c
softirqs last  enabled at (30904): [<8001dc96>] 0x8001dc96
softirqs last disabled at (30897): [<8001dc50>] 0x8001dc50
instead of this:
hardirqs last  enabled at (19421): [<80018c72>] cpu_idle+0x176/0x1c4
hardirqs last disabled at (19422): [<8001e494>] io_no_vtime+0xa/0x1a
softirqs last  enabled at (19418): [<8001dc9e>] do_softirq+0xa6/0xe8
softirqs last disabled at (19411): [<8001dc58>] do_softirq+0x60/0xe8
Cc: Ingo Molnar <mingo@elte.hu>
Cc: Arjan van de Ven <arjan@infradead.org>
Cc: Martin Schwidefsky <schwidefsky@de.ibm.com>
Signed-off-by: Heiko Carstens <heiko.carstens@de.ibm.com>
---
Patch is against 2.6.17-mm3.
 include/linux/kallsyms.h |    9 +++++++++
 1 file changed, 9 insertions(+)
Index: linux-2.6.17-mm3/include/linux/kallsyms.h
===================================================================
--- linux-2.6.17-mm3.orig/include/linux/kallsyms.h
+++ linux-2.6.17-mm3/include/linux/kallsyms.h
@@ -57,11 +57,20 @@ do {						\
 #define print_fn_descriptor_symbol(fmt, addr) print_symbol(fmt, addr)
 #endif
 
+/* need to clear the most significant bit on s390 31bit */
+#if defined(CONFIG_S390) && !defined(CONFIG_64BIT)
+#define print_symbol(fmt, addr)			\
+do {						\
+	__check_printsym_format(fmt, "");	\
+	__print_symbol(fmt, addr & 0x7fffffff);	\
+} while(0)
+#else
 #define print_symbol(fmt, addr)			\
 do {						\
 	__check_printsym_format(fmt, "");	\
 	__print_symbol(fmt, addr);		\
 } while(0)
+#endif
 
 #ifndef CONFIG_64BIT
 #define print_ip_sym(ip)		\
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
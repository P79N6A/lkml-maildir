Date: Sat, 19 Jan 2008 16:37:25 +0200
From: Felipe Balbi <>
Subject: [PATCH 4/4] USB: OTG: Add check for roothub initialization
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2008/1/19/73

From: Tony Lindgren <tony@atomide.com>
Roothub may not be initialized if no gadget is loaded on musb
for example. Add check for roothub initialization. Also make
comment more accurate.
Signed-off-by: Tony Lindgren <tony@atomide.com>
Signed-off-by: Felipe Balbi <me@felipebalbi.com>
---
 drivers/usb/core/otg.c |   11 ++++++++++-
 1 files changed, 10 insertions(+), 1 deletions(-)
diff --git a/drivers/usb/core/otg.c b/drivers/usb/core/otg.c
index e9ece31..9a2ce7e 100644
--- a/drivers/usb/core/otg.c
+++ b/drivers/usb/core/otg.c
@@ -33,16 +33,25 @@ struct otg_transceiver *otg_get_transceiver(void)
 }
 EXPORT_SYMBOL(otg_get_transceiver);
 
-/* OTG MESSAGE: report errors here, customize to match your product */
+/*
+ * OTG MESSAGE: report errors here, customize to match your product
+ * See also otg_last_error_show().
+ */
 void otg_set_error(struct otg_transceiver *x, enum usb_otg_error errno)
 {
 	if (!x)
 		return;
+
 	if (!x->tpl_enabled)
 		x->last_error = OTG_ERR_DEVICE_SUPPORTED;
 	else
 		x->last_error = errno;
 
+	if (!x->host->root_hub) {
+		printk(KERN_WARNING "OTG: root hub not yet initialized\n");
+		return;
+	}
+
 	sysfs_notify(&x->host->root_hub->dev.kobj, NULL, "otg_last_error");
 }
 EXPORT_SYMBOL(otg_set_error);
-- 
1.5.4.rc3.24.gb53139
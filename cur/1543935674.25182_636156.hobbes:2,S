Date: Wed, 09 Jan 2008 08:31:26 +0100
From: Takashi Iwai <>
Subject: Re: 2.6.24-rc7, intel audio: alsa doesn't say a beep
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2008/1/9/30

At Wed, 09 Jan 2008 07:03:18 +0100,
Harald Dunkel wrote:
> 
> Takashi Iwai wrote:
> > 
> > Did you enable CONFIG_SND_HDA_POWER_SAVE feature?  And which hardware
> > (laptop, product name, whatever) exactly?
> > 
> 
> CONFIG_SND_HDA_POWER_SAVE is not set.
That's fine.
> Hardware is a Dell XPS M1330. CPU is Core2 Duo T7500, 2.20GHz,
> 2 GByte RAM. lspci:
> 
> 00:00.0 Host bridge: Intel Corporation Mobile Memory Controller Hub (rev 0c)
> 00:01.0 PCI bridge: Intel Corporation Mobile PCI Express Root Port (rev 0c)
> 00:1a.0 USB Controller: Intel Corporation 82801H (ICH8 Family) USB UHCI #4 (rev 02)
> 00:1a.1 USB Controller: Intel Corporation 82801H (ICH8 Family) USB UHCI #5 (rev 02)
> 00:1a.7 USB Controller: Intel Corporation 82801H (ICH8 Family) USB2 EHCI #2 (rev 02)
> 00:1b.0 Audio device: Intel Corporation 82801H (ICH8 Family) HD Audio Controller (rev 02)
> 00:1c.0 PCI bridge: Intel Corporation 82801H (ICH8 Family) PCI Express Port 1 (rev 02)
> 00:1c.1 PCI bridge: Intel Corporation 82801H (ICH8 Family) PCI Express Port 2 (rev 02)
> 00:1c.3 PCI bridge: Intel Corporation 82801H (ICH8 Family) PCI Express Port 4 (rev 02)
> 00:1c.5 PCI bridge: Intel Corporation 82801H (ICH8 Family) PCI Express Port 6 (rev 02)
> 00:1d.0 USB Controller: Intel Corporation 82801H (ICH8 Family) USB UHCI #1 (rev 02)
> 00:1d.1 USB Controller: Intel Corporation 82801H (ICH8 Family) USB UHCI #2 (rev 02)
> 00:1d.2 USB Controller: Intel Corporation 82801H (ICH8 Family) USB UHCI #3 (rev 02)
> 00:1d.7 USB Controller: Intel Corporation 82801H (ICH8 Family) USB2 EHCI #1 (rev 02)
> 00:1e.0 PCI bridge: Intel Corporation 82801 Mobile PCI Bridge (rev f2)
> 00:1f.0 ISA bridge: Intel Corporation Mobile LPC Interface Controller (rev 02)
> 00:1f.1 IDE interface: Intel Corporation Mobile IDE Controller (rev 02)
> 00:1f.2 SATA controller: Intel Corporation Mobile SATA AHCI Controller (rev 02)
> 00:1f.3 SMBus: Intel Corporation 82801H (ICH8 Family) SMBus Controller (rev 02)
> 01:00.0 VGA compatible controller: nVidia Corporation Unknown device 0427 (rev a1)
> 03:01.0 FireWire (IEEE 1394): Ricoh Co Ltd Unknown device 0832 (rev 05)
> 03:01.1 Generic system peripheral [0805]: Ricoh Co Ltd R5C822 SD/SDIO/MMC/MS/MSPro Host Adapter (rev 22)
> 03:01.2 System peripheral: Ricoh Co Ltd R5C592 Memory Stick Bus Host Adapter (rev 12)
> 03:01.3 System peripheral: Ricoh Co Ltd xD-Picture Card Controller (rev 12)
> 09:00.0 Ethernet controller: Broadcom Corporation Unknown device 1713 (rev 02)
> 0c:00.0 Network controller: Intel Corporation PRO/Wireless 3945ABG Network Connection (rev 02)
> 
> > Also, please show the contents of /proc/asound/card0/codec#* files.
> > Do you see difference in these files between with and without the
> > patch?
> > 
> 
> See below. There is no difference between both.
Thanks.  Then the possible reason might be the registers that don't
appear in this proc output, such as GPIO.
Could you try the patch below with the latency patch (you reverted) in
rc7?
Takashi
diff -r d773ad622068 sound/pci/hda/patch_sigmatel.c
--- a/sound/pci/hda/patch_sigmatel.c	Tue Jan 08 18:13:27 2008 +0100
+++ b/sound/pci/hda/patch_sigmatel.c	Wed Jan 09 08:29:49 2008 +0100
@@ -1624,12 +1624,13 @@ static void stac92xx_enable_gpio_mask(st
 				  AC_VERB_SET_GPIO_DIRECTION, spec->gpio_mask);
 	/* Configure GPIOx as CMOS */
 	snd_hda_codec_write_cache(codec, codec->afg, 0, 0x7e7, 0x00000000);
+	/* Enable GPIOx */
+	snd_hda_codec_write_cache(codec, codec->afg, 0,
+				  AC_VERB_SET_GPIO_MASK, spec->gpio_mask);
+	msleep(1);
 	/* Assert GPIOx */
 	snd_hda_codec_write_cache(codec, codec->afg, 0,
 				  AC_VERB_SET_GPIO_DATA, spec->gpio_data);
-	/* Enable GPIOx */
-	snd_hda_codec_write_cache(codec, codec->afg, 0,
-				  AC_VERB_SET_GPIO_MASK, spec->gpio_mask);
 }
 
 /*
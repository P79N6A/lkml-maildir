Date: Fri, 15 Jul 2005 18:34:52 +0800
From: David Teigland <>
Subject: [patch 02/12] dlm: resend lookups
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2005/7/15/82

During recovery, set the RESEND flag on locks waiting for a lookup so
they'll be resent when recovery completes.
Signed-off-by: David Teigland <teigland@redhat.com>
Index: linux-2.6.12-mm1/drivers/dlm/lock.c
===================================================================
--- linux-2.6.12-mm1.orig/drivers/dlm/lock.c
+++ linux-2.6.12-mm1/drivers/dlm/lock.c
@@ -3212,12 +3212,20 @@ void dlm_recover_waiters_pre(struct dlm_
 	down(&ls->ls_waiters_sem);
 
 	list_for_each_entry_safe(lkb, safe, &ls->ls_waiters, lkb_wait_reply) {
-		if (!dlm_is_removed(ls, lkb->lkb_nodeid))
-			continue;
-
 		log_debug(ls, "pre recover waiter lkid %x type %d flags %x",
 			  lkb->lkb_id, lkb->lkb_wait_type, lkb->lkb_flags);
 
+		/* all outstanding lookups, regardless of destination  will be
+		   resent after recovery is done */
+
+		if (lkb->lkb_wait_type == DLM_MSG_LOOKUP) {
+			lkb->lkb_flags |= DLM_IFL_RESEND;
+			continue;
+		}
+
+		if (!dlm_is_removed(ls, lkb->lkb_nodeid))
+			continue;
+
 		switch (lkb->lkb_wait_type) {
 
 		case DLM_MSG_REQUEST:
@@ -3244,11 +3252,6 @@ void dlm_recover_waiters_pre(struct dlm_
 			put_lkb(lkb);
 			break;
 
-		case DLM_MSG_LOOKUP:
-			/* all outstanding lookups, regardless of dest.
-			   will be resent after recovery is done */
-			break;
-
 		default:
 			log_error(ls, "invalid lkb wait_type %d",
 				  lkb->lkb_wait_type);
--
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
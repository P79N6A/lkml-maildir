Date: Tue, 05 Feb 2008 17:25:06 +0100
From: Jim Meyering <>
Subject: [PATCH] uml: handle unusual results from find_tempdir.
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2008/2/5/232

An alternative: make find_tempdir set tempdir to default_tempdir
upon malloc failure.
* arch/um/os-Linux/mem.c (make_tempfile): Handle NULL tempdir.
Don't let a long tempdir (e.g., via TMPDIR) provoke heap corruption.
Signed-off-by: Jim Meyering <meyering@redhat.com>
---
 arch/um/os-Linux/mem.c |    3 +++
 1 files changed, 3 insertions(+), 0 deletions(-)
diff --git a/arch/um/os-Linux/mem.c b/arch/um/os-Linux/mem.c
index e114d09..1458385 100644
--- a/arch/um/os-Linux/mem.c
+++ b/arch/um/os-Linux/mem.c
@@ -176,6 +176,9 @@ int __init make_tempfile(const char *template, char **out_tempname,
 	  return -1;
 	find_tempdir();
+	if (tempdir == NULL || strlen(tempdir) >= MAXPATHLEN)
+	  return -1;
+
 	if (template[0] != '/')
 		strcpy(tempname, tempdir);
 	else
--
1.5.4.19.gd3dfd
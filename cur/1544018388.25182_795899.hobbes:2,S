Date: Thu, 22 Jan 2009 17:56:08 +0000
From: Ian Campbell <>
Subject: [PATCH] HVC: do not request the irq twice.
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2009/1/22/254

Otherwise:
  root@bogga:~# tty
  /dev/hvc0
  root@bogga:~# reboot
  Broadcast message from root@bogga (hvc0) (Thu Jan 22 17:51:20 2009):
  The system is going down for reboot NOW!
  INIT: Switching to runlevel: 6
  INIT: Sending processes the TERM signal
  hvc_open: request_irq failed with rc -16.
Signed-off-by: Ian Campbell <ian.campbell@citrix.com>
Cc: Milton Miller <miltonm@bga.com>
Cc: Christian Borntraeger <borntraeger@de.ibm.com>
Cc: Hendrik Brueckner <brueckner@linux.vnet.ibm.com>
Cc: Benjamin Herrenschmidt <benh@kernel.crashing.org>
Cc: Rusty Russell <rusty@rustcorp.com.au>
---
 drivers/char/hvc_irq.c |    4 ++++
 1 files changed, 4 insertions(+), 0 deletions(-)
diff --git a/drivers/char/hvc_irq.c b/drivers/char/hvc_irq.c
index 2623e17..8152a13 100644
--- a/drivers/char/hvc_irq.c
+++ b/drivers/char/hvc_irq.c
@@ -28,6 +28,10 @@ int notifier_add_irq(struct hvc_struct *hp, int irq)
 		hp->irq_requested = 0;
 		return 0;
 	}
+
+	if (hp->irq_requested)
+		return 0;
+
 	rc = request_irq(irq, hvc_handle_interrupt, IRQF_DISABLED,
 			   "hvc_console", hp);
 	if (!rc)
-- 
1.5.6.5
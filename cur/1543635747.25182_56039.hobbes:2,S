Date: Fri, 12 Jul 2002 17:02:07 -0500 (CDT)
From: Matt Stegman <>
Subject: Re: 64 bit netdev stats counter
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2002/7/12/216

On 12 Jul 2002, Stephen Hemminger wrote:
> 64 bit values are not atomic so on x86 there will be glitches if this
> ever wraps over on an SMP machine.  One other engineer is already
> adressing this for inode values like size; but this would introduce the
> same problem for network stuff.
One other solution I thought of would be to have an rx_bytes_wrap counter
in the struct.
struct net_device_stats {
...
	unsigned long rx_bytes;
	unsigned long rx_bytes_wrap;
	unsigned long tx_bytes;
	unsigned long tx_bytes_wrap;
...
}
... and then, everywhere we add to rx_bytes (or tx_bytes):
stats->rx_bytes += pkt_length;
if (stats->rx_bytes <= pkt_length) stats->rx_bytes_wrap++;
I suppose this might also be more backwards compatible - if other code I
don't know about expects the rx_bytes to be a long, this would keep it so.
Also, if gcc has real problems with doing 64-bit math on a 32-bit
processor, this keeps everything in 32-bits.  I could then make a local
"unsigned long long" variable in the code that prints /proc/net/dev, and
in ifconfig.
unsigned long long rx_total_bytes = stats->rx_bytes * stats->rx_bytes_wrap;
sprintf(buf, "RX bytes:%llu", stats->rx_total_bytes);
-- 
      -Matt Stegman
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
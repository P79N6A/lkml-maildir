Date: Sun, 30 Jan 2005 09:02:41 +0000
From: Al Viro <>
Subject: [FIX] Re: [2.6 patch] drivers/cdrom/isp16.c: small cleanups
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2005/1/30/12

On Sun, Jan 30, 2005 at 12:54:30AM +0100, Bartlomiej Zolnierkiewicz wrote:
> On Sun, 30 Jan 2005 00:46:24 +0100, Adrian Bunk <bunk@stusta.de> wrote:
> > On Sat, Jan 29, 2005 at 06:51:25PM +0100, Bartlomiej Zolnierkiewicz wrote:
> > > Hi,
> > >
> > > On Sat, 29 Jan 2005 18:11:08 +0100, Adrian Bunk <bunk@stusta.de> wrote:
> > > > This patch makes the needlessly global function isp16_init static.
> > > >
> > > > As a result, it turned out that both this function and some other code
> > > > are only required #ifdef MODULE.
... assuming that driver had not been broken to start with
> > >
> > > Your patch is correct but it is wrong. ;)
> > >
> > > #ifdefs around isp16_init() need to be removed as
> > > otherwise this driver is not initialized in built-in case.
... assuming that driver is initialized in built-in case
> > It's somehow initialized via isp16_setup.
... assuming that magic exists, which would follow from the original
assumptions
> Could you explain?
> 
> AFAICS isp16_setup() only handles "isp16=" boot parameter.
Simple: driver is broken.  And "obvious" transformations of that sort are
safe only when they are applied to correct code.  Otherwise you end up with
obfuscation of original breakage.
Trivial check of history shows that
	a) until 2.5.1-pre1 isp16_init() had been called from blk_dev_init()
	b) in 2.5.1-pre2 Jens had taken that call out, but forgot to remove
ifdef in isp16.c
	c) nobody had cared since then.
Fix follows.
diff -u RC11-rc2-bk6-base/drivers/cdrom/isp16.c RC11-rc2-bk6-current/drivers/cdrom/isp16.c
--- RC11-rc2-bk6-base/drivers/cdrom/isp16.c	2005-01-28 17:06:37.000000000 -0500
+++ RC11-rc2-bk6-current/drivers/cdrom/isp16.c	2005-01-30 04:00:09.319617779 -0500
@@ -112,7 +112,7 @@
  *  ISP16 initialisation.
  *
  */
-int __init isp16_init(void)
+static int __init isp16_init(void)
 {
 	u_char expected_drive;
 
@@ -366,15 +366,13 @@
 	return 0;
 }
 
-void __exit isp16_exit(void)
+static void __exit isp16_exit(void)
 {
 	release_region(ISP16_IO_BASE, ISP16_IO_SIZE);
 	printk(KERN_INFO "ISP16: module released.\n");
 }
 
-#ifdef MODULE
 module_init(isp16_init);
-#endif
 module_exit(isp16_exit);
 
 MODULE_LICENSE("GPL");
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
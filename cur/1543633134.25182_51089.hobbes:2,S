Date: Sat, 08 Jun 2002 11:33:01 -0400
From: Brian Gerst <>
Subject: [PATCH] missing GET_CPU_IDX in i386 entry.S
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2002/6/8/37

resume_kernel uses CPU_IDX but never uses GET_CPU_IDX to get the index. 
  This is an issue when smp and preemption are both enabled.  I also 
removed the unused GET_CURRENT_CPU_IDX.
--
				Brian Gerst
diff -urN linux-bk/arch/i386/kernel/entry.S linux/arch/i386/kernel/entry.S
--- linux-bk/arch/i386/kernel/entry.S	Wed May 29 15:06:00 2002
+++ linux/arch/i386/kernel/entry.S	Sat Jun  8 10:44:44 2002
@@ -83,13 +83,9 @@
 #define GET_CPU_IDX \
 		movl TI_CPU(%ebx), %eax;  \
 		shll $irq_array_shift, %eax
-#define GET_CURRENT_CPU_IDX \
-		GET_THREAD_INFO(%ebx); \
-		GET_CPU_IDX
 #define CPU_IDX (,%eax)
 #else
 #define GET_CPU_IDX
-#define GET_CURRENT_CPU_IDX GET_THREAD_INFO(%ebx)
 #define CPU_IDX
 #endif
 
@@ -236,6 +232,7 @@
 	movl TI_FLAGS(%ebx), %ecx
 	testb $_TIF_NEED_RESCHED, %cl
 	jz restore_all
+	GET_CPU_IDX
 	movl irq_stat+local_bh_count CPU_IDX, %ecx
 	addl irq_stat+local_irq_count CPU_IDX, %ecx
 	jnz restore_all
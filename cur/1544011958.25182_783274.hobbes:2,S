Date: Mon, 22 Dec 2008 14:12:43 +0100
From: Bernd Eckenfels <>
Subject: Re: [PATCH 2/2] mmc_block: ensure all sectors that do not have errors are read
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2008/12/22/91

In article <494F7A02.2030302@nokia.com> you wrote:
> +               /*
> +                * After a read error, we redo the request one sector at a time
> +                * in order to accurately determine which sectors can be read
> +                * successfully.
> +                */
> +               if (disable_multi && brq.data.blocks > 1)
> +                       brq.data.blocks = 1;
> +
>                if (brq.data.blocks > 1) {
>                        /* SPI multiblock writes terminate using a special
>                         * token, not a STOP_TRANSMISSION request.
We would save an comparision here if we use it like this:
...
                if (brq.data.blocks > 1) {
                 /*
                  * After a read error, we redo the request one sector at a time
                  * in order to accurately determine which sectors can be read
                  * successfully.
                  */
                  if (disable_multi)
                    brq.data.blocks = 1;                        
                  /* SPI multiblock writes terminate using a special
...
> +               if (brq.cmd.error || brq.data.error || brq.stop.error) {
> +                       if (brq.data.blocks > 1 && rq_data_dir(req) == READ) {
> +                               /* Redo read one sector at a time */
> +                               printk(KERN_WARNING "%s: retrying using single "
> +                                      "block read\n", req->rq_disk->disk_name);
> +                               disable_multi = 1;
> +                               continue;
> +                       }
Will this flood the logs?
Gruss
Bernd
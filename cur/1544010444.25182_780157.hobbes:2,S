Date: Sat, 13 Dec 2008 17:29:15 +0900 (JST)
From: Ryusuke Konishi <>
Subject: Re: [PATCH mmotm 1/5] nilfs2: fix problems of memory allocation in ioctl
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2008/12/13/26

On Fri, 12 Dec 2008 21:24:11 +0100, Andi Kleen <andi@firstfloor.org> wrote:
> > In the current interface, each data item is copied twice: one is to
> > the allocated memory from user space (via copy_from_user), and another
> 
> For such large copies it is better to use multiple smaller (e.g. 4K) 
> copy user, that gives better real time preempt latencies. Each cfu has a 
> cond_resched(), but only one, not multiple times in the inner loop.
For the function in question, the buffer memory can be divided into a
smaller size (at least to 4K bytes) since the buffer is repeatedly
used for small objects, where the copy_from_user (and a copy_to_user)
is only once in each cycle.
So, just reducing the allocation size of the buffer seems good; it is
likely able to avoid both large preempt latencies and large memory
allocation, which also can leave off the use of vmalloc.
> > is to on-memory structures or to buffers/pages from the allocated
> > memory.
> 
> It depends how performance critical it is.
> 
> One way for example is to grab the user pages using get_user_pages()
> and then reference those pages directly using kmap().
> But you would be at the mercy of the user process not modifying in 
> parallel then. Normally it is safer to work from copies in kernel
> space to avoid races. As long as it doesn't happen too often a few
> copies are also usually not a problem. I wouldn't worry about them
> unless you see them prominently in profiler logs.
> 
> -Andi
I got it.  If need arises, then I'll recall get_user_pages(). At
present, there is likely no need to do like that.
Thank you for the informative advises.
With regards,
Ryusuke
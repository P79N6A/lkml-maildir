Date: Tue, 04 Mar 2008 13:06:43 -0800
From: Harvey Harrison <>
Subject: [JANITOR-PATCH] rtc: switch to unlocked_ioctl
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2008/3/4/439

Make the lock/unlock_kernel explicit.
Signed-off-by: Harvey Harrison <harvey.harrison@gmail.com>
---
 arch/arm/common/rtctime.c |    7 ++++---
 1 files changed, 4 insertions(+), 3 deletions(-)
diff --git a/arch/arm/common/rtctime.c b/arch/arm/common/rtctime.c
index f53bca4..2062f92 100644
--- a/arch/arm/common/rtctime.c
+++ b/arch/arm/common/rtctime.c
@@ -173,8 +173,7 @@ static unsigned int rtc_poll(struct file *file, poll_table *wait)
 	return data != 0 ? POLLIN | POLLRDNORM : 0;
 }
 
-static int rtc_ioctl(struct inode *inode, struct file *file, unsigned int cmd,
-		     unsigned long arg)
+static int rtc_ioctl(struct file *file, unsigned int cmd, unsigned long arg)
 {
 	struct rtc_ops *ops = file->private_data;
 	struct rtc_time tm;
@@ -182,6 +181,7 @@ static int rtc_ioctl(struct inode *inode, struct file *file, unsigned int cmd,
 	void __user *uarg = (void __user *)arg;
 	int ret = -EINVAL;
 
+	lock_kernel();
 	switch (cmd) {
 	case RTC_ALM_READ:
 		ret = rtc_arm_read_alarm(ops, &alrm);
@@ -276,6 +276,7 @@ static int rtc_ioctl(struct inode *inode, struct file *file, unsigned int cmd,
 			ret = ops->ioctl(cmd, arg);
 		break;
 	}
+	unlock_kernel();
 	return ret;
 }
 
@@ -333,7 +334,7 @@ static const struct file_operations rtc_fops = {
 	.llseek		= no_llseek,
 	.read		= rtc_read,
 	.poll		= rtc_poll,
-	.ioctl		= rtc_ioctl,
+	.unlocked_ioctl	= rtc_ioctl,
 	.open		= rtc_open,
 	.release	= rtc_release,
 	.fasync		= rtc_fasync,
-- 
1.5.4.3.500.g83a2c
Date: Fri, 27 Jan 2006 06:50:14 +1100
From: Nick Piggin <>
Subject: Re: 2.6.16-rc1-mm3
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2006/1/26/239

Nick Piggin wrote:
> Thanks, it confirms my suspicions.
> 
> Can you try the following patch, please?
> It appears the warnings were brought out by my improvement to
> the put_page_testzero debugging code (which previously did not
> check that we might be attempting to free a constituent compound
> page).
> 
> Can you test the following patch please?
> 
Sorry, wrong patch.
Note the warnings you are seeing should not result in memory
corruption, but will result in the given hugepage leaking.
-- 
SUSE Labs, Novell Inc.
Index: linux-2.6/include/linux/mm.h
===================================================================
--- linux-2.6.orig/include/linux/mm.h
+++ linux-2.6/include/linux/mm.h
@@ -294,6 +294,8 @@ struct page {
  */
 static inline int put_page_testzero(struct page *page)
 {
+	if (unlikely(PageCompound(page)))
+		page = (struct page *)page_private(page);
 	BUG_ON(atomic_read(&page->_count) == 0);
 	return atomic_dec_and_test(&page->_count);
 }
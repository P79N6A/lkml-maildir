Date: Sat, 12 Aug 2006 04:58:49 -0400
From: Chuck Ebbert <>
Subject: Re: 2.6.17.8 - do_vfs_lock: VFS is out of sync with lock  manager!
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2006/8/12/18

In-Reply-To: <9a8748490608101537y4c377fb3xcd8babbdbc29cee2@mail.gmail.com>
On Fri, 11 Aug 2006 00:37:35 +0200, Jesper Juhl wrote:
> > > >I have some webservers that have recently started reporting the
> > > >following message in their logs :
> > > >
> > > >  do_vfs_lock: VFS is out of sync with lock manager!
What does this (not even compile tested) patch print?
--- 2.6.17.8-nb/fs/lockd/clntproc.c	2006-06-10 17:39:21.000000000 -0400
+++ 2.6.17.8-nb/fs/lockd/clntproc.c.new	2006-08-12 04:43:45.000000000 -0400
@@ -458,7 +458,9 @@ static void nlmclnt_locks_init_private(s
 static void do_vfs_lock(struct file_lock *fl)
 {
 	int res = 0;
-	switch (fl->fl_flags & (FL_POSIX|FL_FLOCK)) {
+	unsigned char flags = fl->fl_flags & (FL_POSIX|FL_FLOCK);
+
+	switch (flags) {
 		case FL_POSIX:
 			res = posix_lock_file_wait(fl->fl_file, fl);
 			break;
@@ -469,8 +471,8 @@ static void do_vfs_lock(struct file_lock
 			BUG();
 	}
 	if (res < 0)
-		printk(KERN_WARNING "%s: VFS is out of sync with lock manager!\n",
-				__FUNCTION__);
+		printk(KERN_WARNING "%s: VFS is out of sync with lock manager! -- %s: %d\n",
+				__FUNCTION__, flags == FL_POSIX ? "POSIX" : "FLOCK", res);
 }
 
 /*
-- 
Chuck
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
Date: Tue, 18 Sep 2007 14:51:18 -0700
From: Jeremy Fitzhardinge <>
Subject: Re: [patch 4/7] Immediate Values - i386 Optimization
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2007/9/18/382

Mathieu Desnoyers wrote:
> +#define immediate_read(name)						\
> +	({								\
> +		__typeof__(name##__immediate) value;			\
> +		switch (sizeof(value)) {				\
> +		case 1:							\
> +			asm (	".section __immediate, \"a\", @progbits;\n\t" \
> +					".long %1, (0f)+1, 1;\n\t"	\
> +					".previous;\n\t"		\
> +					"0:\n\t"			\
> +					"mov %2,%0;\n\t"		\
Given that you're relying on the exact instruction that this mov
generates, it might be better to explicitly put the opcodes in with
.byte.  That way you're protected from the assembler deciding to
generate some other form of the instruction (for whatever reason).  I
guess substituting in different registers would be a pain.
Aside from that,  is there any reason not to just put $0 in there rather
than use %2?
> +					".long %1, (0f)+1, 4;\n\t"	\
> +					".previous;\n\t"		\
> +					"1:\n\t"			\
> +					".org (1b)+(3-((1b)%%4)), 0x90;\n\t" \
> 
Seems a little complex, but I couldn't come up with anything much better:
	.org . + 3 - (. & 3), 0x90
You can use . rather than needing to define 1:, it doesn't need quite so
many parens, and using &3 avoids the %% wart. 
It's a pity that gas seems to generate plain 0x90 nops rather than
long-nop forms here.  I thought it could do that.
    J
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
Date: Fri, 15 Apr 2005 23:03:20 +1000
From: Nick Piggin <>
Subject: Re: [patch] sched: fix sched domain degenerate
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2005/4/15/54

Siddha, Suresh B wrote:
> Appended patch makes sched domain degenerate really work.
> 
> For example, now NUMA domain really gets removed on a non-NUMA system.
> 
> Signed-off-by: Suresh Siddha <suresh.b.siddha@intel.com>
> 
> 
> --- linux-2.6.12-rc2-mm3/kernel/sched.c	2005-04-13 11:15:00.942609504 -0700
> +++ linux-mc/kernel/sched.c	2005-04-13 10:44:37.400829992 -0700
> @@ -4777,7 +4777,7 @@ static int __devinit sd_parent_degenerat
>  	/* WAKE_BALANCE is a subset of WAKE_AFFINE */
>  	if (cflags & SD_WAKE_AFFINE)
>  		pflags &= ~SD_WAKE_BALANCE;
> -	if ((~sd->flags) & parent->flags)
> +	if (~cflags & pflags)
>  		return 0;
> 
>  	return 1;
Thanks, I need a brown paper bag.
I think instead of the other 2 hunks in your patch I would like
to do it the following way (I hope I get this right, finally).
-- 
SUSE Labs, Novell Inc.
Make sched-remove-degenerate-domains.patch actually work.
Signed-off-by: Suresh Siddha <suresh.b.siddha@intel.com>
Catch more (hopefully all) cases.
Signed-off-by: Nick Piggin <nickpiggin@yahoo.com.au>
Index: linux-2.6/kernel/sched.c
===================================================================
--- linux-2.6.orig/kernel/sched.c	2005-04-15 22:52:25.000000000 +1000
+++ linux-2.6/kernel/sched.c	2005-04-15 22:58:54.000000000 +1000
@@ -4844,7 +4844,14 @@ static int __devinit sd_parent_degenerat
 	/* WAKE_BALANCE is a subset of WAKE_AFFINE */
 	if (cflags & SD_WAKE_AFFINE)
 		pflags &= ~SD_WAKE_BALANCE;
-	if ((~sd->flags) & parent->flags)
+	/* Flags needing groups don't count if only 1 group in parent */
+	if (parent->groups == parent->groups->next) {
+		pflags &= ~(SD_LOAD_BALANCE |
+				SD_BALANCE_NEWIDLE |
+				SD_BALANCE_FORK |
+				SD_BALANCE_EXEC);
+	}
+	if (~cflags & pflags)
 		return 0;
 
 	return 1;
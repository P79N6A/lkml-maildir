Date: Wed, 5 Mar 2008 19:22:31 +0100
From: Andi Kleen <>
Subject: Re: 2.6.25-rc3-mm1 - PROFILE_LIKELY redux..
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2008/3/5/308

> Yes, but both those files now have:
> 
> /*
>  * likely and unlikely explode when used in vdso in combination with
>  * profile-likely-unlikely-macros.patch
>  */
> #undef likely
> #define likely(x) (x)
> #undef unlikely
> #define unlikely(x) (x)
> 
> at the top, so it'll be something else.  Perhaps a `likely' snuck in via an
I see. 
> inline in a header file.  It would be better to add a #define DONT_DO_THAT
I think you need to do it differently. Not undef/define, but set
some symbol that is checked by the unlikely profiler and it won't
enable itself with that symbol set.  Then header files would be covered too.
> at the top of arch/x86/kernel/vsyscall_64.c and
> arch/x86/vdso/vclock_gettime.c, then use that to defeat likely-profiling.
Possible.  The problem is that there are now vsyscall functions in
other files too, especially hpet_64.c and tsc_64.c
Perhaps this is something that should be just checked in modpost instead. 
Any external references from the vsyscall section to another section
should be flag'ed as error (cc'ed Sam in case he wants to look at that) 
-Andi
Date: Wed, 18 Oct 2006 10:29:32 +0200
From: Jarek Poplawski <>
Subject: Re: [PATCH 2.6.19-rc2] [REVISED] drivers/media/video/se401.c: check kmalloc() return value.
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2006/10/18/50

On 18-10-2006 06:31, Amit Choudhary wrote:
> Description: Check the return value of kmalloc() in function se401_start_stream(), in file drivers/media/video/se401.c.
> 
> Signed-off-by: Amit Choudhary <amit2030@gmail.com>
> 
> diff --git a/drivers/media/video/se401.c b/drivers/media/video/se401.c
> index 7aeec57..fe94227 100644
> --- a/drivers/media/video/se401.c
> +++ b/drivers/media/video/se401.c
> @@ -450,6 +450,8 @@ static int se401_start_stream(struct usb
>  	}
>  	for (i=0; i<SE401_NUMSBUF; i++) {
>  		se401->sbuf[i].data=kmalloc(SE401_PACKETSIZE, GFP_KERNEL);
> +		if (!se401->sbuf[i].data)
> +			goto nomem_err;
>  	}
> 
>  	se401->bayeroffset=0;
> @@ -458,13 +460,15 @@ static int se401_start_stream(struct usb
>  	se401->scratch_overflow=0;
>  	for (i=0; i<SE401_NUMSCRATCH; i++) {
>  		se401->scratch[i].data=kmalloc(SE401_PACKETSIZE, GFP_KERNEL);
> +		if (!se401->scratch[i].data)
> +			goto nomem_err;
>  		se401->scratch[i].state=BUFFER_UNUSED;
>  	}
> 
>  	for (i=0; i<SE401_NUMSBUF; i++) {
>  		urb=usb_alloc_urb(0, GFP_KERNEL);
>  		if(!urb)
> -			return -ENOMEM;
> +			goto nomem_err;
> 
>  		usb_fill_bulk_urb(urb, se401->dev,
>  			usb_rcvbulkpipe(se401->dev, SE401_VIDEO_ENDPOINT),
> @@ -482,6 +486,20 @@ static int se401_start_stream(struct usb
>  	se401->framecount=0;
> 
>  	return 0;
> +
> + nomem_err:
> +	for (i=0; i<SE401_NUMSBUF; i++) {
> +		usb_kill_urb(se401->urb[i]);
> +		usb_free_urb(se401->urb[i]);
> +		se401->urb[i] = NULL;
> +		kfree(se401->sbuf[i].data);
...
I see before se401_start_stream usually this is done: 
static int se401_stop_stream(struct usb_se401 *se401)
{
...
	for (i=0; i<SE401_NUMSBUF; i++) if (se401->urb[i]) {
		usb_kill_urb(se401->urb[i]);
		usb_free_urb(se401->urb[i]);
		se401->urb[i]=NULL;
		kfree(se401->sbuf[i].data);
	}
	for (i=0; i<SE401_NUMSCRATCH; i++) {
		kfree(se401->scratch[i].data);
		se401->scratch[i].data=NULL;
	}
	return 0;
}
... but because above there is no: 
se401->sbuf[i].data=NULL;
after kfree(se401->sbuf[i].data);
it is possible that in se401_start_stream we have
kmalloc error for e.g. i == 0 but kfree for i >= 1,
which could be not NULL (but kfreed)... 
Regards,
Jarek P.
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
Date: Sun, 04 Sep 2005 17:54:58 +0200
From: Ondrej Zary <>
Subject: Re: ide-floppy - software eject not working with LS-120 drive
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2005/9/4/83

Denis Vlasenko wrote:
> On Friday 02 September 2005 23:47, Ondrej Zary wrote:
> 
>>Hello,
>>I've bought "new" LS-120 drive and found that software eject does not 
>>work with 2.6.13 kernel:
>>root@pentium:~# eject /dev/hdc
>>eject: unable to eject, last error: Invalid argument
>>
>>The drive spins up and after a while the command fails.
>>This appears in dmesg after each eject attempt:
>>  hdc: unknown partition table
>>ide-floppy: hdc: I/O error, pc = 1b, key =  5, asc = 24, ascq =  0
>>
>>When I boot 2.4.31, eject works fine.
> 
> 
> Can you probive something narrower than 2.4.31 -> 2.6.13 jump?
The problem is caused by idefloppy_ioctl() function which *first* tries
generic_ide_ioctl() and *only* if it fails with -EINVAL, proceeds with
the specific ioctls.
This patch fixes it by first going through the internal ioctls and only
trying generic_ide_ioctl() if none of them matches.
Signed-off-by: Ondrej Zary <linux@rainbow-software.org>
-- 
Ondrej Zary
--- linux-2.6.13-orig/drivers/ide/ide-floppy.c	2005-08-29 01:41:01.000000000 +0200
+++ linux-2.6.13-pentium/drivers/ide/ide-floppy.c	2005-09-04 14:07:53.000000000 +0200
@@ -2038,11 +2038,9 @@
 	struct ide_floppy_obj *floppy = ide_floppy_g(bdev->bd_disk);
 	ide_drive_t *drive = floppy->drive;
 	void __user *argp = (void __user *)arg;
-	int err = generic_ide_ioctl(drive, file, bdev, cmd, arg);
+	int err;
 	int prevent = (arg) ? 1 : 0;
 	idefloppy_pc_t pc;
-	if (err != -EINVAL)
-		return err;
 
 	switch (cmd) {
 	case CDROMEJECT:
@@ -2094,7 +2092,7 @@
 	case IDEFLOPPY_IOCTL_FORMAT_GET_PROGRESS:
 		return idefloppy_get_format_progress(drive, argp);
 	}
- 	return -EINVAL;
+	return generic_ide_ioctl(drive, file, bdev, cmd, arg);
 }
 
 static int idefloppy_media_changed(struct gendisk *disk)
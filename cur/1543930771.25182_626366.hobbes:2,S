Date: Tue, 11 Dec 2007 00:06:15 +0200
From: "Pekka Enberg" <>
Subject: Re: [RFC] [PATCH] A clean approach to writeout throttling
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2007/12/10/241

Hi,
On Dec 10, 2007 11:31 PM, Jonathan Corbet <corbet@lwn.net> wrote:
> I'm just getting around to looking at this.  One thing jumped out at me:
>
> > +     if (bio->bi_throttle) {
> > +             struct request_queue *q = bio->bi_queue;
> > +             bio->bi_throttle = 0; /* or detect multiple endio and err? */
> > +             atomic_add(bio->bi_throttle, &q->available);
> > +             wake_up(&q->throttle_wait);
> > +     }
>
> I'm feeling like I must be really dumb, but...how can that possibly
> work?  You're zeroing >bi_throttle before adding it back into
> q->available, so the latter will never increase...
Heh, well, that's ok as long as bio->bi_vcnt is set to zero and I think we
have some md raid drivers do just that... ;-)
                                Pekka
Date: Sun, 05 Nov 2000 14:39:43 +1100
From: Keith Owens <>
Subject: Re: Locking Between User Context and Soft IRQs in 2.4.0
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2000/11/4/65

On Sun, 05 Nov 2000 12:28:55 +1100, 
Andrew Morton <andrewm@uow.edu.au> wrote:
>          CPU0                              CPU1
>
>        rtnl_lock()
>         dev_ifsioc()
>          dev_change_flags()
>           dev_open();
>            dev->open();
>            vortex_open()
>                                        sys_delete_module()
>                                        if (!__MOD_IN_USE)
>                                         free_module()
If dev->open() calls try_inc_use_count() before it enters the module
you will lock out concurrent module unload via module unload_lock.
There is no need for another module semaphore.
Also there is no need to test dev->owner, try_inc_use_count() already
does that.
        /*
         *      Call device private open method
         */
	ret = -ENODEV;
	if (try_inc_mod_count(dev->owner)) {
		if (dev->open && (ret = dev->open(dev)) && dev->owner)
			__MOD_DEC_USE_COUNT(dev->owner);
	}
In dev_close()
        /*
         *      Call device private close method
         */
	if (dev->owner)
		__MOD_DEC_USE_COUNT(dev->owner);
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
Please read the FAQ at 
http://www.tux.org/lkml/
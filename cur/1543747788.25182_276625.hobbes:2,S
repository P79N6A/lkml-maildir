Date: Fri, 03 Dec 2004 23:52:14 -0800
From: Joshua Kwan <>
Subject: Re: [2.6.10-rc2] In-kernel swsusp broken
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2004/12/4/6

[CC:ing Jaroslav, solution involving ALSA code is attached.]
Andrew Morton wrote:
> Yes, if you could apply something like the below and see if we can see
> which driver is causing the problem?  Make sure that CONFIG_PCI_NAMES is
> set...
Yeah, did that (didn't use yours), and apparently all the suspend 
functions return 0 but it died after pcibios_set_master on several 
devices - the last call succeeded (it was my intel8x0 sound card) and 
thereafter the hang occurred.
I noticed a recent -mm patch added
pci_disable_device(chip->pci);
in sound/pci/intel8x0.c -> intel8x0_suspend. Looks like that didn't 
help; I also had to add a pci_save_state(chip->pci) above that for 
suspend to work, mimicking the way USB seemed to handle suspending, and 
that worked! Had to do that for intel8x0m.c as well. I looked for other 
instances of disable_device in sound/pci and saw many 
pci_set_power_state(pdev, 3). Would that have a similar effect to saving 
the state? Should I have used that instead? Well, you be the judge...
I'm not really sure what to send a diff against, but I figure -rc3 is 
best so that other people can take advantage of the fix without having 
to patch to -mm first.
Signed-off-by: Joshua Kwan <joshk@triplehelix.org>
-- 
Joshua Kwan
--- linux-2.6.9/sound/pci/intel8x0.c~	2004-12-03 23:44:28.000000000 -0800
+++ linux-2.6.9/sound/pci/intel8x0.c	2004-12-03 23:44:36.000000000 -0800
@@ -2279,6 +2279,8 @@
 	for (i = 0; i < 3; i++)
 		if (chip->ac97[i])
 			snd_ac97_suspend(chip->ac97[i]);
+	pci_save_state(chip->pci);
+	pci_disable_device(chip->pci);
 	snd_power_change_state(card, SNDRV_CTL_POWER_D3hot);
 	return 0;
 }
--- linux-2.6.9/sound/pci/intel8x0m.c~	2004-12-03 23:44:42.000000000 -0800
+++ linux-2.6.9/sound/pci/intel8x0m.c	2004-12-03 23:44:57.000000000 -0800
@@ -1091,6 +1091,8 @@
 		snd_pcm_suspend_all(chip->pcm[i]);
 	if (chip->ac97)
 		snd_ac97_suspend(chip->ac97);
+	pci_save_state(chip->pci);
+	pci_disable_device(chip->pci);
 	snd_power_change_state(card, SNDRV_CTL_POWER_D3hot);
 	return 0;
 }
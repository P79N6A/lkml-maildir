Date: Thu, 29 Sep 2005 09:41:40 +0200
From: Nico Schottelius <>
Subject: udev/modprobe issue
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2005/9/29/34

Good morning everybody!
I've a small problem with loading the sata_sil module, but it could be a
general issue: We use this sata-kontroller with sata-harddisks to backup
our systems. The harddisk is exchanged (while the system is running) every
day. So we load/unload sata_sil in our backup scripts, so 'hotplugging' is possible.
My problem is, that modprobe returns earlier than the attached device is usable:
----------------------------------------------------------------------
srwali01:/# modprobe sata_sil; mount /dev/sda1 /mnt/hdbackup/
mount: you must specify the filesystem type
srwali01:/# rmmod sata_sil
srwali01:/# modprobe sata_sil; ls -l /dev/sda1               
ls: /dev/sda1: No such file or directory
----------------------------------------------------------------------
So I have to do
----------------------------------------------------------------------
srwali01:/# modprobe sata_sil
srwali01:/# sleep 2
srwali01:/# mount /dev/sda1 /mnt/hdbackup
----------------------------------------------------------------------
The problem is most likely that udev is too slow or that modprobe does not
know/wait for udev:
----------------------------------------------------------------------
srwali01:/# mount | grep tmpfs | grep -v /dev/shm
tmpfs on /dev type tmpfs (rw,size=10M,mode=0755)
srwali01:/# cat /proc/sys/kernel/hotplug 
/sbin/udevsend
----------------------------------------------------------------------
My questions:
- Should modprobe wait for whatever current hotplug is so that
  the system can definitly use the device after modprobe?
- Or should there be a command-line switch to modprobe to tell it to wait
  for hotplug?
- Is the 'wait for hotplug'-idea possible to do or would it have to be a dirty
  hack in the kernel?
- Is there clean solution to wait exactly as long as
  it needs to load sata_sil and create /dev/sda*?
  Using while+ls monitoring /dev/sda* is not a solution imho.
Greetings,
Nico
P.S.: Sorry for crossposting, I am not really sure which list would have been
      the correct one to ask.
-- 
Latest project: cconfig (
http://nico.schotteli.us/papers/linux/cconfig/
)
Open Source nutures open minds and free, creative developers.
[unhandled content-type:application/pgp-signature]
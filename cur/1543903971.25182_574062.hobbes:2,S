Date: Tue, 24 Jul 2007 09:59:58 +0300
From: Avi Kivity <>
Subject: Re: [kvm-devel] [RFC 0/8]KVM: swap out guest pages
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2007/7/24/53

Rusty Russell wrote:
>
>>> If not, it does get harder.  A callback in the mm struct to say "I want
>>> to swap your page out" is required if we don't take a reference to the
>>> page.  Dirty bit handling would be an interesting issue (maybe the
>>> callback can say "No!" and dirty the page again?).
>>> 
>> Since we have rmap, I don't see that as an issue.  Given a page, we can
>> easily drop all refs.  Though lguest doesn't do that, right?
>> 
>
> Yeah, rmap might maul some puppies.  I could do poor man's rmap tho with
> one backref and a bit to say "there are more".  Then if that bit is set,
> I just drop all 4 shadows 8)
>
> 
It's too poor.  A long running guest will eventually map all of memory
using the kernel page tables and a large proportion with user page
tables, so many pages will have that bit set.
However, you can probably work around that by not setting an rmap for
the kernel mappings, and instead have the guest teach the host where the
kernel page tables live.  You'd only be left with shared libraries,
until the kernel can share page tables for them too.
>> I'm also concerned with picking the correct page, but there's no good
>> solution here.
>> 
>
> But since you have rmap, if there was a cb when the the page was
> undirtied, you could undirty the ptes.  When there "I want to kick this
> page out" cb comes along, see if one of the ptes is now dirty, dirty the
> page and return "no".
>
> Maybe it's too simplistic, but it might work.
> 
Ah, I see what you mean now.  It could work, as far as I can tell (which
isn't very far, though).
-- 
Do not meddle in the internals of kernels, for they are subtle and quick to panic.
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
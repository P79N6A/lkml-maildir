Date: Sun, 20 May 2007 14:13:29 +0200
From: Ã‰ric Piel <>
Subject: [PATCH] wistron_btns: reduce polling frequency (to save power)
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2007/5/20/82

Hello,
I'm usually not a fashion victim, but I felt into the trap this time: 
I've launched powertop. As I noticed that wistron_btns was part of the 
topers (10 wake-up's per seconds), here is a patch that should reduce 
the problem. The driver now polls the hardware only twice per second.
Actually, I've tried to decrease the timer to 1 Hz, using round_jiffies 
it would have been an even bigger win, but latency was just too big from 
a user point of view. It's pity, there doesn't seem to be any API to 
synchronize a 2 Hz timer with the rounded timers :-(
It should apply against 2.6.22-rc2 (as well as input tree). It's 
completely orthogonal to my previous patch "add led support", so you can 
apply both in the order you like ;-) There is no particular urgency in 
this patch, so I guess you can keep it for 2.6.23.
See you,
Eric
From: Eric Piel <eric.piel@tremplin-utc.net>
wriston_btns: Reduce polling frequency
Reduces the polling frequency from 10 Hz to 2 Hz, which should be less a burden
for laptops wrt energy saving. As it is multimedia keys, 500ms (maximum) of
latency should be still fine for the user. In order to keep fluent the feeling
when the user is pressing several keys in a raw (such as changing the volume),
the frequency is increased for a short duration after a key is pressed.
Signed-off-by: Eric Piel <eric.piel@tremplin-utc.net>
--- linux-2.6.21/drivers/input/misc/wistron_btns.c.bak	2007-05-18 00:37:42.000000000 +0200
+++ linux-2.6.21/drivers/input/misc/wistron_btns.c	2007-05-18 00:36:44.000000000 +0200
@@ -22,6 +22,7 @@
 #include <linux/init.h>
 #include <linux/input.h>
 #include <linux/interrupt.h>
+#include <linux/jiffies.h>
 #include <linux/kernel.h>
 #include <linux/mc146818rtc.h>
 #include <linux/module.h>
@@ -37,9 +38,10 @@
  */
 #define MAX_POLL_ITERATIONS 64
 
-#define POLL_FREQUENCY 10 /* Number of polls per second */
+#define POLL_FREQUENCY 2 /* Number of polls per second when idle */
+#define POLL_FREQUENCY_BURST 10 /* Polls per second when a key was recently pressed */
 
-#if POLL_FREQUENCY > HZ
+#if POLL_FREQUENCY_BURST > HZ
 #error "POLL_FREQUENCY too high"
 #endif
 
@@ -1079,6 +1081,8 @@ static void handle_key(u8 code)
 
 static void poll_bios(unsigned long discard)
 {
+	static unsigned long jiffies_last_press;
+	unsigned long jiffies_now = jiffies;
 	u8 qlen;
 	u16 val;
 
@@ -1087,11 +1091,17 @@ static void poll_bios(unsigned long disc
 		if (qlen == 0)
 			break;
 		val = bios_pop_queue();
-		if (val != 0 && !discard)
+		if (val != 0 && !discard) {
 			handle_key((u8)val);
+			jiffies_last_press = jiffies_now;
+		}
 	}
 
-	mod_timer(&poll_timer, jiffies + HZ / POLL_FREQUENCY);
+	/* Increase precision if user is currently pressing keys (< 2s ago) */
+	if (time_after(jiffies_last_press, jiffies_now - (HZ * 2)))
+		mod_timer(&poll_timer, jiffies_now + HZ / POLL_FREQUENCY_BURST);
+	else
+		mod_timer(&poll_timer, jiffies_now + HZ / POLL_FREQUENCY);
 }
 
 static int __devinit wistron_probe(struct platform_device *dev)
Date: Mon, 23 Jun 2003 16:36:14 -0700
From: Matthew Dobson <>
Subject: [patch] fix types for generic_hweight64
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2003/6/23/261

A user reported to me that he had errors compiling a userspace portion 
of iptables because the u64 data type isn't exported to userspace.  This 
patch changes generic_hweight64 to use unsigned long longs instead of 
u64s.  It also changes the return type to unsigned int, to match the 
other generic_hweight functions.  Please apply.
Cheers!
-Matt
diff -Nurp --exclude-from=/home/mcd/.dontdiff linux-2.5.73-vanilla/include/linux/bitops.h linux-2.5.73-hweight64_fix/include/linux/bitops.h
--- linux-2.5.73-vanilla/include/linux/bitops.h	Sun Jun 22 11:33:32 2003
+++ linux-2.5.73-hweight64_fix/include/linux/bitops.h	Mon Jun 23 11:31:18 2003
@@ -108,19 +108,20 @@ static inline unsigned int generic_hweig
         return (res & 0x0F) + ((res >> 4) & 0x0F);
 }
 
-static inline unsigned long generic_hweight64(__u64 w)
+static inline unsigned int generic_hweight64(unsigned long long w)
 {
 #if BITS_PER_LONG < 64
 	return generic_hweight32((unsigned int)(w >> 32)) +
 				generic_hweight32((unsigned int)w);
 #else
-	u64 res;
+	unsigned long long res;
 	res = (w & 0x5555555555555555) + ((w >> 1) & 0x5555555555555555);
 	res = (res & 0x3333333333333333) + ((res >> 2) & 0x3333333333333333);
 	res = (res & 0x0F0F0F0F0F0F0F0F) + ((res >> 4) & 0x0F0F0F0F0F0F0F0F);
 	res = (res & 0x00FF00FF00FF00FF) + ((res >> 8) & 0x00FF00FF00FF00FF);
 	res = (res & 0x0000FFFF0000FFFF) + ((res >> 16) & 0x0000FFFF0000FFFF);
-	return (res & 0x00000000FFFFFFFF) + ((res >> 32) & 0x00000000FFFFFFFF);
+	res = (res & 0x00000000FFFFFFFF) + ((res >> 32) & 0x00000000FFFFFFFF);
+	return (unsigned int)res;
 #endif
 }
 
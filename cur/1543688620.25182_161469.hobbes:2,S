Date: 30 Aug 2003 09:35:36 +0200
From: Martin Schlemmer <>
Subject: Re: 2.6.0-test4-mm3
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2003/8/30/16

On Fri, 2003-08-29 at 16:55, Martin Schlemmer wrote:
> On Fri, 2003-08-29 at 15:00, Valdis.Kletnieks@vt.edu wrote:
> > On Fri, 29 Aug 2003 11:54:27 +0200, Boszormenyi Zoltan <zboszor@freemail.hu>  said:
> > 
> > > I tried to "make modules_install" on the compiled tree.
> > > It says:
> > > 
> > > # make modules_install
> > > Install a current version of module-init-tools
> > > See 
http://www.codemonkey.org.uk/post-halloween-2.5.txt
> > > make: *** [_modinst_] Error 1
> > 
> > Whoops... My fault. ;)
> > 
> > It was mostly a proof of concept - if there's a *known*
> > better test I'm all ears. ;)
> 
> Cannot think of one that is known.  An quick solution
> your (and not RH) side, might be something like below.
> I am though not 100% sure if this will work (does the RH
> patches check for modules present before calling bins
> from module-init-tools, or do they just yield if they
> detect a newer kernel?), so if somebody on a RH box could
> test it ...
> 
> The basic concept is that modprobe from modutils start
> an error message with 'modprobe:' and the one from
> module-init-tools starts with 'FATAL:'.
> 
> Another issue you may want to consider, is that modprobe
> from module-init-tools use the 'create_module' syscall
> to determine the kernel version, and I think that the RH
> patches does as well .... what are you going to do if its
> a 2.4 kernel running, but module-init-tools are installed?
> In this case even my patch are going to fail.  I guess thus
> that you will have to try and get Boszormenyi's changes
> applied RH side ...
> 
> ---------------
> iff -puN Makefile~old-module-tools-warning Makefile
> --- 25/Makefile~old-module-tools-warning	Thu Aug 28 14:24:35 2003
> +++ 25-akpm/Makefile	Thu Aug 28 14:24:35 2003
> @@ -606,6 +606,11 @@ modules_install: _modinst_ _modinst_post
> 
>  .PHONY: _modinst_
>  _modinst_:
> +	@if [ -z "`modprobe -n foobar 2>&1 | egrep '^FATAL:'`" ]; then \
> +		echo "Install a current version of module-init-tools"; \
> +		echo "See 
http://www.codemonkey.org.uk/post-halloween-2.5.txt";
\
> +		/bin/false; \
> +	fi
>  	@rm -rf $(MODLIB)/kernel
>  	@rm -f $(MODLIB)/build
>  	@mkdir -p $(MODLIB)/kernel
> 
----------------------
Seems like above never made it out.  Anyhow, adding anything
like this that fails is no good, except maybe if it checks
current kernel, and if depmod then do not return a version
consistent with module-init-tools if we are using a 2.5/6 kernel,
fail.  Reason for this, is that even with the '-V' switch,
depmod.old will be called and the incorrect version supplied if
we are currently on a 2.4 kernel ....
Regards,
-- 
Martin Schlemmer
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
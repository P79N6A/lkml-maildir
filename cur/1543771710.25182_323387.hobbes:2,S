Date: Mon, 06 Jun 2005 13:39:10 +0200
From: Jan Blunck <>
Subject: [PATCH] don't allow sys_readahead() on files opened with O_DIRECT
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2005/6/6/52

do_readahead() doesn't make sense if the file is opened with O_DIRECT, 
since only the page cache is stuffed but never used.
Signed-off-by: Jan Blunck <j.blunck@tu-harburg.de>
 mm/filemap.c |    3 ++-
 1 files changed, 2 insertions(+), 1 deletion(-)
Index: experimental-um/mm/filemap.c
===================================================================
--- experimental-um.orig/mm/filemap.c
+++ experimental-um/mm/filemap.c
@@ -1110,7 +1110,8 @@ static ssize_t
 do_readahead(struct address_space *mapping, struct file *filp,
 	     unsigned long index, unsigned long nr)
 {
-	if (!mapping || !mapping->a_ops || !mapping->a_ops->readpage)
+	if (!mapping || !mapping->a_ops || !mapping->a_ops->readpage
+	    || mapping->a_ops->direct_IO)
 		return -EINVAL;
 
 	force_page_cache_readahead(mapping, filp, index,
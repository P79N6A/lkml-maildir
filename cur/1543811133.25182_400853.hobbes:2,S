Date: Fri, 24 Feb 2006 14:28:44 -0800
From: Andrew Morton <>
Subject: Re: [PATCH] Enable mprotect on huge pages
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2006/2/24/264

"Zhang, Yanmin" <yanmin_zhang@linux.intel.com> wrote:
>
> From: Zhang, Yanmin <yanmin.zhang@intel.com>
> 
> 2.6.16-rc3 uses hugetlb on-demand paging, but it doesn_t support hugetlb
> mprotect. My patch against 2.6.16-rc3 enables this capability.
> 
Well I suppose that makes sense.  It does assume that the normal pte
protection-changing APIs do the right thing on all architectures which
implement huge pages.  That's quite possibly the case, but we should
confirm that.
> +
> +void hugetlb_change_protection(struct vm_area_struct *vma,
> +		unsigned long address, unsigned long end, pgprot_t newprot)
> +{
> +	struct mm_struct *mm = vma->vm_mm;
> +	unsigned long start = address;
> +	pte_t *ptep;
> +	pte_t pte;
> +
> +	BUG_ON(address >= end);
> +	flush_cache_range(vma, address, end);
> +
> +	spin_lock(&mm->page_table_lock);
> +	for (; address < end; address += HPAGE_SIZE) {
> +		ptep = huge_pte_offset(mm, address);
> +		if (!ptep)
> +			continue;
> +		if (pte_present(*ptep)) {
> +			pte = ptep_get_and_clear(mm, address, ptep);
> +			pte = pte_modify(pte, newprot);
> +			set_huge_pte_at(mm, addr, ptep, pte);
> +			lazy_mmu_prot_update(pte);
> +		}
> +	}
> +	spin_unlock(&mm->page_table_lock);
> +
> +	flush_tlb_range(vma, start, end);
> +}
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
Date: Sat, 29 Dec 2007 13:51:13 +0800
From: Fengguang Wu <>
Subject: Re: [PATCH] jfs: clear PAGECACHE_TAG_DIRTY for no-write pages
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2007/12/29/5

On Fri, Dec 28, 2007 at 10:50:59PM -0600, Dave Kleikamp wrote:
> 
> On Sat, 2007-12-29 at 10:21 +0800, Fengguang Wu wrote:
> > On Fri, Dec 28, 2007 at 10:53:14AM -0600, Dave Kleikamp wrote:
> > 
> > 
> > > ---
> > > 
> > > diff -Nurp linux-2.6.24-rc6-git5/fs/jfs/jfs_metapage.c linux/fs/jfs/jfs_metapage.c
> > > --- linux-2.6.24-rc6-git5/fs/jfs/jfs_metapage.c	2007-12-28 10:28:33.000000000 -0600
> > > +++ linux/fs/jfs/jfs_metapage.c	2007-12-28 10:37:30.000000000 -0600
> > > @@ -360,6 +360,7 @@ static int metapage_writepage(struct pag
> > >  	struct metapage *mp;
> > >  	int redirty = 0;
> > >  	sector_t lblock;
> > > +	int nr_underway = 0;
> > >  	sector_t pblock;
> > >  	sector_t next_block = 0;
> > >  	sector_t page_start;
> > > @@ -371,6 +372,7 @@ static int metapage_writepage(struct pag
> > >  		     (PAGE_CACHE_SHIFT - inode->i_blkbits);
> > >  	BUG_ON(!PageLocked(page));
> > >  	BUG_ON(PageWriteback(page));
> > 
> > This line should be moved below:
> > > +	set_page_writeback(page);
> 
> No.  set_page_writeback() needs to be called before submit_bio() is
> called.
Ah yes.
> I don't think there is any harm in calling set_page_writeback(),
> redirty_page_for_writeback() and end_page_writeback() in the case where
> there is no I/O to submit, and some dirty data cannot be written.  It is
> consistent with what happens in __block_write_full_page().
> 
> It's also possible that some part of the page was written, and another
> part cannot be, causing the page to be redirtied.
You are right. I revisited the code and there's nothing wrong with
your patch :-)
Regards,
Fengguang
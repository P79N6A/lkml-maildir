Date: Thu, 31 Dec 1998 01:49:22 -0500 (EST)
From: "Joshua M. Thompson" <>
Subject: [PATCH] wanpipe byte counting
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/1998/12/31/104

Here's a small patch that should be included before 2.2 goes out...it
simply patches the wanpipe drivers to count bytes as well as packets in
/proc/net/dev. I've been running this on a heavily loaded 2.1.126 router
here for months with no problems.
-- 
Network Administrator        | FABRICATI DIEM, PVNC.
mich.com, Inc.               |   -- The motto of the Ankh-Morpork City Watch
248-442-1000 x212            |      (Terry Pratchett, Guards! Guards!)
diff -u -r -N linux-orig/drivers/net/sdla_fr.c linux/drivers/net/sdla_fr.c
--- linux-orig/drivers/net/sdla_fr.c	Fri Oct  9 14:56:59 1998
+++ linux/drivers/net/sdla_fr.c	Thu Dec 31 01:32:25 1998
@@ -1078,6 +1078,8 @@
 				++chan->if_send_bfrs_passed_to_adptr;
 				++chan->ifstats.tx_packets;
 				++card->wandev.stats.tx_packets;
+				chan->ifstats.tx_bytes += skb->len;
+				card->wandev.stats.tx_bytes += skb->len;
 			}
 		}
 	}
@@ -1501,6 +1503,8 @@
 			netif_rx(skb);
 			++chan->ifstats.rx_packets;
 			++card->wandev.stats.rx_packets;
+			chan->ifstats.rx_bytes += skb->len;
+			card->wandev.stats.rx_bytes += skb->len;
 		}
 	}
 	sdla_mapmem(&card->hw, FR_MB_VECTOR);
@@ -1621,6 +1625,8 @@
 						++chan->rx_intr_bfr_passed_to_stack;
 						++chan->ifstats.rx_packets;
 						++card->wandev.stats.rx_packets;
+						chan->ifstats.rx_bytes += skb->len;
+						card->wandev.stats.rx_bytes += skb->len;
 					}
 				}
 			}
diff -u -r -N linux-orig/drivers/net/sdla_ppp.c linux/drivers/net/sdla_ppp.c
--- linux-orig/drivers/net/sdla_ppp.c	Fri Oct  9 14:56:59 1998
+++ linux/drivers/net/sdla_ppp.c	Thu Dec 31 01:33:04 1998
@@ -698,6 +698,7 @@
 		} else {
 			++ppp_priv_area->if_send_bfr_passed_to_adptr;
 			++card->wandev.stats.tx_packets;
+			card->wandev.stats.tx_bytes += skb->len;
 		}
 	}
 tx_done:
@@ -1202,6 +1203,7 @@
 				skb->mac.raw = skb->data;
 				netif_rx(skb);
 				++card->wandev.stats.rx_packets;
+ 				card->wandev.stats.rx_bytes += skb->len;
 				++ppp_priv_area->rx_intr_bfr_passed_to_stack;
 			}
 		} else {
diff -u -r -N linux-orig/drivers/net/sdla_x25.c linux/drivers/net/sdla_x25.c
--- linux-orig/drivers/net/sdla_x25.c	Thu Dec 31 01:34:18 1998
+++ linux/drivers/net/sdla_x25.c	Thu Dec 31 01:31:00 1998
@@ -1028,6 +1028,7 @@
 		{
 			netif_rx(skb);
 			++chan->ifstats.rx_packets;
+			chan->ifstats.rx_bytes += skb->len;
 		}
 	}
 }
@@ -2122,6 +2123,7 @@
 				return 1;
 			}
 			++chan->ifstats.tx_packets;
+			chan->ifstats.tx_bytes += skb->len;
 			break;
 
 		case 0x33:	/* Tx busy */
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.rutgers.edu
Please read the FAQ at 
http://www.tux.org/lkml/
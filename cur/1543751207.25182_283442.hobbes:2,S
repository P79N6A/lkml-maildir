Date: Wed, 05 Jan 2005 14:41:28 -0700
From: Mark Bellon <>
Subject: PATCH: 2.4.28: 32 bit ltrace oops when tracing 64 bit executable [X86_64]
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2005/1/5/245

Didn't see  a fix for this so here it is. Tried using "ltrace -i" on a 
64 bit executable when ltrace was a 32 bit executable. The kernel threw 
an oops.
The find_target routine (arch/x86/ia32/ptrace32.c) doesn't deal with a 
NULL return from  find_task_by_pid properly - if NULL is returned 
put_task_struct() is still called.
mark
Index: arch/x86_64/ia32/ptrace32.c
===================================================================
RCS file: /cvsdev/mvl-kernel/linux/arch/x86_64/ia32/ptrace32.c,v
retrieving revision 1.1.36.1.8.3
diff -a -u -r1.1.36.1.8.3 ptrace32.c
--- arch/x86_64/ia32/ptrace32.c	19 Nov 2004 04:41:58 -0000	1.1.36.1.8.3
+++ arch/x86_64/ia32/ptrace32.c	5 Jan 2005 19:26:43 -0000
@@ -182,14 +182,14 @@
 			goto out;
 		*err = ptrace_check_attach(child, request == PTRACE_KILL); 
 		if (*err < 0) 
-				goto out;
+			goto out;
 		return child; 
-	} 
 
  out:
-	put_task_struct(child);
+		put_task_struct(child);
+	} 
+
 	return NULL; 
-	
 } 
 
 extern asmlinkage long sys_ptrace(long request, long pid, unsigned long addr, unsigned long data);
Date: Tue, 25 Jul 2006 05:06:07 -0400
From: Chuck Ebbert <>
Subject: Re: [PATCH for 2.6.18rc2] [1/7] i386/x86-64: Don't randomize  stack top when...
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2006/7/25/76

In-Reply-To: <1153815124.8932.15.camel@laptopd505.fenrus.org>
On Tue, 25 Jul 2006 10:12:04 +0200, Arjan van de Ven wrote:
> > >  unsigned long arch_align_stack(unsigned long sp)
> > >  {
> > > -     if (randomize_va_space)
> > > +     if (!(current->personality & ADDR_NO_RANDOMIZE) && randomize_va_space)
> > >               sp -= get_random_int() % 8192;
> > >       return sp & ~0xf;
> > >  }
> > 
> > I think this needs to be done always, at least on P4.  It really isn't
> > 'randomization' at the same high level as the rest -- more like a small
> > adjustment.  And the offset should be a multiple of 128 and < 7K (not
> > 8K.) Something like this:
> 
> the 8K was what Intel proposed for 2.4 quite a while ago and has been in
> use in linux for years and years... Can you explain why you are saying
> 7Kb? throwing away that 1Kb of cache associativity is unfortunate and
> shouldn't be done unless there's a good reason, so I'm quite interested
> in finding out your reason ;)
Well that's what the Intel IA-32 optimization manual says:
        To establish a suitable stack offset for two instances of the same
        application running on two logical processors in the same physical
        processor package, the stack pointer can be adjusted in the entry
        function of the application using the technique shown in Example 7-5.
        Example 7-5 Adding a Pseudo-random Offset to the Stack Pointer
        in the Entry Function
        void main()
        {
        char * pPrivate = NULL;
        long myOffset = GetMod7Krandom128X()
        // A pseudo-random number that is a multiple
        // of 128 and less than 7K.
        // Use runtime library routine to reposition.
        _alloca(myOffset); // The stack pointer.
        }
        IA-32 Intel Architecture Optimization Reference Manual, Ch. 7
        June 2005
-- 
Chuck
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
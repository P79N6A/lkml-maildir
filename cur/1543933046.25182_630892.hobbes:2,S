Date: Thu, 20 Dec 2007 22:59:20 -0800
From: Srinivas Kommu <>
Subject: driver spin lock and files_lock deadlock question
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2007/12/21/14

I have a driver that needs to be SMP-safe. It also has some code hooking 
into the net_rx_action softirq. So it takes a spinlock and disables the 
local bottom-half around its critical sections: 
spin_lock_bh(&driver_lock). Now, I'm facing a deadlock under a 
particular sequence involving the files_lock:
1. CPU 0 takes driver_lock and then calls remove_proc_entry() which is 
hanging at spin_lock(&files_lock).
2. CPU 1 was in fput() which took files_lock; the softirq comes in at 
this point and attempts to take driver_lock and hangs forever.
It seems this kind of a deadlock can happen with any kernel lock, not 
just files_lock. What's the driver's mistake here? Is it wrong to call 
remove_proc_entry() while holding another lock? What is the right thing 
to do?
This is with the 2.4 kernel, BTW.
thanks
srini
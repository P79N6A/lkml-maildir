Date: Wed, 21 Jun 2006 23:00:23 +0200
From: Andreas Mohr <>
Subject: [PATCH -mm 4/6] cpu_relax(): smpboot.c
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2006/6/21/405

Add cpu_relax() to various smpboot.c init loops.
Kept mb() since it's said to be required in some postings.
Tested on 2.6.17-mm1.
Signed-off-by: Andreas Mohr <andi@lisas.de>
diff -urN linux-2.6.17-mm1.orig/arch/i386/kernel/smpboot.c linux-2.6.17-mm1.my/arch/i386/kernel/smpboot.c
--- linux-2.6.17-mm1.orig/arch/i386/kernel/smpboot.c	2006-06-21 14:28:15.000000000 +0200
+++ linux-2.6.17-mm1.my/arch/i386/kernel/smpboot.c	2006-06-21 14:43:24.000000000 +0200
@@ -251,8 +251,10 @@
 		/*
 		 * all APs synchronize but they loop on '== num_cpus'
 		 */
-		while (atomic_read(&tsc_count_start) != num_booting_cpus()-1)
+		while (atomic_read(&tsc_count_start) != num_booting_cpus()-1) {
+			cpu_relax();
 			mb();
+		}
 		atomic_set(&tsc_count_stop, 0);
 		wmb();
 		/*
@@ -270,8 +272,10 @@
 		/*
 		 * Wait for all APs to leave the synchronization point:
 		 */
-		while (atomic_read(&tsc_count_stop) != num_booting_cpus()-1)
+		while (atomic_read(&tsc_count_stop) != num_booting_cpus()-1) {
+			cpu_relax();
 			mb();
+		}
 		atomic_set(&tsc_count_start, 0);
 		wmb();
 		atomic_inc(&tsc_count_stop);
@@ -328,19 +332,27 @@
 	 * this gets called, so we first wait for the BP to
 	 * finish SMP initialization:
 	 */
-	while (!atomic_read(&tsc_start_flag)) mb();
+	while (!atomic_read(&tsc_start_flag)) {
+		cpu_relax();
+		mb();
+	}
 
 	for (i = 0; i < NR_LOOPS; i++) {
 		atomic_inc(&tsc_count_start);
-		while (atomic_read(&tsc_count_start) != num_booting_cpus())
+		while (atomic_read(&tsc_count_start) != num_booting_cpus()) {
+			cpu_relax();
 			mb();
+		}
 
 		rdtscll(tsc_values[smp_processor_id()]);
 		if (i == NR_LOOPS-1)
 			write_tsc(0, 0);
 
 		atomic_inc(&tsc_count_stop);
-		while (atomic_read(&tsc_count_stop) != num_booting_cpus()) mb();
+		while (atomic_read(&tsc_count_stop) != num_booting_cpus()) {
+			cpu_relax();
+			mb();
+		}
 	}
 }
 #undef NR_LOOPS
@@ -1446,8 +1458,10 @@
 	per_cpu(cpu_state, cpu) = CPU_UP_PREPARE;
 	/* Unleash the CPU! */
 	cpu_set(cpu, smp_commenced_mask);
-	while (!cpu_isset(cpu, cpu_online_map))
+	while (!cpu_isset(cpu, cpu_online_map)) {
+		cpu_relax();
 		mb();
+	}
 	return 0;
 }
 
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
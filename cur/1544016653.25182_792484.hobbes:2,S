Date: Thu, 15 Jan 2009 09:01:20 +0000
From: Jarek Poplawski <>
Subject: Re: deadlocks if use htb
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2009/1/15/92

On Wed, Jan 14, 2009 at 03:28:03PM +0100, Peter Zijlstra wrote:
...
> Right, found all that...
> 
> Can't spot anything obviously wrong though.. hrtimer_start*() does
> remove_hrtimer() which checks STATE_ENQUEUED, STATE_PENDING and pulls it
> off the relevant list before it continues the enqueue.
> 
> However a loop in enqueue_hrtimer() would suggest a corrupted RB-tree,
> but I cannot find an RB-op that doesn't hold base-lock.
> 
I've revisited it yesterday, and if I don't miss something, there is
possible a scenario similar to this:
cpu1:				cpu2:
run_hrtimer_pending
spin_unlock
restart = fn(timer)
				hrtimer_start
				enqueue_hrtimer
				hrtimer_start
				remove_hrtimer
				(the HRTIMER_STATE_CALLBACK is removed)
				switch_hrtimer_base
spin_lock
(not this hrtimer's anymore)
__remove_hrtimer
list_add_tail			enqueue_hrtimer
Jarek P.
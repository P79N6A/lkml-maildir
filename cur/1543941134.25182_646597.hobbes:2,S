Date: Thu, 31 Jan 2008 17:48:19 -0800 (PST)
From: Christoph Lameter <>
Subject: Re: mmu_notifier: close hole in fork
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2008/1/31/494

On Fri, 1 Feb 2008, Andrea Arcangeli wrote:
> Good catch! This was missing also in my #v5 (KVM doesn't need that
> because the only possible cows on sptes can be generated by ksm, but
> it would have been a problem for GRU). The more I think about it, the
How do you think the GRU should know when to drop the refcount? There is 
no page table and thus no way of tracking that a refcount was taken. 
Without the refcount you cannot defer the freeing of the page. So 
shootdown on invalidate_range_begin and lock out until 
invalidate_range_end seems to be the only workable solution.
BTW what do you think about adding a flag parameter to the invalidate 
calls that allows shooting down writable ptes only? That could be useful 
for COW and page_mkclean.
So
#define MMU_ATOMIC 1
#define MMU_WRITABLE 2
insted of the atomic parameter?
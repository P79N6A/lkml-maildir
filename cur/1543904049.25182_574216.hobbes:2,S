Date: Tue, 24 Jul 2007 14:28:05 +0100
From: Al Viro <>
Subject: Re: [RFC] error management in add_disk()
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2007/7/24/207

On Tue, Jul 24, 2007 at 01:57:53PM +0200, Alban Crequy wrote:
> Hi,
> 
> I have a problem with the error management of add_disk() and del_gendisk().
> 
> add_disk() adds an entry in /sys/block/<name>. The filename in /sys/block is
> not (struct gen_disk)->disk_name but more or less the first KOBJ_NAME_LEN
> characters of (struct gen_disk)->disk_name.
> 
> #define KOBJ_NAME_LEN                   20
> 
> My problem occurs when we try to add 2 disks with different names, but when
> the KOBJ_NAME_LEN first characters are the same.
So don't do that.
> The attached test module triggers the problem. You can try something like:
> for i in $(seq 1 100) ; do insmod ./adddiskbug.ko ; rmmod adddiskbug ; done
> 
> The attached patch fixes the problem by changing the prototype of add_disk() and
> register_disk() to return errors.
This is bogus.  Just what would callers do with these error values?
Ignore them silently?  Bail out?  Can't do - at that point disk just might
have been opened already.  add_disk() is the point of no return; we are
already past the last point where we could bail out.
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
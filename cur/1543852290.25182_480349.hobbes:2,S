Date: Wed, 8 Nov 2006 13:09:14 +0100
From: Ingo Molnar <>
Subject: Re: + i386-lapic-timer-calibration.patch added to -mm tree
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2006/11/8/86

* akpm@osdl.org <akpm@osdl.org> wrote:
> Subject: i386/apic: Rework local apic timer calibration
> From: Thomas Gleixner <tglx@linutronix.de>
> 
> The local apic timer calibration has two problem cases:
> 
> 1. The calibration is based on readout of the PIT/HPET timer to detect 
> the wrap of the periodic tick. It happens that a box gets stuck in the
> calibration loop due to a PIT with a broken readout function.
> 
> 2. CoreDuo boxen show a sporadic PIT runs too slow defect, which results
> in a wrong lapic calibration. The PIT goes back to normal operation once
> the lapic timer is switched to periodic mode.
> 
> Rework the code to address both problems:
> - Make the calibration interrupt driven. This removes the wait_timer_tick
>   magic hackery from lapic.c and time_hpet.c. The clockevents framework
>   allows easy substitution of the global tick event handler for the
>   calibration. This is more accurate than monitoring jiffies. At this
>   point of the boot process, nothing disturbes the interrupt delivery, so
>   the results are very accurate.
> 
> - Verify the calibration against the PM timer, when available by using the
>   early access function. When the measured calibration period is outside
>   of an one percent window, then the lapic timer calibration is adjusted
>   to the pm timer result.
> 
> - Verify the calibration by running the lapic timer with the calibration
>   handler. Disable lapic timer in case of deviation.
> 
> This also removes the "synchronization" of the local apic timer to the
> global tick. This synchronization never worked, as there is no way to
> synchronize PIT(HPET) and local APIC timer. The synchronization by waiting
> for the tick just alignes the local APIC timer for the first events, but
> later the events drift away due to the different clocks. Removing the
> "sync" is just randomizing the asynchronous behaviour at setup time.
> 
> Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
> Signed-off-by: Andrew Morton <akpm@osdl.org>
i agree with this method.
one question:
> +	long tapic = apic_read(APIC_TMCCT);
> +	unsigned long pm = acpi_pm_read_early();
is this function call safe if the box has no pm-timer?
otherwise, i have tested this on a couple of boxes, it looks good. This 
patch should also solve some apic-calibration hangs reported against 
Fedora.
Acked-by: Ingo Molnar <mingo@elte.hu>
	Ingo
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
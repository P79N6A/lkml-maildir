Date: Fri, 02 May 2008 14:59:29 +0200
From: Peter Zijlstra <>
Subject: Re: [PATCH 1/10] Add generic helpers for arch IPI function calls
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2008/5/2/184

On Fri, 2008-05-02 at 05:42 -0700, Paul E. McKenney wrote:
> And here is one scenario that makes me doubt that my imagination is
> faulty:
> 
> 1.	CPU 0 disables irqs.
> 
> 2.	CPU 1 disables irqs.
> 
> 3.	CPU 0 invokes smp_call_function().  But CPU 1 will never respond
> 	because its irqs are disabled.
> 
> 4.	CPU 1 invokes smp_call_function().  But CPU 0 will never respond
> 	because its irqs are disabled.
> 
> Looks like inherent deadlock to me, requiring that smp_call_function()
> be invoked with irqs enabled.
> 
> So, what am I missing here?
The wish to do it anyway ;-)
I can imagine some situations where I'd like to try anyway and fall back
to a slower path when failing.
With the initial design we would simply allocate data, stick it on the
queue and call the ipi (when needed).
This is perfectly deadlock free when wait=0 and it just returns -ENOMEM
on allocation failure.
It it doesn't return -ENOMEM I know its been queued and will be
processed at some point, if it does fail, I can deal with it in another
way.
I know I'd like to do that and I suspect Nick has a few use cases up his
sleeve as well.
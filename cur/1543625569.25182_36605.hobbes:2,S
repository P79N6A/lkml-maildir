Date: Fri, 22 Mar 2002 16:16:34 +1100
From: Christopher Yeoh <>
Subject: [PATCH] msync writing when MS_INVALIDATE set and memory locked
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2002/3/22/1

For msync, SUSv2 states that it will fail if:
"[EBUSY] Some or all of the addresses in the range starting at addr
and continuing for len bytes are locked, and MS_INVALIDATE is
specified."
This check isn't being done. The following patch (against 2.4.19pre4)
adds the correct behaviour:
--- linux-2.4.18/mm/filemap.c~	Thu Mar 21 16:04:48 2002
+++ linux-2.4.18/mm/filemap.c	Fri Mar 22 15:48:40 2002
@@ -2205,6 +2205,9 @@
 	int ret = 0;
 	struct file * file = vma->vm_file;
 
+	if ( (flags & MS_INVALIDATE) && (vma->vm_flags & VM_LOCKED) )
+		return -EBUSY;
+
 	if (file && (vma->vm_flags & VM_SHARED)) {
 		ret = filemap_sync(vma, start, end-start, flags);
 
Chris
-- 
cyeoh@au.ibm.com
IBM OzLabs Linux Development Group
Canberra, Australia
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
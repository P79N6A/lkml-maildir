Date: Thu, 24 Feb 2000 02:29:28 -0600
From: Bill Wendling <>
Subject: [patch-2.3.48-pre1] Change to list_for_each macro
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2000/2/24/27

Hi, Linus,
Here's a patch applied to 2.3.48pre1 which removes the usless commented
code in sysctl.c and also changes the list_for_each macro to accept a
pointer to the struct list_head object instead of the object itself. This
is to make it consistent with the other list_* functions in linux/list.h
which accept pointers.
The patch can also be downloaded at:
http://ganymede.isdn.uiuc.edu/~wendling/patches/patch-2.3.48-pre1-1.list_enh
Thanks.
-- 
|| Bill Wendling			wendling@ganymede.isdn.uiuc.edu
diff -Naur linux-2.3.48pre1/include/linux/list.h linux-2.3.48pre1-new/include/linux/list.h
--- linux-2.3.48pre1/include/linux/list.h	Thu Feb 24 00:41:03 2000
+++ linux-2.3.48pre1-new/include/linux/list.h	Thu Feb 24 01:06:49 2000
@@ -105,7 +105,7 @@
 	((type *)((char *)(ptr)-(unsigned long)(&((type *)0)->member)))
 
 #define list_for_each(pos, head) \
-	for (pos = (head).next; pos != &(head); pos = pos->next)
+	for (pos = (head)->next; pos != (head); pos = pos->next)
 
 #endif /* __KERNEL__ */
 
diff -Naur linux-2.3.48pre1/include/linux/sysctl.h linux-2.3.48pre1-new/include/linux/sysctl.h
--- linux-2.3.48pre1/include/linux/sysctl.h	Thu Feb 24 00:41:03 2000
+++ linux-2.3.48pre1-new/include/linux/sysctl.h	Thu Feb 24 00:56:29 2000
@@ -21,7 +21,7 @@
  ****************************************************************
  */
 
-#include <linux/lists.h>
+#include <linux/list.h>
 
 #ifndef _LINUX_SYSCTL_H
 #define _LINUX_SYSCTL_H
diff -Naur linux-2.3.48pre1/kernel/sched.c linux-2.3.48pre1-new/kernel/sched.c
--- linux-2.3.48pre1/kernel/sched.c	Thu Feb 24 00:41:03 2000
+++ linux-2.3.48pre1-new/kernel/sched.c	Thu Feb 24 01:07:19 2000
@@ -499,7 +499,7 @@
 		goto still_running;
 
 still_running_back:
-	list_for_each(tmp, runqueue_head) {
+	list_for_each(tmp, &runqueue_head) {
 		p = list_entry(tmp, struct task_struct, run_list);
 		if (can_schedule(p)) {
 			int weight = goodness(p, this_cpu, prev->active_mm);
@@ -656,7 +656,7 @@
         if (!head->next || !head->prev)
                 WQ_BUG();
 #endif
-	list_for_each(tmp, *head) {
+	list_for_each(tmp, head) {
 		unsigned int state;
                 wait_queue_t *curr = list_entry(tmp, wait_queue_t, task_list);
 
diff -Naur linux-2.3.48pre1/kernel/sysctl.c linux-2.3.48pre1-new/kernel/sysctl.c
--- linux-2.3.48pre1/kernel/sysctl.c	Thu Feb 24 00:41:05 2000
+++ linux-2.3.48pre1-new/kernel/sysctl.c	Thu Feb 24 01:07:26 2000
@@ -12,6 +12,8 @@
  *  Horn.
  * Added proc_doulongvec_ms_jiffies_minmax, 09/08/99, Carlos H. Bauer.
  * Added proc_doulongvec_minmax, 09/08/99, Carlos H. Bauer.
+ * Changed linked lists to use list.h instead of lists.h, 02/24/00, Bill
+ *  Wendling.
  */
 
 #include <linux/config.h>
@@ -86,10 +88,6 @@
 
 
 static ctl_table root_table[];
-/*
-static struct ctl_table_header root_table_header = 
-	{ root_table, LIST_HEAD_INIT(root_table_header) };
-*/
 static LIST_HEAD(root_table_header);
 
 static ctl_table kern_table[];
@@ -321,7 +319,6 @@
 	       void *newval, size_t newlen)
 {
 	int error;
-	/* struct ctl_table_header *tmp; */
 	struct list_head *tmp;
 	void *context;
 	
@@ -336,20 +333,7 @@
 		if(get_user(old_len, oldlenp))
 			return -EFAULT;
 	}
-	/*
-	tmp = &root_table_header;
-	do {
-		context = NULL;
-		error = parse_table(name, nlen, oldval, oldlenp, 
-				    newval, newlen, tmp->ctl_table, &context);
-		if (context)
-			kfree(context);
-		if (error != -ENOTDIR)
-			return error;
-		tmp = tmp->DLIST_NEXT(ctl_entry);
-	} while (tmp != &root_table_header);
-	*/
-	list_for_each(tmp, root_table_header) {
+	list_for_each(tmp, &root_table_header) {
 		struct ctl_table_header *head =
 			list_entry(tmp, struct ctl_table_header, ctl_entry);
 		context = NULL;
@@ -516,12 +500,6 @@
 		return 0;
 	tmp->ctl_table = table;
 	INIT_LIST_HEAD(&tmp->ctl_entry);
-	/*
-	if (insert_at_head)
-		DLIST_INSERT_AFTER(&root_table_header, tmp, ctl_entry);
-	else
-		DLIST_INSERT_BEFORE(&root_table_header, tmp, ctl_entry);
-	*/
 	if (insert_at_head)
 		list_add(&tmp->ctl_entry, &root_table_header);
 	else
@@ -537,7 +515,6 @@
  */
 void unregister_sysctl_table(struct ctl_table_header * header)
 {
-	/* DLIST_DELETE(header, ctl_entry); */
 	list_del(&header->ctl_entry);
 #ifdef CONFIG_PROC_FS
 	unregister_proc_table(header->ctl_table, proc_sys_root);
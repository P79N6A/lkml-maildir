Date: Sun, 05 Nov 2006 21:36:23 +0100
From: Peter Zijlstra <>
Subject: [PATCH] debug workqueue locking sanity
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2006/11/5/132

Workqueue functions should not leak locks, assert so, printing the
last function ran.
Signed-off-by: Peter Zijlstra <a.p.zijlstra@chello.nl>
---
 kernel/workqueue.c |   16 ++++++++++++++++
 1 file changed, 16 insertions(+)
Index: linux-2.6-twins/kernel/workqueue.c
===================================================================
--- linux-2.6-twins.orig/kernel/workqueue.c	2006-11-05 21:04:13.000000000 +0100
+++ linux-2.6-twins/kernel/workqueue.c	2006-11-05 21:16:05.000000000 +0100
@@ -29,6 +29,7 @@
 #include <linux/kthread.h>
 #include <linux/hardirq.h>
 #include <linux/mempolicy.h>
+#include <linux/kallsyms.h>
 
 /*
  * The per-CPU workqueue (if single thread, we always use the first
@@ -222,6 +223,21 @@ static void run_workqueue(struct cpu_wor
 		clear_bit(0, &work->pending);
 		f(data);
 
+		if (unlikely(in_atomic()
+#ifdef CONFIG_LOCKDEP
+			|| current->lockdep_depth > 0
+#endif
+			)) {
+			printk(KERN_ERR "BUG: workqueue leaked lock or atomic: "
+					"%s/0x%08x/%d\n",
+					current->comm, preempt_count(),
+				       	current->pid);
+			printk(KERN_ERR "    last function: ");
+			print_symbol("%s\n", (unsigned long)f);
+			debug_show_held_locks(current);
+			dump_stack();
+		}
+
 		spin_lock_irqsave(&cwq->lock, flags);
 		cwq->remove_sequence++;
 		wake_up(&cwq->work_done);
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
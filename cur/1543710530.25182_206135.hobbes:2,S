Date: Sat, 13 Mar 2004 14:20:50 +0100
From: Thomas Themel <>
Subject: [: PDC202XX_OLD regression between 2.6 and 2.4]
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2004/3/13/29

Hi,
[Repost, I tried on linux-ide first, but the list seems to be somewhat dead
(no traffic for the past three days other than someone who has similar
problems), so here we go again. Also, it seems linux-ide is not archived
anywhere.]
I'm currently trying to set up a system that contains a Promise 20267
controller, and it seems that DMA on that controller causes problems in
2.6. 
My test case consists of simply creating an empty ext3 file system and
running bonnie++ on it. In 2.4.25, this works as expected. In 2.6.3-rc4,
however, it breaks after a few seconds:
Mar 11 17:27:19 sophokles kernel: hdg: dma_timer_expiry: dma status == 0x60
Mar 11 17:27:19 sophokles kernel: hdg: DMA timeout retry
Mar 11 17:27:19 sophokles kernel: PDC202XX: Secondary channel reset.
Mar 11 17:27:19 sophokles kernel: PDC202XX: Primary channel reset.
Mar 11 17:27:19 sophokles kernel: hdg: timeout waiting for DMA
Mar 11 17:27:40 sophokles kernel: hdg: dma_timer_expiry: dma status == 0x60
Mar 11 17:27:40 sophokles kernel: hdg: DMA timeout retry
Mar 11 17:27:40 sophokles kernel: PDC202XX: Secondary channel reset.
Mar 11 17:27:40 sophokles kernel: PDC202XX: Primary channel reset.
Mar 11 17:27:40 sophokles kernel: hdg: timeout waiting for DMA
Mar 11 17:28:02 sophokles kernel: hdg: dma_timer_expiry: dma status == 0x60
Mar 11 17:28:02 sophokles kernel: hdg: DMA timeout retry
Mar 11 17:28:02 sophokles kernel: PDC202XX: Secondary channel reset.
Mar 11 17:28:02 sophokles kernel: PDC202XX: Primary channel reset.
Mar 11 17:28:02 sophokles kernel: hdg: timeout waiting for DMA
Mar 11 17:28:22 sophokles kernel: hdg: dma_timer_expiry: dma status == 0x60
Mar 11 17:28:22 sophokles kernel: hdg: DMA timeout retry
Mar 11 17:28:22 sophokles kernel: PDC202XX: Secondary channel reset.
Mar 11 17:28:22 sophokles kernel: PDC202XX: Primary channel reset.
Mar 11 17:28:22 sophokles kernel: hdg: timeout waiting for DMA
Other information:
hdparm output is slightly different between 2.4 and 2.6 (hda is an
identical drive on a vt8233a controller on the motherboard) - 
sophokles:~# diff -Nrua 2.4.25/ 2.6.4-rc3/
diff -Nrua 2.4.25/hda 2.6.4-rc3/hda
--- 2.4.25/hda  2004-03-11 19:48:29.000000000 +0100
+++ 2.6.4-rc3/hda       2004-03-11 19:52:28.000000000 +0100
@@ -6,5 +6,5 @@
  using_dma    =  1 (on)
  keepsettings =  0 (off)
  readonly     =  0 (off)
- readahead    =  8 (on)
- geometry     = 14593/255/63, sectors = 234441648, start = 0
+ readahead    = 256 (on)
+ geometry     = 16383/255/63, sectors = 234441648, start = 0
diff -Nrua 2.4.25/hdg 2.6.4-rc3/hdg
--- 2.4.25/hdg  2004-03-11 19:48:32.000000000 +0100
+++ 2.6.4-rc3/hdg       2004-03-11 19:52:31.000000000 +0100
@@ -6,5 +6,5 @@
  using_dma    =  1 (on)
  keepsettings =  0 (off)
  readonly     =  0 (off)
- readahead    =  8 (on)
- geometry     = 14593/255/63, sectors = 234441648, start = 0
+ readahead    = 256 (on)
+ geometry     = 16383/255/63, sectors = 234441648, start = 0
I am a bit confused by the geometry changes, but they can hardly
cause the problem since hda works nicely under 2.6.
Can I do anything to narrow this down, is there a way to get more
debugging output? 
ciao,
-- 
[*Thomas  Themel*]  While differing widely in the various little bits we know,
[extended contact]  in our infinite ignorance we are all equal. 
[info provided in]
[*message header*]      - Karl Popper
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
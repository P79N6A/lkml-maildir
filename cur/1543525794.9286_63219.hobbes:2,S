Date: Mon, 14 Feb 2000 13:47:27 -0500
From: Peter Rival <>
Subject: Re: [axp] Re: qlogic problem in pre3-2.3.44
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2000/2/14/116

I've attached a copy of the boot failure of 2.3.45 as described below, with
DEBUG_ALLOC set to 2 in arch/alpha/kernel/pci_iommu.c.  Does this help anyone?
 - Pete
Peter Rival wrote:
> FYI, I tried out 2.3.45 and the same problems still exist.  If someone could point
> me to the debug stuff that lead y'all to these conclusions, I'd be happy to play
> some more.
>
>  - Pete
>
> "David S. Miller" wrote:
>
> >    Date:   Sat, 12 Feb 2000 17:31:27 -0800
> >    From: Richard Henderson <rth@twiddle.net>
> >
> >    > qlogic driver doesn't squirrel away the count of entries returned by
> >    > pci_map_sg and when it comes time to free the list, often does too
> >    > many entries and runs into some bogus ones, causing panics in pci_free_sg.
> >
> >    This probably isn't fully correct, but a similar change to the sym
> >    driver appears to work under load.  If it's wrong it's going to fail
> >    on scsi errors, which I don't know how to force.
> >
> >  ...
> >
> >    Thoughts on a better way to fix?
> >
> > pci_{unmap,dma_sync}_sg should be passed the same "nents" which was
> > passed into pci_map_sg, not the one returned from the latter.
> >
> > Fix the Alpha iommu code please :-)  This mechanism was specifically
> > chosen such that the scsi drivers did not have to keep track of this
> > secondary dma 'nents' value.  Thanks.
> >
> > Later,
> > David S. Miller
> > davem@redhat.com
> >
> > -
> > To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
> > the body of a message to majordomo@vger.rutgers.edu
> > Please read the FAQ at 
http://www.tux.org/lkml/
Script started on Mon Feb 14 10:29:09 2000
P00>>>b dka200 -fi vmlinux.45.gz -fl "root=4251 console=ttyS0"
(boot dka200.2.0.1.1 -file vmlinux.45.gz -flags root=4251 console=ttyS0)
block 0 of dka200.2.0.1.1 is a valid boot block
reading 152 blocks from dka200.2.0.1.1
bootstrap code read in
base = 200000, image_start = 0, image_bytes = 13000
initializing HWRPB at 2000
initializing page table at 3ffb4000
initializing machine state
setting affinity to the primary CPU
jumping to bootstrap code
aboot: Linux/Alpha SRM bootloader version 0.5
aboot: switching to OSF/1 PALcode version 1.62
aboot: valid disklabel found: 5 partitions.
aboot: booted_dev=`scsi 1 1 0 2 200 0 0', guessing boot_device=`scd0'
aboot: loading compressed vmlinux.45.gz...
aboot: ok, now starting the kernel...
Linux version 2.3.45 (frival@schooner.zk3.dec.com) (gcc version egcs-2.91.66 19990314/Linux (egcs-1.1.2 release)) #3 SMP Fri Feb 14 18:26:11 EST 2048
Booting on Tsunami variation Clipper using machine vector Clipper from SRM
Command line: root=4251 console=ttyS0 bootdevice=scd0 bootfile=vmlinux.45.gz
memcluster 0, usage 1, start        0, end      256
memcluster 1, usage 0, start      256, end   131033
memcluster 2, usage 1, start   131033, end   131072
memcluster 3, usage 0, start   131072, end   524282
memcluster 4, usage 1, start   524282, end   524288
freeing pages 786:131033
freeing pages 131072:524282
SMP: 4 CPUs probed -- cpu_present_mask = f
On node 0 totalpages: 524288
zone(0): 524288 pages.
zone(1): 0 pages.
zone(2): 0 pages.
Console: colour VGA+ 80x25
Calibrating delay loop... 1321.21 BogoMIPS
Memory: 4097104k/4194256k available (1498k kernel code, 94792k reserved, 429k data, 224k init)
Buffer-cache hash table entries: 262144 (order: 8, 2097152 bytes)
Page-cache hash table entries: 524288 (order: 9, 4194304 bytes)
POSIX conformance testing by UNIFIX
SMP starting up secondaries.
recv_secondary_console_msg: on 0 message is 'P01>>>START  P01>>>'
Calibrating delay loop... 1325.40 BogoMIPS
recv_secondary_console_msg: on 0 message is 'P02>>>START  P02>>>'
Calibrating delay loop... 1304.43 BogoMIPS
recv_secondary_console_msg: on 0 message is 'P03>>>START  P03>>>'
Calibrating delay loop... 1325.40 BogoMIPS
SMP: Total of 4 processors activated (5276.43 BogoMIPS).
Linux NET4.0 for Linux 2.3
Based upon Swansea University Computer Society NET3.039
NET4: Unix domain sockets 1.0/SMP for Linux NET4.0.
NET4: Linux TCP/IP 1.0 for NET4.0
IP Protocols: ICMP, UDP, TCP
IP: routing cache hash table of 32768 buckets, 512Kbytes
TCP: Hash tables configured (established 262144 bind 43690)
Starting kswapd v1.6
Serial driver version 4.92 (2000-1-27) with MANY_PORTS SHARE_IRQ SERIAL_PCI enabled
ttyS00 at 0x03f8 (irq = 4) is a 16550A
ttyS01 at 0x02f8 (irq = 3) is a 16550A
pty: 256 Unix98 ptys configured
Uniform Multi-Platform E-IDE driver Revision: 6.30
ALI15X3: IDE controller on PCI bus 00 dev 78
ALI15X3: not 100% native mode: will probe irqs later
    ide0: BM-DMA at 0x1210-0x1217<7>pci_map_single: [fffffc0005eb6000,1000] -> direct 45eb6000 from fffffc000031bed8
, BIOS settings: hda:pio, hdb:pio
    ide1: BM-DMA at 0x1218-0x121f<7>pci_map_single: [fffffc0005eb4000,1000] -> direct 45eb4000 from fffffc000031bed8
, BIOS settings: hdc:pio, hdd:pio
hda: TOSHIBA CD-ROM XM-6302B, ATAPI CDROM drive
ide0 at 0x1f0-0x1f7,0x3f6 on irq 14
io_request_lock is fffffc000051a0a0
hda: ATAPI 32X CD-ROM drive, 256kB Cache, DMA
Uniform CD-ROM driver Revision: 3.06
Floppy drive(s): fd0 is 2.88M
FDC 0 is a post-1991 82077
qlogicisp : new isp1020 revision ID (5)
qlogicisp : new isp1020 revision ID (5)
qlogicisp : new isp1020 revision ID (5)
qlogicisp : new isp1020 revision ID (5)
qlogicisp : new isp1020 revision ID (5)
sym53c8xx: at PCI bus 1, device 1, function 0
sym53c8xx: setting PCI_COMMAND_PARITY...(fix-up)
sym53c8xx: 53c895 detected with Symbios NVRAM
sym53c895-0: rev 0x2 on pci bus 1 device 1 function 0 irq 40
sym53c895-0: NCR clock is 40218KHz
sym53c895-0: Symbios format NVRAM, ID 7, Fast-40, Parity Checking
sym53c895-0: initial SCNTL3/DMODE/DCNTL/CTEST3/4/5 = (hex) 00/00/00/00/00/00
sym53c895-0: final   SCNTL3/DMODE/DCNTL/CTEST3/4/5 = (hex) 07/4e/80/00/08/24
sym53c895-0: on-chip RAM at 0x201001000
sym53c895-0: Delay (GEN=11): 251 msec, 35411 KHz
sym53c895-0: Delay (GEN=11): 274 msec, 32439 KHz
sym53c895-0: Delay (GEN=11): 274 msec, 32439 KHz
CACHE TEST FAILED: script execution failed.
start=7ff9ee78, pc=7ff9ee80, end=7ff9ee98
CACHE INCORRECTLY CONFIGURED.
sym53c895-0: giving up ...
scsi0 : QLogic ISP1020 SCSI on PCI bus 00 device 08 irq 24 I/O base 0x8000
scsi1 : QLogic ISP1020 SCSI on PCI bus 00 device 10 irq 28 I/O base 0x8800
scsi2 : QLogic ISP1020 SCSI on PCI bus 01 device 10 irq 44 I/O base 0x200000800
scsi3 : QLogic ISP1020 SCSI on PCI bus 01 device 20 irq 52 I/O base 0x200001000
scsi4 : QLogic ISP1020 SCSI on PCI bus 01 device 28 irq 56 I/O base 0x200001800
scsi : 5 hosts.
scsi : aborting command due to timeout : pid 0, scsi0, channel 0, id 0, lun 0 Test Unit Ready 00 00 00 00 00 
qlogicisp: mbox_command loop timeout #2
scsi : aborting command due to timeout : pid 0, scsi0, channel 0, id 0, lun 0 Test Unit Ready 00 00 00 00 00 
qlogicisp: mbox_command loop timeout #1
qlogicisp: mbox_command loop timeout #2
scsi : aborting command due to timeout : pid 0, scsi0, channel 0, id 0, lun 0 Test Unit Ready 00 00 00 00 00 
qlogicisp: mbox_command loop timeout #1
qlogicisp: mbox_command loop timeout #2
scsi : aborting command due to timeout : pid 0, scsi0, channel 0, id 0, lun 0 Test Unit Ready 00 00 00 00 00 
qlogicisp: mbox_command loop timeout #1
qlogicisp: mbox_command loop timeout #2
scsi : aborting command due to timeout : pid 0, scsi0, channel 0, id 0, lun 0 Test Unit Ready 00 00 00 00 00 
qlogicisp: mbox_command loop timeout #1
qlogicisp: mbox_command loop timeout #2
scsi : aborting command due to timeout : pid 0, scsi0, channel 0, id 0, lun 0 Test Unit Ready 00 00 00 00 00 
qlogicisp: mbox_command loop timeout #1
qlogicisp: mbox_command loop timeout #2
scsi : aborting command due to timeout : pid 0, scsi0, channel 0, id 0, lun 0 Test Unit Ready 00 00 00 00 00 
Script done on Mon Feb 14 10:31:34 2000
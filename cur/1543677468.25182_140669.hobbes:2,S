Date: 15 Jun 2003 09:35:52 -0500
From: James Bottomley <>
Subject: Re: New struct sock_common breaks parisc 64 bit compiles with a misalignment
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2003/6/15/65

On Sun, 2003-06-15 at 01:19, David S. Miller wrote:
> On Mon, 2003-06-09 at 21:57, James Bottomley wrote:
> > The problem seems to be that the new struct sock_common ends with a
> > pointer and an atomic_t (which is an int on parisc), so the compiler
> > adds an extra four bytes of padding where none previously existed in
> > struct tcp_tw_bucket, so the __u64 ptr tricks with tw_daddr fail.
> 
> I'm fixing this, but why does it "fail"?  You should get unaligned
> traps which get fixed up by the trap handler.
Well, it's an architecture thing, I suppose.  Unaligned access traps are
pretty expensive on the parisc, so we don't actually handle them when
they're from the kernel, we panic instead (and expect the problem code
to be fixed).
In this case, our rather crappy kernel tool chain gcc generated the
instruction
ldd 52(%r1),%r4
Which is actually illegal assembly (displacements greater than 16 must
be multiples of 8 for the load double word instruction).  So I couldn't
even compile the code.
> If that isn't happening, lots of things in the networking should
> break on you.
If the gcc is told that the structure won't be aligned, it generates
non-alignment faulting instructions to access it, so no, we don't see
any misalignment faults in the networking layer.
James
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
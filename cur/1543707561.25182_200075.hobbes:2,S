Date: Thu, 19 Feb 2004 15:30:01 +0100 (CET)
From: Krzysztof Benedyczak <>
Subject: [RFC][PATCH] 4/6 POSIX message queues
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2004/2/19/102

// $Header$
// Kernel Version:
//  VERSION = 2
//  PATCHLEVEL = 6
//  SUBLEVEL = 2
//  EXTRAVERSION =
--- 2.6/ipc/mqueue.c	2004-02-16 23:01:18.000000000 +0100
+++ build-2.6/ipc/mqueue.c	2004-02-16 23:01:05.000000000 +0100
@@ -14,6 +14,7 @@
 #include <linux/mqueue.h>
 #include <linux/msg.h>
 #include <linux/list.h>
+#include <linux/poll.h>
 #include <linux/init.h>
 #include <linux/pagemap.h>
 #include <linux/file.h>
@@ -250,6 +251,24 @@
 	return 0;
 }
+static unsigned int mqueue_poll_file(struct file *filp, struct poll_table_struct *poll_tab)
+{
+	struct mqueue_inode_info *info = MQUEUE_I(filp->f_dentry->d_inode);
+	int retval = 0;
+
+	poll_wait(filp, &info->wait_q, poll_tab);
+
+	spin_lock(&info->lock);
+	if (info->attr.mq_curmsgs)
+		retval = POLLIN | POLLRDNORM;
+
+	if (info->attr.mq_curmsgs < info->attr.mq_maxmsg)
+		retval |= POLLOUT | POLLWRNORM;
+	spin_unlock(&info->lock);
+
+	return retval;
+}
+
 /* Adds current to info->e_wait_q[sr] before element with smaller prio */
 static void wq_add(struct mqueue_inode_info *info, int sr,
 			struct ext_wait_queue *ewp)
@@ -374,11 +393,11 @@
 				       &sig_i, info->notify_owner);
 		} else if (info->notify.sigev_notify == SIGEV_THREAD) {
 			info->notify_filp->private_data = (void*)NP_WOKENUP;
-			wake_up(&info->wait_q);
 		}
 		/* after notification unregisters process */
 		info->notify_owner = 0;
 	}
+	wake_up(&info->wait_q);
 }
 static long prepare_timeout(const struct timespec __user *u_arg)
@@ -660,9 +679,11 @@
 {
 	struct ext_wait_queue *sender = wq_get_first_waiter(info, SEND);
-	if (!sender)
+	if (!sender) {
+		/* for poll */
+		wake_up_interruptible(&info->wait_q);
 		return;
-
+	}
 	msg_insert(sender->msg, info);
 	list_del(&sender->list);
 	sender->state = STATE_PENDING;
@@ -974,6 +995,7 @@
 static struct file_operations mqueue_file_operations = {
 	.flush = mqueue_flush_file,
+	.poll = mqueue_poll_file,
 };
 static struct file_operations mqueue_notify_fops = {
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
Date: Fri, 4 Apr 2008 13:56:13 -0400
From: Erez Zadok <>
Subject: Re: [patch 07/10] vfs: add path_rename()
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2008/4/4/262

In message <20080402201330.689695350@szeredi.hu>, Miklos Szeredi writes:
> From: Miklos Szeredi <mszeredi@suse.cz>
> 
> Introduce path_rename().  Make vfs_rename() static.
[...]
> +int path_rename(struct path *old_dir_path, struct dentry *old_dentry,
> +		struct inode *new_dir, struct dentry *new_dentry)
> +{
> +	int error = mnt_want_write(old_dir_path->mnt);
> +
> +	if (!error) {
> +		struct inode *old_dir = old_dir_path->dentry->d_inode;
> +
> +		error = vfs_rename(old_dir, old_dentry, new_dir, new_dentry);
> +		mnt_drop_write(old_dir_path->mnt);
> +	}
> +
> +	return error;
> +}
> +EXPORT_SYMBOL(path_rename);
You're grabbing a want_write ref on the source vfsmount only.  Shouldn't
path_rename() call mnt_want_write on *both* the source and destination
vfsmounts?  If so, do we need to order the locks ala lock_rename()?
Erez.
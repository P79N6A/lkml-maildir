Date: Sun, 9 Sep 2007 09:27:06 +0200
From: Andi Kleen <>
Subject: Re: 2.6.23-rc3-mm1 - vdso and gettimeofday issues with glibc
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2007/9/9/8

> Updating on this issue:   Both myself and another person have reported on
> the RedHat bugzilla that it's a clocksource issue - if you are using the
> hpet clocksource, the time warps, but booting with clocksource=acpi_pm works.
> 
> This ring any bells?
Does this patch fix it? 
-Andi
Add missing mask operation to vdso
vdso vgetns() didn't mask the time source offset calculation, which could
lead to time problems with 32bit HPET. Add the masking.
Thanks to Chuck Ebbert for tracking down.
Signed-off-by: Andi Kleen <ak@suse.de>
Index: linux/arch/x86_64/vdso/vclock_gettime.c
===================================================================
--- linux.orig/arch/x86_64/vdso/vclock_gettime.c
+++ linux/arch/x86_64/vdso/vclock_gettime.c
@@ -34,10 +34,11 @@ static long vdso_fallback_gettime(long c
 
 static inline long vgetns(void)
 {
+	long v;
 	cycles_t (*vread)(void);
 	vread = gtod->clock.vread;
-	return ((vread() - gtod->clock.cycle_last) * gtod->clock.mult) >>
-		gtod->clock.shift;
+	v = (vread() - gtod->clock.cycle_last) & gtod->clock.mask;
+	return (v * gtod->clock.mult) >> gtod->clock.shift;
 }
 
 static noinline int do_realtime(struct timespec *ts)
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
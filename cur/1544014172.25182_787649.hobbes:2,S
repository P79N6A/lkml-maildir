Date: Tue, 06 Jan 2009 10:50:01 -0800
From: Randy Dunlap <>
Subject: Re: [RFC PATCH v2] waitfd
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2009/1/6/281

Casey Dahlin wrote:
> Randy Dunlap wrote:
>> Casey Dahlin wrote:
>> 
>>> Linux now exposes signals, timers, and events via file descriptors
>>> through signalfd, timerfd, and eventfd. This means programmers can use a
>>> single select/[e]poll call to monitor all change in their program. This
>>> patch aims to expose child death via the same mechanism.
>>>
>>> waitfd provides a file descriptor out of which may be read a series of
>>> siginfo_t objects describing child death. A child process is reaped as
>>> soon as its information is read. This means child monitoring too can be
>>> performed with that same poll call.
>>>
>>> Patch is against v2.6.28
>>>
>>> --CJD
>>>
>>> diff --git a/arch/x86/include/asm/unistd_32.h
>>> b/arch/x86/include/asm/unistd_32.h
>>> index f2bba78..134d83c 100644
>>> --- a/arch/x86/include/asm/unistd_32.h
>>> +++ b/arch/x86/include/asm/unistd_32.h
>>> @@ -338,6 +338,7 @@
>>> #define __NR_dup3        330
>>> #define __NR_pipe2        331
>>> #define __NR_inotify_init1    332
>>> +#define __NR_waitfd        333
>>>
>>> #ifdef __KERNEL__
>>>
>>> diff --git a/arch/x86/include/asm/unistd_64.h
>>> b/arch/x86/include/asm/unistd_64.h
>>> index d2e415e..b28eb07 100644
>>> --- a/arch/x86/include/asm/unistd_64.h
>>> +++ b/arch/x86/include/asm/unistd_64.h
>>> @@ -653,6 +653,8 @@ __SYSCALL(__NR_dup3, sys_dup3)
>>> __SYSCALL(__NR_pipe2, sys_pipe2)
>>> #define __NR_inotify_init1            294
>>> __SYSCALL(__NR_inotify_init1, sys_inotify_init1)
>>> +#define __NR_waitfd                295
>>> +__SYSCALL(__NR_waitfd, sys_waitfd)
>>>
>>> 
>>
>> Only for x86??
>>
>> 
> 
> At the moment. I should have mentioned this earlier but I haven't made
> the syscall table entries for archs I don't test on. That will change
> once the rest of the change has settled out.
>>> diff --git a/fs/waitfd.c b/fs/waitfd.c
>>> new file mode 100644
>>> index 0000000..0155a83
>>> --- /dev/null
>>> +++ b/fs/waitfd.c
>>> @@ -0,0 +1,117 @@
>>> +/*
>>> + *  fs/waitfd.c
>>> + *
>>> + *  Copyright (C) 2008  Red Hat, Casey Dahlin <cdahlin@redhat.com>
>>> + *
>>> + *  Largely derived from fs/signalfd.c
>>> + */
>>> +
>>> +#include <linux/file.h>
>>> +#include <linux/poll.h>
>>> +#include <linux/init.h>
>>> +#include <linux/fs.h>
>>> +#include <linux/sched.h>
>>> +#include <linux/kernel.h>
>>> +#include <linux/signal.h>
>>> +#include <linux/list.h>
>>> +#include <linux/anon_inodes.h>
>>> +#include <linux/syscalls.h>
>>> +
>>> +long do_waitid(int which, pid_t upid,
>>> +           struct siginfo __user *infop, int options,
>>> +           struct rusage __user *ru);
>>> +
>>> +struct waitfd_ctx {
>>> +    int ops;
>>> +    int which;
>>> +    pid_t upid;
>>> +};
>>> +
>>> 
>>
>> Please use kernel coding style:  use tabs to indent, not
>> <lots-of-spaces>,
>> and struct members, functions, etc., are indented by one tab stop
>> minimum.
>>
>> 
> 
> Damnit. This is a mailer artifact. This is the first time thunderbird
> has eaten a patch on me. I'll look in to it.
OK.
You can see if Documentation/email-clients.txt helps you any.
>>> +}
>>> +
>>> +static const struct file_operations waitfd_fops = {
>>> +    .release    = waitfd_release,
>>> +    .poll        = waitfd_poll,
>>> +    .read        = waitfd_read,
>>> +};
>>> +
>>> +asmlinkage long sys_waitfd(int which, pid_t upid, int options, int
>>> unused)
>>> +{
>>> +    int ufd;
>>> +    struct waitfd_ctx *ctx;
>>> +
>>> +    /* Just to make sure we don't end up with a sys_waitfd4 */
>>> +    (void)unused;
>>> +
>>> +    if (options & ~(WNOHANG|WEXITED|WSTOPPED|WCONTINUED))
>>> +        return -EINVAL;
>>> +    if (!(options & (WEXITED|WSTOPPED|WCONTINUED)))
>>> +        return -EINVAL;
>>> 
>>
>> Use spaces around '|'.
>>
>> 
> 
> Those 4 lines are copied almost exactly from kernel/exit.c. Is there
> motivation to keep them consistent?
I would say no.
-- 
~Randy
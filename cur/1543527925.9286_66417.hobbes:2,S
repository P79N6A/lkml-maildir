Date: Mon, 28 Feb 2000 23:41:57 -0500
From: James Manning <>
Subject: Re: [PATCH] make checkstruct (was Re: [PATCH] file_operations policing and CodingStyle addition)
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2000/2/29/11

[ Monday, February 28, 2000 ] Jeff Garzik wrote:
> Very cool, though I'm wondering if it wouldn't be more useful to have a
> list of check-able struct types...   I am sure that not all struct
> initializations need to be gcc-ified.
A simple enough change .. attached :)  Only a few from linux/fs.h
currently selected, just to increase the chances of Linus accepting it.
jmm@ns1:/usr/src/linux-check> make checkstruct
find * -name '*.[hc]' -type f -print | xargs perl -w scripts/checkstruct.pl
arch/mips64/sgi-ip27/ip27-rtc.c: non-gcc struct file_operations init
drivers/char/ds1620.c: non-gcc struct file_operations init
drivers/char/nwbutton.c: non-gcc struct file_operations init
drivers/char/nwflash.c: non-gcc struct file_operations init
drivers/char/wdt285.c: non-gcc struct file_operations init
drivers/char/wdt977.c: non-gcc struct file_operations init
drivers/isdn/avmb1/capi.c: non-gcc struct file_operations init
drivers/isdn/divert/divert_procfs.c: non-gcc struct file_operations init
drivers/isdn/hysdn/hysdn_procconf.c: non-gcc struct file_operations init
drivers/isdn/hysdn/hysdn_procfs.c: non-gcc struct file_operations init
drivers/isdn/hysdn/hysdn_proclog.c: non-gcc struct file_operations init
drivers/isdn/isdn_common.c: non-gcc struct file_operations init
drivers/macintosh/via-pmu68k.c: non-gcc struct file_operations init
drivers/usb/scanner.c: non-gcc struct file_operations init
fs/dquot.c: non-gcc struct dquot_operations init
(note the last one is for dquot_operations.  I've already sent Linus
 a patch for all the above file_operations init's, of course, since that
 started this thread :)
James
diff -ruN linux/Makefile linux-check/Makefile
--- linux/Makefile	Mon Feb 28 20:14:51 2000
+++ linux-check/Makefile	Mon Feb 28 20:07:08 2000
@@ -503,6 +503,9 @@
 checkhelp:
 	perl -w scripts/checkhelp.pl `find * -name [cC]onfig.in -print`
 
+checkstruct:
+	find * -name '*.[hc]' -type f -print | xargs perl -w scripts/checkstruct.pl
+
 ifdef CONFIGURATION
 ..$(CONFIGURATION):
 	@echo
diff -ruN linux/scripts/checkstruct.pl linux-check/scripts/checkstruct.pl
--- linux/scripts/checkstruct.pl	Wed Dec 31 19:00:00 1969
+++ linux-check/scripts/checkstruct.pl	Mon Feb 28 23:37:32 2000
@@ -0,0 +1,44 @@
+#!/usr/bin/perl -w
+
+# Copyright 2000 James Manning, <jmm@computer.org>
+# Licensed under the GNU General Public License, version 2.
+
+use strict;
+undef $/; # entire files at a time
+
+my @check_structs=qw(
+	file_operations
+	inode_operations
+	super_operations
+	address_space_operations
+	block_device_operations
+	dquot_operations
+);
+
+foreach my $file (@ARGV) {
+	open(IN,"$file") or die "$file"; my $contents=<IN>; close(IN);
+	for my $check_struct (@check_structs) {
+		print "$file: non-gcc struct $check_struct init\n"
+			if &has_nongcc_struct($check_struct,\$contents);
+	}
+}
+	
+sub has_nongcc_struct {
+	my $struct_type = shift(@_);
+	my $ref_content = shift(@_);
+	my $struct_num=0;
+	my @struct_contents=($$ref_content =~ m|
+			struct\s+$struct_type\s+   # preamble for this struct
+			\S+                        # struct name
+			\s*=\s*{(.*?)(?=})         # postamble
+			|gsx);
+	for my $content (@struct_contents) {
+        	$content =~ s#/\*.*?\*/##gs; # kill c style comments
+        	$content =~ s#//.*##g;       # kill c++ style comments
+		# if non-empty and no : present, non-gcc syntax
+		if($content =~ /\w/ and $content !~ m/:/) {
+			return 1;
+		}
+	}
+	return 0;
+}
Date: Tue, 24 Jan 2006 00:05:52 +0300
From: Alexey Dobriyan <>
Subject: [PATCH] include/asm-*/bitops.h: fix masking in find_next_zero_bit()
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2006/1/23/249

Commit 3960f2faaf0a67ad352bd5d4085e43f19f33ab91 says:
    [PATCH] m68knommu: fix find_next_zero_bit in bitops.h
    We're starting a number of big applications (memory footprint app.
    1MByte) on our Arcturus uC5272.  Therefore memory fragmentation is a
    real pain for us.  We've switched to uClinux-2.4.27-uc1 and found that
    page_alloc2 fragments the memory heavily.
    Digging into it we found a bug in the find_next_zero_bit function in the
    m68knommu/bitops.h file.  if the size isn't a multiple of 32 than the
    upper bits of the last word to be searched should be masked.  But the
    functions masks the lower bits of the last word because it uses a right
    shift instead of a left shift operator.
Fix same typos.
Signed-off-by: Alexey Dobriyan <adobriyan@gmail.com>
---
 include/asm-cris/bitops.h  |    2 +-
 include/asm-frv/bitops.h   |    2 +-
 include/asm-h8300/bitops.h |    2 +-
 include/asm-v850/bitops.h  |    2 +-
 4 files changed, 4 insertions(+), 4 deletions(-)
--- a/include/asm-cris/bitops.h
+++ b/include/asm-cris/bitops.h
@@ -290,7 +290,7 @@ static inline int find_next_zero_bit (co
 	tmp = *p;
 	
  found_first:
-	tmp |= ~0UL >> size;
+	tmp |= ~0UL << size;
  found_middle:
 	return result + ffz(tmp);
 }
--- a/include/asm-frv/bitops.h
+++ b/include/asm-frv/bitops.h
@@ -209,7 +209,7 @@ static inline int find_next_zero_bit(con
 	tmp = *p;
 
 found_first:
-	tmp |= ~0UL >> size;
+	tmp |= ~0UL << size;
 found_middle:
 	return result + ffz(tmp);
 }
--- a/include/asm-h8300/bitops.h
+++ b/include/asm-h8300/bitops.h
@@ -227,7 +227,7 @@ static __inline__ int find_next_zero_bit
 	tmp = *p;
 
 found_first:
-	tmp |= ~0UL >> size;
+	tmp |= ~0UL << size;
 found_middle:
 	return result + ffz(tmp);
 }
--- a/include/asm-v850/bitops.h
+++ b/include/asm-v850/bitops.h
@@ -188,7 +188,7 @@ static inline int find_next_zero_bit(con
 	tmp = *p;
 
  found_first:
-	tmp |= ~0UL >> size;
+	tmp |= ~0UL << size;
  found_middle:
 	return result + ffz (tmp);
 }
-
To unsubscribe from this list: send the line "unsubscribe linux-kernel" in
the body of a message to majordomo@vger.kernel.org
More majordomo info at  
http://vger.kernel.org/majordomo-info.html
Please read the FAQ at  
http://www.tux.org/lkml/
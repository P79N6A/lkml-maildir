Date: Sat, 5 Feb 2005 01:54:56 +0100
From: Bartlomiej Zolnierkiewicz <>
Subject: Re: 2.6.11-rc3-mm1
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-Lkml-Link: https://lkml.org/lkml/2005/2/4/312

On Sat, 05 Feb 2005 11:16:49 +1100, Benjamin Herrenschmidt
<benh@kernel.crashing.org> wrote:
> 
> > I tried it two or three times, same result each time.  I'll give it a
> > lash with USB disabled.
> 
> Also, can you try editing arch/ppc/syslib/open_pic.c, in function
> openpic_resume(), comment out the call to openpic_reset() and let me
> know if that helps...
Well, maybe I'm to blame this time...
I've introduced bug in ATAPI Power Management handling,
idedisk_pm_idle shouldn't be done for ATAPI devices.
Sorry for that, fix attached.
--- a/drivers/ide/ide-io.c	2005-02-04 03:27:35.000000000 +0100
+++ b/drivers/ide/ide-io.c	2005-02-05 01:44:33.000000000 +0100
@@ -230,6 +230,12 @@
 
 	memset(args, 0, sizeof(*args));
 
+	if (drive->media != ide_disk) {
+		/* skip idedisk_pm_idle for ATAPI devices */
+		if (rq->pm->pm_step == idedisk_pm_idle)
+			rq->pm->pm_step = ide_pm_restore_dma;
+	}
+
 	switch (rq->pm->pm_step) {
 	case ide_pm_flush_cache:	/* Suspend step 1 (flush cache) */
 		if (drive->media != ide_disk)